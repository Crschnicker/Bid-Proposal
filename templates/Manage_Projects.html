{% extends "layout.html" %}

{% block title %}Price Book: Manage Projects{% endblock %}

{% block additional_styles %}
<style>
    .content-container {
        max-width: 1400px;
        margin: 40px auto;
        padding: 20px;
    }

    .search-bar {
        margin-bottom: 20px;
    }

    .search-bar input {
        width: 100%;
        padding: 15px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        font-size: 16px;
    }

    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 10px;
        margin-bottom: 20px;
    }

    th, td {
        padding: 15px;
        text-align: left;
        border: none;
        vertical-align: middle;
    }

    th {
        background-color: #3498db;
        color: white;
        font-weight: 500;
    }

    tr {
        background-color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: transform 0.3s;
    }

    tr:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .button-container {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        align-items: center;
    }

    .button {
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s, transform 0.3s;
        text-decoration: none;
        color: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 100px;
        height: 40px;
        outline: none; /* Remove any outline */
    }

    .edit-button {
        background: linear-gradient(135deg, #3498db, #2ecc71);
    }

    .delete-button {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    .button:hover {
        transform: translateY(-2px);
    }

    .button i {
        margin-right: 5px;
    }

    .button-container form {
        background: none;
        padding: 0;
        margin: 0;
        box-shadow: none;
        border: none; /* Ensure no border on the form */
    }

    .button-container form .button {
        box-shadow: none;
    }

    /* Remove any potential bottom border or outline */
    .button-container, .button-container * {
        border-bottom: none;
        outline: none;
    }

    @media (max-width: 1200px) {
        table, thead, tbody, th, td, tr {
            display: block;
        }

        thead tr {
            position: absolute;
            top: -9999px;
            left: -9999px;
        }

        tr {
            margin-bottom: 15px;
        }

        td {
            border: none;
            position: relative;
            padding-left: 50%;
        }

        td:before {
            position: absolute;
            top: 6px;
            left: 6px;
            width: 45%;
            padding-right: 10px;
            white-space: nowrap;
            content: attr(data-label);
            font-weight: bold;
        }

        .button-container {
            justify-content: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="content-container">
    <h2>Manage Projects</h2>
    <div class="search-bar">
        <input type="search" id="searchInput" placeholder="Search projects..." oninput="filterProjects()">
    </div>

    <h3>Existing Projects</h3>
    <table id="projectsTable">
        <thead>
            <tr>
                <th>Name</th>
                <th>Address</th>
                <th>State</th>
                <th>City</th>
                <th>ZIP</th>
                <th>Point of Contact</th>
                <th>Phone Number</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for project in projects %}
            <tr data-project-name="{{ project.project_name }}">
                <td data-label="Name">{{ project.project_name }}</td>
                <td data-label="Address">{{ project.project_address or 'N/A' }}</td>
                <td data-label="State">{{ project.project_state or 'N/A' }}</td>
                <td data-label="City">{{ project.project_city or 'N/A' }}</td>
                <td data-label="ZIP">{{ project.project_zip or 'N/A' }}</td>
                <td data-label="Point of Contact">{{ project.point_of_contact }}</td>
                <td data-label="Phone Number">{{ project.contact_phone_number }}</td>
                <td data-label="Actions">
                    <div class="button-container">
                        <button onclick="editProject('{{ project.project_name }}')" class="button edit-button"><i class="fas fa-edit"></i> Edit</button>
                        <form action="{{ url_for('delete_project', project_name=project.project_name|urlencode) }}" method="POST" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="button delete-button" onclick="return confirm('Are you sure you want to delete this project?');"><i class="fas fa-trash"></i> Delete</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="pagination">
        {% if page > 1 %}
            <a href="{{ url_for('manage_projects', page=page-1) }}"><i class="fas fa-chevron-left"></i> Previous</a>
        {% endif %}
        
        {% for p in range(1, pages + 1) %}
            {% if p == page %}
                <span class="current-page">{{ p }}</span>
            {% else %}
                <a href="{{ url_for('manage_projects', page=p) }}">{{ p }}</a>
            {% endif %}
        {% endfor %}
        
        {% if page < pages %}
            <a href="{{ url_for('manage_projects', page=page+1) }}">Next <i class="fas fa-chevron-right"></i></a>
        {% endif %}
    </div>
    
    <p>Showing {{ projects|length }} of {{ total_projects }} total projects</p>

    <h3>Add/Edit Project</h3>
    <form id="projectForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="text" name="project_name" id="projectName" placeholder="Project Name" required>
        <input type="text" name="project_address" id="projectAddress" placeholder="Address">
        <input type="text" name="project_state" id="projectState" placeholder="State">
        <input type="text" name="project_city" id="projectCity" placeholder="City">
        <input type="text" name="project_zip" id="projectZip" placeholder="ZIP Code">
        <input type="text" name="point_of_contact" id="pointOfContact" placeholder="Point of Contact" required>
        <input type="text" name="contact_phone_number" id="contactPhoneNumber" placeholder="Contact Phone Number" required>
        <button type="submit">Submit Project</button>
    </form>
</div>

<div id="alertContainer"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function filterProjects() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById('searchInput');
        filter = input.value.toLowerCase();
        table = document.getElementById('projectsTable');
        tr = table.getElementsByTagName('tr');

        for (i = 1; i < tr.length; i++) {
            tr[i].style.display = 'none';
            td = tr[i].getElementsByTagName('td');
            for (var j = 0; j < td.length; j++) {
                if (td[j]) {
                    txtValue = td[j].textContent || td[j].innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        tr[i].style.display = '';
                        break;
                    }
                }
            }
        }
    }

    function editProject(projectName) {
        var row = document.querySelector('tr[data-project-name="' + projectName + '"]');
        var cells = row.getElementsByTagName('td');

        for (var i = 0; i < cells.length - 1; i++) {
            var cell = cells[i];
            var input = document.createElement('input');
            input.type = 'text';
            input.value = cell.innerText;
            input.setAttribute('data-original-value', cell.innerText);
            cell.innerText = '';
            cell.appendChild(input);
        }

        var buttonContainer = row.querySelector('.button-container');
        buttonContainer.innerHTML = '<button onclick="saveProject(this)" class="button edit-button"><i class="fas fa-save"></i> Save</button>';
    }

    function saveProject(button) {
        var row = button.closest('tr');
        var inputs = row.querySelectorAll('input');
        var projectData = {};

        inputs.forEach(function(input, index) {
            var column = ['project_name', 'project_address', 'project_state', 'project_city', 'project_zip', 'point_of_contact', 'contact_phone_number'][index];
            projectData[column] = input.value;
        });

        fetch('/api/project/' + projectData.project_name, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            },
            body: JSON.stringify(projectData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                inputs.forEach(function(input, index) {
                    var cell = input.parentElement;
                    cell.innerText = input.value;
                });
                restoreEditDeleteButtons(row, projectData.project_name);
                showAlert('success', 'Project updated successfully');
            } else {
                showAlert('danger', 'Failed to save changes: ' + data.message);
                inputs.forEach(function(input) {
                    input.parentElement.innerText = input.getAttribute('data-original-value');
                });
                restoreEditDeleteButtons(row, projectData.project_name);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'An error occurred while saving changes');
            inputs.forEach(function(input) {
                input.parentElement.innerText = input.getAttribute('data-original-value');
            });
            restoreEditDeleteButtons(row, projectData.project_name);
        });
    }

    function restoreEditDeleteButtons(row, projectName) {
        var buttonContainer = row.querySelector('.button-container');
        buttonContainer.innerHTML = `
            <button onclick="editProject('${projectName}')" class="button edit-button"><i class="fas fa-edit"></i> Edit</button>
            <form action="/delete_project/${projectName}" method="POST" style="display: inline;">
                <input type="hidden" name="csrf_token" value="${document.querySelector('input[name="csrf_token"]').value}">
                <button type="submit" class="button delete-button" onclick="return confirm('Are you sure you want to delete this project?');"><i class="fas fa-trash"></i> Delete</button>
            </form>
        `;
    }

    function showAlert(type, message) {
        var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        var alertHtml = '<div class="alert ' + alertClass + '">' +
                        message +
                        '<button type="button" class="close-alert" aria-label="Close">' +
                        '<span aria-hidden="true">&times;</span></button></div>';
        
        $('#alertContainer').html(alertHtml);
        
        $('.close-alert').click(function() {
            $(this).parent('.alert').remove();
        });

        setTimeout(function() {
            $('.alert').remove();
        }, 5000);
    }

    $(document).ready(function() {
        $('#projectForm').submit(function(e) {
            e.preventDefault();
            
            $.ajax({
                url: '/add-update-project',
                type: 'POST',
                data: $(this).serialize(),
                success: function(response) {
                    if (response.success) {
                        showAlert('success', 'Project created/updated successfully');
                        location.reload();
                    } else {
                        showAlert('danger', 'Error: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('danger', 'An error occurred while creating/updating the project. Please try again.');
                }
            });
        });
    });
</script>
{% endblock %}
</body>
</html>
