<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bid Job Estimating - {{ bid.bid_id }}</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .dragging {
            background-color: #f0f0f0;
            opacity: 0.8;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
    
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    
        body {
            font-family: 'Open Sans', sans-serif;
            text-align: center;
            background: #f4f7f6;
            margin: 0;
            padding: 20px;
        }





        .itemsTable tbody tr.ui-sortable-helper {
            background-color: #f0f8ff; /* Alice blue background for the row being dragged */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            opacity: 0.9;
        }

        .itemsTable tbody tr.ui-sortable-placeholder {
            background-color: #e0f0ff; /* Light blue background for the placeholder */
            height: 40px; /* Adjust as needed */
            visibility: visible !important;
            border: 2px dashed #4a90e2; /* Blue dashed border for the placeholder */
        }

        .tab {
            overflow: hidden;
            border: 1px solid #007bff;
            background-color: #e7f0fa;
        }
    
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
            color: #007bff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    
        .tab button:hover, .tab button.active {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
    
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #007bff;
            border-top: none;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            font-size: 100%;
        }
        .tabcontent {
            display: none;
        }

        .tabcontent.active {
            display: block;
        }
        .heading-info {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 20px;
        }
    
        .heading-content {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
    
        .budget-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
        }

        .budget-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .budget-grid {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .budget-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            background-color: #f0f8ff;
            border: 1px solid #d1e8ff;
        }

        .budget-label {
            font-size: 14px;
            color: #333;
        }

        .budget-value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .grand-total {
            background-color: #e6f3ff;
            border: 1px solid #b3d9ff;
        }
        
        .grand-total .budget-value {
            color: #007bff;
        }

        .total-budget {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 15px;
        }

        .total-budget .section-title {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        @media (max-width: 480px) {
            .budget-grid {
                grid-template-columns: 1fr;
            }
        }

        .info-table-container {
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #007bff;
        }
    
        .info-table-container input[type="text"].partNumInput,
        .info-table-container input[type="text"].factorCodeInput {
            padding: 24px 30px;
            font-size: 1.2em;
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
        }
    
        .placeholder {
            color: #999;
            font-style: italic;
        }
    
        .itemsTable input[type="text"],
        .itemsTable input[type="number"] {
            height: 35px;
            padding: 6px 12px;
            font-size: 1.1em;
            border: 1px solid #ccc;
            box-sizing: border-box;
            width: 100%;
        }
    
        /* Enhanced styles for autocomplete dropdowns */
        .ui-autocomplete {
            max-width: 600px;
            width: auto !important;
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 1000;
            border: 1px solid #ddd;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    
        .ui-menu-item {
            padding: 8px 10px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1.4;
            border-bottom: 1px solid #f0f0f0;
        }
    
        .ui-menu-item:last-child {
            border-bottom: none;
        }
    
        .ui-menu-item:hover,
        .ui-state-active {
            background-color: #f0f0f0;
            border-color: #f0f0f0;
        }
    
        .ui-autocomplete .part-number-item,
        .ui-autocomplete .factor-code-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    
        .ui-autocomplete .part-number-item .item-details,
        .ui-autocomplete .factor-code-item .item-details {
            flex-grow: 1;
        }
    
        .ui-autocomplete .part-number-item .item-price {
            white-space: nowrap;
            margin-left: 10px;
            color: #007bff;
            font-weight: bold;
        }
    
        .ui-autocomplete .factor-code-item .item-labor-hours {
            white-space: nowrap;
            margin-left: 10px;
            color: #28a745;
            font-weight: bold;
        }
    
        .ui-autocomplete::-webkit-scrollbar {
            width: 8px;
        }
    
        .ui-autocomplete::-webkit-scrollbar-thumb {
            background: #007bff;
            border-radius: 4px;
        }
    
        .ui-autocomplete::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
    
        .action-buttons {
            margin-bottom: 20px;
            text-align: center;
        }
    
        table.itemsTable th, 
        table.itemsTable td {
            padding: 12px;
            font-size: 1em;
        }
    
        .budget-container {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 15px;
            max-width: 100%;
            box-sizing: border-box;
        }
    
        @media (max-width: 480px) {
            .budget-grid {
                grid-template-columns: 1fr;
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
            margin-bottom: 20px;
        }
    
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e1e1e1;
        }
    
        th {
            background: linear-gradient(180deg, #e9eff9 0%, #dce4f1 100%);
            color: #333;
            font-weight: 600;
            border-bottom: 2px solid #007bff;
        }
    
        tbody tr:nth-child(odd) {
            background-color: #f9f9f9;
        }
    
        tbody tr:hover {
            background-color: #eef4fb;
        }
    
        .action-buttons button, .removeBtn {
            padding: 12px 18px;
            font-size: 21px;
            border-radius: 6px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
    
        .action-buttons button:hover, .removeBtn:hover {
            background-color: #007BFF;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16);
        }
    
        .removeBtn {
            background-color: #dc3545;
        }
    
        .removeBtn:hover {
            background-color: #c82333;
        }
    
        .total-cost {
            text-align: right;
            font-size: 1.5rem;
            font-weight: 600;
            color: #007bff;
            margin-top: 20px;
        }
    
        label {
            margin-right: 10px;
        }
    
        .heading-details {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
        }
    
        .detail-container {
            flex-grow: 1;
            min-width: 250px;
            padding: 10px;
            box-sizing: border-box;
        }
    
        .heading-details label {
            font-size: 1.5em;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
    
        .heading-details input[type="text"] {
            font-size: 1.2em;
            padding: 10px;
            margin-bottom: 10px;
        }
    
        .tabcontent caption,
        .tabcontent h3 {
            font-weight: bold;
            font-size: 2.1em;
        }
    
        .itemsTable th.lineNumber, .itemsTable td.lineNumber {
            width: 5%;
        }
    
        .itemsTable th.partNumber, .itemsTable td.partNumber {
            width: 9%;
        }
    
        .itemsTable th.description, .itemsTable td.description {
            width: auto;
        }
        .itemsTable th.factorCode, .itemsTable td.factorCode {
            width: 8%;
        }
        .itemsTable th.quantity, .itemsTable td.quantity {
            width: 5%;
        }
        .itemsTable th.cost, .itemsTable td.cost,
        .itemsTable th.lineCost, .itemsTable td.lineCost,
        .itemsTable th.laborHours, .itemsTable td.laborHours,
        .itemsTable th.action, .itemsTable td.action {
            width: 10%;
        }
        .selected {
            background-color: #e0e0e0;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
            position: relative;
        }
        .save-and-close-btn.top-right {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }

        .additional-description-row td {
            padding: 10px;
        }

        .additional-description-row .additionalDescriptionInput {
            width: 100%;
            padding: 5px;
        }

        .additional-description-row .line-ext-cost {
            text-align: right;
            font-weight: bold;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .save-and-close-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        .save-and-close-btn:hover {
            background-color: #45a049;
        }
        .popout {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
        }
        .itemsTable tbody tr.selected {
            background-color: #e6f3ff; /* Light blue background for selected rows */
        }

        .itemsTable tbody tr.active-dropdown {
            background-color: #4a90e2; /* Darker blue for rows with active dropdown */
        }

        .itemsTable tbody tr.active-dropdown input {
            background-color: white; /* Keep input backgrounds white for readability */
            color: black; /* Keep input text black */
        }

        /* New style to maintain blue color on hover for active-dropdown rows */
        .itemsTable tbody tr.active-dropdown:hover {
            background-color: #4a90e2; /* Keep the same blue color on hover */
        }

        /* If you have a general hover style for rows, you might want to update it like this: */
        .itemsTable tbody tr:hover {
            background-color: #f5f5f5; /* Light grey for normal hover */
        }

        /* This ensures that the active-dropdown color takes precedence over the normal hover color */
        .itemsTable tbody tr.active-dropdown:hover {
            background-color: #4a90e2 !important; /* Use !important to override any other hover styles */
        }

        .additional-info-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            width: 100%;
        }
        .additional-description, .line-ext-cost {
            flex: 1;
        }
        .additional-description {
            margin-right: 20px;
            text-align: left;
        }
        .additional-description input {
            width: 100%;
            max-width: 500px;
            padding: 8px;
            font-size: 1em;
        }
        .line-ext-cost {
            text-align: right;
        }
        .line-ext-cost label {
            margin-right: 10px;
        }
        .sub-bid-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #e7f0fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .sub-bid-entry div {
            flex: 1;
            text-align: left;
            color: #007bff;
            font-weight: bold;
        }
        .sub-bid-entry button {
            padding: 10px 20px;
            font-size: 16px;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .sub-bid-entry button:hover {
            background-color: #0056b3;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16);
        }
        .save-button-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        #saveButton {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #saveButton:hover {
            background-color: #45a049;
        }
        /* Modal content table styles */
        .modal-content .itemsTable {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .modal-content .itemsTable th,
        .modal-content .itemsTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .modal-content .itemsTable th {
            background-color: #f2f2f2;
        }
        .modal-content .itemsTable input[type="text"],
        .modal-content .itemsTable input[type="number"] {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }
        /* Responsive adjustments */
        @media screen and (max-width: 1024px) {
            .modal-content {
                width: 95%;
                margin: 2% auto;
            }
        }
        @media screen and (max-width: 768px) {
            .modal-content {
                width: 98%;
                margin: 1% auto;
                padding: 10px;
            }
            .modal-content .itemsTable {
                font-size: 14px;
            }
            .modal-content .itemsTable th,
            .modal-content .itemsTable td {
                padding: 5px;
            }
        }
        .drag-handle {
            cursor: move;
            user-select: none;
            width: 20px;
            text-align: center;
        }
        .itemsTable tbody tr {
            cursor: move;
        }

        .ui-sortable-helper {
            display: table;
            table-layout: fixed;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        /* Reduce font size for description column */
        .itemsTable td input.descriptionInput {
            font-size: 0.95em; /* Adjust this value as needed */
            padding: 4px 6px; /* Reduce padding to fit smaller text */
        }

        /* Optionally, adjust the width of the description column if needed */
        .itemsTable th.description,
        .itemsTable td:nth-child(3) {
            width: auto; /* or set a specific width, e.g., width: 25%; */
        }

        /* If the text is still truncated, you can add this to show full content */
        .itemsTable td input.descriptionInput {
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <input type="hidden" name="csrf_token" id="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" id="bidId" value="{{ bid.bid_id }}">
    <div id="confirmDialog" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 300px; text-align: center;">
            <p id="confirmMessage"></p>
            <button id="confirmYes">Yes</button>
            <button id="confirmNo">No</button>
            <p style="font-size: 0.8em; margin-top: 10px;">Press Enter to confirm</p>
        </div>
        <div id="subBidConfirmDialog" style="display: none; position: absolute; z-index: 2000; left: 50%; top: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <p id="subBidConfirmMessage">Are you sure you want to delete this item?</p>
            <button id="subBidConfirmYes">Yes</button>
            <button id="subBidConfirmNo">No</button>
            <p style="font-size: 0.8em; margin-top: 10px;">Press Enter to confirm</p>
        </div>
    </div>
    <div id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    
    <div class="bid-header-container">
        <div class="home-button-container">
            <a href="/" class="home-button">Home</a>
        </div>
        <h1 class="bid-title"><span id="bidTitleText">{{ bid.project_name }}: {{ bid.bid_id }}</span></h1>
        <div class="save-button-container">
            <button id="saveButton" onclick="saveBid()">Save</button>
        </div>
    </div>
    <div class="tab">
        <button class="tablinks" onclick="openCategory(event, 'Heading')">Heading</button>
        <button class="tablinks" onclick="openCategory(event, 'Drains')">Drains</button>
        <button class="tablinks" onclick="openCategory(event, 'Irrigation')">Irrigation</button>
        <button class="tablinks" onclick="openCategory(event, 'Landscape')">Landscape</button>
        <button class="tablinks" onclick="openCategory(event, 'Maintenance')">Maintenance</button>
        <button class="tablinks" onclick="openCategory(event, 'Subcontractor')">Subcontractor</button>
    </div>
    <div id="Heading" class="tabcontent">
        <h3>{{ bid.bid_id }} Summary</h3>
        <div class="heading-details">
            <div class="detail-container">
                <label for="bidJobId">Bid/Job ID</label>
                <input type="text" id="bidJobId" value="B11342" readonly>
            </div>
            <div class="detail-container">
                <label for="bidDate">Bid Date</label>
                <input type="text" id="bidDate" value="2024-08-27">
            </div>
            <div class="detail-container">
                <label for="architectName">Architect</label>
                <input type="text" id="architectName" value="">
            </div>
            <div class="detail-container">
                <label for="engineerName">Engineer</label>
                <input type="text" id="engineerName" value="">
            </div>
        </div>
        <div class="heading-content">
            <div class="info-table-container">
                <table>
                    <caption>Customer Information</caption>
                    <tr>
                        <th>Name</th>
                        <td>
                            <input type="text" id="customerName" value="{{ bid.customer_name }}" autocomplete="off">
                            <div id="customerSearchResults"></div>
                        </td>
                    </tr>
                    <tr><th>Address</th><td><input type="text" id="customerAddress" value="{{ bid.customer.customer_address }}"></td></tr>
                    <tr><th>State</th><td><input type="text" id="customerState" value="{{ bid.customer.customer_state }}"></td></tr>
                    <tr><th>City</th><td><input type="text" id="customerCity" value="{{ bid.customer.customer_city }}"></td></tr>
                    <tr><th>Zip Code</th><td><input type="text" id="customerZip" value="{{ bid.customer.customer_zip }}"></td></tr>
                </table>
            </div>
            <div class="info-table-container">
                <table>
                    <caption>Labor Rates (Hourly)</caption>
                    <tr><th>Drains</th><td><input type="number" id="laborRateDrains" value="50"></td></tr>
                    <tr><th>Irrigation</th><td><input type="number" id="laborRateIrrigation" value="50"></td></tr>
                    <tr><th>Landscape</th><td><input type="number" id="laborRateLandscape" value="50"></td></tr>
                    <tr><th>Maintenance</th><td><input type="number" id="laborRateMaintenance" value="50"></td></tr>
                    <tr><th>Local Sales Tax (%)</th><td><input type="number" id="localSalesTax" value="8.75"></td></tr>
                </table>
            </div>
            <div class="info-table-container">
                <table>
                    <caption>Project Details</caption>
                    <tr><th>Name</th><td><input type="text" id="projectName" value="{{ bid.project_name }}"></td></tr>
                    <tr><th>Address</th><td><input type="text" id="projectAddress" value="{{ bid.project_address }}"></td></tr>
                    <tr><th>State</th><td><input type="text" id="projectState" value="{{ bid.project_state }}"></td></tr>
                    <tr><th>City</th><td><input type="text" id="projectCity" value="{{ bid.project_city }}"></td></tr>
                    <tr><th>Zip Code</th><td><input type="text" id="projectZip" value="{{ bid.project_zip }}"></td></tr>
                    <tr><th>Point of Contact</th><td><input type="text" id="pointOfContact" value="{{ bid.point_of_contact }}"></td></tr>

                </table>
            </div>
            <div class="info-table-container">
                <table class="budget-summary-table">
                    <caption>Project Budget Summary</caption>
                    <tr>
                        <th colspan="2">Category Totals</th>
                    </tr>
                    <tr>
                        <td>Drains:</td>
                        <td><span id="drainsTotalValue">$185.00</span></td>
                    </tr>
                    <tr>
                        <td>Irrigation:</td>
                        <td><span id="irrigationTotalValue">$0.00</span></td>
                    </tr>
                    <tr>
                        <td>Landscape:</td>
                        <td><span id="landscapeTotalValue">$0.00</span></td>
                    </tr>
                    <tr>
                        <td>Maintenance:</td>
                        <td><span id="maintenanceTotalValue">$0.00</span></td>
                    </tr>
                    <tr>
                        <th colspan="2">Total Budget</th>
                    </tr>
                    <tr>
                        <td>Material:</td>
                        <td><span id="materialTotalValue">$185.00</span></td>
                    </tr>
                    <tr>
                        <td>Labor:</td>
                        <td><span id="laborTotalValue">$99.20</span></td>
                    </tr>
                    <tr>
                        <td>Subcontractor:</td>
                        <td><span id="subcontractorTotalValue">$53.18</span></td>
                    </tr>
                    <tr>
                        <td>Other Materials:</td>
                        <td><span id="otherMaterialsTotalValue">$20.84</span></td>
                    </tr>
                    <tr>
                        <td>Tax:</td>
                        <td><span id="taxTotalValue">$0.00</span></td>
                    </tr>
                    <tr class="grand-total">
                        <td>Grand Total:</td>
                        <td><span id="grandTotalValue">$358.22</span></td>
                    </tr>
                </table>
            </div>
        </div>    
    </div>        
    <!-- Drains Section -->
    <div id="Drains" class="tabcontent">
        <h3>Drains</h3>
        <div class="content-wrapper" id="drainsWrapper">
            <div class="action-buttons">
                <button class="addBtn" onclick="addBlankLineItem('drainsWrapper')">Add Line Item</button>
                <button class="insertBtn" onclick="insertBlankLineItem('drainsWrapper')">Insert Line Item</button>
                <button class="otherMaterialsBtn" onclick="showOtherMaterials('drains')">Other Materials</button>
                <button class="subBidBtn" onclick="openSubBidModal('drains')">Sub Bid</button>
                <button class="generateReportBtn" onclick="generateCombinedReport('drains')">Generate Report</button>
            </div>
            
            <div class="factor-code-search-container">
                <input type="text" id="factorCodeSearchDrains" placeholder="Search Factor Codes..." oninput="searchFactorCodes('factorCodeSearchDrains', 'factorCodeSearchResultsDrains')">
                <div id="factorCodeSearchResultsDrains" class="factor-code-dropdown" style="display: none;"></div>
            </div>

            <table class="itemsTable">
                <thead>
                    <tr>
                        <th class="lineNumber">Line Number</th>
                        <th class="partNumber">Part Number</th>
                        <th class="description">Description</th>
                        <th class="factorCode">Factor Code</th>
                        <th class="quantity">Quantity</th>
                        <th class="cost">Bid Price</th>
                        <th class="laborHours">Labor Hours</th>
                        <th class="otherMaterials">Other Materials</th>
                        <th class="tax">Tax</th>
                        <th class="action">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamically generated rows -->
                </tbody>
            </table>
            <div class="total-cost">
                <h2>Material Cost: <span class="totalMaterialCost">$0.00</span></h2>
                <h2>Labor Cost: <span class="totalLaborCost">$0.00</span></h2>
                <h2>Other Materials Cost: <span class="totalOtherMaterialsCost">$0.00</span></h2>
                <h2>Tax: <span class="totalTax">$0.00</span></h2>
                <h2>Total Cost: <span class="totalCost">$0.00</span></h2>
            </div>
        </div>
    </div>

    <!-- Irrigation Section -->
    <div id="Irrigation" class="tabcontent">
        <h3>Irrigation</h3>
        <div class="content-wrapper" id="irrigationWrapper">
            <div class="action-buttons">
                <button class="addBtn" onclick="addBlankLineItem('irrigationWrapper')">Add Line Item</button>
                <button class="insertBtn" onclick="insertBlankLineItem('irrigationWrapper')">Insert Line Item</button>
                <button class="otherMaterialsBtn" onclick="showOtherMaterials('irrigation')">Other Materials</button>
                <button class="subBidBtn" onclick="openSubBidModal('irrigation')">Sub Bid</button>
                <button class="generateReportBtn" onclick="generateCombinedReport('irrigation')">Generate Report</button>
            </div>
            
            <div class="factor-code-search-container">
                <input type="text" id="factorCodeSearchIrrigation" placeholder="Search Factor Codes..." oninput="searchFactorCodes('factorCodeSearchIrrigation', 'factorCodeSearchResultsIrrigation')">
                <div id="factorCodeSearchResultsIrrigation" class="factor-code-dropdown" style="display: none;"></div>
            </div>

            <table class="itemsTable">
                <thead>
                    <tr>
                        <th class="lineNumber">Line Number</th>
                        <th class="partNumber">Part Number</th>
                        <th class="description">Description</th>
                        <th class="factorCode">Factor Code</th>
                        <th class="quantity">Quantity</th>
                        <th class="cost">Bid Price</th>
                        <th class="laborHours">Labor Hours</th>
                        <th class="otherMaterials">Other Materials</th>
                        <th class="tax">Tax</th>
                        <th class="action">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamically generated rows -->
                </tbody>
            </table>
            <div class="total-cost">
                <h2>Material Cost: <span class="totalMaterialCost">$0.00</span></h2>
                <h2>Labor Cost: <span class="totalLaborCost">$0.00</span></h2>
                <h2>Other Materials Cost: <span class="totalOtherMaterialsCost">$0.00</span></h2>
                <h2>Tax: <span class="totalTax">$0.00</span></h2>
                <h2>Total Cost: <span class="totalCost">$0.00</span></h2>
            </div>
        </div>
    </div>

    <!-- Landscape Section -->
    <div id="Landscape" class="tabcontent">
        <h3>Landscape</h3>
        <div class="content-wrapper" id="landscapeWrapper">
            <div class="action-buttons">
                <button class="addBtn" onclick="addBlankLineItem('landscapeWrapper')">Add Line Item</button>
                <button class="insertBtn" onclick="insertBlankLineItem('landscapeWrapper')">Insert Line Item</button>
                <button class="otherMaterialsBtn" onclick="showOtherMaterials('landscape')">Other Materials</button>
                <button class="subBidBtn" onclick="openSubBidModal('landscape')">Sub Bid</button>
                <button class="generateReportBtn" onclick="generateCombinedReport('landscape')">Generate Report</button>
            </div>
            
            <div class="factor-code-search-container">
                <input type="text" id="factorCodeSearchLandscape" placeholder="Search Factor Codes..." oninput="searchFactorCodes('factorCodeSearchLandscape', 'factorCodeSearchResultsLandscape')">
                <div id="factorCodeSearchResultsLandscape" class="factor-code-dropdown" style="display: none;"></div>
            </div>

            <table class="itemsTable">
                <thead>
                    <tr>
                        <th class="lineNumber">Line Number</th>
                        <th class="partNumber">Part Number</th>
                        <th class="description">Description</th>
                        <th class="factorCode">Factor Code</th>
                        <th class="quantity">Quantity</th>
                        <th class="cost">Bid Price</th>
                        <th class="laborHours">Labor Hours</th>
                        <th class="otherMaterials">Other Materials</th>
                        <th class="tax">Tax</th>
                        <th class="action">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamically generated rows -->
                </tbody>
            </table>
            <div class="total-cost">
                <h2>Material Cost: <span class="totalMaterialCost">$0.00</span></h2>
                <h2>Labor Cost: <span class="totalLaborCost">$0.00</span></h2>
                <h2>Other Materials Cost: <span class="totalOtherMaterialsCost">$0.00</span></h2>
                <h2>Tax: <span class="totalTax">$0.00</span></h2>
                <h2>Total Cost: <span class="totalCost">$0.00</span></h2>
            </div>
        </div>
    </div>

    <!-- Maintenance Section -->
    <div id="Maintenance" class="tabcontent">
        <h3>Maintenance</h3>
        <div class="content-wrapper" id="maintenanceWrapper">
            <div class="action-buttons">
                <button class="addBtn" onclick="addBlankLineItem('maintenanceWrapper')">Add Line Item</button>
                <button class="insertBtn" onclick="insertBlankLineItem('maintenanceWrapper')">Insert Line Item</button>
                <button class="otherMaterialsBtn" onclick="showOtherMaterials('maintenance')">Other Materials</button>
                <button class="subBidBtn" onclick="openSubBidModal('maintenance')">Sub Bid</button>
                <button class="generateReportBtn" onclick="generateCombinedReport('maintenance')">Generate Report</button>
            </div>
            
            <div class="factor-code-search-container">
                <input type="text" id="factorCodeSearchMaintenance" placeholder="Search Factor Codes..." oninput="searchFactorCodes('factorCodeSearchMaintenance', 'factorCodeSearchResultsMaintenance')">
                <div id="factorCodeSearchResultsMaintenance" class="factor-code-dropdown" style="display: none;"></div>
            </div>

            <table class="itemsTable">
                <thead>
                    <tr>
                        <th class="lineNumber">Line Number</th>
                        <th class="partNumber">Part Number</th>
                        <th class="description">Description</th>
                        <th class="factorCode">Factor Code</th>
                        <th class="quantity">Quantity</th>
                        <th class="cost">Bid Price</th>
                        <th class="laborHours">Labor Hours</th>
                        <th class="otherMaterials">Other Materials</th>
                        <th class="tax">Tax</th>
                        <th class="action">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamically generated rows -->
                </tbody>
            </table>
            <div class="total-cost">
                <h2>Material Cost: <span class="totalMaterialCost">$0.00</span></h2>
                <h2>Labor Cost: <span class="totalLaborCost">$0.00</span></h2>
                <h2>Other Materials Cost: <span class="totalOtherMaterialsCost">$0.00</span></h2>
                <h2>Tax: <span class="totalTax">$0.00</span></h2>
                <h2>Total Cost: <span class="totalCost">$0.00</span></h2>
            </div>
        </div>
    </div>

    <!-- Subcontractor Section -->
    <div id="Subcontractor" class="tabcontent">
        <h3>Subcontractor</h3>
        <div class="content-wrapper" id="subcontractorWrapper">
            <div class="action-buttons">
                <button class="addBtn" onclick="addBlankLineItem('subcontractorWrapper')">Add Line Item</button>
                <button class="insertBtn" onclick="insertBlankLineItem('subcontractorWrapper')">Insert Line Item</button>
                <button class="otherMaterialsBtn" onclick="showOtherMaterials('subcontractor')">Other Materials</button>
                <button class="subBidBtn" onclick="openSubBidModal('subcontractor')">Sub Bid</button>
                <button class="generateReportBtn" onclick="generateCombinedReport('subcontractor')">Generate Report</button>
            </div>
            
            <div class="factor-code-search-container">
                <input type="text" id="factorCodeSearchSubcontractor" placeholder="Search Factor Codes..." oninput="searchFactorCodes('factorCodeSearchSubcontractor', 'factorCodeSearchResultsSubcontractor')">
                <div id="factorCodeSearchResultsSubcontractor" class="factor-code-dropdown" style="display: none;"></div>
            </div>

            <table class="itemsTable">
                <thead>
                    <tr>
                        <th class="lineNumber">Line Number</th>
                        <th class="partNumber">Part Number</th>
                        <th class="description">Description</th>
                        <th class="factorCode">Factor Code</th>
                        <th class="quantity">Quantity</th>
                        <th class="cost">Bid Price</th>
                        <th class="laborHours">Labor Hours</th>
                        <th class="otherMaterials">Other Materials</th>
                        <th class="tax">Tax</th>
                        <th class="action">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamically generated rows -->
                </tbody>
            </table>
            <div class="total-cost">
                <h2>Material Cost: <span class="totalMaterialCost">$0.00</span></h2>
                <h2>Labor Cost: <span class="totalLaborCost">$0.00</span></h2>
                <h2>Other Materials Cost: <span class="totalOtherMaterialsCost">$0.00</span></h2>
                <h2>Tax: <span class="totalTax">$0.00</span></h2>
                <h2>Total Cost: <span class="totalCost">$0.00</span></h2>
            </div>
        </div>
    </div>
    <div id="drainsSubBidModal" class="modal">
        <div class="modal-content">
            <button class="save-and-close-btn top-right" onclick="saveAndCloseSubBid('drains')">Save and Close</button>
            <div id="drainsSubBidsList"></div>
            <div class="create-sub-bid" id="createSubBidDrains">
                <input type="text" id="newSubBidNameDrains" placeholder="Enter Sub Bid Name">
                <button onclick="createNewSubBid('drains')">Create New Sub Bid</button>
            </div>
            <div id="drainsSubBidContent"></div>
        </div>
    </div>
    
    <div id="irrigationSubBidModal" class="modal">
        <div class="modal-content">
            <button class="save-and-close-btn top-right" onclick="saveAndCloseSubBid('irrigation')">Save and Close</button>
            <div id="irrigationSubBidsList"></div>
            <div class="create-sub-bid" id="createSubBidIrrigation">
                <input type="text" id="newSubBidNameIrrigation" placeholder="Enter Sub Bid Name">
                <button onclick="createNewSubBid('irrigation')">Create New Sub Bid</button>
            </div>
            <div id="irrigationSubBidContent"></div>
        </div>
    </div>
    
    <div id="landscapeSubBidModal" class="modal">
        <div class="modal-content">
            <button class="save-and-close-btn top-right" onclick="saveAndCloseSubBid('landscape')">Save and Close</button>
            <div id="landscapeSubBidsList"></div>
            <div class="create-sub-bid" id="createSubBidLandscape">
                <input type="text" id="newSubBidNameLandscape" placeholder="Enter Sub Bid Name">
                <button onclick="createNewSubBid('landscape')">Create New Sub Bid</button>
            </div>
            <div id="landscapeSubBidContent"></div>
        </div>
    </div>
    
    <div id="maintenanceSubBidModal" class="modal">
        <div class="modal-content">
            <button class="save-and-close-btn top-right" onclick="saveAndCloseSubBid('maintenance')">Save and Close</button>
            <div id="maintenanceSubBidsList"></div>
            <div class="create-sub-bid" id="createSubBidMaintenance">
                <input type="text" id="newSubBidNameMaintenance" placeholder="Enter Sub Bid Name">
                <button onclick="createNewSubBid('maintenance')">Create New Sub Bid</button>
            </div>
            <div id="maintenanceSubBidContent"></div>
        </div>
    </div>
    
    <div id="subcontractorSubBidModal" class="modal">
        <div class="modal-content">
            <button class="save-and-close-btn top-right" onclick="saveAndCloseSubBid('subcontractor')">Save and Close</button>
            <div id="subcontractorSubBidsList"></div>
            <div class="create-sub-bid" id="createSubBidSubcontractor">
                <input type="text" id="newSubBidNameSubcontractor" placeholder="Enter Sub Bid Name">
                <button onclick="createNewSubBid('subcontractor')">Create New Sub Bid</button>
            </div>
            <div id="subcontractorSubBidContent"></div>
        </div>
    </div>
    

    <script>
        // Ensure jsPDF is correctly referenced
        const { jsPDF } = window.jspdf;
        
        var inventory = [];
        var factors = [];
        document.addEventListener("DOMContentLoaded", function() {
            initializeTable('subcontractorWrapper');
            enableDragAndDrop('#subcontractorWrapper .itemsTable');

            // Add this to the labor rate listeners
            var laborRateSubcontractor = document.getElementById('laborRateSubcontractor');
            if (laborRateSubcontractor) {
                laborRateSubcontractor.addEventListener('input', function() {
                    updateTotalsBasedOnLaborRateChange('subcontractorWrapper', parseFloat(this.value) || 50);
                });
            } else {
                console.warn('laborRateSubcontractor element not found');
            }
            
            // Automatically click the "Heading" tab to open it on page load
            document.querySelector(".tablinks[onclick*='Heading']").click();
            document.querySelectorAll("#Heading .heading-details input[type='text'], #Heading .heading-details input[type='number']").forEach(input => {
            // Load saved bid items
            loadSavedBidItems();
                //input.addEventListener('input', () => autoSaveBidData());
            });

            // Attach auto-save listeners to line item inputs
            document.querySelectorAll(".itemsTable input").forEach(input => {
                //input.addEventListener('input', () => autoSaveBidData());
            });

            // Attach auto-save listeners to additional description inputs
            document.querySelectorAll(".additional-description input").forEach(input => {
                //input.addEventListener('input', () => autoSaveBidData());
            });            // Set default inventory items in the dropdown
            populateDefaultInventoryDropdown();
    
            // Initialize tables for each category
            initializeTable('drainsWrapper');
            initializeTable('irrigationWrapper');
            initializeTable('landscapeWrapper');
            initializeTable('maintenanceWrapper');
    

            // Add these lines after table initialization
            enableDragAndDrop('#drainsWrapper .itemsTable');
            enableDragAndDrop('#irrigationWrapper .itemsTable');
            enableDragAndDrop('#landscapeWrapper .itemsTable');
            enableDragAndDrop('#maintenanceWrapper .itemsTable');
            // Attach event listeners to labor rate inputs for dynamic updates
            document.getElementById('laborRateDrains').addEventListener('input', function() {
                updateTotalsBasedOnLaborRateChange('drainsWrapper', parseFloat(this.value) || 50);
            });
            document.getElementById('laborRateIrrigation').addEventListener('input', function() {
                updateTotalsBasedOnLaborRateChange('irrigationWrapper', parseFloat(this.value) || 50);
            });
            document.getElementById('laborRateLandscape').addEventListener('input', function() {
                updateTotalsBasedOnLaborRateChange('landscapeWrapper', parseFloat(this.value) || 50);
            });
            document.getElementById('laborRateMaintenance').addEventListener('input', function() {
                updateTotalsBasedOnLaborRateChange('maintenanceWrapper', parseFloat(this.value) || 50);
            });
    
            // Attach event listeners for labor rate inputs in the heading tab
            document.querySelectorAll("#Heading .heading-details input[type='text']").forEach(input => {
                input.addEventListener('input', function() {
                    //updateBudgetTotals();
                });
            });
    
            // Initialize the budget totals based on the current values in the input fields
            initializeHeadingTab();
        });
    
        function initializeAutoSave() {
            // Select all input fields in the heading tab and attach auto-save on input
            const headingInputs = document.querySelectorAll("#Heading .heading-details input[type='text'], #Heading .heading-details input[type='number']");
            headingInputs.forEach(input => {
                //input.addEventListener('input', () => autoSaveBidData());
            });

            // Select all line item inputs and attach auto-save on input
            const lineItemInputs = document.querySelectorAll(".itemsTable input");
            lineItemInputs.forEach(input => {
                //input.addEventListener('input', () => autoSaveBidData());
            });

            // Select all additional description inputs and attach auto-save on input
            const additionalDescriptionInputs = document.querySelectorAll(".additional-description input");
            additionalDescriptionInputs.forEach(input => {
                //input.addEventListener('input', () => autoSaveBidData());
            });
        }

        function autoSaveBidData() {
            const bidId = document.getElementById('bidId').value;
            if (!bidId) {
                console.error('No bid ID found');
                return;
            }

            const bidData = {
                bid_id: bidId,
                heading_info: {
                    bid_job_id: $('#bidJobId').val(),
                    bid_date: $('#bidDate').val(),
                    customer_name: $('#customerName').val(),
                    customer_address: $('#customerAddress').val(),
                    customer_state: $('#customerState').val(),
                    customer_city: $('#customerCity').val(),
                    customer_zip: $('#customerZip').val(),
                    project_name: $('#projectName').val(),
                    project_address: $('#projectAddress').val(),
                    project_state: $('#projectState').val(),
                    project_city: $('#projectCity').val(),
                    project_zip: $('#projectZip').val()
                },
                labor_rates: {
                    drains_labor_rate: getFloatValueSafely('laborRateDrains'),
                    irrigation_labor_rate: getFloatValueSafely('laborRateIrrigation'),
                    landscape_labor_rate: getFloatValueSafely('laborRateLandscape'),
                    maintenance_labor_rate: getFloatValueSafely('laborRateMaintenance'),
                    subcontractor_labor_rate: getFloatValueSafely('laborRateSubcontractor'),
                    local_sales_tax: getFloatValueSafely('localSalesTax')
                },
                items: {
                    drains: collectLineItems('drainsWrapper'),
                    irrigation: collectLineItems('irrigationWrapper'),
                    landscape: collectLineItems('landscapeWrapper'),
                    maintenance: collectLineItems('maintenanceWrapper'),
                    subcontractor: collectLineItems('subcontractorWrapper')
                }
            };

            // Send the data to the server
            fetch('/auto-save-bid', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(bidData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Auto-save successful:', data);
            })
            .catch(error => {
                console.error('Error during auto-save:', error);
            });
        }

        function saveBid() {
            const csrfToken = getCsrfToken();
            if (!csrfToken) {
                alert('Error: CSRF token is missing. Please reload the page and try again.');
                return;
            }

            $('#loadingOverlay').show();

            function getValueSafely(id) {
                const element = document.getElementById(id);
                return element ? element.value : '';
            }

            function getFloatValueSafely(id) {
                const value = getValueSafely(id);
                return parseFloat(value) || 0;
            }

            const bidId = getValueSafely('bidId');

            if (!bidId) {
                alert('Error: Bid ID is missing. Please reload the page and try again.');
                $('#loadingOverlay').hide();
                return;
            }

            const customerName = $('#customerName').val().trim();
            if (!customerName) {
                alert('Error: Customer name cannot be empty. Please enter a customer name before saving.');
                $('#customerName').focus();
                $('#loadingOverlay').hide();
                return;
            }

            // Collect Heading Info
            const headingInfo = {
                bid_id: getValueSafely('bidJobId'),
                bid_date: getValueSafely('bidDate'),
                customer_name: getValueSafely('customerName'),
                customer_address: getValueSafely('customerAddress'),
                customer_state: getValueSafely('customerState'),
                customer_city: getValueSafely('customerCity'),
                customer_zip: getValueSafely('customerZip'),
                project_name: getValueSafely('projectName'),
                project_address: getValueSafely('projectAddress'),
                project_state: getValueSafely('projectState'),
                project_city: getValueSafely('projectCity'),
                project_zip: getValueSafely('projectZip'),
                architect_name: getValueSafely('architectName'),  // Added this line
                engineer_name: getValueSafely('engineerName'),    // Added this line
                point_of_contact: getValueSafely('pointOfContact') // Added this line
            };

            const laborRates = {
                drains_labor_rate: getFloatValueSafely('laborRateDrains'),
                irrigation_labor_rate: getFloatValueSafely('laborRateIrrigation'),
                landscape_labor_rate: getFloatValueSafely('laborRateLandscape'),
                maintenance_labor_rate: getFloatValueSafely('laborRateMaintenance'),
                local_sales_tax: getFloatValueSafely('localSalesTax')
            };

            const bidData = {
                bid_id: bidId,
                heading_info: headingInfo,
                labor_rates: laborRates,
                items: {
                    drains: collectLineItems('drainsWrapper'),
                    irrigation: collectLineItems('irrigationWrapper'),
                    landscape: collectLineItems('landscapeWrapper'),
                    maintenance: collectLineItems('maintenanceWrapper'),
                    subcontractor: collectLineItems('subcontractorWrapper') // Add this line
                }
            };

            // Replace 'None' with empty string in heading info
            Object.keys(bidData.heading_info).forEach(key => {
                if (bidData.heading_info[key] === 'None') bidData.heading_info[key] = '';
            });

            console.log('Sending bid data:', bidData);

            saveCustomer()
                .then(() => saveProject(headingInfo))
                .then(() => {
                    return fetch('/save-bid', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify(bidData),
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    $('#loadingOverlay').hide();
                    console.log('Success:', data);
                    alert('Bid saved successfully!');
                })
                .catch((error) => {
                    $('#loadingOverlay').hide();
                    console.error('Error:', error);
                    let errorMessage = 'An unexpected error occurred while saving the bid.';
                    if (error.message.includes('HTTP error!')) {
                        try {
                            const errorBody = JSON.parse(error.message.split('body: ')[1]);
                            errorMessage = errorBody.error || errorBody.details || errorMessage;
                        } catch (e) {
                            errorMessage = error.message;
                        }
                    } else if (error.name === 'SyntaxError') {
                        errorMessage = 'Received an invalid response from the server. Please try again later.';
                    }
                    alert('Error saving bid: ' + errorMessage);
                });
        }

        function saveCustomer() {
            return new Promise((resolve, reject) => {
                const csrfToken = document.getElementById('csrf_token').value;
                if (!csrfToken) {
                    console.error('CSRF token is missing');
                    reject(new Error('CSRF token is missing'));
                    return;
                }

                const customerData = {
                    customer_name: $('#customerName').val(),
                    customer_address: $('#customerAddress').val(),
                    customer_state: $('#customerState').val(),
                    customer_city: $('#customerCity').val(),
                    customer_zip: $('#customerZip').val()
                };

                console.log('Sending customer data:', customerData);

                $.ajax({
                    url: '/save-customer',
                    method: 'POST',
                    data: JSON.stringify(customerData),
                    contentType: 'application/json',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    success: function(response) {
                        console.log('Save customer response:', response);
                        if (response.status === 'new') {
                            if (confirm('Customer not found. Would you like to create a new customer?')) {
                                createNewCustomer(customerData, csrfToken)
                                    .then(() => {
                                        console.log('New customer created successfully');
                                        resolve();
                                    })
                                    .catch(reject);
                            } else {
                                clearCustomerFields();
                                resolve();
                            }
                        } else {
                            console.log('Customer updated successfully');
                            resolve();
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Error saving customer:', textStatus, errorThrown);
                        console.error('Response:', jqXHR.responseText);
                        reject(new Error(`Error saving customer: ${textStatus}`));
                    }
                });
            });
        }


        function collectLineItems(wrapperId) {
            const lineItems = [];
            $(`#${wrapperId} .itemsTable tbody tr:not(.additional-description-row)`).each(function() {
                const partNumber = $(this).find('.partNumInput').val().trim();
                
                // Skip this line item if the part number is empty
                if (!partNumber) {
                    return true; // This is equivalent to 'continue' in a jQuery each loop
                }

                const inventoryDescription = $(this).find('.partNumInput').data('inventoryDescription') || '';
                const currentDescription = $(this).find('.descriptionInput').val() || '';
                const additionalDescription = $(this).data('additionalDescription') || '';

                const item = {
                    line_number: $(this).find('.lineNumber').text() || '',
                    part_number: partNumber,
                    description: encodeURIComponent(currentDescription),
                    inventory_description: encodeURIComponent(inventoryDescription),
                    custom_description: currentDescription !== inventoryDescription,
                    factor_code: $(this).find('.factorCodeInput').val() || '',
                    quantity: parseFloat($(this).find('.quantity input').val()) || 0,
                    cost: parseFloat($(this).find('.costInput').val()) || 0,
                    labor_hours: parseFloat($(this).find('.laborHoursInput').val()) || 0,
                    line_ext_cost: parseFloat($(this).find('.lineExtCost').text().replace('$', '')) || 0,
                    additional_description: encodeURIComponent(additionalDescription),
                    other_materials_cost: parseFloat($(this).find('.otherMaterials').text().replace('$', '')) || 0,
                    tax: parseFloat($(this).find('.tax').text().replace('$', '')) || 0
                };
                lineItems.push(item);
            });
            return lineItems;
        }

        function createNewSubBid(category) {
            var subBidNameInput = document.getElementById('newSubBidName' + capitalizeFirstLetter(category));
            if (!subBidNameInput) {
                console.error('Sub bid name input not found for category:', category);
                return;
            }
            var subBidName = subBidNameInput.value;
            if (!subBidName) {
                alert("Please enter a sub bid name.");
                return;
            }

            var bidId = document.getElementById('bidId').value;
            var csrfToken = getCsrfToken();

            fetch(`/api/subbids/${bidId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    category: category,
                    name: subBidName,
                    total_cost: 0,
                    labor_hours: 0
                }),
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                console.log('Success:', data);
                subBidNameInput.value = '';
                populateSubBidsList(category);
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Error creating sub-bid: ' + error.message);
            });
        }


        function initializeHeadingTab() {
            loadDefaultLaborRates();

            // Attach event listeners to labor rate inputs
            ['laborRateDrains', 'laborRateIrrigation', 'laborRateLandscape', 'laborRateMaintenance', 'localSalesTax'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', function() {
                        updateTotalsBasedOnLaborRateChange(this.id.replace('laborRate', '').toLowerCase() + 'Wrapper', parseFloat(this.value) || 50);
                        //updateBudgetTotals();
                    });
                } else {
                    console.warn(`Element not found: ${id}`);
                }
            });

            // Attach event listeners for other inputs in the heading tab
            document.querySelectorAll("#Heading .heading-details input[type='text']").forEach(input => {
                input.addEventListener('input', function() {
                    //updateBudgetTotals();
                });
            });
        }
        function fetchInventoryAndFactors() {
            return Promise.all([
                new Promise((resolve, reject) => {
                    $.getJSON('/inventory', function(data) {
                        inventory = data;
                        console.log("Loaded Inventory:", inventory);
                        resolve(inventory);
                    }).fail(function(jqXHR, textStatus, errorThrown) {
                        console.error("An error occurred while fetching the inventory:", textStatus, errorThrown);
                        reject(new Error("Failed to fetch inventory"));
                    });
                }),
                new Promise((resolve, reject) => {
                    $.getJSON('/factors', function(data) {
                        factors = data;
                        console.log("Loaded Factors:", factors);
                        resolve(factors);
                    }).fail(function(jqXHR, textStatus, errorThrown) {
                        console.error("An error occurred while fetching the factors:", textStatus, errorThrown);
                        reject(new Error("Failed to fetch factors"));
                    });
                })
            ]).then(([inventoryData, factorsData]) => {
                // Attach autocomplete after both data sets are loaded
                attachAutocomplete($('.partNumInput'), inventoryData);
                attachFactorAutocomplete($('.factorCodeInput'), factorsData);
                
                // Process the labor hours queue
                processlaborHoursQueue();
                
                return { inventory: inventoryData, factors: factorsData };
            }).catch(error => {
                console.error("Error in fetchInventoryAndFactors:", error);
                // You might want to show an error message to the user here
                throw error; // Re-throw the error for the caller to handle if needed
            });
        } 
        function populateDefaultInventoryDropdown() {
            var dropdown = $('#partDropdown');
            inventory.slice(0, 10).forEach(function(part) {
                var div = $('<div>').text(part.part_number + ' - ' + part.description);
                div.on('click', function() {
                    $('#PartNum').val(part.part_number);
                    $('#Description').val(part.description);
                    $('#Cost').val(part.cost);
                    $('#FactorCode').val(part.factor_code);
                    dropdown.empty();  // Clear the dropdown after selection
                });
                dropdown.append(div);
            });
        }
    
        // Update the openCategory function to clear the additional description input when switching tabs
        function openCategory(evt, categoryName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            var selectedTab = document.getElementById(categoryName);
            if (selectedTab) {
                selectedTab.style.display = "block";
                console.log("Opened tab:", categoryName); // Debug log
            } else {
                console.error("Tab not found:", categoryName); // Error log
            }
            evt.currentTarget.className += " active";
        }

        function removeLineItem(button) {
            if ($(button).data('removing')) {
                return;
            }

            $(button).data('removing', true);

            const isSubBid = $(button).closest('.sub-bid-wrapper').length > 0;
            const confirmDialog = isSubBid ? $('#subBidConfirmDialog') : $('#confirmDialog');
            const confirmMessage = isSubBid ? $('#subBidConfirmMessage') : $('#confirmMessage');
            const confirmYes = isSubBid ? $('#subBidConfirmYes') : $('#confirmYes');
            const confirmNo = isSubBid ? $('#subBidConfirmNo') : $('#confirmNo');

            confirmMessage.text("Are you sure you want to delete this item?");
            
            if (isSubBid) {
                const subBidModal = $(button).closest('.modal-content');
                confirmDialog.appendTo(subBidModal).show();
            } else {
                confirmDialog.show();
            }

            function handleConfirmation(isConfirmed) {
                confirmDialog.hide();
                if (isConfirmed) {
                    var tr = $(button).closest('tr');
                    var contentWrapper = tr.closest('.content-wrapper, .sub-bid-wrapper');
                    
                    // Remove the additional description row if it exists
                    var additionalDescRow = tr.next('.additional-description-row');
                    if (additionalDescRow.length) {
                        additionalDescRow.remove();
                    }
                    
                    tr.remove();
                    updateLineNumbers(contentWrapper);
                    updateTotalCost(contentWrapper);
                    updateBudgetTotals();
                }
                $(button).removeData('removing');
                $(document).off('keydown.confirmDialog');
            }

            confirmYes.one('click', function() {
                handleConfirmation(true);
            });

            confirmNo.one('click', function() {
                handleConfirmation(false);
            });

            // Handle Enter key press
            $(document).on('keydown.confirmDialog', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleConfirmation(true);
                }
            });
        }

        function updateLineNumbers(contentWrapper) {
            var lineNumber = 1;
            contentWrapper.find(".itemsTable tbody tr").each(function() {
                if (!$(this).hasClass('additional-description-row')) {
                    $(this).find('.lineNumber').text(lineNumber);
                    lineNumber++;
                }
            });
        }


        $(document).ready(function() {
            // Loading overlay
            $('#loadingOverlay').show();

            $('.generateReportBtn').on('click', function() {
                var category = $(this).closest('.content-wrapper').attr('id').replace('Wrapper', '');
                generateCombinedReport(category);
            });

            // Add the new event listener here
            $('#localSalesTax').on('input', function() {
                $('.itemsTable tbody tr').each(function() {
                    updateLineAndTotalCosts($(this).find('.quantity input')[0]);
                });
            });

            // Customer search initialization
            $('#customerName').on('input', function() {
                clearTimeout(customerSearchTimeout);
                const query = $(this).val();
                if (query.length >= 2) {
                    customerSearchTimeout = setTimeout(() => searchCustomers(query), 300);
                } else {
                    $('#customerSearchResults').empty();
                }
            });

            $('#laborRateDrains, #laborRateIrrigation, #laborRateLandscape, #laborRateMaintenance, #localSalesTax').on('input', function() {
                updateBudgetTotals();
            });

            // Initialize tables
            ['drainsWrapper', 'irrigationWrapper', 'landscapeWrapper', 'maintenanceWrapper'].forEach(wrapperId => {
                initializeTable(wrapperId);
            });

            // Minimum delay promise
            const minDelay = new Promise(resolve => setTimeout(resolve, 1000));

            // Fetch inventory and factors first
            fetchInventoryAndFactors()
                .then(() => {
                    console.log("Inventory and factors loaded");
                    // Then load saved bid items
                    return loadSavedBidItems();
                })
                .then(() => {
                    console.log("Saved bid items loaded");
                    // Reinitialize autocomplete for all part number and description inputs
                    reinitializeAutocomplete();
                    // Initialize existing rows
                    initializeExistingRows();
                    // Initialize labor rate listeners
                    initializeLaborRateListeners();
                    // Update budget totals
                    updateBudgetTotals();
                    return minDelay;
                })
                .catch((error) => {
                    console.error('Error loading data:', error);
                    alert('Error loading data. Please refresh the page and try again.');
                })
                .finally(() => {
                    $('#loadingOverlay').hide();
                });

            // Automatically click the "Heading" tab to open it on page load
            document.querySelector(".tablinks[onclick*='Heading']").click();

            // Event delegation for remove buttons
            $(document).on('click', '.removeBtn', function(e) {
                e.preventDefault();
                removeLineItem(this);
            });

            // Hide unwanted UI elements on interval
            setInterval(function() {
                $('.ui-helper-hidden-accessible, .ui-helper-hidden-accessible div').css('display', 'none');
            }, 100);

            // Initialize auto-save functionality
            initializeAutoSave();

            // Add event listener for saving default labor rates
            $('#save-labor-rates').on('click', function() {
                saveDefaultLaborRates();
            });
        });



        function updateTotalsBasedOnLaborRateChange(wrapperId, newLaborRate) {
            var categoryData = calculateCategoryTotal(wrapperId, newLaborRate);
            updateTotalCost($('#' + wrapperId));
            //updateBudgetTotals();
        }
    
        function getSubBidLaborRate(subBidId) {
            var category = $('#' + subBidId).data('category');
            return getLaborRate(category + 'Wrapper');
        }

        function updateTotalCost(contentWrapper) {
            var isSubcontractor = contentWrapper.attr('id') === 'subcontractorWrapper';
            var isSubBid = contentWrapper.hasClass('sub-bid-wrapper');
            var totalMaterialCost = 0;
            var totalLaborCost = 0;
            var totalOtherMaterialsCost = 0;
            var totalTax = 0;
            var laborRate = isSubcontractor ? 0 : getLaborRate(contentWrapper.attr('id') || contentWrapper.data('category'));

            contentWrapper.find(".itemsTable tbody tr").each(function() {
                var quantity = parseFloat($(this).find('.quantity input').val()) || 0;
                var cost = parseFloat($(this).find('.costInput').val()) || 0;
                totalMaterialCost += quantity * cost;

                if (!isSubcontractor) {
                    var laborHours = parseFloat($(this).find('.laborHoursInput').val()) || 0;
                    totalLaborCost += quantity * laborHours * laborRate;
                    var otherMaterialsCost = parseFloat($(this).find('.otherMaterials').text().replace('$', '')) || 0;
                    totalOtherMaterialsCost += otherMaterialsCost;
                    var taxAmount = parseFloat($(this).find('.tax').text().replace('$', '')) || 0;
                    totalTax += taxAmount;
                }
            });

            var totalCost = totalMaterialCost + totalLaborCost + totalOtherMaterialsCost + totalTax;

            var totalCostContainer = contentWrapper.find(".total-cost");
            totalCostContainer.find(".totalMaterialCost").text(`$${totalMaterialCost.toFixed(2)}`);
            
            if (!isSubcontractor) {
                totalCostContainer.find(".totalLaborCost").text(`$${totalLaborCost.toFixed(2)}`);
                totalCostContainer.find(".totalOtherMaterialsCost").text(`$${totalOtherMaterialsCost.toFixed(2)}`);
                totalCostContainer.find(".totalTax").text(`$${totalTax.toFixed(2)}`);
            }
            
            totalCostContainer.find(".totalCost").text(`$${totalCost.toFixed(2)}`);

            if (isSubBid) {
                // Update the sub-bid entry in the list if it exists
                var subBidId = contentWrapper.attr('id');
                var subBidEntry = $(`[data-subbid-id="${subBidId}"]`);
                if (subBidEntry.length) {
                    subBidEntry.find('.sub-bid-total').text(`$${totalCost.toFixed(2)}`);
                    subBidEntry.find('.sub-bid-labor-hours').text(totalLaborCost.toFixed(2));
                }
            }
        }



        // Attach event listeners to all inputs that can affect the totals
        $('.content-wrapper').on('input', '.quantity input, .costInput, .laborHoursInput', function() {
            updateLineAndTotalCosts(this);
        });


        // Update the initializeLaborRateListeners function
        function initializeLaborRateListeners() {
            const laborRateFields = [
                { id: 'laborRateDrains', wrapper: 'drainsWrapper' },
                { id: 'laborRateIrrigation', wrapper: 'irrigationWrapper' },
                { id: 'laborRateLandscape', wrapper: 'landscapeWrapper' },
                { id: 'laborRateMaintenance', wrapper: 'maintenanceWrapper' }
            ];

            laborRateFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.addEventListener('input', function() {
                        updateTotalsBasedOnLaborRateChange(field.wrapper, parseFloat(this.value) || 50);
                        saveBidLaborRate(field.wrapper, parseFloat(this.value) || 50);
                    });
                } else {
                    console.warn(`Element not found: ${field.id}`);
                }
            });
        }

  
        // Function to calculate line extension cost
        function calculateLineExtCost(factorCode, quantity) {
            var factor = factors.find(f => f.factor_code === factorCode);
            if (!factor || !factor.items) return 0;
            
            return factor.items.reduce((total, item) => {
                var inventoryItem = inventory.find(i => i.part_number === item.part_number);
                if (!inventoryItem) return total;
                return total + (inventoryItem.cost * item.quantity * quantity);
            }, 0);
        }

        function fetchFactorCodeAndLaborHoursForPart(partNumber, tr) {
            return new Promise((resolve, reject) => {
                console.log(`Fetching factor code and labor hours for part: ${partNumber}`);
                $.ajax({
                    url: `/get-factor-code-and-labor-hours/${partNumber}`,
                    success: function(data) {
                        console.log(`Received data for part ${partNumber}:`, data);
                        if (data && typeof data === 'object') {
                            tr.find('.factorCodeInput').val(data.factor_code || '');
                            var laborHours = data.labor_hours !== undefined ? data.labor_hours : 0;
                            tr.find('.laborHoursInput').val(laborHours.toFixed(4));
                        } else {
                            console.warn(`No valid data received for part ${partNumber}`);
                            tr.find('.factorCodeInput').val('');
                            tr.find('.laborHoursInput').val('0.00');
                        }
                        resolve();
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error(`Error fetching data for part ${partNumber}:`, textStatus, errorThrown);
                        tr.find('.factorCodeInput').val('');
                        tr.find('.laborHoursInput').val('0.00');
                        reject(errorThrown);
                    }
                });
            });
        }
        
        // Global caches
        const factorCodeCache = new Map();
        const customerCache = new Map();
        const projectCache = new Map();
        let bidDataCache = null;

        
        function calculateOtherMaterials(category) {
            console.log(`Calculating other materials for category: ${category}`);
            var otherMaterials = [];

            var isSubBid = category.startsWith('subbid-');
            var wrapperSelector = isSubBid ? 
                `#subBid_${category.replace('subbid-', '')}` : 
                `#${category.toLowerCase()}Wrapper`;
            console.log(`Using wrapper selector: ${wrapperSelector}`);

            var wrapper = $(wrapperSelector);
            if (wrapper.length === 0) {
                console.error(`Wrapper not found: ${wrapperSelector}`);
                return otherMaterials;
            }

            wrapper.find('.itemsTable tbody tr').each(function() {
                var factorCode = $(this).find('.factorCodeInput').val();
                var quantity = parseFloat($(this).find('.quantity input').val()) || 0;
                console.log(`Row data - Factor Code: ${factorCode}, Main Quantity: ${quantity}`);

                if (factorCode && window.factorCodeItemsCache && window.factorCodeItemsCache[factorCode]) {
                    console.log(`Processing items for factor code: ${factorCode}`);
                    window.factorCodeItemsCache[factorCode].forEach(item => {
                        var totalQuantity = (item.quantity || 0) * quantity;
                        if (totalQuantity > 0) {
                            var existingMaterial = otherMaterials.find(m => m.part_number === item.part_number);
                            if (existingMaterial) {
                                existingMaterial.quantity += totalQuantity;
                            } else {
                                otherMaterials.push({
                                    part_number: item.part_number,
                                    description: item.description,
                                    quantity: totalQuantity,
                                    cost: item.cost || 0
                                });
                            }
                        }
                    });
                }
            });

            console.log('Finished processing rows. Other materials:', otherMaterials);
            return otherMaterials;
        }

        function saveProject(projectData) {
            return new Promise((resolve, reject) => {
                const csrfToken = getCsrfToken();
                if (!csrfToken) {
                    console.error('CSRF token is missing');
                    reject(new Error('CSRF token is missing'));
                    return;
                }

                const data = {
                    project_name: projectData.project_name,
                    project_address: projectData.project_address,
                    project_state: projectData.project_state,
                    project_city: projectData.project_city,
                    project_zip: projectData.project_zip
                };

                console.log('Sending project data:', data);

                $.ajax({
                    url: '/save-project',
                    method: 'POST',
                    data: JSON.stringify(data),
                    contentType: 'application/json',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    success: function(response) {
                        console.log('Save project response:', response);
                        if (response.success) {
                            console.log('Project saved successfully');
                            resolve();
                        } else {
                            console.error('Error saving project:', response.error);
                            reject(new Error(response.error));
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Error saving project:', textStatus, errorThrown);
                        console.error('Response:', jqXHR.responseText);
                        reject(new Error(`Error saving project: ${textStatus}`));
                    }
                });
            });
        }


        function clearCustomerFields() {
            $('#customerName').val('');
            $('#customerAddress').val('');
            $('#customerState').val('');
            $('#customerCity').val('');
            $('#customerZip').val('f');
        }

        function loadSavedBidItems() {
            return new Promise((resolve, reject) => {
                const bidIdElement = document.getElementById('bidId');
                if (!bidIdElement) {
                    console.error('Bid ID element not found');
                    resolve();
                    return;
                }
                const bidId = bidIdElement.value;
                if (!bidId) {
                    console.error('No bid ID found');
                    resolve();
                    return;
                }
                if (bidDataCache) {
                    console.log('Using cached bid data');
                    processBidData(bidDataCache);
                    updateBudgetTotals();
                    resolve();
                    return;
                }
                fetch(`/get-bid-items/${bidId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(bidData => {
                        console.log('Fetched bid data:', bidData);
                        bidDataCache = bidData;
                        processBidData(bidData);
                        updateBudgetTotals();

                        // Load architect and engineer names
                        if (bidData.heading_info) {
                            $('#architectName').val(bidData.heading_info.architect_name || '');
                            $('#engineerName').val(bidData.heading_info.engineer_name || '');
                            $('#pointOfContact').val(bidData.heading_info.point_of_contact || '');
                        }

                        // Reinitialize autocomplete after loading bid items
                        reinitializeAutocomplete();

                        // Enable drag-and-drop for all tables
                        enableDragAndDrop('#drainsWrapper .itemsTable');
                        enableDragAndDrop('#irrigationWrapper .itemsTable');
                        enableDragAndDrop('#landscapeWrapper .itemsTable');
                        enableDragAndDrop('#maintenanceWrapper .itemsTable');
                        enableDragAndDrop('#subcontractorWrapper .itemsTable');

                        resolve();
                    })
                    .catch(error => {
                        console.error('Error loading saved bid items:', error);
                        alert('Error loading saved bid items. Please try again.');
                        reject(error);
                    });
            });
        }
            
        // Add a new function to initialize existing rows
        function initializeExistingRows() {
            $('.itemsTable tbody tr').each(function() {
                initializeRow($(this));
            });
        }

        // Update the reinitializeAutocomplete function
        function reinitializeAutocomplete() {
            $('.partNumInput').each(function() {
                attachAutocompleteToPartNumber($(this));
            });
            $('.descriptionInput').each(function() {
                attachAutocompleteToDescription($(this));
            });
            $('.factorCodeInput').each(function() {
                attachFactorAutocomplete($(this));
            });
        }


        function processBidData(bidData) {
            if (bidData.heading_info) {
                updateHeadingInfo(bidData.heading_info);
            }

            if (bidData.labor_rates) {
                updateLaborRates(bidData.labor_rates);
            } else {
                console.warn('Labor rates not found in bid data');
                loadDefaultLaborRates();
            }

            if (bidData.items) {
                const categories = ['drains', 'irrigation', 'landscape', 'maintenance', 'subcontractor'];
                const uniqueFactorCodes = new Set();

                categories.forEach(category => {
                    if (Array.isArray(bidData.items[category])) {
                        bidData.items[category].forEach(item => {
                            if (item.factor_code) {
                                uniqueFactorCodes.add(item.factor_code);
                            }
                        });
                    }
                });

                const factorCodePromises = Array.from(uniqueFactorCodes).map(fetchFactorCodeItems);

                Promise.all(factorCodePromises)
                    .then(() => {
                        return Promise.all(categories.map(category => {
                            if (Array.isArray(bidData.items[category])) {
                                return loadCategoryItemsBatch(category, bidData.items[category]);
                            }
                            return Promise.resolve();
                        }));
                    })
                    .then(() => {
                        updateBudgetTotals();
                        reinitializeAutocomplete();
                    })
                    .catch(error => {
                        console.error('Error loading category items:', error);
                    });
            }
        }

        function fetchFactorCodeItems(factorCode) {
            if (factorCodeCache.has(factorCode)) {
                return Promise.resolve(factorCodeCache.get(factorCode));
            }

            return fetch(`/get-factor-code-items/${factorCode}`)
                .then(response => response.json())
                .then(data => {
                    factorCodeCache.set(factorCode, data);
                    if (!window.factorCodeItemsCache) {
                        window.factorCodeItemsCache = {};
                    }
                    window.factorCodeItemsCache[factorCode] = data.items || [];
                    return data;
                });
        }

        function loadCategoryItemsBatch(category, items) {
            const wrapperId = `${category}Wrapper`;
            const tableBody = $(`#${wrapperId} .itemsTable tbody`);
            tableBody.empty();
            const isSubcontractor = category === 'subcontractor';

            items.forEach((item, index) => {
                const newRow = $(`
                    <tr>
                        <td class="lineNumber">${index + 1}</td>
                        <td class="partNumber"><input type='text' class='partNumInput' value='${item.part_number || ''}' autocomplete='off'></td>
                        <td><input type='text' class='descriptionInput' value='${decodeURIComponent(item.description || '')}' autocomplete='off'></td>
                        ${!isSubcontractor ? `<td><input type="text" class="factorCodeInput" value='${item.factor_code || ''}' autocomplete="off"></td>` : ''}
                        <td class="quantity"><input type='text' class='quantity' value='${item.quantity || ''}' oninput='updateLineAndTotalCosts(this)'></td>
                        <td><input type='text' class='costInput' value='${item.cost !== undefined ? item.cost.toFixed(2) : ''}' oninput='updateLineAndTotalCosts(this)'></td>
                        ${!isSubcontractor ? `
                            <td><input type='text' class='laborHoursInput' value='${item.labor_hours !== undefined ? item.labor_hours.toFixed(4) : '0.00'}' oninput='updateLineAndTotalCosts(this)'></td>
                            <td class="otherMaterials">$${(item.other_materials_cost || 0).toFixed(2)}</td>
                            <td class="tax">$${(item.tax || 0).toFixed(2)}</td>
                        ` : ''}
                        <td class="action"><button class='removeBtn'>Remove</button></td>
                    </tr>
                `);

                newRow.data('additionalDescription', decodeURIComponent(item.additional_description || ''));
                
                const lineExtCost = calculateLineExtCost(item.factor_code, item.quantity);
                newRow.data('lineExtCost', lineExtCost);

                tableBody.append(newRow);
                attachAutocompleteToPartNumber(newRow.find('.partNumInput'));
                attachAutocompleteToDescription(newRow.find('.descriptionInput'));
                attachFactorAutocomplete(newRow.find('.factorCodeInput'));
                initializeRow(newRow);
            });

            const wrapper = $(`#${wrapperId}`);
            updateLineNumbers(wrapper);
            showOtherMaterials(category, false);
            attachEventHandlers(wrapper);

            $(`#additionalDescription-${wrapperId}`).val(decodeURIComponent(items[0]?.additional_description || ''));

            wrapper.find('.itemsTable tbody tr').each(function() {
                updateLineAndTotalCosts($(this).find('.quantity input')[0]);
            });
        }

        function updateHeadingInfo(headingInfo) {
            $('#bidDate').val(headingInfo.bid_date || '');
            $('#projectName').val(headingInfo.project_name || '');
            $('#projectAddress').val(headingInfo.project_address || '');
            $('#projectState').val(headingInfo.project_state || '');
            $('#projectCity').val(headingInfo.project_city || '');
            $('#projectZip').val(headingInfo.project_zip || '');

            loadCustomerData(headingInfo.customer_name);
            loadProjectData(headingInfo.project_name);
        }

        function loadCustomerData(customerName) {
            if (customerCache.has(customerName)) {
                fillCustomerDetails(customerCache.get(customerName));
                return;
            }

            fetch(`/search-customers?query=${encodeURIComponent(customerName)}`)
                .then(response => response.json())
                .then(customers => {
                    if (customers.length > 0) {
                        const customerData = customers[0];
                        customerCache.set(customerName, customerData);
                        fillCustomerDetails(customerData);
                    }
                })
                .catch(error => console.error('Error fetching customer data:', error));
        }

        function loadProjectData(projectName) {
            if (projectCache.has(projectName)) {
                fillProjectDetails(projectCache.get(projectName));
                return;
            }

            fetch(`/search-projects?query=${encodeURIComponent(projectName)}`)
                .then(response => response.json())
                .then(projects => {
                    if (projects.length > 0) {
                        const projectData = projects[0];
                        projectCache.set(projectName, projectData);
                        fillProjectDetails(projectData);
                    }
                })
                .catch(error => console.error('Error fetching project data:', error));
        }

        function fillCustomerDetails(customerData) {
            $('#customerName').val(customerData.customer_name || '');
            $('#customerAddress').val(customerData.customer_address || '');
            $('#customerState').val(customerData.customer_state || '');
            $('#customerCity').val(customerData.customer_city || '');
            $('#customerZip').val(customerData.customer_zip || '');
        }

        function fillProjectDetails(projectData) {
            $('#projectName').val(projectData.project_name || '');
            $('#projectAddress').val(projectData.project_address || '');
            $('#projectState').val(projectData.project_state || '');
            $('#projectCity').val(projectData.project_city || '');
            $('#projectZip').val(projectData.project_zip || '');
        }

        function updateLaborRates(laborRates) {
            const setLaborRate = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value !== null ? value : element.value;
                } else {
                    console.warn(`Element not found: ${id}`);
                }
            };

            setLaborRate('laborRateDrains', laborRates.drains_labor_rate);
            setLaborRate('laborRateIrrigation', laborRates.irrigation_labor_rate);
            setLaborRate('laborRateLandscape', laborRates.landscape_labor_rate);
            setLaborRate('laborRateMaintenance', laborRates.maintenance_labor_rate);
            setLaborRate('localSalesTax', laborRates.local_sales_tax);
        }
        
        let laborHoursUpdateQueue = [];

        async function generateCombinedReport(category) {
            const { jsPDF } = window.jspdf;
            let combinedDoc = new jsPDF();
            
            // Generate main bid report
            await generateReport(category, combinedDoc, `${category} - Main Bid`);
            
            // Fetch all sub-bids for the category
            const subBids = await fetchAllSubBids(category);
            
            // Generate reports for each sub-bid
            for (const subBid of subBids) {
                // Add a page break between bids
                combinedDoc.addPage();
                
                // Generate sub-bid report
                await generateReport(category, combinedDoc, `${category} - Sub-Bid: ${subBid.name}`, subBid.id);
            }
            
            const totalPages = combinedDoc.getNumberOfPages();
            
            // Add page numbers to all pages
            for (let i = 1; i <= totalPages; i++) {
                combinedDoc.setPage(i);
                combinedDoc.setFont("helvetica", "normal");
                combinedDoc.setFontSize(10);
                combinedDoc.text(`Page ${i} of ${totalPages}`, 105, 287, { align: 'center' });
            }
            
            combinedDoc.save(`${category}_combined_bid_report.pdf`);
        }

        // New function to fetch all sub-bids for a category
        async function fetchAllSubBids(category) {
            try {
                const bidId = document.getElementById('bidId').value;
                const response = await fetch(`/api/subbids/${bidId}?category=${category}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching sub-bids:', error);
                return [];
            }
        }


        async function generateReport(category, doc, title, subBidId = null) {
            const bidId = $('#bidId').val();
            const bidDate = $('#bidDate').val();
            
            let pageNumber = 1;
            let totalPages = 1;


            function formatNumber(number, decimalPlaces = 0) {
                return Number(number).toLocaleString('en-US', {
                    minimumFractionDigits: decimalPlaces,
                    maximumFractionDigits: decimalPlaces
                });
            }

            
            function formatDate(dateString) {
                const date = new Date(dateString);
                const utcDate = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
                return `${utcDate.getUTCMonth() + 1}/${utcDate.getUTCDate()}/${utcDate.getUTCFullYear()}`;
            }

            const formattedBidDate = formatDate(bidDate);
            const formattedPrintDate = formatDate(new Date().toISOString());
            
            const customerName = $('#customerName').val();
            const customerAddress = $('#customerAddress').val();
            const customerCity = $('#customerCity').val();
            const customerState = $('#customerState').val();
            const customerZip = $('#customerZip').val();
            const projectName = $('#projectName').val();
            const projectAddress = $('#projectAddress').val();
            const projectCity = $('#projectCity').val();
            const projectState = $('#projectState').val();
            const projectZip = $('#projectZip').val();
            const taxRate = parseFloat($('#localSalesTax').val()) / 100;
            const laborRate = category !== 'subcontractor' ? parseFloat($(`#laborRate${category.charAt(0).toUpperCase() + category.slice(1)}`).val()) : 0;

            function addPageNumber() {
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(`Page ${pageNumber} of ${totalPages}`, 105, 287, { align: 'center' });
            }

            function addFullHeader() {
                doc.setFont("helvetica", "bold");
                doc.setFontSize(18);
                doc.text(title, 105, 20, { align: 'center' });

                doc.setFontSize(12);
                doc.setFont("helvetica", "normal");
                doc.text(`BID #: ${bidId}`, 20, 30);
                doc.text(category.toUpperCase(), 105, 30, { align: 'center' });
                doc.text(`Bid Created: ${formattedBidDate}`, 190, 30, { align: 'right' });

                doc.setFontSize(10);
                doc.text(`Date Printed: ${formattedPrintDate}`, 190, 37, { align: 'right' });

                doc.setFontSize(11);
                doc.setFont("helvetica", "bold");
                doc.text("CUSTOMER", 20, 52);
                doc.text("PROJECT", 115, 52);

                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.text(customerName, 20, 59);
                doc.text(customerAddress, 20, 65);
                doc.text(`${customerCity}, ${customerState} ${customerZip}`, 20, 71);

                doc.text(projectName, 115, 59);
                doc.text(projectAddress, 115, 65);
                doc.text(`${projectCity}, ${projectState} ${projectZip}`, 115, 71);

                doc.setLineWidth(0.5);
                doc.line(20, 75, 190, 75);

                doc.setFont("helvetica", "bold");
                doc.text("RATES", 20, 82);
                doc.setFont("helvetica", "normal");
                if (category !== 'subcontractor') {
                    doc.text(`Tax Rate: ${(taxRate * 100).toFixed(2)}%`, 20, 89);
                    doc.text(`Labor Rate: $${laborRate.toFixed(2)}/hr`, 80, 89);
                } else {
                    doc.text("N/A for Subcontractor", 20, 89);
                }

                doc.line(20, 93, 190, 93);

                return 99;
            }

            function addTableHeader(startY) {
                let headers, colWidths;
                if (category === 'subcontractor') {
                    headers = ["ITEM / DESC", "QTY", "COST", "TOTAL"];
                    colWidths = [100, 30, 30, 40];
                } else {
                    headers = ["ITEM / DESC", "FACTOR", "QTY", "COST", "X-COST", "OT MATL", "TAX", "LABHRS", "LABOR $", "TOTAL"];
                    colWidths = [50, 15, 15, 15, 20, 20, 15, 15, 15, 20];
                }

                const tableWidth = colWidths.reduce((sum, width) => sum + width, 0);
                const startX = (210 - tableWidth) / 2;
                let x = startX;

                doc.setFillColor(240, 240, 240);
                doc.rect(startX, startY, tableWidth, 7, 'F');
                doc.setFontSize(8);
                doc.setFont("helvetica", "bold");
                headers.forEach((header, i) => {
                    doc.text(header, x + (colWidths[i] / 2), startY + 5, { align: 'center', maxWidth: colWidths[i] });
                    x += colWidths[i];
                });

                return { startX, colWidths, tableWidth, headers };
            }

            let startY = addFullHeader();
            let { startX, colWidths, tableWidth, headers } = addTableHeader(startY);
            startY += 10;

            let totalMaterialCost = 0;
            let totalLaborCost = 0;
            let totalOtherMaterialsCost = 0;
            let totalTax = 0;
            let grandTotal = 0;
            let totalLaborHours = 0;

            doc.setFont("helvetica", "normal");

            // Fetch items based on whether it's a main bid or sub-bid
            let items;
            if (subBidId) {
                items = await fetchSubBidItems(subBidId);
            } else {
                const wrapper = $(`#${category}Wrapper`);
                items = wrapper.find(".itemsTable tbody tr").map(function() {
                    return {
                        part_number: $(this).find('.partNumInput').val(),
                        description: $(this).find('.descriptionInput').val(),
                        additional_description: $(this).data('additionalDescription') || '',
                        quantity: parseFloat($(this).find('.quantity input').val()) || 0,
                        cost: parseFloat($(this).find('.costInput').val()) || 0,
                        factor_code: $(this).find('.factorCodeInput').val(),
                        other_materials: parseFloat($(this).find('.otherMaterials').text().replace('$', '')) || 0,
                        tax: parseFloat($(this).find('.tax').text().replace('$', '')) || 0,
                        labor_hours: parseFloat($(this).find('.laborHoursInput').val()) || 0
                    };
                }).get();
            }

            items.forEach(function(item) {
                if (startY > 270) {
                    doc.addPage();
                    pageNumber++;
                    startY = 20;
                    let headerInfo = addTableHeader(startY);
                    startX = headerInfo.startX;
                    colWidths = headerInfo.colWidths;
                    tableWidth = headerInfo.tableWidth;
                    headers = headerInfo.headers;
                    startY += 10;
                }

                const xCost = (item.quantity || 0) * (item.cost || 0);
                let rowData;
                    if (category === 'subcontractor') {
                        rowData = [
                            `${item.part_number}\n${item.description}${item.additional_description ? '\n* ' + item.additional_description : ''}`,
                            formatNumber(item.quantity || 0, 0),
                            formatNumber(item.cost || 0),
                            formatNumber(xCost)
                        ];
                        totalMaterialCost += xCost;
                        grandTotal += xCost;
                    } else {
                        const labor = (item.labor_hours || 0) * (item.quantity || 0) * laborRate;
                        const total = xCost + (item.other_materials || 0) + (item.tax || 0) + labor;

                        rowData = [
                            `${item.part_number}\n${item.description}${item.additional_description ? '\n* ' + item.additional_description : ''}`,
                            item.factor_code || '',
                            formatNumber(item.quantity || 0, 0),
                            formatNumber(item.cost || 0),
                            formatNumber(xCost),
                            formatNumber(item.other_materials || 0),
                            formatNumber(item.tax || 0),
                            formatNumber((item.labor_hours || 0) * (item.quantity || 0)),
                            formatNumber(labor),
                            formatNumber(total)
                        ];

                    totalMaterialCost += xCost;
                    totalLaborCost += labor;
                    totalOtherMaterialsCost += (item.other_materials || 0);
                    totalTax += (item.tax || 0);
                    grandTotal += total;
                    totalLaborHours += (item.labor_hours || 0) * (item.quantity || 0);
                }

                let x = startX;
                doc.setFontSize(8);
                rowData.forEach((cell, i) => {
                    if (i === 0) {
                        doc.text(cell, x + 1, startY + 3, { maxWidth: colWidths[i] - 2 });
                        const textHeight = doc.getTextDimensions(cell, { maxWidth: colWidths[i] - 2 }).h;
                        startY += textHeight;
                    } else {
                        doc.text(cell, x + colWidths[i], startY + 3, { align: 'right', maxWidth: colWidths[i] - 2 });
                    }
                    x += colWidths[i];
                });
                startY += 7;
            });

            // Totals
            startY += 10;
            if (startY > 270) {
                doc.addPage();
                pageNumber++;
                startY = 20;
            }
            doc.setFontSize(8);
            doc.setFont("helvetica", "bold");
            doc.text("REPORT TOTALS:", startX, startY);

            if (category === 'subcontractor') {
                doc.text(formatNumber(grandTotal), startX + tableWidth, startY, { align: 'right' });
            } else {
                const colXOffsets = [
                    startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4],
                    startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5],
                    startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + colWidths[6],
                    startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + colWidths[6] + colWidths[7],
                    startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + colWidths[6] + colWidths[7] + colWidths[8],
                    startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + colWidths[6] + colWidths[7] + colWidths[8] + colWidths[9]
                ];

                const totalRowY = startY;
                doc.setFont("helvetica", "normal");
                const materialTotal = totalMaterialCost + totalOtherMaterialsCost + totalTax;

                function drawSlightlyAdjustedBox(startX, endX, y, height) {
                    const boxWidth = endX - startX;
                    const boxY = y - 5;
                    const shiftAmount = 2.5;
                    doc.setLineWidth(0.1);
                    doc.rect(startX + shiftAmount, boxY, boxWidth, height);
                }

                doc.text(formatNumber(totalMaterialCost), colXOffsets[0], totalRowY, { align: 'right' });
                doc.text(formatNumber(totalOtherMaterialsCost), colXOffsets[1], totalRowY, { align: 'right' });
                doc.text(formatNumber(totalTax), colXOffsets[2], totalRowY, { align: 'right' });
                drawSlightlyAdjustedBox(colXOffsets[0] - colWidths[4], colXOffsets[2], totalRowY, 7);
                doc.text(formatNumber(totalLaborHours), colXOffsets[3], totalRowY, { align: 'right' });
                doc.text(formatNumber(totalLaborCost), colXOffsets[4], totalRowY, { align: 'right' });
                doc.setFont("helvetica", "bold");
                doc.text(formatNumber(grandTotal), colXOffsets[5], totalRowY, { align: 'right' });

                startY += 10;
                doc.setFont("helvetica", "bold");
                doc.text("Material Total", startX, startY);
                doc.setFont("helvetica", "normal");
                doc.text(formatNumber(materialTotal), colXOffsets[0], startY, { align: 'right' });
                drawSlightlyAdjustedBox(colXOffsets[0] - colWidths[4], colXOffsets[0], startY, 7);
            }


            // Other Materials Section
            if (category !== 'subcontractor') {
                doc.addPage();
                pageNumber++;
                startY = 20;

                doc.setFont("helvetica", "bold");
                doc.setFontSize(14);
                doc.text("Other Materials", 105, startY, { align: 'center' });

                doc.setFontSize(12);
                doc.text(category.toUpperCase(), 105, startY + 10, { align: 'center' });

                doc.setFontSize(10);
                doc.text(`BID #: ${bidId}`, 20, startY + 10);
                doc.text(`PROJECT NAME:`, 190, startY + 10, { align: 'right' });
                doc.text(`${projectName}`, 190, startY + 15, { align: 'right' });

                startY += 25;
                const otherMaterialsHeaders = ["PART NUMBER", "DESCRIPTION", "QUANTITY", "UNIT COST", "TOTAL COST"];
                const otherMaterialsColWidths = [30, 70, 30, 30, 30];

                function drawOtherMaterialsHeader() {
                    let x = startX;
                    doc.setFillColor(240, 240, 240);
                    doc.rect(startX, startY, tableWidth, 7, 'F');
                    doc.setFontSize(8);
                    doc.setFont("helvetica", "bold");
                    otherMaterialsHeaders.forEach((header, i) => {
                        doc.text(header, x + (otherMaterialsColWidths[i] / 2), startY + 5, { align: 'center', maxWidth: otherMaterialsColWidths[i] });
                        x += otherMaterialsColWidths[i];
                    });
                    startY += 10;
                    doc.setFont("helvetica", "normal");
                }

                drawOtherMaterialsHeader();

                const otherMaterials = subBidId ? await fetchSubBidOtherMaterials(subBidId) : calculateOtherMaterials(category);
                let otherMaterialsTotalCost = 0;

                otherMaterials.forEach((item) => {
                    if (startY > 270) {
                        doc.addPage();
                        pageNumber++;
                        startY = 20;
                        drawOtherMaterialsHeader();
                    }

                    const itemTotalCost = item.quantity * item.cost;
                    otherMaterialsTotalCost += itemTotalCost;

                    const rowData = [
                        item.part_number,
                        item.description,
                        formatNumber(item.quantity, 2),
                        formatNumber(item.cost, 2),
                        formatNumber(itemTotalCost, 2)
                    ];

                    let x = startX;
                    doc.setFontSize(8);
                    rowData.forEach((cell, i) => {
                        if (i === 1) { // Description column
                            doc.text(cell, x + 1, startY + 3, { maxWidth: otherMaterialsColWidths[i] - 2 });
                            const textHeight = doc.getTextDimensions(cell, { maxWidth: otherMaterialsColWidths[i] - 2 }).h;
                            startY += textHeight > 7 ? textHeight : 7;
                        } else {
                            doc.text(cell, x + otherMaterialsColWidths[i], startY + 3, { align: 'right', maxWidth: otherMaterialsColWidths[i] - 2 });
                        }
                        x += otherMaterialsColWidths[i];
                    });
                    startY += 7;
                });

                startY += 5;
                if (startY > 270) {
                    doc.addPage();
                    pageNumber++;
                    startY = 20;
                }
                doc.setFontSize(9);
                doc.setFont("helvetica", "bold");
                doc.text("OTHER MATERIALS TOTAL:", startX, startY + 5);
                doc.text(formatNumber(otherMaterialsTotalCost), startX + tableWidth, startY + 5, { align: 'right' });
            }

            return doc;
        }



        async function fetchSubBidItems(subBidId) {
            const response = await fetch(`/api/subbids/${subBidId}/items`);
            if (!response.ok) {
                throw new Error('Failed to fetch sub-bid items');
            }
            return await response.json();
        }

        async function fetchSubBidOtherMaterials(subBidId) {
            const response = await fetch(`/api/subbids/${subBidId}/other-materials`);
            if (!response.ok) {
                throw new Error('Failed to fetch sub-bid other materials');
            }
            return await response.json();
        }

        function queueLaborHoursUpdate(partNumber, quantity, rowElement) {
            laborHoursUpdateQueue.push({ partNumber, quantity, rowElement });
        }

        function processlaborHoursQueue() {
            console.log("Processing labor hours queue");
            laborHoursUpdateQueue.forEach(item => {
                updateLaborHours(item.partNumber, item.quantity, item.rowElement);
            });
            laborHoursUpdateQueue = []; // Clear the queue after processing
        }

        function updateLaborHours(partNumber, quantity, rowElement) {
            if (factors.length === 0) {
                console.log("Factors not loaded yet, queuing update");
                queueLaborHoursUpdate(partNumber, quantity, rowElement);
                return;
            }
            
            const inventoryItem = inventory.find(item => item.part_number === partNumber);
            if (inventoryItem && inventoryItem.factor_code) {
                const factor = factors.find(f => f.factor_code === inventoryItem.factor_code);
                if (factor) {
                    const laborHours = factor.labor_hours * quantity;
                    $(rowElement).find('.laborHours').text(laborHours.toFixed(2));
                    updateTotalCost($(rowElement).closest('.content-wrapper'));
                }
            }
        }

        // Update the calculateSubBidOtherMaterials function
        function calculateSubBidOtherMaterials(subBidId) {
            var otherMaterials = [];
            var subBidWrapper = $(`#subBid_${subBidId}`);

            if (subBidWrapper.length === 0) {
                console.error(`Sub-bid wrapper not found for ID: ${subBidId}`);
                return otherMaterials;
            }

            subBidWrapper.find('.itemsTable tbody tr').each(function() {
                var factorCode = $(this).find('.factorCodeInput').val();
                var quantity = parseFloat($(this).find('.quantity input').val()) || 0;

                if (factorCode && window.factorCodeItemsCache && window.factorCodeItemsCache[factorCode]) {
                    window.factorCodeItemsCache[factorCode].forEach(item => {
                        var totalQuantity = (item.quantity || 0) * quantity;
                        if (totalQuantity > 0) {
                            var existingMaterial = otherMaterials.find(m => m.part_number === item.part_number);
                            if (existingMaterial) {
                                existingMaterial.quantity += totalQuantity;
                            } else {
                                otherMaterials.push({
                                    part_number: item.part_number,
                                    description: item.description,
                                    quantity: totalQuantity,
                                    cost: item.cost || 0
                                });
                            }
                        }
                    });
                }
            });

            return otherMaterials;
        }



        function updateLineNumbers(contentWrapper) {
            contentWrapper.find(".itemsTable tbody tr").each(function(index) {
                $(this).find('.lineNumber').text(index + 1);
            });
        }
    

        function showOtherMaterials(category, shouldDisplay = true) {
            console.log(`Showing other materials for category: ${category}`);
            var otherMaterials = calculateOtherMaterials(category);
            var isSubBid = category.startsWith('subbid-');
            var subBidId = isSubBid ? category.replace('subbid-', '') : null;
            var title = isSubBid ? getSubBidName(subBidId) : category.charAt(0).toUpperCase() + category.slice(1);
            var wrapperSelector = isSubBid ? `#subBid_${subBidId}` : `#${category.toLowerCase()}Wrapper`;
            var wrapper = $(wrapperSelector);

            if (wrapper.length === 0) {
                console.error(`Wrapper not found: ${wrapperSelector}`);
                return;
            }

            var totalCost = 0;

            var popoutHTML = `
                <div id="otherMaterialsPopout" class="popout">
                    <h3>Sub Bid Other Materials</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Part Number</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Cost</th>
                                <th>Total Cost</th>
                            </tr>
                        </thead>
                        <tbody id="otherMaterialsBody">
            `;

            otherMaterials.forEach(function(item) {
                var itemTotalCost = item.quantity * item.cost;
                totalCost += itemTotalCost;
                popoutHTML += `
                    <tr>
                        <td>${item.part_number}</td>
                        <td>${item.description}</td>
                        <td>${item.quantity.toFixed(2)}</td>
                        <td>$${item.cost.toFixed(2)}</td>
                        <td>$${itemTotalCost.toFixed(2)}</td>
                    </tr>
                `;
            });

            popoutHTML += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4">Total Other Material Cost:</td>
                                <td>$${totalCost.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                    <button onclick="closeOtherMaterials()">Close</button>
                </div>`;

            $('#otherMaterialsPopout').remove();
            $('body').append(popoutHTML);

            if (shouldDisplay) {
                $('#otherMaterialsPopout').show();
            } else {
                $('#otherMaterialsPopout').hide();
            }

            // Update the Other Materials cost for each row
            wrapper.find('.itemsTable tbody tr').each(function() {
                var tr = $(this);
                var factorCode = tr.find('.factorCodeInput').val();
                var quantity = parseFloat(tr.find('.quantity input').val()) || 0;
                var otherMaterialsCost = calculateOtherMaterialsCost(factorCode, quantity);
                tr.find('.otherMaterials').text(`$${otherMaterialsCost.toFixed(2)}`);
            });

            // Update the total Other Materials cost
            wrapper.find('.totalOtherMaterialsCost').text(`$${totalCost.toFixed(2)}`);

            updateTotalLineExtCost(wrapper);
            updateTotalCost(wrapper);

            console.log(`Finished showing other materials for ${category}. Total cost: $${totalCost.toFixed(2)}`);
        }

        // Function to calculate other materials cost for a specific row in a sub-bid
        function calculateSubBidRowOtherMaterialsCost(tr, otherMaterials) {
            var partNumber = tr.find('.partNumInput').val();
            var quantity = parseFloat(tr.find('.quantity input').val()) || 0;
            var matchingMaterial = otherMaterials.find(m => m.part_number === partNumber);
            return matchingMaterial ? matchingMaterial.quantity * matchingMaterial.cost : 0;
        }

        function getSubBidName(subBidId) {
            var subBidElement = document.getElementById(subBidId);
            if (subBidElement) {
                var nameElement = subBidElement.querySelector('h3');
                if (nameElement) {
                    return nameElement.textContent;
                }
            }
            return 'Unknown Sub Bid';
        }

        function closeOtherMaterials() {
            $('#otherMaterialsPopout').remove();
        }

        function initializeTable(wrapperId) {
            var contentWrapper = $('#' + wrapperId);
            var isSubcontractor = wrapperId === 'subcontractorWrapper';
            var tableHTML = `
                <div class="action-buttons">
                    <button onclick="addBlankLineItem('${wrapperId}')" class="addBtn">Add Line Item</button>
                    <button onclick="insertBlankLineItem('${wrapperId}')" class="insertBtn">Insert Line Item</button>
                    ${!isSubcontractor ? `
                        <button onclick="showOtherMaterials('${wrapperId.replace('Wrapper', '')}')" class="otherMaterialsBtn">Other Materials</button>
                        <button onclick="openSubBidModal('${wrapperId.replace('Wrapper', '')}')" class="subBidBtn">Sub Bid</button>
                    ` : ''}
                    <button onclick="generateCombinedReport('${wrapperId.replace('Wrapper', '')}')" class="generateReportBtn">Generate Report</button>
                </div>
                <div class="table-container">
                    <table class="itemsTable">
                        <thead>
                            <tr>
                                <th class="lineNumber">Line Number</th>
                                <th class="partNumber">Part Number</th>
                                <th class="description">Description</th>
                                ${!isSubcontractor ? `<th class="factorCode">Factor Code</th>` : ''}
                                <th class="quantity">Quantity</th>
                                <th class="cost">Bid Price</th>
                                ${!isSubcontractor ? `
                                    <th class="laborHours">Labor Hours</th>
                                    <th class="otherMaterials">Other Materials</th>
                                    <th class="tax">Tax</th>
                                ` : ''}
                                <th class="action">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dynamic content will be appended here -->
                        </tbody>
                    </table>
                </div>
                <div class="total-cost">
                    <h2>Material Cost: <span class="totalMaterialCost">$0.00</span></h2>
                    ${!isSubcontractor ? `
                        <h2>Labor Cost: <span class="totalLaborCost">$0.00</span></h2>
                        <h2>Other Materials Cost: <span class="totalOtherMaterialsCost">$0.00</span></h2>
                        <h2>Tax: <span class="totalTax">$0.00</span></h2>
                    ` : ''}
                    <h2>Total Cost: <span class="totalCost">$0.00</span></h2>
                </div>`;
            contentWrapper.html(tableHTML);
            attachEventHandlers(contentWrapper);

            // Attach autocomplete to part number inputs after adding them to the DOM
            contentWrapper.find('.partNumInput').each(function() {
                attachAutocompleteToPartNumber($(this));
            });
        }

    function updateLaborHoursFromFactorCode(tr, factorCode, quantity) {
        if (!factorCode) {
            tr.find('.laborHoursInput').val('0.00');
            updateLineAndTotalCosts(tr.find('.laborHoursInput')[0]);
            return;
        }

        $.ajax({
            url: `/get-factor-code-labor-hours/${factorCode}`,
            method: 'GET',
            success: function(data) {
                if (data && typeof data.labor_hours !== 'undefined') {
                    var laborHours = data.labor_hours;
                    tr.find('.laborHoursInput').val(laborHours.toFixed(4));
                    updateLineAndTotalCosts(tr.find('.laborHoursInput')[0]);
                } else {
                    console.warn(`No valid labor hours data received for factor code ${factorCode}`);
                    tr.find('.laborHoursInput').val('0.00');
                    updateLineAndTotalCosts(tr.find('.laborHoursInput')[0]);
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error(`Error fetching labor hours for factor code ${factorCode}:`, textStatus, errorThrown);
                tr.find('.laborHoursInput').val('0.00');
                updateLineAndTotalCosts(tr.find('.laborHoursInput')[0]);
            }
        });
    }

    function attachEventHandlers(contentWrapper) {
        var wrapperId = contentWrapper.attr('id');

        contentWrapper.on('mousedown', '.itemsTable tbody tr:not(.additional-description-row)', function(e) {
            var $this = $(this);
            var startX = e.pageX;
            var startY = e.pageY;
            var isDragging = false;

            $(document).on('mousemove.rowSelect', function(e) {
                if (Math.abs(e.pageX - startX) > 5 || Math.abs(e.pageY - startY) > 5) {
                    isDragging = true;
                    $(document).off('mousemove.rowSelect');
                }
            });

            $(document).on('mouseup.rowSelect', function(e) {
                $(document).off('mousemove.rowSelect mouseup.rowSelect');
                if (!isDragging) {
                    var $additionalDescRow = $this.next('.additional-description-row');
                    var wasSelected = $this.hasClass('active-dropdown');

                    // Remove selection from all other rows
                    contentWrapper.find('.itemsTable tbody tr').not($this).removeClass('selected active-dropdown');
                    contentWrapper.find('.additional-description-row').not($additionalDescRow).remove();

                    // Toggle selection for the clicked row
                    $this.toggleClass('active-dropdown');

                    if (wasSelected) {
                        // If it was selected, remove the additional description row
                        $additionalDescRow.remove();
                    } else {
                        // If it wasn't selected, add or show the additional description row
                        if ($additionalDescRow.length) {
                            $additionalDescRow.show();
                        } else {
                            var additionalDescription = $this.data('additionalDescription') || '';
                            var lineExtCost = $this.data('lineExtCost') || 0;
                            var newRow = $(`
                                <tr class="additional-description-row">
                                    <td colspan="5">
                                        <input type="text" class="additionalDescriptionInput" value="${additionalDescription}" placeholder="Enter additional description">
                                    </td>
                                    <td colspan="5">
                                        <div class="line-ext-cost">Line Ext Cost: <span>$${lineExtCost.toFixed(2)}</span></div>
                                    </td>
                                </tr>
                            `);
                            $this.after(newRow);

                            newRow.find('.additionalDescriptionInput').on('input', function() {
                                var updatedDescription = $(this).val();
                                $this.data('additionalDescription', updatedDescription);
                            });
                        }
                    }
                }
            });
        });


        // Add a click event listener to the document to close dropdowns when clicking outside
        $(document).on('click', function(event) {
            if (!$(event.target).closest('.itemsTable').length) {
                contentWrapper.find('.itemsTable tbody tr').removeClass('active-dropdown');
                contentWrapper.find('.additional-description-row').remove();
            }
        });

        contentWrapper.on('change', '.factorCodeInput', function() {
            var tr = $(this).closest('tr');
            var factorCode = $(this).val();
            updateLaborHoursFromFactorCode(tr, factorCode);
        });

        contentWrapper.on('input', '.quantity input, .costInput, .laborHoursInput, .factorCodeInput', function() {
            updateLineAndTotalCosts(this);
        });

        attachAutocompleteToPartNumber(contentWrapper.find('.partNumInput'));
        attachFactorAutocomplete(contentWrapper.find('.factorCodeInput'));

        contentWrapper.on('focus', 'input[type="text"], input[type="number"]', function() {
            highlightAndSelectInput($(this));
        });

        contentWrapper.on('keydown', 'input', handleTabNavigation);

        contentWrapper.on('click', '.description', function() {
            makeDescriptionEditable($(this));
        });

        contentWrapper.on('blur', '.description input', function() {
            var text = $(this).val();
            $(this).parent().text(text);
            //autoSaveBidData();
        });
        contentWrapper.on('click', '.removeBtn', function(event) {
            event.preventDefault(); // Prevent default browser behavior
            removeLineItem(this);
        });
        contentWrapper.on('keydown', 'input[type="number"]', function(e) {
            if (e.which === 38 || e.which === 40) {
                e.preventDefault();
            }
        });
    }


    function closeAndSaveSubBid(subBidId, category) {
        saveSubBidItems(subBidId, category);
        showSubBidsList(category);
    }
    function initializeModalCloseButtons() {
        var closeButtons = document.getElementsByClassName("close");
        for (var i = 0; i < closeButtons.length; i++) {
            closeButtons[i].onclick = function() {
                var modal = this.closest('.modal');
                if (modal) {
                    closeModal(modal.id);
                }
            }
        }
    }

    function updateOtherMaterialsCost(tr, factorCode, quantity) {
        var contentWrapper = tr.closest('.content-wrapper, .modal-content, .sub-bid-wrapper');
        var isSubBid = contentWrapper.hasClass('sub-bid-wrapper');
        var otherMaterialsCost;

        if (isSubBid) {
            var subBidOtherMaterials = calculateSubBidOtherMaterials(contentWrapper);
            otherMaterialsCost = calculateSubBidRowOtherMaterialsCost(tr, subBidOtherMaterials);
        } else {
            otherMaterialsCost = calculateOtherMaterialsCost(factorCode, quantity);
        }

        tr.find('.otherMaterials').text(`$${otherMaterialsCost.toFixed(2)}`);

        updateTotalOtherMaterialsCost(contentWrapper);
    }

    function updateTotalOtherMaterialsCost(contentWrapper) {
        var totalOtherMaterialsCost = 0;
        contentWrapper.find('.itemsTable tbody tr').each(function() {
            var otherMaterialsCost = parseFloat($(this).find('.otherMaterials').text().replace('$', '')) || 0;
            totalOtherMaterialsCost += otherMaterialsCost;
        });
        contentWrapper.find('.totalOtherMaterialsCost').text(`$${totalOtherMaterialsCost.toFixed(2)}`);
    }

    function calculateTax(cost, quantity, otherMaterialsCost) {
        var taxRate = parseFloat($('#localSalesTax').val()) / 100 || 0;
        var taxableAmount = (cost * quantity) + otherMaterialsCost;
        return taxableAmount * taxRate;
    }

    // Helper function to get the correct sub-bid ID
    function getSubBidId(element) {
        var wrapper = $(element).closest('.sub-bid-wrapper');
        if (wrapper.length) {
            return wrapper.attr('id').replace('subBid_', '');
        }
        return null;
    }   

    function updateLineAndTotalCosts(inputElement) {
        var tr = $(inputElement).closest('tr');
        var contentWrapper = tr.closest('.content-wrapper, .modal-content, .sub-bid-wrapper');
        var isSubcontractor = contentWrapper.attr('id') === 'subcontractorWrapper';
        var isSubBid = contentWrapper.hasClass('sub-bid-wrapper');
        
        var quantity = parseFloat(tr.find('.quantity input').val()) || 0;
        var cost = parseFloat(tr.find('.costInput').val()) || 0;
        var factorCode = tr.find('.factorCodeInput').val();

        // Calculate material cost
        var materialCost = quantity * cost;
        var laborCost = 0;
        var otherMaterialsCost = 0;
        var taxAmount = 0;

        if (!isSubcontractor) {
            var laborHours = parseFloat(tr.find('.laborHoursInput').val()) || 0;
            var laborRate = getLaborRate(contentWrapper.attr('id'));
            laborCost = quantity * laborHours * laborRate;
            
            // Update other materials cost
            if (isSubBid) {
                var subBidId = getSubBidId(inputElement);
                if (subBidId) {
                    otherMaterialsCost = calculateOtherMaterialsCost(factorCode, quantity);
                }
            } else {
                otherMaterialsCost = calculateOtherMaterialsCost(factorCode, quantity);
            }
            tr.find('.otherMaterials').text(`$${otherMaterialsCost.toFixed(2)}`);
            
            // Calculate tax including other materials cost
            taxAmount = calculateTax(cost, quantity, otherMaterialsCost);
            tr.find('.tax').text(`$${taxAmount.toFixed(2)}`);
        }

        // Calculate total line cost (Line Ext Cost)
        var lineExtCost = materialCost + laborCost + otherMaterialsCost + taxAmount;

        // Update line extension cost
        tr.data('lineExtCost', lineExtCost);
        if (tr.hasClass('selected')) {
            tr.next('.additional-description-row').find('.line-ext-cost span').text(`$${lineExtCost.toFixed(2)}`);
        }

        // Update total cost for the wrapper (main bid or sub-bid)
        updateTotalCost(contentWrapper);

        // Update overall budget totals
        updateBudgetTotals();

        console.log(`Updated line and total costs for row. Material: $${materialCost.toFixed(2)}, Labor: $${laborCost.toFixed(2)}, Other Materials: $${otherMaterialsCost.toFixed(2)}, Tax: $${taxAmount.toFixed(2)}, Total: $${lineExtCost.toFixed(2)}`);
    }


    // Update updateSubBidListEntry function
    function updateSubBidListEntry(subBidId) {
        var subBidWrapper = $(`#subBid_${subBidId}`);
        if (subBidWrapper.length === 0) {
            console.error(`Sub-bid wrapper not found for ID: ${subBidId}`);
            return;
        }

        var totalCost = parseFloat(subBidWrapper.find('.totalCost').text().replace('$', '')) || 0;
        var totalLaborHours = 0;

        subBidWrapper.find('.itemsTable tbody tr').each(function() {
            var quantity = parseFloat($(this).find('.quantity input').val()) || 0;
            var laborHours = parseFloat($(this).find('.laborHoursInput').val()) || 0;
            totalLaborHours += quantity * laborHours;
        });

        var subBidEntry = $(`[data-subbid-id="${subBidId}"]`);
        if (subBidEntry.length) {
            subBidEntry.find('.sub-bid-total').text(`$${totalCost.toFixed(2)}`);
            subBidEntry.find('.sub-bid-labor-hours').text(totalLaborHours.toFixed(2));
        }
    }   

    function updateLineItemCost(tr) {
        var lineExtCost = tr.data('lineExtCost') || 0;
        var wrapperId = tr.closest('.content-wrapper').attr('id');
        $(`#lineItemCost-${wrapperId}`).text(`$${lineExtCost.toFixed(2)}`);
    }


    function insertBlankLineItem(wrapperId) {
        var lineNum = prompt("Enter the line number after which you want to insert a new line item:");
        if (!lineNum || isNaN(lineNum) || parseInt(lineNum) < 1) {
            alert("Please enter a valid line number.");
            return;
        }
        lineNum = parseInt(lineNum);

        var contentWrapper = $('#' + wrapperId);
        var itemsTableBody = contentWrapper.find(".itemsTable tbody");
        var existingRows = itemsTableBody.find('tr:not(.additional-description-row)').length;

        if (lineNum > existingRows) {
            alert("Line number exceeds the current number of items. Adding at the end.");
            addBlankLineItem(wrapperId);
        } else {
            var newRow = $(getTableRow(0));  // Use 0 as a placeholder
            var targetRow = itemsTableBody.find("tr:not(.additional-description-row)").eq(lineNum - 1);
            newRow.insertAfter(targetRow);

            // Insert an empty additional description row
            $(`<tr class="additional-description-row" style="display:none;">
                <td colspan="5">
                    <input type="text" class="additionalDescriptionInput" value="" placeholder="Enter additional description">
                </td>
                <td colspan="5">
                    <div class="line-ext-cost">Line Ext Cost: <span>$0.00</span></div>
                </td>
            </tr>`).insertAfter(newRow);

            attachAutocompleteToPartNumber(newRow.find('.partNumInput'));
            attachFactorAutocomplete(newRow.find('.factorCodeInput'));

            // Set default values
            var defaultQuantity = 1;
            var defaultCost = 0;
            var defaultOtherMaterialsCost = 0;
            updateLineAndTotalCosts(newRow.find('.quantity input')[0]);
            newRow.find('.quantity input').val(defaultQuantity);
            newRow.find('.costInput').val(defaultCost.toFixed(2));
            newRow.find('.otherMaterials').text('$' + defaultOtherMaterialsCost.toFixed(2));

            // Calculate and set initial tax
            var initialTax = calculateTax(defaultCost, defaultQuantity, defaultOtherMaterialsCost);
            newRow.find('.tax').text('$' + initialTax.toFixed(2));

            newRow.find('.quantity input, .costInput, .laborHoursInput').on('input', function() {
                updateLineAndTotalCosts(this);
            }); 

            newRow.find('.partNumInput').on('change', function() {
                var partNumber = $(this).val();
                fetchFactorCodeAndLaborHoursForPart(partNumber, newRow);
            });

            newRow.find('.partNumInput').on('autocompletechange', function() {
                $(this).closest('tr').find('.quantity input').focus();
            });

            newRow.find('.quantity input').on('keydown', function(event) {
                if (event.key === 'Enter') {
                    var currentRow = $(this).closest('tr');
                    var wrapperId = currentRow.closest('.content-wrapper, .modal-content').attr('id');
                    currentRow.next().find('.partNumInput').focus();
                }
            });

            updateLineNumbers(contentWrapper);
            updateTotalCost(contentWrapper);

            // Clear the additional description input when inserting a new line item
            $(`#additionalDescription-${wrapperId}`).val('');
        }
    }


    function reinitializeAutocompleteForAll(contentWrapper) {
        var partNumInputs = contentWrapper.find('.partNumInput');
        var factorCodeInputs = contentWrapper.find('.factorCodeInput');

        partNumInputs.each(function() {
            attachAutocomplete($(this), inventory);
        });

        factorCodeInputs.each(function() {
            attachFactorAutocomplete($(this), factors);
        });
    }
    
    function addBlankLineItem(wrapperId) {
        console.log(`Adding blank line item to ${wrapperId}`);
        
        if ($(`.${wrapperId}-adding-line`).length > 0) {
            console.log('Already adding a line, skipping');
            return;
        }
        
        $('body').addClass(`${wrapperId}-adding-line`);
        
        const bidId = document.getElementById('bidId').value;
        const isSubcontractor = wrapperId === 'subcontractorWrapper';
        
        fetch('/add-blank-line-item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ wrapper_id: wrapperId, bid_id: bidId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                var contentWrapper = $('#' + wrapperId);
                var tableBody = contentWrapper.find('.itemsTable tbody');
                var newRow = $(getTableRow(data.total_items, isSubcontractor));
                tableBody.append(newRow);

                // Add an empty additional description row
                tableBody.append(`<tr class="additional-description-row" style="display:none;">
                    <td colspan="5">
                        <input type="text" class="additionalDescriptionInput" value="" placeholder="Enter additional description">
                    </td>
                    <td colspan="5">
                        <div class="line-ext-cost">Line Ext Cost: <span>$0.00</span></div>
                    </td>
                </tr>`);

                attachAutocompleteToPartNumber(newRow.find('.partNumInput'));
                attachAutocompleteToDescription(newRow.find('.descriptionInput'));
                if (!isSubcontractor) {
                    attachFactorAutocomplete(newRow.find('.factorCodeInput'));
                }

                updateLineNumbers(contentWrapper);
                updateLineAndTotalCosts(newRow.find('.quantity input')[0]);

                // Scroll to the new row
                var scrollContainer = tableBody.closest('.table-container');
                scrollContainer.animate({
                    scrollTop: scrollContainer[0].scrollHeight
                }, 500);

                updateBudgetTotals();

                // Set focus on the part number input of the new row
                newRow.find('.partNumInput').focus();
            } else {
                console.error('Error adding new line item:', data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        })
        .finally(() => {
            $('body').removeClass(`${wrapperId}-adding-line`);
        });
    }

    function updateOtherMaterials(category) {
        console.log(`Updating other materials for category: ${category}`);
        var otherMaterials = calculateOtherMaterials(category);
        updateOtherMaterialsList(otherMaterials);

        var wrapperSelector = category.startsWith('subbid-') ? `#${category.replace('subbid-', '')}` : `#${category.toLowerCase()}Wrapper`;
        var wrapper = $(wrapperSelector);

        // Update the Other Materials cost for each row
        wrapper.find('.itemsTable tbody tr').each(function() {
            var tr = $(this);
            var factorCode = tr.find('.factorCodeInput').val();
            var quantity = parseFloat(tr.find('.quantity input').val()) || 0;
            var otherMaterialsCost = calculateOtherMaterialsCost(factorCode, quantity);
            tr.find('.otherMaterials').text(`$${otherMaterialsCost.toFixed(2)}`);
        });

        // Update the total Other Materials cost
        var totalCost = otherMaterials.reduce((sum, item) => sum + item.quantity * item.cost, 0);
        wrapper.find('.totalOtherMaterialsCost').text(`$${totalCost.toFixed(2)}`);

        updateTotalLineExtCost(wrapper);
        updateTotalCost(wrapper);
    }

    function getTableRow(rowNum, isSubcontractor = false) {
        return `
            <tr>
                <td class="lineNumber">${rowNum}</td>
                <td class="partNumber"><input type='text' class='partNumInput' autocomplete='off'></td>
                <td><input type='text' class='descriptionInput' autocomplete='off'></td>
                ${!isSubcontractor ? `<td><input type="text" class="factorCodeInput" autocomplete="off"></td>` : ''}
                <td class="quantity"><input type='text' class='quantity' value='1' oninput='updateLineAndTotalCosts(this)'></td>
                <td><input type='text' class='costInput' value='0.00' oninput='updateLineAndTotalCosts(this)'></td>
                ${!isSubcontractor ? `
                    <td><input type='text' class='laborHoursInput' value='0' oninput='updateLineAndTotalCosts(this)'></td>
                    <td class="otherMaterials">$0.00</td>
                    <td class="tax">$0.00</td>
                ` : ''}
                <td class="action"><button class='removeBtn'>Remove</button></td>
            </tr>`;
    }

    // Update the calculateCategoryTotal function to handle subcontractor differently
    function calculateCategoryTotal(wrapperId, laborRate, taxRate) {
        var contentWrapper = $('#' + wrapperId);
        var materialTotal = 0;
        var laborTotal = 0;
        var otherMaterialsTotal = 0;
        var taxTotal = 0;

        contentWrapper.find(".itemsTable tbody tr").each(function() {
            var quantity = parseFloat($(this).find('.quantity input').val()) || 0;
            var cost = parseFloat($(this).find('.costInput').val()) || 0;
            var lineCost = quantity * cost;
            materialTotal += lineCost;

            if (wrapperId !== 'subcontractorWrapper') {
                var laborHours = parseFloat($(this).find('.laborHoursInput').val()) || 0;
                laborTotal += quantity * laborHours * laborRate;
            }

            var otherMaterialsCost = parseFloat($(this).find('.otherMaterials').text().replace('$', '')) || 0;
            otherMaterialsTotal += otherMaterialsCost;

            var taxableAmount = lineCost + otherMaterialsCost;
            taxTotal += taxableAmount * taxRate;
        });

        return {
            materialTotal: materialTotal,
            laborTotal: laborTotal,
            otherMaterialsTotal: otherMaterialsTotal,
            taxTotal: taxTotal
        };
    }

    function recalculateLaborHours(tr, quantity) {
        var partNumber = tr.find('.partNumInput').val();
        var baseLaborHours = tr.data('baseLaborHours');
        
        if (baseLaborHours === undefined) {
            // If baseLaborHours is not set, fetch it from the server
            fetchFactorCodeAndLaborHoursForPart(partNumber, tr, quantity);
        } else {
            var scaledLaborHours = baseLaborHours * quantity;
            tr.find('.laborHours').text(scaledLaborHours.toFixed(2));
        }
    }

    function getLaborRate(wrapperId) {
        switch(wrapperId) {
            case 'drainsWrapper':
                return parseFloat($('#laborRateDrains').val()) || 50;
            case 'irrigationWrapper':
                return parseFloat($('#laborRateIrrigation').val()) || 50;
            case 'landscapeWrapper':
                return parseFloat($('#laborRateLandscape').val()) || 50;
            case 'maintenanceWrapper':
                return parseFloat($('#laborRateMaintenance').val()) || 50;
            case 'subcontractorWrapper':
                return 0; // Subcontractors don't have a labor rate
            default:
                return 50;
        }
    }

    function populateDropdown(input, dropdown, type) {
        var query = input.val();
        var url = type === 'part' ? '/inventory/search' : '/autocomplete-factor-codes';

        $.ajax({
            url: url,
            data: { query: query },
            success: function(data) {
                dropdown.empty();
                var items = type === 'part' ? data.inventory : data.factor_codes;
                items.forEach(function(item) {
                    var option = $('<div class="dropdown-option"></div>');
                    option.text(type === 'part' ? `${item.part_number} - ${item.description}` : `${item.factor_code} - ${item.description}`);
                    option.on('click', function() {
                        if (type === 'part') {
                            handlePartNumberSelection(input, item);
                        } else {
                            handleFactorCodeSelection(input, item);
                        }
                        dropdown.hide();
                    });
                    dropdown.append(option);
                });
            },
            error: function() {
                dropdown.empty();
                dropdown.append('<div>No results found</div>');
            }
        });
    }

    function saveBidLaborRate(wrapperId, newRate) {
        const laborRates = {
            bid_id: currentBidId, // Assume this is a global or passed variable
            [wrapperId]: newRate
        };

        $.ajax({
            url: '/save-bid-labor-rate',
            type: 'POST',
            data: JSON.stringify(laborRates),
            contentType: 'application/json',
            success: function(response) {
                if (!response.success) {
                    alert('Failed to save labor rates: ' + response.message);
                }
            },
            error: function(error) {
                console.error('Error saving labor rates:', error);
                alert('Failed to save labor rates. Please try again.');
            }
        });
    }


    function loadLaborRates(bidId) {
        $.ajax({
            url: '/get-bid-labor-rates',
            type: 'GET',
            data: { bid_id: bidId },
            success: function(response) {
                updateLaborRates(response); // Update the fields with either custom or default rates
            },
            error: function(error) {
                console.error('Error loading labor rates:', error);
                alert('Failed to load labor rates.');
            }
        });
    }

    function updateSubBidTotals(contentWrapper) {
        var totalMaterialCost = 0;
        var totalLaborCost = 0;
        var totalOtherMaterialsCost = 0;
        var laborRate = 50; // Default labor rate, adjust as needed

        contentWrapper.find(".itemsTable tbody tr").each(function() {
            var quantity = parseInt($(this).find('.quantity input').val()) || 0;
            var cost = parseFloat($(this).find('.costInput').val()) || 0;
            var laborHours = parseFloat($(this).find('.laborHours').text()) || 0;
            var otherMaterialsCost = parseFloat($(this).find('.otherMaterials').text().replace('$', '')) || 0;

            totalMaterialCost += quantity * cost;
            totalLaborCost += laborHours * laborRate;
            totalOtherMaterialsCost += otherMaterialsCost;
        });

        var totalCost = totalMaterialCost + totalLaborCost + totalOtherMaterialsCost;

        contentWrapper.find('.totalMaterialCost').text(`$${totalMaterialCost.toFixed(2)}`);
        contentWrapper.find('.totalLaborCost').text(`$${totalLaborCost.toFixed(2)}`);
        contentWrapper.find('.totalOtherMaterialsCost').text(`$${totalOtherMaterialsCost.toFixed(2)}`);
        contentWrapper.find('.totalCost').text(`$${totalCost.toFixed(2)}`);
    }

    function calculateOtherMaterialsCost(factorCode, quantity) {
        if (!factorCode || !window.factorCodeItemsCache || !window.factorCodeItemsCache[factorCode]) {
            return 0;
        }
        
        return window.factorCodeItemsCache[factorCode].reduce((total, item) => {
            return total + (item.cost * item.quantity * quantity);
        }, 0);
    }


    function updateLineExtCost(tr, factorCode, quantity) {
        console.log(`Updating other materials cost - Factor Code: ${factorCode}, Quantity: ${quantity}`);
        var otherMaterialsCost = 0;

        if (factorCode && window.factorCodeItemsCache && window.factorCodeItemsCache[factorCode]) {
            otherMaterialsCost = calculateOtherMaterialsCost(factorCode, quantity);
        }
        
        tr.find('.otherMaterials').text(`$${otherMaterialsCost.toFixed(2)}`);
        tr.find('.lineExtCost').text(`$${otherMaterialsCost.toFixed(2)}`);
        
        var contentWrapper = tr.closest('.content-wrapper, .modal-content');
        
        if (contentWrapper.length > 0) {
            updateTotalCost(contentWrapper);
            updateSubBidTotals(contentWrapper);
            
            var category;
            if (contentWrapper.hasClass('content-wrapper')) {
                category = contentWrapper.attr('id').replace('Wrapper', '');
            } else {
                var subBidId = contentWrapper.find('.itemsTable').attr('id');
                category = subBidId ? 'subbid-' + subBidId : 'unknown';
            }

            if (factorCode) {
                fetchFactorCodeItems(factorCode)
                    .then(() => {
                        var otherMaterials = calculateOtherMaterials(category);
                        updateOtherMaterialsList(otherMaterials);
                        showOtherMaterials(category, false);
                    });
            }
        } else {
            console.warn('Content wrapper not found for the current row');
        }
    }

    function loadDefaultLaborRates() {
        fetch('/get-default-labor-rates')
            .then(response => response.json())
            .then(data => {
                console.log('Received default labor rates:', data);
                // Only update rates that are not already set
                const currentRates = {
                    drains: parseFloat($('#laborRateDrains').val()),
                    irrigation: parseFloat($('#laborRateIrrigation').val()),
                    landscape: parseFloat($('#laborRateLandscape').val()),
                    maintenance: parseFloat($('#laborRateMaintenance').val()),
                    localSalesTax: parseFloat($('#localSalesTax').val())
                };

                if (isNaN(currentRates.drains)) $('#laborRateDrains').val(data.drains_labor_rate);
                if (isNaN(currentRates.irrigation)) $('#laborRateIrrigation').val(data.irrigation_labor_rate);
                if (isNaN(currentRates.landscape)) $('#laborRateLandscape').val(data.landscape_labor_rate);
                if (isNaN(currentRates.maintenance)) $('#laborRateMaintenance').val(data.maintenance_labor_rate);
                if (isNaN(currentRates.localSalesTax)) $('#localSalesTax').val(data.local_sales_tax);

                updateBudgetTotals();
            })
            .catch(error => {
                console.error('Error loading default labor rates:', error);
            });
    }

    function saveDefaultLaborRates() {
        var laborRates = {
            drains: $('#drains-labor-rate').val(),
            irrigation: $('#irrigation-labor-rate').val(),
            landscape: $('#landscape-labor-rate').val(),
            maintenance: $('#maintenance-labor-rate').val()
        };

        $.ajax({
            url: '/save-default-labor-rates',
            type: 'POST',
            data: JSON.stringify(laborRates),
            contentType: 'application/json',
            success: function(response) {
                if (response.success) {
                    alert('Labor rates saved successfully!');
                } else {
                    alert('Failed to save labor rates: ' + response.message);
                }
            },
            error: function(error) {
                console.error('Error saving labor rates:', error);
                alert('Failed to save labor rates. Please try again.');
            }
        });
    }

    function updateOtherMaterialsList(otherMaterials) {
        var otherMaterialsHtml = '';
        var totalCost = 0;
        otherMaterials.forEach(item => {
            var itemTotalCost = item.quantity * item.cost;
            totalCost += itemTotalCost;
            otherMaterialsHtml += `
                <tr>
                    <td>${item.part_number}</td>
                    <td>${item.description}</td>
                    <td>${item.quantity.toFixed(2)}</td>
                    <td>$${item.cost.toFixed(2)}</td>
                    <td>$${itemTotalCost.toFixed(2)}</td>
                </tr>
            `;
        });
        $('#otherMaterialsBody').html(otherMaterialsHtml);
        $('#otherMaterialsTotalCost').text(`$${totalCost.toFixed(2)}`);
    }    

    function updateTotalLineExtCost(contentWrapper) {
        var totalLineExtCost = 0;
        contentWrapper.find('.itemsTable tbody tr').each(function() {
            var lineExtCost = parseFloat($(this).find('.lineExtCost').text().replace('$', '')) || 0;
            totalLineExtCost += lineExtCost;
        });
        contentWrapper.find('.line-ext-cost #lineExtCost').text(`$${totalLineExtCost.toFixed(2)}`);
    }

    function updateAdditionalDescriptionForPartNumber(partNumber, description) {
        $('.itemsTable tbody tr').each(function() {
            if ($(this).find('.partNumInput').val() === partNumber) {
                $(this).data('additionalDescription', description);
            }
        });
    }

    function searchFactorCodes(searchInputId, resultsContainerId) {
        const query = $('#' + searchInputId).val().toLowerCase();
        if (query.length >= 2) {
            $.getJSON(`/search-factor-codes?query=${query}`, function(data) {
                const resultsDiv = $('#' + resultsContainerId);
                resultsDiv.empty();

                if (data.factors.length === 0) {
                    resultsDiv.append('<p>No matching factor codes found.</p>');
                } else {
                    const ul = $('<ul>');
                    data.factors.forEach(factor => {
                        ul.append(`<li data-factor='${JSON.stringify(factor)}'>${factor.factor_code} - ${factor.description}</li>`);
                    });
                    resultsDiv.append(ul);

                    // Add click event to factor code results
                    resultsDiv.find('li').on('click', function() {
                        const factor = JSON.parse($(this).attr('data-factor'));
                        fillFactorCodeDetails(factor);
                        resultsDiv.hide(); // Hide the results after selecting
                    });
                    resultsDiv.show(); // Show the results dropdown
                }
            });
        } else {
            $('#' + resultsContainerId).hide(); // Hide the results if query is less than 2 characters
        }
    }

    function fillFactorCodeDetails(factor) {
        // Fill in the details as per your requirement
        $('#factorCodeInput').val(factor.factor_code);
        $('#laborHoursInput').val(factor.labor_hours); // Example for filling labor hours
    }

    function recalculateLineNumbers(contentWrapper) {
        var lineNumber = 1;
        contentWrapper.find(".itemsTable tbody tr").each(function() {
            if (!$(this).hasClass('additional-description-row')) {
                $(this).find('.lineNumber').text(lineNumber);
                lineNumber++;
            }
        });
    }

    function enableDragAndDrop(tableSelector) {
        $(tableSelector + ' tbody').sortable({
            cursor: 'move',
            helper: function(e, tr) {
                var $originals = tr.children();
                var $helper = tr.clone();
                $helper.children().each(function(index) {
                    $(this).width($originals.eq(index).width());
                });
                return $helper;
            },
            start: function(e, ui) {
                ui.item.data('start_pos', ui.item.index());
                
                // Hide all additional description rows
                $(tableSelector + ' .additional-description-row').hide();

                // Remove 'active-dropdown' class from all rows
                $(tableSelector + ' tbody tr').removeClass('active-dropdown');

                // Add a class to the dragged item for styling
                ui.item.addClass('ui-sortable-helper');
            },
            stop: function(e, ui) {
                // Remove the helper class
                ui.item.removeClass('ui-sortable-helper');

                // Ensure the dropped item is not selected and its additional description remains hidden
                ui.item.removeClass('active-dropdown');
                ui.item.next('.additional-description-row').hide();

                // Re-apply alternating row colors if needed
                $(tableSelector + ' tbody tr:not(.additional-description-row)').each(function(index) {
                    $(this).removeClass('odd even');
                    $(this).addClass(index % 2 === 0 ? 'odd' : 'even');
                });
            },
            update: function(event, ui) {
                var contentWrapper = $(this).closest('.content-wrapper');
                
                // Recalculate line numbers for all rows
                recalculateLineNumbers(contentWrapper);

                // Update totals
                updateTotalCost(contentWrapper);
                updateBudgetTotals();
            }
        }).disableSelection();
    }


    function initializeRow(row) {
        attachAutocompleteToPartNumber(row.find('.partNumInput'));
        attachAutocompleteToDescription(row.find('.descriptionInput'));
        attachFactorAutocomplete(row.find('.factorCodeInput'));
        
        row.find('.quantity input, .costInput, .laborHoursInput').on('input', function() {
            updateLineAndTotalCosts(this);
        });

        row.find('.partNumInput, .descriptionInput').on('change', function() {
            var partNumber = row.find('.partNumInput').val();
            fetchFactorCodeAndLaborHoursForPart(partNumber, row);
        });

        row.find('.quantity input').on('keydown', function(event) {
            if (event.key === 'Enter') {
                var currentRow = $(this).closest('tr');
                var wrapperId = currentRow.closest('.content-wrapper, .modal-content').attr('id');
                currentRow.next().find('.partNumInput').focus();
            }
        });
    }
    // Update the handleTabNavigation function
    function handleTabNavigation(event) {
        if (event.key === 'Tab' || event.key === 'Enter') {
            event.preventDefault();
            var currentCell = $(event.target);
            var currentRow = currentCell.closest('tr');
            var nextCell;

            if (currentCell.hasClass('partNumInput')) {
                nextCell = currentRow.find('.descriptionInput');
            } else if (currentCell.hasClass('descriptionInput')) {
                nextCell = currentRow.find('.factorCodeInput');
            } else if (currentCell.hasClass('factorCodeInput')) {
                nextCell = currentRow.find('.quantity input');
            } else if (currentCell.hasClass('quantity')) {
                nextCell = currentRow.find('.costInput');
            } else if (currentCell.hasClass('costInput')) {
                nextCell = currentRow.find('.laborHoursInput');
            } else if (currentCell.hasClass('laborHoursInput')) {
                var nextRow = currentRow.next('tr');
                if (nextRow.length) {
                    nextCell = nextRow.find('.partNumInput');
                } else {
                    // If it's the last row, add a new row and focus on its part number input
                    var wrapperId = currentRow.closest('.content-wrapper').attr('id');
                    addBlankLineItem(wrapperId);
                    nextCell = currentRow.next('tr').find('.partNumInput');
                }
            }

            if (nextCell && nextCell.length) {
                nextCell.focus().select();
            }
        }
    }
    // Make sure to attach this event handler to all input fields
    $('.content-wrapper').on('keydown', 'input', handleTabNavigation);

    // Make the description field editable
    $('.content-wrapper').on('click', '.description', function() {
        var text = $(this).text();
        $(this).html('<input type="text" value="' + text + '">');
        $(this).find('input').focus();
    });

    $('.content-wrapper').on('blur', '.description input', function() {
        var text = $(this).val();
        $(this).parent().text(text);
    });


    function handlePartNumberSelection(input, item) {
        var tr = input.closest('tr');
        
        // Set values safely
        tr.find('.partNumInput').val(item.value || '').data('inventoryDescription', item.desc || '');
        tr.find('.descriptionInput').val(item.desc ? decodeURIComponent(item.desc) : '');
        tr.find('.costInput').val(item.cost ? item.cost.toFixed(2) : '0.00');
        tr.find('.factorCodeInput').val(item.factorCode || '');

        // Set default quantity to 1 if empty
        if (!tr.find('.quantity input').val()) {
            tr.find('.quantity input').val(1);
        }

        fetchFactorCodeAndLaborHoursForPart(item.value, tr)
            .then(() => {
                return fetchFactorCodeItems(item.factorCode);
            })
            .then(() => {
                var contentWrapper = tr.closest('.content-wrapper, .modal-content');
                var category = contentWrapper.data('category') || contentWrapper.attr('id').replace('Wrapper', '').toLowerCase();
                
                updateOtherMaterials(category);
                // Call updateLineAndTotalCosts here after all data is fetched and set
                updateLineAndTotalCosts(tr.find('.costInput')[0]);
            })
            .catch(error => {
                console.error('Error updating after part selection:', error);
            });

        highlightAndSelectInput(tr.find('.descriptionInput'));
    }

    // Add a function to highlight and select the content of input fields
    function highlightAndSelectInput(input) {
        // Consider this:
        $('input').on('focus', function() {
            if (!$(this).data('highlighted')) {
                $(this).data('highlighted', true);
                highlightAndSelectInput($(this));
                setTimeout(() => $(this).data('highlighted', false), 100);
            }
        });
    }
    function makeDescriptionEditable(descriptionCell) {
        if (!descriptionCell.find('input').length) {
            var text = descriptionCell.text().trim();
            var input = $('<input type="text">').val(text);
            descriptionCell.html(input);
            
            input.focus();

            input.on('blur', function() {
                var newText = $(this).val();
                if (newText.trim() === '') {
                    descriptionCell.html('<span class="placeholder">Click to edit description</span>');
                } else {
                    descriptionCell.text(newText);
                }
            }).on('keydown', function(e) {
                if (e.key === 'Enter') {
                    $(this).blur();
                }
            });
        }
    }


    function attachAutocompleteToPartNumber(input) {
        // Destroy any existing autocomplete to prevent duplicates
        if (input.autocomplete("instance")) {
            input.autocomplete("destroy");
        }

        input.autocomplete({
            minLength: 2,
            appendTo: input.closest('.tabcontent, .modal-content'),
            source: function(request, response) {
                var searchTerm = request.term.toLowerCase();
                var isClick = this.element.data('isClick') || false;
                
                if (isClick && searchTerm.length >= 4) {
                    searchTerm = searchTerm.substring(0, 4);
                }

                $.ajax({
                    url: "/inventory/search",
                    data: { query: searchTerm },
                    success: function(data) {
                        var exactConversionCodeMatch = data.inventory.find(item => 
                            item.conversion_codes && item.conversion_codes.some(code => 
                                code.toLowerCase() === searchTerm
                            )
                        );

                        var results;
                        if (exactConversionCodeMatch) {
                            results = data.inventory.filter(item => 
                                item.conversion_codes && item.conversion_codes.some(code => 
                                    code.toLowerCase() === searchTerm
                                )
                            );
                        } else {
                            results = data.inventory.filter(function(item) {
                                if (isClick) {
                                    return item.part_number.toLowerCase().startsWith(searchTerm);
                                } else {
                                    return item.part_number.toLowerCase().includes(searchTerm) ||
                                        item.description.toLowerCase().includes(searchTerm);
                                }
                            });
                        }

                        response($.map(results, function(item) {
                            return {
                                label: `${item.part_number} - ${item.description}`,
                                value: item.part_number,
                                desc: item.description,
                                cost: item.cost,
                                factorCode: item.factor_code
                            };
                        }));
                    },
                    error: function() {
                        response([]);
                    }
                });
                this.element.data('isClick', false);
            },
            select: function(event, ui) {
                handlePartNumberSelection($(this), ui.item);
                return false;
            },
            focus: function(event, ui) {
                event.preventDefault();
                $(this).val(ui.item.value);
            },
            create: function() {
                $(this).data('ui-autocomplete')._renderItem = function(ul, item) {
                    const cost = typeof item.cost === 'number' ? item.cost.toFixed(2) : '0.00';
                    return $("<li>")
                        .append(`<div class='part-number-item'>
                                    <div class='item-details'>${item.value} - ${item.desc}</div>
                                    <div class='item-price'>$${cost}</div>
                                </div>`)
                        .appendTo(ul);
                };
            }
        });

        input.off('click').on('click', function() {
            if ($(this).val().length >= 4) {
                $(this).data('isClick', true);
                $(this).autocomplete("search", $(this).val());
            }
        }).off('keydown').on('keydown', function(event) {
            if (event.keyCode === 13) { // Enter key
                var menu = $(this).autocomplete("widget");
                if (menu.is(":visible")) {
                    var exactMatch = menu.find("li").filter(function() {
                        return $(this).text().split(' - ')[0] === input.val();
                    });
                    
                    if (exactMatch.length) {
                        exactMatch.first().trigger("click");
                    } else {
                        var highlighted = menu.find(".ui-state-active");
                        if (highlighted.length === 0) {
                            highlighted = menu.children().first();
                        }
                        highlighted.trigger("click");
                    }
                    event.preventDefault();
                    return false;
                }
            }
        });
    }

    function attachAutocompleteToDescription(input) {
        // Destroy any existing autocomplete to prevent duplicates
        if (input.autocomplete("instance")) {
            input.autocomplete("destroy");
        }

        input.autocomplete({
            minLength: 2,
            appendTo: input.closest('.tabcontent, .modal-content'),
            source: function(request, response) {
                var searchTerm = request.term.toLowerCase();
                var isClick = this.element.data('isClick') || false;
                
                if (isClick && searchTerm.length >= 4) {
                    searchTerm = searchTerm.substring(0, 4);
                }

                $.ajax({
                    url: "/inventory/search",
                    data: { query: searchTerm },
                    success: function(data) {
                        var results = data.inventory.filter(function(item) {
                            if (isClick) {
                                return item.description.toLowerCase().startsWith(searchTerm);
                            } else {
                                return item.description.toLowerCase().includes(searchTerm) ||
                                    item.part_number.toLowerCase().includes(searchTerm);
                            }
                        });

                        response($.map(results, function(item) {
                            return {
                                label: `${item.description} (${item.part_number})`,
                                value: item.description,
                                part_number: item.part_number,
                                cost: item.cost,
                                factorCode: item.factor_code
                            };
                        }));
                    },
                    error: function() {
                        response([]);
                    }
                });
                this.element.data('isClick', false);
            },
            select: function(event, ui) {
                handleDescriptionSelection($(this), ui.item);
                return false;
            },
            focus: function(event, ui) {
                event.preventDefault();
                $(this).val(ui.item.value);
            },
            create: function() {
                $(this).data('ui-autocomplete')._renderItem = function(ul, item) {
                    const cost = typeof item.cost === 'number' ? item.cost.toFixed(2) : '0.00';
                    return $("<li>")
                        .append(`<div class='description-item'>
                                    <div class='item-details'>${item.value} (${item.part_number})</div>
                                    <div class='item-price'>$${cost}</div>
                                </div>`)
                        .appendTo(ul);
                };
            }
        });

        input.off('click').on('click', function() {
            if ($(this).val().length >= 4) {
                $(this).data('isClick', true);
                $(this).autocomplete("search", $(this).val());
            }
        }).off('keydown').on('keydown', function(event) {
            if (event.keyCode === 13) { // Enter key
                var menu = $(this).autocomplete("widget");
                if (menu.is(":visible")) {
                    var exactMatch = menu.find("li").filter(function() {
                        return $(this).text().split(' (')[0] === input.val();
                    });
                    
                    if (exactMatch.length) {
                        exactMatch.first().trigger("click");
                    } else {
                        var highlighted = menu.find(".ui-state-active");
                        if (highlighted.length === 0) {
                            highlighted = menu.children().first();
                        }
                        highlighted.trigger("click");
                    }
                    event.preventDefault();
                    return false;
                }
            }
        });
    }

    function handleDescriptionSelection(input, item) {
        var tr = input.closest('tr');
        
        // Set values safely
        tr.find('.partNumInput').val(item.part_number || '');
        tr.find('.descriptionInput').val(item.value || '').data('inventoryDescription', item.value || '');
        tr.find('.costInput').val(item.cost ? item.cost.toFixed(2) : '0.00');
        tr.find('.factorCodeInput').val(item.factorCode || '');

        // Set default quantity to 1 if empty
        if (!tr.find('.quantity input').val()) {
            tr.find('.quantity input').val(1);
        }

        fetchFactorCodeAndLaborHoursForPart(item.part_number, tr)
            .then(() => {
                return fetchFactorCodeItems(item.factorCode);
            })
            .then(() => {
                var contentWrapper = tr.closest('.content-wrapper, .modal-content');
                var category = contentWrapper.data('category') || contentWrapper.attr('id').replace('Wrapper', '').toLowerCase();
                
                updateOtherMaterials(category);
                // Call updateLineAndTotalCosts here after all data is fetched and set
                updateLineAndTotalCosts(tr.find('.costInput')[0]);
            })
            .catch(error => {
                console.error('Error updating after description selection:', error);
            });

        highlightAndSelectInput(tr.find('.quantity input'));
    }

    function attachFactorAutocomplete(selector) {
        selector.autocomplete({
            minLength: 2,
            appendTo: selector.closest('.tabcontent, .modal-content'),
            source: function(request, response) {
                var searchTerm = request.term;
                var isClick = this.element.data('isClick') || false;
                
                if (isClick && searchTerm.length >= 3) {
                    searchTerm = searchTerm.substring(0, 3);
                }

                $.ajax({
                    url: "/autocomplete-factor-codes",
                    data: { query: searchTerm },
                    success: function(data) {
                        var results = data.factor_codes.filter(function(item) {
                            if (isClick) {
                                return item.factor_code.toLowerCase().startsWith(searchTerm.toLowerCase());
                            } else {
                                return item.factor_code.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    item.description.toLowerCase().includes(searchTerm.toLowerCase());
                            }
                        });
                        response($.map(results, function(item) {
                            return {
                                label: `${item.factor_code} - ${item.description}`,
                                value: item.factor_code,
                                description: item.description,
                                labor_hours: item.labor_hours
                            };
                        }));
                    },
                    error: function() {
                        response([]);
                    }
                });
                this.element.data('isClick', false);
            },
            select: function(event, ui) {
                handleFactorCodeSelection($(this), ui.item);
                return false;
            },
            focus: function(event, ui) {
                event.preventDefault();
                $(this).val(ui.item.value);
            },
            create: function() {
                $(this).data('ui-autocomplete')._renderItem = function(ul, item) {
                    return $("<li>")
                        .append(`<div class='factor-code-item'>
                                    <div class='item-details'>${item.value} - ${item.description}</div>
                                    <div class='item-labor-hours'>${item.labor_hours} hours</div>
                                </div>`)
                        .appendTo(ul);
                };
            }
        });

        selector.on('click', function() {
            if ($(this).val().length >= 3) {
                $(this).data('isClick', true);
                $(this).autocomplete("search", $(this).val());
            }
        }).on('keydown', function(event) {
            if (event.keyCode === 13) { // Enter key
                var menu = $(this).autocomplete("widget");
                if (menu.is(":visible")) {
                    var highlighted = menu.find(".ui-state-active");
                    if (highlighted.length === 0) {
                        highlighted = menu.children().first();
                    }
                    highlighted.trigger("click");
                    event.preventDefault();
                }
            }
        });
    }


    // Update handleFactorCodeSelection function
    function handleFactorCodeSelection(input, item) {
        const tr = input.closest('tr');
        input.val(item.value);
        tr.find('.factorCode').text(item.description);
        
        const quantity = parseFloat(tr.find('.quantity input').val()) || 0;
        updateLaborHoursFromFactorCode(tr, item.value, quantity);
        
        // Calculate and update Line Ext Cost
        updateLineExtCost(tr, item.value, quantity);
        
        // Update totals
        var contentWrapper = tr.closest('.content-wrapper, .modal-content, .sub-bid-wrapper');
        updateTotalCost(contentWrapper);
        updateBudgetTotals();
        
        // Fetch factor code items and update materials
        fetchFactorCodeItems(item.value)
            .then(() => {
                var subBidId = getSubBidId(input);
                var category = subBidId ? `subbid-${subBidId}` : contentWrapper.attr('id').replace('Wrapper', '');
                showOtherMaterials(category, false);  // Update other materials without displaying the popout
            });
    }

    function saveAndCloseSubBid(category) {
        console.log(`Saving and closing sub-bid for category: ${category}`);
        var modalId = category + 'SubBidModal';
        var modal = document.getElementById(modalId);
        if (!modal) {
            console.error('Modal not found:', modalId);
            return;
        }

        var subBidContent = document.getElementById(category + 'SubBidContent');
        if (subBidContent && subBidContent.firstElementChild) {
            var subBidId = subBidContent.firstElementChild.id.replace('subBid_', '');
            saveSubBidItems(subBidId, category)
                .then(() => {
                    modal.style.display = "none";
                    populateSubBidsList(category);
                    console.log(`Sub-bid saved and modal closed for category: ${category}`);
                })
                .catch((error) => {
                    console.error('Failed to save sub-bid items:', error);
                    alert('There was an error saving the sub-bid. Please try again.');
                });
        } else {
            console.log('No sub-bid content found in modal:', modalId);
            modal.style.display = "none";
            populateSubBidsList(category);
        }
    }


    function openSubBidModal(category) {
        console.log(`Opening sub-bid modal for category: ${category}`);
        populateSubBidsList(category);
        var modalId = category + 'SubBidModal';
        console.log(`Attempting to open modal with ID: ${modalId}`);
        openModal(modalId);
        var createSubBidElement = document.getElementById('createSubBid' + capitalizeFirstLetter(category));
        if (createSubBidElement) {
            createSubBidElement.style.display = 'block';
            console.log(`Create sub-bid element displayed for ${category}`);
        } else {
            console.error(`Create sub-bid element not found for ${category}`);
        }
        var subBidContentElement = document.getElementById(category + 'SubBidContent');
        if (subBidContentElement) {
            subBidContentElement.innerHTML = ''; // Clear any existing sub-bid content
            console.log(`Cleared sub-bid content for ${category}`);
        } else {
            console.error(`Sub-bid content element not found for ${category}`);
        }
    }


    function populateSubBidsList(category) {
        var bidId = document.getElementById('bidId').value;
        console.log(`Populating sub bids list for category: ${category}, bid ID: ${bidId}`);

        fetch(`/api/subbids/${bidId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Received sub bids data:', data);
            
            if (!Array.isArray(data)) {
                console.error('Unexpected data format:', data);
                throw new Error('Server returned unexpected data format');
            }
            
            var filteredSubBids = data.filter(subBid => subBid.category === category);
            console.log(`Filtered sub bids for category ${category}:`, filteredSubBids);

            var subBidsListElement = document.getElementById(category + 'SubBidsList');
            if (!subBidsListElement) {
                console.error(`Element not found: ${category}SubBidsList`);
                return;
            }

            subBidsListElement.innerHTML = '<h3>Existing Sub Bids</h3>';
            if (filteredSubBids.length === 0) {
                subBidsListElement.innerHTML += '<p>No sub bids found for this category.</p>';
            } else {
                filteredSubBids.forEach(function(subBid) {
                    var subBidElement = document.createElement('div');
                    subBidElement.className = 'sub-bid-entry';
                    subBidElement.innerHTML = `
                        <div>${subBid.name} - Total Cost: $${subBid.total_cost.toFixed(2)}, Labor Hours: ${subBid.labor_hours.toFixed(2)}</div>
                        <button onclick="editSubBid(${subBid.id}, '${category}')">Edit</button>
                        <button class="removeSubBidBtn" onclick="removeSubBid(${subBid.id}, '${category}')">Remove</button>
                    `;
                    subBidsListElement.appendChild(subBidElement);
                });
            }

            var createSubBidElement = document.getElementById('createSubBid' + capitalizeFirstLetter(category));
            if (createSubBidElement) {
                createSubBidElement.style.display = 'block';
            } else {
                console.error(`Element not found: createSubBid${capitalizeFirstLetter(category)}`);
            }
        })
        .catch(error => {
            console.error('Error fetching sub-bids:', error);
            var subBidsListElement = document.getElementById(category + 'SubBidsList');
            if (subBidsListElement) {
                subBidsListElement.innerHTML = '<h3>Existing Sub Bids</h3><p>Error loading sub bids. Please try again.</p>';
            }
            var createSubBidElement = document.getElementById('createSubBid' + capitalizeFirstLetter(category));
            if (createSubBidElement) {
                createSubBidElement.style.display = 'block';
            }
        });
    }

    function addNewSubBid(category) {
        var subBids = JSON.parse(localStorage.getItem('subBids')) || [];
        var subBidName = prompt("Enter Sub Bid Name:");
        if (!subBidName) return;

        var newSubBid = {
            id: Date.now().toString(),
            category: category,
            name: subBidName,
            totalCost: 0,
            laborHours: 0,
            items: []
        };

        subBids.push(newSubBid);
        localStorage.setItem('subBids', JSON.stringify(subBids));
        populateSubBidsList(category);
    }

    function editSubBid(subBidId, category) {
        $('#loadingOverlay').show();

        fetch(`/api/subbids/${subBidId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(subBid => {
                if (subBid.error) {
                    throw new Error(subBid.error);
                }

                var modalId = category + 'SubBidModal';
                var subBidContentElement = document.getElementById(category + 'SubBidContent');
                if (!subBidContentElement) {
                    throw new Error(`Sub-bid content element not found for category: ${category}`);
                }

                let tableHTML = `
                    <div id="subBid_${subBidId}" data-category="${category}" class="content-wrapper sub-bid-wrapper">
                        <h3>${subBid.name}</h3>
                        <div class="action-buttons">
                            <button class="addBtn" onclick="addBlankLineItem('subBid_${subBidId}')">Add Line Item</button>
                            <button class="insertBtn" onclick="insertBlankLineItem('subBid_${subBidId}')">Insert Line Item</button>
                            <button class="otherMaterialsBtn" onclick="showOtherMaterials('subbid-${subBidId}')">Other Materials</button>
                        </div>
                        <table class="itemsTable">
                            <thead>
                                <tr>
                                    <th class="lineNumber">Line Number</th>
                                    <th class="partNumber">Part Number</th>
                                    <th class="description">Description</th>
                                    <th class="factorCode">Factor Code</th>
                                    <th class="quantity">Quantity</th>
                                    <th class="cost">Bid Price</th>
                                    <th class="laborHours">Labor Hours</th>
                                    <th class="otherMaterials">Other Materials</th>
                                    <th class="tax">Tax</th>
                                    <th class="action">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                            ${subBid.items.map((item, index) => `
                                <tr>
                                    <td class="lineNumber">${index + 1}</td>
                                    <td class="partNumber"><input type="text" value="${item.part_number}" class="partNumInput" autocomplete="off"></td>
                                    <td><input type="text" value="${decodeURIComponent(item.description)}" class="descriptionInput" autocomplete="off"></td>
                                    <td><input type="text" value="${item.factor_code}" class="factorCodeInput" autocomplete="off"></td>
                                    <td class="quantity"><input type="text" value="${item.quantity}" class="quantity" oninput="updateLineAndTotalCosts(this)"></td>
                                    <td><input type="text" value="${item.cost.toFixed(2)}" class="costInput" oninput="updateLineAndTotalCosts(this)"></td>
                                    <td><input type="text" value="${item.labor_hours.toFixed(4)}" class="laborHoursInput" oninput="updateLineAndTotalCosts(this)"></td>
                                    <td class="otherMaterials">$${(item.other_materials_cost || 0).toFixed(2)}</td>
                                    <td class="tax">$${(item.tax || 0).toFixed(2)}</td>
                                    <td class="action"><button class='removeBtn'>Remove</button></td>
                                </tr>
                            `).join('')}
                            </tbody>
                        </table>
                        <div class="total-cost">
                            <h2>Material Cost: <span class="totalMaterialCost">$0.00</span></h2>
                            <h2>Labor Cost: <span class="totalLaborCost">$0.00</span></h2>
                            <h2>Other Materials Cost: <span class="totalOtherMaterialsCost">$0.00</span></h2>
                            <h2>Tax: <span class="totalTax">$0.00</span></h2>
                            <h2>Total Cost: <span class="totalCost">$0.00</span></h2>
                        </div>
                    </div>`;

                subBidContentElement.innerHTML = tableHTML;

                const subBidWrapper = $(`#subBid_${subBidId}`);
                attachEventHandlers(subBidWrapper);
                attachAutocompleteToPartNumber(subBidWrapper.find('.partNumInput'));
                attachFactorAutocomplete(subBidWrapper.find('.factorCodeInput'));

                subBidWrapper.find('.itemsTable tbody tr').each(function() {
                    updateLineAndTotalCosts($(this).find('.quantity input')[0]);
                });

                updateTotalCost(subBidWrapper);
            })
            .then(() => {
                openModal(category + 'SubBidModal');
                var createSubBidElement = document.getElementById('createSubBid' + capitalizeFirstLetter(category));
                if (createSubBidElement) {
                    createSubBidElement.style.display = 'none';
                }
                // Enable drag and drop for the sub-bid table
                enableDragAndDrop(`#subBid_${subBidId} .itemsTable`);
            })
            .catch(error => {
                console.error('Error fetching sub-bid data:', error);
                alert('Error fetching sub-bid data: ' + error.message);
            })
            .finally(() => {
                $('#loadingOverlay').hide();
            });
    }


    function updateSubBidOtherMaterials(subBidId, category) {
        fetch(`/api/subbids/${subBidId}/other-materials`)
            .then(response => response.json())
            .then(otherMaterials => {
                let totalOtherMaterialsCost = 0;
                let otherMaterialsTableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>Part Number</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Cost</th>
                                <th>Total Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                otherMaterials.forEach(item => {
                    const itemTotalCost = item.quantity * item.cost;
                    totalOtherMaterialsCost += itemTotalCost;
                    otherMaterialsTableHtml += `
                        <tr>
                            <td>${item.part_number}</td>
                            <td>${item.description}</td>
                            <td>${item.quantity.toFixed(2)}</td>
                            <td>$${item.cost.toFixed(2)}</td>
                            <td>$${itemTotalCost.toFixed(2)}</td>
                        </tr>
                    `;
                });

                otherMaterialsTableHtml += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4">Total Other Material Cost:</td>
                                <td>$${totalOtherMaterialsCost.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                `;

                // Update the Other Materials table in the modal
                $(`#${category}SubBidModal .modal-content`).append(`
                    <div id="${subBidId}OtherMaterialsTable">
                        <h4>Other Materials</h4>
                        ${otherMaterialsTableHtml}
                    </div>
                `);

                // Update the main table's Other Materials cell for each row
                $(`#${subBidId} .itemsTable tbody tr`).each(function() {
                    const factorCode = $(this).find('.factorCodeInput').val();
                    const quantity = parseFloat($(this).find('.quantity input').val()) || 0;
                    const rowOtherMaterialsCost = calculateRowOtherMaterialsCost(otherMaterials, factorCode, quantity);
                    $(this).find('.otherMaterials').text(`$${rowOtherMaterialsCost.toFixed(2)}`);
                });

                // Update totals
                updateTotalCost($(`#${subBidId}`));
            })
            .catch(error => console.error('Error updating sub-bid other materials:', error));
    }    

    function addSubBidItem(subBidId, category) {
        var subBids = JSON.parse(localStorage.getItem('subBids')) || [];
        var subBid = subBids.find(subBid => subBid.id === subBidId);

        if (!subBid) {
            alert("Sub Bid not found");
            return;
        }

        subBid.items.push({
            name: '',
            cost: 0,
            laborHours: 0
        });

        localStorage.setItem('subBids', JSON.stringify(subBids));
        editSubBid(subBidId, category);
    }

    function removeSubBid(subBidId, category) {
        const csrfToken = getCsrfToken();
        if (!csrfToken) {
            console.error('CSRF token is missing');
            alert('Error: CSRF token is missing. Please refresh the page and try again.');
            return;
        }

        fetch(`/api/subbids/${subBidId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Success:', data);
            populateSubBidsList(category);
        })
        .catch((error) => {
            console.error('Error:', error);
            alert(`Error removing sub-bid: ${error.message}\nPlease try again or contact support if the problem persists.`);
        });
    }

    function removeSubBidItem(subBidId, itemIndex, category) {
        const csrfToken = getCsrfToken();
        if (!csrfToken) {
            console.error('CSRF token is missing');
            alert('Error: CSRF token is missing. Please refresh the page and try again.');
            return;
        }

        fetch(`/api/subbids/${subBidId}/items/${itemIndex}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Item removed successfully:', data);
            // Refresh the sub-bid edit view
            editSubBid(subBidId, category);
        })
        .catch(error => {
            console.error('Error removing sub-bid item:', error);
            let errorMessage = 'An unexpected error occurred while removing the sub-bid item.';
            if (error.message.includes('HTTP error!')) {
                errorMessage = `Server error: ${error.message}`;
            }
            alert(`Error removing sub-bid item: ${errorMessage}\nPlease try again or contact support if the problem persists.`);
        });
    }

    function saveSubBidItems(subBidId, category) {
        console.log(`Attempting to save sub-bid items for subBidId: ${subBidId}, category: ${category}`);

        var subBidElement = document.getElementById(`subBid_${subBidId}`);
        if (!subBidElement) {
            console.error(`Element with subBidId not found: subBid_${subBidId}`);
            console.log("DOM structure:", document.body.innerHTML);
            return Promise.reject(`Sub-bid element not found: subBid_${subBidId}`);
        }

        var itemRows = subBidElement.querySelectorAll('.itemsTable tbody tr');
        console.log(`Found ${itemRows.length} item rows for sub-bid ${subBidId}`);

        var items = Array.from(itemRows).map((row, index) => {
            var quantity = parseFloat(row.querySelector('.quantity input')?.value) || 0;
            var cost = parseFloat(row.querySelector('.costInput')?.value) || 0;
            var item = {
                part_number: row.querySelector('.partNumInput')?.value || '',
                description: encodeURIComponent(row.querySelector('.descriptionInput')?.value || ''),
                factor_code: row.querySelector('.factorCodeInput')?.value || '',
                quantity: quantity,
                cost: cost,
                labor_hours: parseFloat(row.querySelector('.laborHoursInput')?.value) || 0,
                line_ext_cost: quantity * cost
            };
            console.log(`Item ${index + 1}:`, item);
            return item;
        });

        var totalCost = items.reduce((total, item) => total + item.line_ext_cost, 0);
        var totalLaborHours = items.reduce((total, item) => total + item.labor_hours * item.quantity, 0);

        var subBidData = {
            bid_id: document.getElementById('bidId')?.value,
            sub_bid_id: subBidId,
            name: subBidElement.querySelector('h3')?.textContent || `Sub-bid ${subBidId}`,
            category: category,
            total_cost: totalCost,
            labor_hours: totalLaborHours,
            items: items
        };

        console.log('Sending sub-bid data:', subBidData);

        return fetch('/save-sub-bid', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(subBidData),
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Sub-bid saved successfully:', data);
            updateSubBidUI(subBidId, data, category);
            return data;
        })
        .catch((error) => {
            console.error('Error saving sub-bid:', error);
            alert(`Error saving sub-bid: ${error.message}. Please try again.`);
            throw error;
        });
    }

    // Helper function to get CSRF token
    function getCsrfToken() {
        const tokenElement = document.getElementById('csrf_token');
        if (!tokenElement) {
            console.error('CSRF token element not found');
            return null;
        }
        return tokenElement.value;
    }

    // Helper function to capitalize first letter
    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }


    function updateSubBidUI(subBidId, data, category) {
        var subBidElement = document.getElementById(`subBid_${subBidId}`);
        if (!subBidElement) return;

        const safeNumber = (value) => typeof value === 'number' && !isNaN(value) ? value : 0;
        const totalCost = safeNumber(data.total_cost);
        const laborHours = safeNumber(data.labor_hours);

        // Update total costs
        subBidElement.querySelector('.totalMaterialCost').textContent = `$${totalCost.toFixed(2)}`;
        subBidElement.querySelector('.totalLaborCost').textContent = `$${(laborHours * getLaborRate(category)).toFixed(2)}`;

        var overallTotalCost = totalCost + (laborHours * getLaborRate(category));
        subBidElement.querySelector('.totalCost').textContent = `$${overallTotalCost.toFixed(2)}`;

        // Update the sub-bid list if it's visible
        var subBidsList = document.getElementById(category + 'SubBidsList');
        if (subBidsList) {
            var subBidEntry = subBidsList.querySelector(`[data-subbid-id="${subBidId}"]`);
            if (subBidEntry) {
                subBidEntry.querySelector('.sub-bid-total').textContent = `$${overallTotalCost.toFixed(2)}`;
                subBidEntry.querySelector('.sub-bid-labor-hours').textContent = laborHours.toFixed(2);
            }
        }

        // Recalculate and update the total line ext cost
        updateTotalLineExtCost($(subBidElement));

        // Update the overall bid totals
        updateBudgetTotals();
    }
    // Function to open a modal
    function openModal(modalId) {
        var modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = "block";
            initializeModalCloseButtons(); // Reinitialize close buttons when opening a modal
        }
    }

    function closeModal(modalId) {
        var modal = document.getElementById(modalId);
        if (!modal) {
            console.error('Modal not found:', modalId);
            return;
        }

        if (modalId.includes('SubBidModal')) {
            var category = modalId.replace('SubBidModal', '');
            var subBidContent = document.getElementById(category + 'SubBidContent');
            if (subBidContent && subBidContent.firstElementChild) {
                var subBidId = subBidContent.firstElementChild.id.replace('subBid_', '');
                saveSubBidItems(subBidId, category)
                    .then(() => {
                        modal.style.display = "none";
                        populateSubBidsList(category);
                    })
                    .catch((error) => {
                        console.error('Failed to save sub-bid items:', error);
                        if (confirm('There was an error saving the sub-bid. Do you want to close without saving?')) {
                            modal.style.display = "none";
                            populateSubBidsList(category);
                        }
                    });
            } else {
                console.log('No sub-bid content found in modal:', modalId);
                modal.style.display = "none";
                populateSubBidsList(category);
            }
        } else {
            modal.style.display = "none";
        }
    }
    function updateCategoryBudget(elementId, data) {
        document.getElementById(elementId).textContent = `Material: $${data.materialTotal.toFixed(2)} | Labor: $${data.laborTotal.toFixed(2)} | Other Materials: $${data.otherMaterialsTotal.toFixed(2)} | Tax: $${data.taxTotal.toFixed(2)} | Total: $${(data.materialTotal + data.laborTotal + data.otherMaterialsTotal + data.taxTotal).toFixed(2)}`;
    }

    function calculateSubBidTotals() {
        var totalMaterial = 0;
        var totalLabor = 0;
        var totalOtherMaterials = 0;

        $('.modal-content').each(function() {
            var subBidId = $(this).find('.itemsTable').attr('id');
            if (subBidId) {
                var subBidData = calculateCategoryTotal(subBidId, getSubBidLaborRate(subBidId));
                totalMaterial += subBidData.materialTotal;
                totalLabor += subBidData.laborTotal;
                totalOtherMaterials += subBidData.otherMaterialsTotal;
            }
        });

        return {
            materialTotal: totalMaterial,
            laborTotal: totalLabor,
            otherMaterialsTotal: totalOtherMaterials
        };
    }

    function updateBudgetTotals() {
        console.log('Starting updateBudgetTotals');

        const categories = ['Drains', 'Irrigation', 'Landscape', 'Maintenance'];
        let totalMaterialBudget = 0;
        let totalLaborBudget = 0;
        let totalOtherMaterialsBudget = 0;
        let totalTaxBudget = 0;
        let totalSubcontractorBudget = 0;

        categories.forEach(category => {
            const wrapper = $(`#${category.toLowerCase()}Wrapper`);
            const laborRate = getLaborRate(`${category.toLowerCase()}Wrapper`);
            const taxRate = parseFloat($('#localSalesTax').val()) / 100 || 0;

            const categoryData = calculateCategoryTotal(`${category.toLowerCase()}Wrapper`, laborRate, taxRate);
            
            const budgetItem = $(`#budget${category}`);
            
            budgetItem.find('.budget-value:eq(0)').text(`$${categoryData.materialTotal.toFixed(2)}`);
            budgetItem.find('.budget-value:eq(1)').text(`$${categoryData.laborTotal.toFixed(2)}`);
            budgetItem.find('.budget-value:eq(2)').text(`$${categoryData.otherMaterialsTotal.toFixed(2)}`);
            budgetItem.find('.budget-value:eq(3)').text(`$${categoryData.taxTotal.toFixed(2)}`);
            
            const categoryTotal = categoryData.materialTotal + categoryData.laborTotal + 
                                categoryData.otherMaterialsTotal + categoryData.taxTotal;
            budgetItem.find('.budget-value:eq(4)').text(`$${categoryTotal.toFixed(2)}`);

            totalMaterialBudget += categoryData.materialTotal;
            totalLaborBudget += categoryData.laborTotal;
            totalOtherMaterialsBudget += categoryData.otherMaterialsTotal;
            totalTaxBudget += categoryData.taxTotal;

            $(`#${category.toLowerCase()}TotalValue`).text(`$${categoryTotal.toFixed(2)}`);
        });

        // Calculate Subcontractor total separately without tax
        const subcontractorData = calculateCategoryTotal('subcontractorWrapper', 0, 0); // Set tax rate to 0
        totalSubcontractorBudget = subcontractorData.materialTotal + subcontractorData.otherMaterialsTotal;

        const totalBudget = totalMaterialBudget + totalLaborBudget + totalOtherMaterialsBudget + 
                            totalTaxBudget + totalSubcontractorBudget;

        const totalBudgetItem = $('#totalBudget');
        totalBudgetItem.find('.budget-value:eq(0)').text(`$${totalMaterialBudget.toFixed(2)}`);
        totalBudgetItem.find('.budget-value:eq(1)').text(`$${totalLaborBudget.toFixed(2)}`);
        totalBudgetItem.find('.budget-value:eq(2)').text(`$${totalOtherMaterialsBudget.toFixed(2)}`);
        totalBudgetItem.find('.budget-value:eq(3)').text(`$${totalTaxBudget.toFixed(2)}`);
        totalBudgetItem.find('.budget-value:eq(4)').text(`$${totalSubcontractorBudget.toFixed(2)}`);
        totalBudgetItem.find('.budget-value:eq(5)').text(`$${totalBudget.toFixed(2)}`);

        // Update the heading budget summary
        $('#materialTotalValue').text(`$${totalMaterialBudget.toFixed(2)}`);
        $('#laborTotalValue').text(`$${totalLaborBudget.toFixed(2)}`);
        $('#subcontractorTotalValue').text(`$${totalSubcontractorBudget.toFixed(2)}`);
        $('#otherMaterialsTotalValue').text(`$${totalOtherMaterialsBudget.toFixed(2)}`);
        $('#taxTotalValue').text(`$${totalTaxBudget.toFixed(2)}`);
        $('#grandTotalValue').text(`$${totalBudget.toFixed(2)}`);

        console.log('updateBudgetTotals completed');
    }

    function attachAutocomplete(selector, inventory) {
        selector.autocomplete({
            minLength: 1,
            source: inventory.map(item => ({
                label: `${item.part_number} - ${item.description}`,
                value: item.part_number
            })),
            select: function(event, ui) {
                const selectedInventory = inventory.find(item => item.part_number === ui.item.value);
                if (selectedInventory) {
                    $(this).closest('tr').find('.description').text(selectedInventory.description);
                    $(this).closest('tr').find('.cost').text(`$${selectedInventory.cost.toFixed(2)}`);
                }
            }
        });
    }

    function updateTotalLineCost(tr) {
        var quantity = parseInt(tr.find('.quantity input').val()) || 0;
        var cost = parseFloat(tr.find('.cost').text().replace('$', '')) || 0;
        var lineCost = quantity * cost;
        tr.find('.lineCost').text('$' + lineCost.toFixed(2));
    }


    function addOtherMaterialsButton(category) {
        const wrapperId = `${category.toLowerCase()}Wrapper`;
        const contentWrapper = $(`#${wrapperId}`);
        const otherMaterialsBtn = `
            <button onclick="showOtherMaterials('${category}')">Other Materials</button>
        `;
        contentWrapper.find('.action-buttons').append(otherMaterialsBtn);
    }
    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }

    let customerSearchTimeout;

    function searchCustomers(query) {
        $.ajax({
            url: '/search-customers',
            method: 'GET',
            data: { query: query },
            success: function(data) {
                displayCustomerResults(data);
            },
            error: function(error) {
                console.error('Error searching customers:', error);
            }
        });
    }
    function displayCustomerResults(customers) {
        const resultsDiv = $('#customerSearchResults');
        resultsDiv.empty();

        if (customers.length === 0) {
            resultsDiv.append('<p>No matching customers found.</p>');
        } else {
            const ul = $('<ul>');
            customers.forEach(customer => {
                ul.append(`<li data-customer='${JSON.stringify(customer)}'>${customer.customer_name}</li>`);
            });
            resultsDiv.append(ul);

            // Add click event to customer results
            resultsDiv.find('li').on('click', function() {
                const customer = JSON.parse($(this).attr('data-customer'));
                fillCustomerDetails(customer);
                resultsDiv.empty();
            });
        }
    }
    function getCsrfToken() {
        const tokenElement = document.getElementById('csrf_token');
        if (!tokenElement) {
            console.error('CSRF token element not found');
            return null;
        }
        return tokenElement.value;
    }

    function saveCustomer() {
        return new Promise((resolve, reject) => {
            const csrfToken = getCsrfToken();
            if (!csrfToken) {
                console.error('CSRF token is missing');
                reject(new Error('CSRF token is missing'));
                return;
            }

            const customerData = {
                customer_name: $('#customerName').val(),
                customer_address: $('#customerAddress').val(),
                customer_state: $('#customerState').val(),
                customer_city: $('#customerCity').val(),
                customer_zip: $('#customerZip').val()
            };

            console.log('Sending customer data:', customerData);

            $.ajax({
                url: '/save-customer',
                method: 'POST',
                data: JSON.stringify(customerData),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                success: function(response) {
                    console.log('Save customer response:', response);
                    if (response.status === 'new') {
                        if (confirm('Customer not found. Would you like to create a new customer?')) {
                            createNewCustomer(customerData, csrfToken)
                                .then(() => {
                                    console.log('New customer created successfully');
                                    resolve();
                                })
                                .catch(reject);
                        } else {
                            clearCustomerFields();
                            resolve();
                        }
                    } else {
                        console.log('Customer updated successfully');
                        resolve();
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('Error saving customer:', textStatus, errorThrown);
                    console.error('Response:', jqXHR.responseText);
                    reject(new Error(`Error saving customer: ${textStatus}`));
                }
            });
        });
    }
    function createNewCustomer(customerData, csrfToken) {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '/create-customer',
                method: 'POST',
                data: JSON.stringify(customerData),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                success: function(response) {
                    alert('New customer created successfully.');
                    resolve();
                },
                error: function(error) {
                    console.error('Error creating new customer:', error);
                    alert('Error creating new customer.');
                    reject(error);
                }
            });
        });
    }
    function clearCustomerFields() {
        $('#customerName').val('');
        $('#customerAddress').val('');
        $('#customerState').val('');
        $('#customerCity').val('');
        $('#customerZip').val('');
    }
</script>
</body>
</html>