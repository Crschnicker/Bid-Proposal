{% extends "layout.html" %}

{% block title %}Create Purchase Order{% endblock %}

{% block additional_styles %}
<style>
    .po-item-row {
        cursor: pointer;
    }

    .po-item-row.selected {
        background-color: #e2e8f0;
    }

    .history-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    .history-table th {
        background-color: #f8fafc;
        color: #1e293b;  
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border: 1px solid #e2e8f0;
    }

    .history-table td {
        padding: 12px;
        border: 1px solid #e2e8f0;
        color: #334155;
        background-color: white;
    }

    .history-table tr:hover {
        background-color: #f1f5f9;
    }

    .vendor-search-container {
        position: relative;
        width: 100%;
        overflow: visible;
    }

    .vendor-search-input {
        width: 100%;
        padding: 6px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        font-size: 14px;
    }

    .vendor-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 9999;
        display: none;
        margin-top: 2px;
    }

    .vendor-result-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }

    .vendor-result-item:last-child {
        border-bottom: none;
    }

    .vendor-result-item:hover {
        background-color: #f7fafc;
    }

    .purchase-order-container {
        max-width: 1400px;
        margin: 32px auto;
        padding: 16px;
        overflow: visible;
    }
    
    .po-header {
        background: white;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 24px;
    }

    .header-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .header-item {
        display: flex;
        flex-direction: column;
    }

    .header-item label {
        font-size: 12px;
        color: #64748b;
        margin-bottom: 4px;
    }

    .header-item .value {
        font-size: 16px;
        color: #1e293b;
        font-weight: 500;
    }

    .header-item input[type="date"] {
        padding: 8px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        font-size: 14px;
    }

    .ship-to-options {
        display: flex;
        gap: 20px;
        align-items: center;
        padding: 12px;
        background: #f8fafc;
        border-radius: 6px;
    }

    .ship-to-option {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .ship-to-option input[type="radio"] {
        width: 16px;
        height: 16px;
    }

    .budget-info {
        display: flex;
        gap: 24px;
        padding: 16px;
        background: #f1f5f9;
        border-radius: 6px;
        margin-top: 16px;
    }

    .budget-item {
        flex: 1;
    }

    .budget-item label {
        display: block;
        font-size: 12px;
        color: #64748b;
        margin-bottom: 4px;
    }

    .budget-item .amount {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
    }

    .action-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }

    .action-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }

    .history-btn {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
    }

    .comments-btn {
        background: linear-gradient(135deg, #9b59b6, #8e44ad);
        color: white;
    }

    .finalize-btn {
        background: linear-gradient(135deg, #27ae60, #219a52);
        color: white;
    }

    .save-btn {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .action-btn:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
        transform: none;
    }

    .items-table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: visible;
    }

    .items-table {
        width: 100%;
        border-collapse: collapse;
    }

    .items-table th {
        background: #f1f5f9;
        padding: 12px 16px;
        text-align: left;
        font-weight: 500;
        color: #475569;
        border-bottom: 2px solid #e2e8f0;
    }

    .items-table td {
        padding: 12px 16px;
        border-bottom: 1px solid #e2e8f0;
    }

    .items-table input, .items-table textarea {
        width: 100%;
        padding: 6px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        font-size: 14px;
    }

    .items-table input:focus, .items-table textarea:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52,152,219,0.2);
    }

    .numeric-cell {
        font-family: monospace;
        text-align: right;
    }

    .item-description {
        resize: vertical;
        min-height: 60px;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }

    .modal-content {
        position: relative;
        background: white;
        margin: 10% auto;
        padding: 24px;
        width: 80%;
        max-width: 800px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .modal-close {
        font-size: 24px;
        cursor: pointer;
        color: #64748b;
    }

    .comments-section {
        max-height: 400px;
        overflow-y: auto;
    }

    .comment-input {
        display: flex;
        gap: 12px;
        margin-top: 16px;
    }

    .comment-input textarea {
        flex: 1;
        padding: 8px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        resize: vertical;
        min-height: 60px;
    }

    .send-comment-btn {
        padding: 8px 16px;
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .comment-actions {
        display: flex;
        gap: 8px;
        margin-top: 4px;
    }

    .comment-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: #3498db;
        font-size: 12px;
        text-decoration: underline;
        padding: 0;
    }

    .comment-btn:hover {
        color: #1f6faf;
    }

    .debug-panel {
        display: none;
        position: fixed;
        bottom: 0;
        right: 0;
        width: 400px;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px 0 0 0;
        box-shadow: -2px -2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
    }

    .debug-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 16px;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        border-radius: 8px 0 0 0;
    }

    .debug-close {
        cursor: pointer;
        font-size: 20px;
        color: #64748b;
    }

    .debug-content {
        padding: 16px;
        max-height: 300px;
        overflow-y: auto;
    }

    .debug-controls {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
    }

    .debug-btn {
        padding: 6px 12px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .debug-btn:hover {
        background: #2563eb;
    }

    .debug-log {
        font-family: monospace;
        font-size: 12px;
        white-space: pre-wrap;
        word-break: break-all;
    }

    .debug-entry {
        margin-bottom: 8px;
        padding: 8px;
        border-radius: 4px;
        border-left: 3px solid #e2e8f0;
    }

    .debug-entry.success {
        background: #f0fdf4;
        border-left-color: #22c55e;
    }

    .debug-entry.error {
        background: #fef2f2;
        border-left-color: #ef4444;
    }

    .debug-timestamp {
        color: #64748b;
        font-size: 11px;
    }

    .history-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1100;
        max-width: 800px;
        width: 90%;
    }

    .history-modal .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .history-modal .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #64748b;
    }

    .history-modal .action-btn {
        padding: 4px 12px;
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .history-modal .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Edit Comment Modal */
    #editCommentModal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1100;
        max-width: 500px;
        width: 90%;
    }

    #editCommentModal .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #editCommentModal .modal-header h2 {
        margin: 0;
    }

    #editCommentModal textarea {
        width: 100%;
        min-height: 80px;
        margin-top: 10px;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #e2e8f0;
    }

    #editCommentModal button {
        margin-top: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="purchase-order-container">
    <div class="po-header">
        <div class="header-grid">
            <div class="header-item">
                <label>Purchase Order #</label>
                <div class="value">{{ po_number }}</div>
            </div>
            <div class="header-item">
                <label>Project Name</label>
                <div class="value">{{ bid.project_name }}</div>
            </div>
            <div class="header-item">
                <label>Type</label>
                <div class="value">{{ category|title }}</div>
            </div>
            <div class="header-item">
                <label>PO Date</label>
                <div class="value">{{ now.strftime('%Y-%m-%d') }}</div>
            </div>
            <div class="header-item">
                <label>Date Needed</label>
                <input type="date" id="dateNeeded" name="dateNeeded">
            </div>
        </div>

        <div class="ship-to-options">
            <div class="ship-to-option">
                <input type="radio" id="shipToJob" name="shipTo" value="job" checked>
                <label for="shipToJob">Ship to Job</label>
            </div>
            <div class="ship-to-option">
                <input type="radio" id="shipToYard" name="shipTo" value="yard">
                <label for="shipToYard">Ship to Yard</label>
            </div>
        </div>

        <div class="budget-info">
            <div class="budget-item">
                <label>Budget</label>
                <div class="amount">$<span id="budgetAmount">{{ "%.2f"|format(budget_amount) }}</span></div>
            </div>
            <div class="budget-item">
                <label>Actual</label>
                <div class="amount">$<span id="actualAmount">{{ "%.2f"|format(actual_amount) }}</span></div>
            </div>
            <div class="budget-item">
                <label>Complete</label>
                <div class="amount">
                    <span id="percentComplete">{{ "%.1f"|format(percent_complete) }}</span>%
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="action-btn history-btn" onclick="showPartHistory()">
                <i class="fas fa-history"></i> History
            </button>
            <button class="action-btn comments-btn" onclick="showComments()">
                <i class="fas fa-comments"></i> Comments
            </button>
            <button class="action-btn finalize-btn" onclick="finalizePO()" id="finalizeBtn" disabled>
                <i class="fas fa-check-circle"></i> Finalize Purchase Order
            </button>
            <button class="action-btn save-btn" onclick="saveAndClose()" id="saveBtn">
                <i class="fas fa-save"></i> Save and Close
            </button>
        </div>
    </div>

    <div class="items-table-container">
        <table class="items-table" id="poItemsTable">
            <thead>
                <tr>
                    <th>Part Number</th>
                    <th>Description</th>
                    <th>Bought Qty</th>
                    <th>Bid Qty</th>
                    <th>Bid Cost</th>
                    <th>Order Qty</th>
                    <th>Order Cost</th>
                    <th>Vendor</th>
                </tr>
            </thead>
            <tbody>
                <!-- Sort items by 'description' A->Z automatically -->
                {% for item in bid_items|sort(attribute='description') %}
                {% set saved = saved_items.get(item.part_number, {}) %}
                <tr data-part-number="{{ item.part_number }}">
                    <td>{{ item.part_number }}</td>
                    <td>
                        <textarea class="item-description"
                                  onchange="updateRowTotals(this)"
                                  onkeydown="handleEnterKey(event, this)">{{ saved.order_description if saved.order_description is defined else item.description }}</textarea>
                    </td>
                    <td class="numeric-cell">{{ bought_quantities[item.part_number]|default(0) }}</td>
                    <td class="numeric-cell">{{ item.quantity }}</td>
                    <td class="numeric-cell">${{ "%.2f"|format(item.cost) }}</td>
                    <td>
                        <input type="number"
                               class="order-qty"
                               min="0"
                               step="1"
                               onchange="updateRowTotals(this)"
                               onkeydown="handleEnterKey(event, this)"
                               data-max-qty="{{ item.quantity - bought_quantities[item.part_number]|default(0) }}"
                               value="{{ saved.order_qty if saved.order_qty is defined else '' }}">
                    </td>
                    <td>
                        <input type="number"
                               class="order-cost"
                               min="0"
                               step="0.01"
                               onchange="updateRowTotals(this)"
                               onkeydown="handleEnterKey(event, this)"
                               value="{{ saved.order_cost if saved.order_cost is defined else item.cost }}">
                    </td>
                    <td class="vendor-cell">
                        <div class="vendor-search-container" data-part-number="{{ item.part_number }}">
                            <input type="text"
                                   class="vendor-search-input"
                                   placeholder="Search vendor..."
                                   autocomplete="off"
                                   data-row-id="{{ loop.index }}"
                                   aria-label="Search vendors"
                                   onkeydown="handleVendorEnter(event, this)"
                                   {% if saved.vendor_id %}
                                   data-vendor-id="{{ saved.vendor_id }}"
                                   value="{{ saved.vendor_name }}"
                                   {% endif %}>
                            <div class="vendor-search-results" aria-live="polite"></div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Part History Modal -->
<div id="partHistoryModal" class="history-modal">
    <div class="modal-header">
        <h3>Part History</h3>
        <button onclick="closePartHistory()" class="modal-close">&times;</button>
    </div>
    <div id="partHistoryContent">
        <table class="history-table">
            <thead>
                <tr>
                    <th>PO Number</th>
                    <th>Date</th>
                    <th>Vendor</th>
                    <th>Quantity</th>
                    <th>Unit Cost</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="partHistoryTableBody">
            </tbody>
        </table>
    </div>
</div>

<!-- Comments Modal -->
<div id="commentsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Comments for PO #{{ po_number }}</h2>
            <span class="modal-close" onclick="closeModal('commentsModal')">&times;</span>
        </div>
        <div class="comments-section" id="commentsContent"></div>
        <div class="comment-input">
            <textarea id="newComment" placeholder="Type your comment here..."></textarea>
            <button class="send-comment-btn" onclick="addComment()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<!-- Edit Comment Modal -->
<div id="editCommentModal">
    <div class="modal-header">
        <h2>Edit Comment</h2>
        <span class="modal-close" onclick="closeModal('editCommentModal')">&times;</span>
    </div>
    <textarea id="editCommentText"></textarea>
    <button class="send-comment-btn" onclick="saveEditedComment()">Save Changes</button>
</div>

<div id="debugPanel" class="debug-panel">
    <div class="debug-header">
        <h3>API Debug Monitor</h3>
        <span class="debug-close" onclick="toggleDebugPanel()">&times;</span>
    </div>
    <div class="debug-content">
        <div class="debug-controls">
            <button onclick="testApiCall()" class="debug-btn">Test API Call</button>
            <button onclick="clearDebugLog()" class="debug-btn">Clear Log</button>
        </div>
        <div id="debugLog" class="debug-log"></div>
    </div>
</div>

<script>
    window.poNumber = "{{ po_number }}";
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    let selectedRow = null;
    let editCommentId = null;

    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
        initializeRowSelection();
        initVendorSearch();
        setupVendorSearchContainers();
        setupOrderQuantityHandlers();
    });

    function initializePage() {
        const dateNeeded = document.getElementById('dateNeeded');
        if (dateNeeded) {
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            dateNeeded.value = nextWeek.toISOString().split('T')[0];
        }

        checkFinalizeButton();
        initVendorSearch();
    }

    function initializeRowSelection() {
        document.querySelectorAll('#poItemsTable tbody tr').forEach(row => {
            row.classList.add('po-item-row');
            row.addEventListener('click', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.closest('.vendor-search-container')) {
                    return;
                }
                if (selectedRow) {
                    selectedRow.classList.remove('selected');
                }
                this.classList.add('selected');
                selectedRow = this;
            });
        });
    }

    function handleEnterKey(e, element) {
        if (e.key === 'Enter') {
            e.preventDefault();
            moveToNextField(element);
        }
    }

    function moveToNextField(current) {
        const row = current.closest('tr');
        const focusableSelectors = ['.item-description', '.order-qty', '.order-cost', '.vendor-search-input'];
        const allFocusable = Array.from(row.querySelectorAll(focusableSelectors.join(',')));

        const currentIndex = allFocusable.indexOf(current);
        if (currentIndex >= 0 && currentIndex < allFocusable.length - 1) {
            allFocusable[currentIndex + 1].focus();
        }
    }

    function moveToNextItemDescription(currentRow) {
        const nextRow = currentRow.nextElementSibling;
        if (nextRow && nextRow.querySelector('.item-description')) {
            nextRow.querySelector('.item-description').focus();
        }
    }

    async function showPartHistory() {
        if (!selectedRow) {
            alert('Please select a part first');
            return;
        }
        const partNumber = selectedRow.querySelector('td:first-child').textContent;
        const jobId = window.poNumber.split('-')[0];

        try {
            const response = await fetch(`/api/part-history/${jobId}/${partNumber}`);
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.message);
            }

            const tbody = document.getElementById('partHistoryTableBody');
            tbody.innerHTML = data.history.map(item => `
                <tr>
                    <td>${item.po_number}</td>
                    <td>${new Date(item.date).toLocaleDateString()}</td>
                    <td>${item.vendor_name}</td>
                    <td>${item.quantity}</td>
                    <td>$${item.unit_cost.toFixed(2)}</td>
                    <td>
                        <button onclick="openPO('${item.po_number}')" class="action-btn">Open</button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('partHistoryModal').style.display = 'block';
        } catch (error) {
            alert('Error fetching part history: ' + error.message);
        }
    }

    function closePartHistory() {
        document.getElementById('partHistoryModal').style.display = 'none';
    }

    function openPO(poNumber) {
        window.location.href = `/update-purchase-order/${poNumber}`;
    }

    function setupVendorSearchContainers() {
        const searchContainers = document.querySelectorAll('.vendor-search-container');
        let searchTimeout;

        searchContainers.forEach(container => {
            const input = container.querySelector('.vendor-search-input');
            const results = container.querySelector('.vendor-search-results');

            input.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();

                searchTimeout = setTimeout(() => {
                    if (query.length >= 2) {
                        searchVendors(query, results);
                    } else {
                        results.style.display = 'none';
                    }
                }, 300);
            });

            document.addEventListener('click', function(e) {
                if (!container.contains(e.target)) {
                    results.style.display = 'none';
                }
            });
        });
    }

    function setupOrderQuantityHandlers() {
        document.querySelectorAll('.order-qty').forEach(input => {
            input.addEventListener('change', function() {
                const row = this.closest('tr');
                const qty = parseFloat(this.value) || 0;
                if (qty > 0) {
                    row.classList.add('requires-vendor');
                } else {
                    row.classList.remove('requires-vendor');
                    row.classList.remove('has-vendor');
                }
                checkFinalizeButton();
            });
        });
    }

    function gatherPurchaseOrderData() {
        const items = [];
        document.querySelectorAll('#poItemsTable tbody tr').forEach(row => {
            const orderQty = parseFloat(row.querySelector('.order-qty')?.value) || 0;
            const descriptionInput = row.querySelector('.item-description');
            const descriptionValue = descriptionInput ? descriptionInput.value.trim() : '';

            if (orderQty > 0 || descriptionValue !== '') {
                const vendorInput = row.querySelector('.vendor-search-input');
                items.push({
                    part_number: row.dataset.partNumber,
                    description: descriptionValue,
                    order_qty: orderQty,
                    order_cost: parseFloat(row.querySelector('.order-cost')?.value) || 0,
                    vendor_id: vendorInput?.dataset.vendorId,
                    vendor_name: vendorInput?.value
                });
            }
        });

        return {
            po_number: window.poNumber,
            date_needed: document.getElementById('dateNeeded')?.value,
            ship_to_job: document.getElementById('shipToJob')?.checked,
            items: items
        };
    }

    function checkFinalizeButton() {
        const activeRows = Array.from(document.querySelectorAll('#poItemsTable tbody tr'))
            .filter(row => {
                const qty = parseFloat(row.querySelector('.order-qty')?.value) || 0;
                return qty > 0;
            });

        const hasItems = activeRows.length > 0;
        const allVendorsSelected = activeRows.every(row => {
            const vendorInput = row.querySelector('.vendor-search-input');
            return vendorInput?.dataset.vendorId;
        });

        const finalizeBtn = document.getElementById('finalizeBtn');
        if (finalizeBtn) {
            finalizeBtn.disabled = !hasItems || !allVendorsSelected;
            if (!hasItems) {
                finalizeBtn.title = 'Add items to finalize purchase order';
            } else if (!allVendorsSelected) {
                finalizeBtn.title = 'Select vendors for all ordered items';
            } else {
                finalizeBtn.title = 'Click to finalize purchase order';
            }
        }
    }

    function selectVendor(element, vendorId, vendorName, vendorCompany) {
        const container = element.closest('.vendor-search-container');
        const input = container.querySelector('.vendor-search-input');
        const results = container.querySelector('.vendor-search-results');
        
        if (input) {
            input.value = vendorName;
            input.dataset.vendorId = vendorId;
            input.dataset.vendorName = vendorName;
            input.dataset.vendorCompany = vendorCompany;
        }
        
        if (results) {
            results.style.display = 'none';
        }
        
        const row = container.closest('tr');
        if (row) {
            const qty = parseFloat(row.querySelector('.order-qty')?.value) || 0;
            if (qty > 0) {
                row.classList.add('has-vendor');
            }
        }
        
        checkFinalizeButton();
        moveToNextItemDescription(row);
    }

    function initVendorSearch() {
        const searchContainers = document.querySelectorAll('.vendor-search-container');
        
        searchContainers.forEach(container => {
            const input = container.querySelector('.vendor-search-input');
            input.addEventListener('keydown', e => handleVendorEnter(e, input));
        });
    }

    function handleVendorEnter(e, input) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const container = input.closest('.vendor-search-container');
            const results = container.querySelector('.vendor-search-results');
            if (results.style.display !== 'none') {
                const items = Array.from(results.querySelectorAll('.vendor-result-item'));
                if (items.length === 1) {
                    items[0].click();
                } else {
                    moveToNextField(input);
                    results.style.display = 'none';
                }
            } else {
                moveToNextField(input);
            }
        }
    }

    async function searchVendors(query, resultsContainer) {
        try {
            const response = await fetch(`/search-vendors?query=${encodeURIComponent(query)}`);
            if (!response.ok) throw new Error('Network response was not ok');
            
            const vendors = await response.json();
            
            if (!vendors || vendors.length === 0) {
                resultsContainer.innerHTML = '<div class="vendor-result-item">No vendors found</div>';
                resultsContainer.style.display = 'block';
                return;
            }

            resultsContainer.innerHTML = vendors.map(vendor => `
                <div class="vendor-result-item"
                    onclick="selectVendor(this, '${vendor.id}', '${vendor.company}', '${vendor.company}')"
                    role="option"
                    tabindex="0">
                    <div class="vendor-company" style="font-weight:bold; text-transform:uppercase;">${vendor.company || ''}</div>
                    <div class="vendor-name" style="font-size:12px;">${vendor.name}</div>
                    <div class="vendor-phone" style="font-size:12px; color:#718096;">${vendor.phone_number || ''}</div>
                </div>
            `).join('');

            resultsContainer.style.display = 'block';

        } catch (error) {
            console.error('Error searching vendors:', error);
            resultsContainer.innerHTML = '<div class="vendor-result-item">Error searching vendors</div>';
            resultsContainer.style.display = 'block';
        }
    }

    function updateRowTotals(input) {
        const row = input.closest('tr');
        if (!row) return;

        const orderQtyInput = row.querySelector('.order-qty');
        const orderCostInput = row.querySelector('.order-cost');
        if (!orderQtyInput || !orderCostInput) return;

        const orderQty = parseFloat(orderQtyInput.value) || 0;
        const orderCost = parseFloat(orderCostInput.value) || 0;
        const maxQty = parseFloat(orderQtyInput.dataset.maxQty) || 0;

        if (orderQty > maxQty && !row.dataset.confirmedOverage) {
            const proceed = confirm(`You are ordering more than the bid quantity. Proceed?`);
            if (!proceed) {
                orderQtyInput.value = maxQty;
                return;
            } else {
                row.dataset.confirmedOverage = "true";
            }
        }

        calculateTotals();
    }

    function calculateTotals() {
        let totalAmount = 0;
        document.querySelectorAll('#poItemsTable tbody tr').forEach(row => {
            const qty = parseFloat(row.querySelector('.order-qty')?.value) || 0;
            const cost = parseFloat(row.querySelector('.order-cost')?.value) || 0;
            totalAmount += qty * cost;
        });

        const totalElement = document.getElementById('totalAmount');
        if (totalElement) {
            totalElement.textContent = `$${totalAmount.toFixed(2)}`;
        }
    }

    async function saveAndClose() {
        try {
            const data = gatherPurchaseOrderData();
            const response = await fetch('/api/purchase-order/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message);
            }

            const jobId = window.poNumber.split('-')[0];
            window.location.href = `/purchase-orders?job_id=${jobId}`;
        } catch (error) {
            console.error('Error saving purchase order:', error);
            alert('Error saving purchase order: ' + error.message);
        }
    }

    async function finalizePO() {
        if (!confirm('Are you sure you want to finalize this purchase order?')) {
            return;
        }

        try {
            const data = gatherPurchaseOrderData();
            await fetch('/api/purchase-order/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(data)
            });

            const response = await fetch(`/api/purchase-order/${window.poNumber}/finalize`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            });

            const result = await response.json();
            
            if (!response.ok) {
                if (result.errors && result.errors.length > 0) {
                    const errorMessage = result.errors.join('\n• ');
                    alert('Cannot finalize purchase order:\n\n• ' + errorMessage);
                } else {
                    throw new Error(result.message || 'Failed to finalize purchase order');
                }
                return;
            }
            
            if (result.success) {
                result.finalized_pos.forEach(poInfo => {
                    const completePdfBlob = base64ToBlob(poInfo.complete_pdf, 'application/pdf');
                    downloadBlob(completePdfBlob, `PO_${poInfo.po_number}_complete.pdf`);
                    const noCostPdfBlob = base64ToBlob(poInfo.no_cost_pdf, 'application/pdf');
                    downloadBlob(noCostPdfBlob, `PO_${poInfo.po_number}_no_cost.pdf`);
                });

                alert('All vendor-specific purchase orders finalized successfully');
                if (result.redirect_url) {
                    window.location.href = result.redirect_url;
                } else {
                    window.location.href = '/purchase-orders';
                }
            } else {
                alert('Cannot finalize purchase order: ' + result.message);
            }
            
        } catch (error) {
            console.error('Error finalizing purchase order:', error);
            alert('Error finalizing purchase order: ' + error.message);
        }
    }

    function base64ToBlob(base64, type = 'application/pdf') {
        const binaryString = window.atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return new Blob([bytes], { type: type });
    }

    function downloadBlob(blob, filename) {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }

    async function showComments() {
        try {
            const response = await fetch(`/api/purchase-order/${poNumber}/comments`);
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message);
            }

            const commentsContent = document.getElementById('commentsContent');
            commentsContent.innerHTML = data.comments.map(comment => `
                <div class="comment-item" data-comment-id="${comment.id}">
                    <div class="comment-header">
                        <span class="comment-user">${comment.user}</span>
                        <span class="comment-timestamp">${new Date(comment.created_at).toLocaleString()}</span>
                    </div>
                    <div class="comment-text">${comment.text}</div>
                    <div class="comment-actions">
                        <button class="comment-btn" onclick="editComment(${comment.id}, '${encodeURIComponent(comment.text)}')">Edit</button>
                        <button class="comment-btn" style="color:red;" onclick="deleteComment(${comment.id})">Delete</button>
                    </div>
                </div>
            `).join('');

            document.getElementById('commentsModal').style.display = 'block';
            
        } catch (error) {
            alert('Error loading comments: ' + error.message);
        }
    }

    async function addComment() {
        const commentText = document.getElementById('newComment').value.trim();
        if (!commentText) return;

        try {
            const response = await fetch(`/api/purchase-order/${poNumber}/comments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ text: commentText })
            });

            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message);
            }

            document.getElementById('newComment').value = '';
            await showComments();
            
        } catch (error) {
            alert('Error adding comment: ' + error.message);
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function testApiCall() {
        // For debugging if needed
    }

    function clearDebugLog() {
        const debugLog = document.getElementById('debugLog');
        if (debugLog) debugLog.innerHTML = '';
    }

    function toggleDebugPanel() {
        const panel = document.getElementById('debugPanel');
        panel.style.display = (panel.style.display === 'none' || !panel.style.display) ? 'block' : 'none';
    }

    async function editComment(commentId, commentText) {
        editCommentId = commentId;
        const decodedText = decodeURIComponent(commentText);
        document.getElementById('editCommentText').value = decodedText;
        document.getElementById('editCommentModal').style.display = 'block';
    }

    async function saveEditedComment() {
        const newText = document.getElementById('editCommentText').value.trim();
        if (!newText) {
            alert('Comment text cannot be empty.');
            return;
        }

        try {
            const response = await fetch(`/api/purchase-order/${poNumber}/comments/${editCommentId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ text: newText })
            });

            const result = await response.json();

            if (!result.success) {
                throw new Error(result.message);
            }

            // Refresh comments and close modal
            await showComments();
            closeModal('editCommentModal');
        } catch (error) {
            alert('Error editing comment: ' + error.message);
        }
    }

    async function deleteComment(commentId) {
        if (!confirm('Are you sure you want to delete this comment?')) {
            return;
        }

        try {
            const response = await fetch(`/api/purchase-order/${poNumber}/comments/${commentId}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });

            const result = await response.json();

            if (!result.success) {
                throw new Error(result.message);
            }

            await showComments();
        } catch (error) {
            alert('Error deleting comment: ' + error.message);
        }
    }

    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }
</script>
{% endblock %}
