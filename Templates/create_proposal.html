{% extends "layout.html" %} {% block title %}Proposal Generation - {{ bid.bid_id
}}{% endblock %} {% block additional_styles %}
<!-- Google Fonts -->
<link
  href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap"
  rel="stylesheet"
/>
<!-- jQuery UI CSS -->
<link
  rel="stylesheet"
  href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
/>

<!-- Bootstrap CSS -->
<link
  rel="stylesheet"
  href="https://maxcdn.bootstrapcdn.com/bootstrap/4.6.0/css/bootstrap.min.css"
/>

<!-- Font Awesome for Icons -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
/>

<style>
  body {
    font-family: "Roboto", sans-serif;
    background: #f4f7f6;
    margin: 0;
    padding: 20px;
  }

  .container {
    width: 100%;
    max-width: none;
    padding: 0;
  }

  /* Header Styles */
  .proposal-header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    width: 100%;
  }

  .proposal-header-container h1 {
    font-size: 2.5em;
    color: #007bff;
  }

  .proposal-header-container .save-button-container button {
    padding: 12px 24px;
    font-size: 1.2em;
    background-color: #4caf50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
  }

  .proposal-header-container .save-button-container button:hover {
    background-color: #45a049;
  }

  /* Tab Navigation Styles */
  .tab-container {
    display: flex;
    justify-content: space-between;
    background-color: #f1f1f1;
    border-bottom: 1px solid #ccc;
    width: 100%;
  }

  .tab-button {
    flex-grow: 1;
    background-color: #f0f0f0;
    color: #333;
    border: 1px solid #ccc;
    padding: 12px 24px;
    cursor: pointer;
    transition: background-color 0.3s;
    font-size: 1.1em;
    text-align: center;
  }

  .tab-button:hover {
    background-color: #e0e0e0;
  }

  .tab-button.active {
    background-color: #007bff;
    color: white;
  }

  /* Tab Content Styles */
  .tabcontent {
    display: none;
    width: 100%;
    padding: 30px;
    border: 1px solid #007bff;
    border-top: none;
    background-color: #fff;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    border-radius: 0 0 5px 5px;
    font-size: 1.1em;
  }

  .tabcontent.active {
    display: block;
  }

  /* Heading layout adjustments */
  .heading-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 30px;
  }

  /* Form and Input Styles */
  .detail-container {
    display: flex;
    flex-direction: column;
  }

  .detail-container label {
    font-size: 1.1em;
    font-weight: bold;
    margin-bottom: 10px;
  }

  .detail-container input[type="text"],
  .detail-container input[type="number"],
  .detail-container textarea {
    width: 100%;
    padding: 12px;
    font-size: 1.1em;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  /* Remove up/down arrows in input[type=number] (Chrome, Safari, Edge, Opera) */
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  /* Remove up/down arrows in input[type=number] (Firefox) */
  input[type="number"] {
    -moz-appearance: textfield;
  }

  /* Info Section Styles */
  .info-section {
    border: 1px solid #ccc;
    padding: 20px;
    border-radius: 5px;
    background-color: #f9f9f9;
    margin-bottom: 30px;
  }

  .info-section h3 {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 1.5em;
    color: #007bff;
  }

  .info-section table {
    width: 100%;
  }

  .info-section table th,
  .info-section table td {
    padding: 12px;
    text-align: left;
  }

  .info-section table th {
    width: 30%;
    font-weight: bold;
  }

  .info-section table input[type="text"],
  .info-section table input[type="number"],
  .info-section table textarea {
    width: 100%;
    padding: 10px;
    font-size: 1.1em;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  /* Button Styles */
  .btn-sm,
  .delete-btn,
  .add-line-btn {
    padding: 5px 10px;
    font-size: 0.9em;
  }

  /* Updated Delete Button Styles */
  .delete-btn {
    width: 100px;
    height: 30px;
    padding: 0;
    font-size: 0.9em;
    background-color: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .delete-btn:hover {
    background-color: #c82333;
  }

  .add-line-btn {
    margin-top: 10px;
  }

  .add-buttons-container {
    display: flex;
    justify-content: flex-start;
    margin-top: 20px;
  }

  .add-buttons-container button {
    margin-right: 10px;
    padding: 5px 10px;
    font-size: 0.9em;
    width: auto;
  }

  /* Table Styles */
  table {
    width: 100%;
    border-collapse: collapse;
    background-color: #fff;
    margin-bottom: 30px;
  }

  .table td,
  .table th,
  th,
  td {
    padding: 15px;
    text-align: left;
    border-bottom: 1px solid #e1e1e1;
    vertical-align: middle;
  }

  th {
    background: linear-gradient(180deg, #e9eff9 0%, #dce4f1 100%);
    color: #333;
    font-weight: 600;
    border-bottom: 2px solid #007bff;
    font-size: 1.2em;
  }

  tbody tr:nth-child(odd) {
    background-color: #f9f9f9;
  }

  tbody tr:hover {
    background-color: #eef4fb;
  }

  /* Budget Summary */
  .budget-summary-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
  }

  .budget-summary-table th,
  .budget-summary-table td {
    padding: 15px;
    border: 1px solid #ddd;
    font-size: 1.1em;
  }

  .budget-summary-table th {
    background-color: #f2f2f2;
    text-align: left;
  }

  .grand-total td {
    background-color: #e6f3ff;
    font-weight: bold;
    color: #007bff;
    font-size: 1.2em;
  }

  /* Component Styles */
  .component {
    margin-bottom: 30px;
  }

  .component-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    cursor: move; /* Makes the header the "drag handle" */
  }

  .component-name {
    flex-grow: 1;
    margin-right: 10px;
  }

  .lines-container {
    margin-bottom: 20px;
  }

  .lines-container table {
    margin-bottom: 0;
  }

  .lines-container .line-name,
  .lines-container .line-value {
    font-size: 1.2em;
  }

  .component-separator {
    border: none;
    border-top: 2px dashed #ccc;
    margin: 30px 0;
  }

  .phase,
  .section {
    transition: all 0.3s ease;
  }

  .phase-header,
  .section-header {
    cursor: pointer;
  }

  .line {
    transition: all 0.2s ease;
  }

  /* Action Buttons */
  .action-buttons {
    display: flex;
    justify-content: flex-start;
    margin: 20px 0;
    gap: 10px;
  }

  .action-buttons button {
    padding: 8px 16px;
    font-size: 1.1em;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    transition: background-color 0.2s, box-shadow 0.2s;
  }

  .action-buttons .btn-primary {
    background-color: #007bff;
    color: white;
  }

  .action-buttons .btn-primary:hover {
    background-color: #0056b3;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16);
  }

  .action-buttons .btn-danger {
    background-color: #dc3545;
    color: white;
  }

  .action-buttons .btn-danger:hover {
    background-color: #c82333;
  }

  /* Loading Overlay */
  #loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  .spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  /* Terms and Conditions */
  .term-row {
    border-bottom: 1px solid #ddd;
  }

  .term-content {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 15px;
    position: relative;
  }

  .term-textarea {
    flex-grow: 1;
    width: calc(100% - 70px);
    min-height: 100px;
    resize: vertical;
    border: 1px solid #ccc;
    padding: 12px;
    border-radius: 4px;
    font-size: 1.1em;
  }

  .term-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .term-actions .btn {
    padding: 8px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.3s ease;
  }

  .term-textarea:read-only {
    background-color: #f8f9fa;
    border-color: #e9ecef;
  }

  .term-textarea:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    outline: none;
  }

  /* Special Notes Styling */
  .special-note {
    font-family: "Open Sans", sans-serif;
    font-size: 1.1em;
    line-height: 1.6;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    resize: vertical;
    width: 100%;
    min-height: 80px;
  }

  /* Section Phase Container */
  .section-phase-container {
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .table-header {
    margin-bottom: 25px;
  }

  .table-header h3 {
    font-size: 1.75em;
    color: #2c3e50;
    margin: 0;
    font-weight: 600;
  }

  /* Responsive Adjustments */
  @media (max-width: 768px) {
    .heading-grid {
      grid-template-columns: 1fr;
    }

    .term-textarea {
      width: calc(100% - 50px);
    }

    .term-actions .btn {
      width: 35px;
      height: 35px;
    }
  }

  /* Options Table */
  #optionsTable .remove-btn {
    padding: 8px 12px;
    font-size: 1em;
  }

  #optionsTable .btn {
    margin-left: 10px;
  }

  #optionsTable td:last-child {
    text-align: right;
  }
</style>
{% endblock %} {% block content %}
<!-- CSRF Token and Bid ID -->
<input
  type="hidden"
  name="csrf_token"
  id="csrf_token"
  value="{{ csrf_token() }}"
/>
<input type="hidden" id="bidId" value="{{ bid.bid_id }}" />

<div class="container">
  <div class="proposal-header-container">
    <h1>Proposal Generation - {{ bid.bid_id if bid else 'New Proposal' }}</h1>
    <div class="save-button-container">
      <button type="button" id="saveProposalBtn" class="btn btn-success">
        Save Proposal
      </button>
    </div>
  </div>

  <form action="/submit-proposal-data" method="POST" id="proposalForm">
    <!-- Hidden Fields -->
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <input type="hidden" name="next_tab" id="nextTabField" value="" />
    <input
      type="hidden"
      name="bid_id"
      id="bidIdField"
      value="{{ bid.bid_id if bid else '' }}"
    />

    <div class="tab-container">
      <button
        type="button"
        class="tab-button active"
        onclick="openTab(event, 'Heading')"
      >
        Heading
      </button>
      <button
        type="button"
        class="tab-button"
        onclick="openTab(event, 'Sections')"
      >
        Sections
      </button>
      <button
        type="button"
        class="tab-button"
        onclick="openTab(event, 'Options')"
      >
        Options
      </button>
      <button
        type="button"
        class="tab-button"
        onclick="openTab(event, 'SpecialNotes')"
      >
        Special Notes
      </button>
      <button
        type="button"
        class="tab-button"
        onclick="openTab(event, 'Exclusions')"
      >
        Exclusions
      </button>
      <button
        type="button"
        class="tab-button"
        onclick="openTab(event, 'TermsConditions')"
      >
        Terms/Conditions
      </button>
      <button type="button" class="tab-button" onclick="generateReport()">
        Generate Proposal
      </button>
    </div>

    <!-- Heading Tab Content -->
    <div id="Heading" class="tabcontent active">
      <div class="heading-grid">
        <div class="info-section">
          <h3>Proposal Information</h3>
          <table>
            <tr>
              <th>Bid/Job ID</th>
              <td>
                <input
                  type="text"
                  id="bidJobId"
                  value="{{ proposal_data.get('proposal_info', {}).get('bid_id', '') }}"
                  readonly
                />
              </td>
            </tr>
            <tr>
              <th>Bid Date</th>
              <td>
                <input
                  type="text"
                  id="bidDate"
                  value="{{ proposal_data.get('proposal_info', {}).get('bid_date', '') }}"
                  readonly
                />
              </td>
            </tr>
            <tr>
              <th>Total Budget ($)</th>
              <td>
                <input
                  type="text"
                  id="totalBudget"
                  value="{{ '{:.2f}'.format(proposal_data.get('proposal_info', {}).get('total_budget') or 0) }}"
                  readonly
                />
              </td>
            </tr>
            <tr>
              <th>Point of Contact</th>
              <td>
                <input
                  type="text"
                  id="pointOfContact"
                  name="pointOfContact"
                  value="{{ proposal_data.get('proposal_info', {}).get('point_of_contact', '') }}"
                />
              </td>
            </tr>
          </table>
        </div>

        <div class="info-section">
          <h3>Customer Information</h3>
          <table>
            <tr>
              <th>Name</th>
              <td>
                <input
                  type="text"
                  id="customerName"
                  name="customerName"
                  value="{{ proposal_data.get('proposal_info', {}).get('customer_name', '') }}"
                  readonly
                />
              </td>
            </tr>
            <tr>
              <th>Address</th>
              <td>
                <input
                  type="text"
                  id="customerAddress"
                  name="customerAddress"
                  value="{{ proposal_data.get('customer_info', {}).get('address', '') }}"
                  readonly
                />
              </td>
            </tr>
            <tr>
              <th>City</th>
              <td>
                <input
                  type="text"
                  id="customerCity"
                  name="customerCity"
                  value="{{ proposal_data.get('customer_info', {}).get('city', '') }}"
                  readonly
                />
              </td>
            </tr>
            <tr>
              <th>State</th>
              <td>
                <input
                  type="text"
                  id="customerState"
                  name="customerState"
                  value="{{ proposal_data.get('customer_info', {}).get('state', '') }}"
                  readonly
                />
              </td>
            </tr>
            <tr>
              <th>Zip Code</th>
              <td>
                <input
                  type="text"
                  id="customerZip"
                  name="customerZip"
                  value="{{ proposal_data.get('customer_info', {}).get('zip', '') }}"
                  readonly
                />
              </td>
            </tr>
          </table>
        </div>

        <div class="info-section">
          <h3>Job Information</h3>
          <table>
            <tr>
              <th>Name</th>
              <td>
                <input
                  type="text"
                  id="jobName"
                  name="jobName"
                  value="{{ proposal_data.get('proposal_info', {}).get('project_name', '') }}"
                  readonly
                />
              </td>
            </tr>
            <tr>
              <th>City</th>
              <td>
                <input
                  type="text"
                  id="jobCity"
                  name="jobCity"
                  value="{{ proposal_data.get('proposal_info', {}).get('project_city', '') }}"
                  readonly
                />
              </td>
            </tr>
            <tr>
              <th>Revision Number</th>
              <td>
                <input
                  type="text"
                  id="revisionNumber"
                  name="revisionNumber"
                  value="{{ proposal_data.get('proposal_info', {}).get('revision_number', '') }}"
                  readonly
                />
              </td>
            </tr>
            <tr>
              <th>Drains Labor Rate</th>
              <td>
                <input
                  type="number"
                  id="drainsLaborRate"
                  name="drainsLaborRate"
                  value="{{ proposal_data.get('labor_rates', {}).get('drains_labor_rate', 0) }}"
                  readonly
                />
              </td>
            </tr>
            <tr>
              <th>Irrigation Labor Rate</th>
              <td>
                <input
                  type="number"
                  id="irrigationLaborRate"
                  name="irrigationLaborRate"
                  value="{{ proposal_data.get('labor_rates', {}).get('irrigation_labor_rate', 0) }}"
                  readonly
                />
              </td>
            </tr>
            <tr>
              <th>Landscape Labor Rate</th>
              <td>
                <input
                  type="number"
                  id="landscapeLaborRate"
                  name="landscapeLaborRate"
                  value="{{ proposal_data.get('labor_rates', {}).get('landscape_labor_rate', 0) }}"
                  readonly
                />
              </td>
            </tr>
            <tr>
              <th>Maintenance Labor Rate</th>
              <td>
                <input
                  type="number"
                  id="maintenanceLaborRate"
                  name="maintenanceLaborRate"
                  value="{{ proposal_data.get('labor_rates', {}).get('maintenance_labor_rate', 0) }}"
                  readonly
                />
              </td>
            </tr>
            <tr>
              <th>Local Sales Tax (%)</th>
              <td>
                <input
                  type="number"
                  id="localSalesTax"
                  name="localSalesTax"
                  value="{{ proposal_data.get('labor_rates', {}).get('local_sales_tax', 0) }}"
                  readonly
                />
              </td>
            </tr>
          </table>
        </div>

        <div class="info-section">
          <h3>Architect/Engineer Information</h3>
          <table>
            <tr>
              <th>Architect Name</th>
              <td>
                <input
                  type="text"
                  id="architectName"
                  name="architectName"
                  value="{{ proposal_data.get('proposal_info', {}).get('architect_name', '') }}"
                />
              </td>
            </tr>
            <tr>
              <th>Architect Specifications</th>
              <td>
                <input
                  type="text"
                  id="architectSpecifications"
                  name="architectSpecifications"
                  value="{{ proposal_data.get('proposal_info', {}).get('architect_specifications', '') }}"
                />
              </td>
            </tr>
            <tr>
              <th>Architect Dated</th>
              <td>
                <input
                  type="text"
                  id="architectDated"
                  name="architectDated"
                  value="{{ proposal_data.get('proposal_info', {}).get('architect_dated', '') }}"
                />
              </td>
            </tr>
            <tr>
              <th>Architect Sheets</th>
              <td>
                <input
                  type="text"
                  id="architectSheets"
                  name="architectSheets"
                  value="{{ proposal_data.get('proposal_info', {}).get('architect_sheets', '') }}"
                />
              </td>
            </tr>
            <tr>
              <th>Engineer Name</th>
              <td>
                <input
                  type="text"
                  id="engineerName"
                  name="engineerName"
                  value="{{ proposal_data.get('proposal_info', {}).get('engineer_name', '') }}"
                />
              </td>
            </tr>
            <tr>
              <th>Engineer Specifications</th>
              <td>
                <input
                  type="text"
                  id="engineerSpecifications"
                  name="engineerSpecifications"
                  value="{{ proposal_data.get('proposal_info', {}).get('engineer_specifications', '') }}"
                />
              </td>
            </tr>
            <tr>
              <th>Engineer Dated</th>
              <td>
                <input
                  type="text"
                  id="engineerDated"
                  name="engineerDated"
                  value="{{ proposal_data.get('proposal_info', {}).get('engineer_dated', '') }}"
                />
              </td>
            </tr>
            <tr>
              <th>Engineer Sheets</th>
              <td>
                <input
                  type="text"
                  id="engineerSheets"
                  name="engineerSheets"
                  value="{{ proposal_data.get('proposal_info', {}).get('engineer_sheets', '') }}"
                />
              </td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <!-- Updated Sections Tab HTML -->
    <div id="Sections" class="tabcontent">
      <div class="section-phase-container">
        <div id="sectionsContainer">
          <!-- Sections will be dynamically added here -->
        </div>

        <div class="add-buttons-container">
          <button
            type="button"
            class="btn btn-primary btn-sm"
            onclick="addComponent()"
          >
            <i class="fas fa-plus"></i> Add Section/Phase
          </button>
        </div>
      </div>
    </div>

    <!-- Options Tab Content -->
    <div id="Options" class="tabcontent">
      <div class="info-section">
        <table id="optionsTable" class="table table-bordered">
          <thead>
            <tr>
              <th>Description</th>
              <th>Amount ($)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <!-- Existing options will be populated here -->
          </tbody>
        </table>
        <div class="action-buttons">
          <button
            type="button"
            onclick="addOptionLine(event)"
            class="btn btn-primary"
          >
            <i class="fas fa-plus"></i> Add Line
          </button>
        </div>
      </div>
    </div>

    <!-- Exclusions Tab Content -->
    <div id="Exclusions" class="tabcontent">
      <div class="section-phase-container">
        <div class="table-header">
          <h3>Exclusions</h3>
        </div>
        <div class="info-section">
          <textarea
            id="exclusionsTextarea"
            name="exclusions"
            class="form-control special-note"
            rows="10"
          >
Water meter service and hot taps, power for clocks, permits, all hardscape, all grading, import/export of soil, clearing or removal of any existing erosion control devices, demolition, grubbing, rodent control, water cost, downspout connections unless noted, and overtime.</textarea
          >
        </div>
        <div class="action-buttons">
          <button
            type="button"
            class="btn btn-primary"
            onclick="addExclusion()"
          >
            <i class="fas fa-plus"></i> Add Exclusion
          </button>
        </div>
      </div>
    </div>

    <!-- Special Notes Tab Content -->
    <div id="SpecialNotes" class="tabcontent">
      <div class="section-phase-container">
        <div class="table-header">
          <h3>Special Notes</h3>
        </div>
        <div class="info-section">
          <table
            id="specialNotesTable"
            class="table table-bordered modern-table"
          >
            <thead>
              <tr>
                <th>Special Note</th>
                <th width="100">Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- Special notes will be dynamically added here -->
            </tbody>
          </table>
          <div class="action-buttons">
            <button
              type="button"
              onclick="addSpecialNoteLine()"
              class="btn btn-primary"
            >
              <i class="fas fa-plus"></i> Add Special Note
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Terms and Conditions Tab Content -->
    <div id="TermsConditions" class="tabcontent">
      <div class="section-phase-container">
        <div class="table-header">
          <h3>Terms & Conditions</h3>
        </div>
        <div class="info-section">
          <table
            id="termsConditionsTable"
            class="table table-bordered modern-table"
          >
            <thead>
              <tr>
                <th>Term</th>
              </tr>
            </thead>
            <tbody>
              <!-- Terms will be dynamically added here -->
            </tbody>
          </table>
          <div class="action-buttons">
            <button
              type="button"
              onclick="addCustomTerm()"
              class="btn btn-primary"
            >
              <i class="fas fa-plus"></i> Add Custom Term
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.6.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

    <script>
      // Function to get special notes
      function getSpecialNotes() {
        const specialNotes = [];
        const specialNotesRows = document.querySelectorAll(
          "#specialNotesTable tbody tr"
        );
        specialNotesRows.forEach((row) => {
          const noteTextarea = row.querySelector("textarea.special-note");
          if (noteTextarea && noteTextarea.value.trim()) {
            specialNotes.push(noteTextarea.value.trim());
          }
        });
        return specialNotes;
      }

      // Function to get terms and conditions
      function getTermsAndConditions() {
        const termsAndConditions = [];
        const termRows = document.querySelectorAll(
          "#termsConditionsTable tbody .term-row"
        );
        termRows.forEach((row) => {
          const termTextarea = row.querySelector("textarea.term-textarea");
          if (termTextarea && termTextarea.value.trim()) {
            termsAndConditions.push(termTextarea.value.trim());
          }
        });
        return termsAndConditions;
      }

      // Function to get exclusions
      function getExclusions() {
        return document.getElementById("exclusionsTextarea").value.trim();
      }

      function createLineElement(line) {
        return `
            <tr>
                <td><input type="text" class="form-control line-name" value="${line.name}"></td>
                <td><input type="number" class="form-control line-value" value="${line.value}"></td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm delete-btn" onclick="removeLine(this)">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            </tr>
        `;
      }

      function generateReport() {
    const proposalData = gatherProposalData();

    // Utility functions
    function formatNumberWithCommas(x) {
        if (typeof x === "number") {
            x = x.toFixed(2);
        }
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
            month: "2-digit",
            day: "2-digit",
            year: "numeric",
        });
    }

    function getOrdinal(n) {
        // Adjust revision number display (1st revision means original)
        n = n - 1;
        if (n <= 0) return "";

        const j = n % 10,
            k = n % 100;
        if (j === 1 && k !== 11) {
            return n + "st";
        }
        if (j === 2 && k !== 12) {
            return n + "nd";
        }
        if (j === 3 && k !== 13) {
            return n + "rd";
        }
        return n + "th";
    }

    function createSectionHTML(section) {
        // Calculate the total value for the section
        const sectionTotal = section.lines.reduce(
            (total, line) => total + (line.value || 0),
            0
        );

        return `
            <div class="section">
                <h3 class="section-heading word-wrap">${section.name}</h3>
                <table class="section-table">
                    <tbody>
                        ${section.lines
                            .map(
                                (line) => `
                            <tr>
                                <td class="line-name word-wrap">${line.name || ""}</td>
                                <td class="line-value bold word-wrap">
                                    <span class="currency-symbol">$</span>
                                    <span class="value">${formatNumberWithCommas(
                                        line.value || 0
                                    )}</span>
                                </td>
                            </tr>
                            `
                            )
                            .join("")}
                        <tr class="section-total">
                            <td class="line-name bold word-wrap">Total ${section.name}</td>
                            <td class="line-value bold word-wrap">
                                <span class="currency-symbol">$</span>
                                <span class="value">${formatNumberWithCommas(
                                    sectionTotal
                                )}</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        `;
    }

    // Generate report content
    const bidId = proposalData.bid_id || "proposal";
    const currentDate = new Date().toISOString().slice(0, 10);
    const filename = `${bidId}_${currentDate}.pdf`;

    // Conditionally render OPTIONS section only if we have data
    const optionsSection =
        proposalData.options && proposalData.options.length > 0
            ? `
                <div class="section options-section">
                    <h3 class="section-heading word-wrap">OPTIONS</h3>
                    <table class="section-table">
                        <tbody>
                            ${proposalData.options
                                .map(
                                    (option) => `
                                <tr>
                                    <td class="line-name word-wrap">${option.description || ""}</td>
                                    <td class="line-value bold word-wrap">
                                        <span class="currency-symbol">$</span>
                                        <span class="value">${formatNumberWithCommas(option.amount || 0)}</span>
                                    </td>
                                </tr>
                            `
                                )
                                .join("")}
                        </tbody>
                    </table>
                </div>
            `
            : "";

    // Conditionally render SPECIAL NOTES section only if we have data
    const specialNotesSection =
        proposalData.special_notes && proposalData.special_notes.length > 0
            ? `
                <div class="section">
                    <h3 class="section-heading word-wrap">SPECIAL NOTES</h3>
                    <ol class="special-notes-list">
                        ${proposalData.special_notes
                            .map((note) => `<li class="bold">${note || ""}</li>`)
                            .join("")}
                    </ol>
                </div>
            `
            : "";

    // Handle terms_conditions safely
    function getTermsConditionsHTML() {
        let termsConditionsArray = proposalData.terms_conditions || [];
        if (typeof proposalData.terms_conditions === "string") {
            try {
                termsConditionsArray = JSON.parse(proposalData.terms_conditions);
            } catch (e) {
                if (proposalData.terms_conditions.trim() !== "") {
                    termsConditionsArray = proposalData.terms_conditions
                        .split("\n")
                        .map((term) => term.trim())
                        .filter((term) => term !== "");
                } else {
                    termsConditionsArray = [];
                }
            }
        }

        return termsConditionsArray
            .map(
                (term) => `<li class="bold qualifications-item">${term || ""}</li>`
            )
            .join("");
    }

    // Determine if second page has content
    const hasSecondPageContent =
        proposalData.architect_name ||
        proposalData.architect_specifications ||
        proposalData.architect_dated ||
        proposalData.architect_sheets ||
        proposalData.engineer_name ||
        proposalData.engineer_specifications ||
        proposalData.engineer_dated ||
        proposalData.engineer_sheets ||
        proposalData.exclusions ||
        (proposalData.terms_conditions && getTermsConditionsHTML().trim() !== "");

    // Generate the second page content only if there's content
    const secondPageContent = hasSecondPageContent
        ? `
            <!-- SECOND PAGE -->
            <div class="page">
                <div class="page-content page-2-content">
                    <div class="plans-specifications word-wrap">
                        <p class="word-wrap">This proposal is based on the plans and specifications of:</p>
                        <div class="plans-details">
                            <div class="architect-details word-wrap">
                                <p class="word-wrap">Architect: <span>${proposalData.architect_name || ""}</span></p>
                                <p class="word-wrap">Specifications: <span>${proposalData.architect_specifications || ""}</span></p>
                                <p class="word-wrap">Dated: <span>${
                                    proposalData.architect_dated
                                        ? formatDate(proposalData.architect_dated)
                                        : ""
                                }</span></p>
                                <p class="word-wrap">Sheets: <span>${proposalData.architect_sheets || ""}</span></p>
                            </div>
                            <div class="engineer-details word-wrap">
                                <p class="word-wrap">Engineer: <span>${proposalData.engineer_name || ""}</span></p>
                                <p class="word-wrap">Specifications: <span>${proposalData.engineer_specifications || ""}</span></p>
                                <p class="word-wrap">Dated: <span>${
                                    proposalData.engineer_dated
                                        ? formatDate(proposalData.engineer_dated)
                                        : ""
                                }</span></p>
                                <p class="word-wrap">Sheets: <span>${proposalData.engineer_sheets || ""}</span></p>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <h3 class="section-heading exclusions-heading word-wrap">Exclusions:</h3>
                        <p class="exclusions-content bold word-wrap">${proposalData.exclusions || ""}</p>
                    </div>

                    <div class="section">
                        <h3 class="section-heading qualifications-heading word-wrap">Qualifications:</h3>
                        <ol class="qualifications-list">
                            ${getTermsConditionsHTML()}
                        </ol>
                    </div>

                    <div class="signature-section word-wrap">
                        <p class="word-wrap">Respectfully,</p>
                        <div class="signature word-wrap">
                            <p class="word-wrap">Tom Eccles</p>
                            <p class="word-wrap">Vice President</p>
                        </div>
                    </div>
                </div>
                <div class="page-footer">
                    <div class="page-numbers"></div>
                </div>
            </div>
        `
        : "";

    let reportContent = `
        <div id="report-content">
            <style>
                /* Apply box-sizing globally */
                *, *::before, *::after {
                    box-sizing: border-box;
                }

                @page {
                    margin: 20mm 15mm 30mm 15mm; /* Top, right, bottom, left */
                    size: letter;
                }

                body {
                    margin: 0;
                    padding: 0;
                    font-family: Arial, sans-serif;
                    font-size: 10pt; /* Normal font size for the first page */
                    color: black;
                }

                .page {
                    padding: 0 15mm 20mm 15mm; /* Left/Right: 15mm; Bottom: 20mm */
                    box-sizing: border-box;
                    position: relative;
                    width: auto;
                    margin: 0 auto;
                }

                .page:first-of-type {
                    padding-top: 30mm; /* Keep that first-page top margin */
                }

                /* Reduce to 25mm so it's less likely to trigger an extra blank page */
                .page-content {
                    padding-bottom: 25mm; 
                }

                .page-2-content {
                    page-break-before: always;
                    padding: 30mm 0 25mm 0; /* Top: 30mm; Bottom: 25mm */
                    width: 100%;
                    margin: 0 auto;
                    font-size: 10px; /* Smaller font on page 2 */
                }

                .section-heading {
                    text-transform: uppercase;
                    padding-bottom: 3px;
                    margin-bottom: 5px;
                    font-size: 11pt; /* Normal font size */
                    font-weight: bold;
                    border-bottom: 1px solid black;
                    color: black;
                    margin-left: 0;
                    overflow-wrap: break-word;
                    word-break: break-word;
                    white-space: normal;
                    hyphens: auto;
                }

                .section {
                    margin-bottom: 15px;
                    font-size: 10pt;
                    padding-left: 0;
                    overflow-wrap: break-word;
                    word-break: break-word;
                    white-space: normal;
                    hyphens: auto;
                }

                .options-section {
                    page-break-inside: avoid;
                    break-inside: avoid;
                    margin-top: 30mm; /* Add consistent spacing */
                }

                /* Handle any page break before options */
                .page-break-before {
                    page-break-before: always;
                    padding-top: 30mm !important; /* Maintain consistent top padding on new pages */
                }

                .section-table {
                    width: 100%;
                    table-layout: fixed;
                    border-collapse: collapse;
                }

                .line-name {
                    padding: 2px 0;
                    width: 65%;
                    font-size: 9pt;
                    overflow-wrap: break-word;
                    word-break: break-word;
                    hyphens: auto;
                }

                .line-value {
                    text-align: right;
                    padding: 2px 0;
                    width: 35%;
                    font-size: 9pt;
                    overflow-wrap: break-word;
                    word-break: break-word;
                    hyphens: auto;
                }

                .currency-symbol {
                    display: inline-block;
                    width: 20px;
                    text-align: left;
                    font-size: 9pt;
                    overflow-wrap: break-word;
                    word-break: break-word;
                    hyphens: auto;
                }

                .value {
                    display: inline-block;
                    width: auto;
                    text-align: right;
                    font-size: 9pt;
                    overflow-wrap: break-word;
                    word-break: break-word;
                    hyphens: auto;
                }

                .bold {
                    font-weight: bold;
                }

                .customer-job-info {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 20px;
                    font-size: 10pt;
                    overflow-wrap: break-word;
                    word-break: break-word;
                    white-space: normal;
                    hyphens: auto;
                }

                .proposal-title {
                    text-align: center;
                    margin: 20px 0;
                    font-size: 10pt;
                    overflow-wrap: break-word;
                    word-break: break-word;
                    white-space: normal;
                    hyphens: auto;
                }

                .job-name {
                    font-size: 120%;
                    font-weight: bold;
                    overflow-wrap: break-word;
                    word-break: break-word;
                    hyphens: auto;
                }

                .job-city {
                    font-size: 110%;
                    font-weight: bold;
                    overflow-wrap: break-word;
                    word-break: break-word;
                    hyphens: auto;
                }

                .special-notes-list {
                    margin: 0;
                    padding-left: 20px;
                    font-size: 9pt;
                    list-style-position: inside;
                    overflow-wrap: break-word;
                    word-break: break-word;
                    white-space: normal;
                    hyphens: auto;
                }

                .qualifications-list {
                    margin: 0;
                    padding-left: 20px;
                    font-size: 8.25pt;
                    list-style-position: inside;
                    overflow-wrap: break-word;
                    word-break: break-word;
                    hyphens: auto;
                }

                .qualifications-list li,
                .special-notes-list li {
                    width: 100%;
                    overflow-wrap: break-word;
                    word-break: break-word;
                    white-space: normal;
                    hyphens: auto;
                }

                .section-heading.exclusions-heading,
                .section-heading.qualifications-heading {
                    width: 100%;
                    margin-left: 0;
                    overflow-wrap: break-word;
                    word-break: break-word;
                    hyphens: auto;
                }

                .plans-specifications {
                    margin-bottom: 20px;
                    font-size: 10pt;
                    overflow-wrap: break-word;
                    word-break: break-word;
                    hyphens: auto;
                }

                .plans-details {
                    display: flex;
                    justify-content: space-between;
                    font-size: 10pt;
                }

                .architect-details,
                .engineer-details {
                    width: 48%;
                    font-size: 10pt;
                    overflow-wrap: break-word;
                    word-break: break-word;
                    hyphens: auto;
                }

                .architect-details p,
                .engineer-details p {
                    margin: 5px 0;
                    font-size: 10pt;
                }

                .architect-details span,
                .engineer-details span {
                    font-weight: bold;
                    font-size: 10pt;
                }

                .signature-section {
                    margin-top: 40px;
                    font-size: 10pt;
                }

                .signature {
                    margin-top: 60px;
                    font-size: 10pt;
                }

                .exclusions-heading,
                .qualifications-heading {
                    font-size: 9.5pt;
                }

                .exclusions-content,
                .qualifications-list {
                    width: 100%;
                    margin: 0 auto;
                    font-size: 8.25pt;
                }

                /* Modify the last page specific styling */
                .page:last-child .page-content {
                    padding-bottom: 0 !important;
                    margin-bottom: 0 !important;
                }

                /* Slightly reduce margin above footer so leftover space is smaller */
                .page-footer {
                    margin-top: 5mm; 
                    text-align: center;
                    font-size: 10pt;
                    color: #000;
                    font-weight: bold;
                }

                .page-numbers {
                    font-size: 10pt;
                    color: #646464;
                    margin-bottom: 3px;
                }

                .bid-id {
                    font-size: 10pt;
                    color: #000;
                    font-weight: bold;
                }

                /* Additional CSS to prevent word cutoff */
                .word-wrap {
                    overflow-wrap: break-word;
                    word-break: break-word;
                    white-space: normal;
                    hyphens: auto;
                }
            </style>

            <!-- FIRST PAGE -->
            <div class="page">
                <div class="page-content first-page-content">
                    <div class="customer-job-info">
                        <div class="customer-info">
                            <p class="bold word-wrap">${proposalData.customer_name}</p>
                            <p class="word-wrap">${proposalData.customer_address}</p>
                            <p class="word-wrap">${proposalData.customer_city}, ${
        proposalData.customer_state
    } ${proposalData.customer_zip}</p>
                        </div>
                        <div class="job-info word-wrap">
                            <p class="bold word-wrap">${formatDate(proposalData.bid_date)}</p>
                        </div>
                    </div>

                    <div class="proposal-title">
                        <p class="revision-number bold word-wrap">
                            ${
                                proposalData.revision_number > 1
                                    ? getOrdinal(parseInt(proposalData.revision_number)) +
                                      " Revision"
                                    : ""
                            }
                        </p>
                        <p class="proposal-description word-wrap">
                            Proposal for the construction of:<br>
                            <span class="job-name word-wrap">${proposalData.job_name}</span><br>
                            <span class="job-city word-wrap">${proposalData.job_city}</span>
                        </p>
                    </div>

                    ${proposalData.components.map(createSectionHTML).join("")}

                    <div class="section">
                        <table class="section-table">
                            <tbody>
                                <tr class="section-total">
                                    <td class="line-name bold word-wrap">PROPOSAL TOTAL</td>
                                    <td class="line-value bold word-wrap">
                                        <span class="currency-symbol">$</span>
                                        <span class="value">${formatNumberWithCommas(
                                            proposalData.total_budget || 0
                                        )}</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    ${optionsSection}
                    ${specialNotesSection}
                </div>
            </div>

            ${secondPageContent}
        </div>
    `;

    // Convert this HTML to a DOM element
    const element = document.createElement("div");
    element.innerHTML = reportContent;

    const opt = {
        margin: [0, 0, 0, 0], // We rely on the @page CSS margin
        filename: filename,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: {
            scale: 2,
            useCORS: true,
            logging: true,
            letterRendering: true,
        },
        jsPDF: {
            unit: "mm",
            format: "letter",
            orientation: "portrait",
            compress: true,
        },
        // Let default auto page-breaking occur; the CSS helps with "avoid splitting .options-section"
    };

    if (typeof html2pdf !== "undefined") {
        html2pdf()
            .from(element)
            .set(opt)
            .toPdf()
            .get("pdf")
            .then(function (pdf) {
                let totalPages = pdf.internal.getNumberOfPages();
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                // Add page numbers and (optionally) the bidId to each page
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);

                    // Add centered page numbers
                    pdf.setFontSize(10); // Normal font size for page numbers
                    pdf.setTextColor(100);
                    pdf.text(
                        `Page ${i} of ${totalPages}`,
                        pageWidth / 2,
                        pageHeight - 10,
                        {
                            align: "center",
                        }
                    );

                    // (Optional) Add Bid ID below the page number, if you want:
                    pdf.setFontSize(8);
                    pdf.setTextColor(0);
                    pdf.text(
                        `${proposalData.bid_id || ""}`,
                        pageWidth / 2,
                        pageHeight - 5,
                        { align: "center" }
                    );
                }

                // Check if the last page is empty and remove it if needed
                if (totalPages > 1) {
                    const lastPage = pdf.internal.pages[totalPages];
                    if (lastPage) {
                        const lastPageContent = lastPage.rawContent;
                        if (
                            lastPageContent &&
                            typeof lastPageContent === "string" &&
                            lastPageContent.trim() === ""
                        ) {
                            pdf.deletePage(totalPages);
                            totalPages--;
                        }
                    }
                }

                // Save the PDF
                pdf.save(filename);
            })
            .catch(function (error) {
                console.error("An error occurred while generating the PDF:", error);
            });
    } else {
        console.error(
            "html2pdf is not defined. Make sure to include the html2pdf library."
        );
    }
}



      function formatNumberWithCommas(number) {
        if (number == null || isNaN(number)) return "0.00";
        return number.toLocaleString("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }

      // Helper functions
      function setInputValue(id, value) {
        const element = document.getElementById(id);
        if (element) {
          element.value = value !== null && value !== undefined ? value : "";
        } else {
          console.warn(`Element with id '${id}' not found.`);
        }
      }

      function addComponent() {
        const container = document.getElementById("sectionsContainer");
        const componentDiv = document.createElement("div");
        componentDiv.classList.add("component");

        componentDiv.innerHTML = `
            <div class="component-header">
            <input type="text" class="form-control component-name" value="New Section/Phase">
            <button type="button" class="btn btn-danger btn-sm delete-btn" onclick="removeComponent(this)">
                <i class="fas fa-trash-alt"></i>
            </button>
            </div>
            <div class="lines-container">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Line Name</th>
                            <th>Value $</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Lines will be dynamically added here -->
                    </tbody>
                </table>
                <button type="button" class="btn btn-success btn-sm add-line-btn" onclick="addLine(this)">
                    <i class="fas fa-plus"></i> Add Line
                </button>
            </div>
            <hr class="component-separator">
        `;

        container.appendChild(componentDiv);
        updateBudgetSummary();
      }

      function openTab(evt, tabName) {
        var i, tabcontent, tabButtons;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }
        tabButtons = document.getElementsByClassName("tab-button");
        for (i = 0; i < tabButtons.length; i++) {
          tabButtons[i].classList.remove("active");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.classList.add("active");
      }

      function createComponentElement(component) {
        const componentDiv = document.createElement("div");
        componentDiv.classList.add("component");

        componentDiv.innerHTML = `
            <div class="component-header">
            <input type="text" class="form-control component-name" 
                    value="${component.name}">
            <button type="button" class="btn btn-danger btn-sm delete-btn" 
                    onclick="removeComponent(this)">
                <i class="fas fa-trash-alt"></i>
            </button>
            </div>
            <div class="lines-container">
            <table class="table table-bordered">
                <thead>
                <tr>
                    <th>Line Name</th>
                    <th>Value $</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                ${component.lines
                  .map(
                    (line) => `
                        <tr>
                            <td>
                            <input
                                type="text"
                                class="form-control line-name"
                                value="${line.name}"
                            />
                            </td>
                            <td>
                            <input
                                type="number"
                                class="form-control line-value text-right"
                                value="${line.value}"
                            />
                            </td>
                            <td>
                            <!-- ARROW BUTTONS + DELETE -->
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-secondary"
                                onclick="moveLineUp(this)"
                                title="Move Up"
                            >
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-secondary"
                                onclick="moveLineDown(this)"
                                title="Move Down"
                            >
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button
                                type="button"
                                class="btn btn-danger btn-sm delete-btn"
                                onclick="removeLine(this)"
                                title="Delete Line"
                            >
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            </td>
                        </tr>
                        `
                  )
                  .join("")}
                </tbody>
            </table>

            <!-- Button for adding new lines -->
            <button type="button"
                    class="btn btn-success btn-sm add-line-btn w-100 mt-3"
                    onclick="addLine(this)">
                <i class="fas fa-plus"></i> Add Line
            </button>
            </div>
            <hr class="component-separator">
        `;

        return componentDiv;
      }

      // Add this function to ensure terms are loaded when the tab is clicked
      function initializeTermsAndConditions() {
        const termsConditionsTab = document.querySelector(
          ".tab-button[onclick=\"openTab(event, 'TermsConditions')\"]"
        );
        if (termsConditionsTab) {
          termsConditionsTab.addEventListener("click", function () {
            const termsContainer = document.querySelector(
              "#termsConditionsTable tbody"
            );
            if (termsContainer && termsContainer.children.length === 0) {
              populateTermsAndConditions();
            }
          });
        }
      }

      function renderProposalData(data) {
        console.log("[renderProposalData] =>", data);

        /********************************************
         * HEADERS / BASIC FIELDS
         ********************************************/
        // Helper to set input values safely
        function setInputValue(id, value) {
          const element = document.getElementById(id);
          if (element) {
            element.value = value != null ? value : "";
            console.log(`Setting ${id} to: ${value}`);
          } else {
            console.warn(`Element with id '${id}' not found.`);
          }
        }

        // Format a numeric value for display
        function formatNumberWithCommas(num) {
          if (num == null || isNaN(num)) return "0.00";
          return Number(num).toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        }

        // Format raw numeric to integer or float
        function formatValue(value) {
          const num = parseFloat(value || "0");
          // If you want to round to whole numbers:
          return Math.round(num);
        }

        // Populate top-level fields
        setInputValue("jobName", data.proposal_info.project_name);
        setInputValue("jobCity", data.proposal_info.project_city);
        setInputValue("customerName", data.proposal_info.customer_name);
        setInputValue("bidJobId", data.proposal_info.bid_id);
        setInputValue("bidDate", data.proposal_info.bid_date);
        setInputValue(
          "totalBudget",
          formatNumberWithCommas(data.proposal_info.total_budget)
        );
        setInputValue("revisionNumber", data.proposal_info.revision_number);
        setInputValue("pointOfContact", data.proposal_info.point_of_contact);

        // Customer info
        setInputValue("customerAddress", data.customer_info.address);
        setInputValue("customerCity", data.customer_info.city);
        setInputValue("customerState", data.customer_info.state);
        setInputValue("customerZip", data.customer_info.zip);

        // Labor rates
        setInputValue("drainsLaborRate", data.labor_rates.drains_labor_rate);
        setInputValue(
          "irrigationLaborRate",
          data.labor_rates.irrigation_labor_rate
        );
        setInputValue(
          "landscapeLaborRate",
          data.labor_rates.landscape_labor_rate
        );
        setInputValue(
          "maintenanceLaborRate",
          data.labor_rates.maintenance_labor_rate
        );
        setInputValue("localSalesTax", data.labor_rates.local_sales_tax);

        // Architect/Engineer (heading fields from the proposal)
        setInputValue("architectName", data.proposal_info.architect_name);
        setInputValue(
          "architectSpecifications",
          data.proposal_info.architect_specifications
        );
        setInputValue("architectDated", data.proposal_info.architect_dated);
        setInputValue("architectSheets", data.proposal_info.architect_sheets);
        setInputValue("engineerName", data.proposal_info.engineer_name);
        setInputValue(
          "engineerSpecifications",
          data.proposal_info.engineer_specifications
        );
        setInputValue("engineerDated", data.proposal_info.engineer_dated);
        setInputValue("engineerSheets", data.proposal_info.engineer_sheets);

        /********************************************
         * CLEAR SECTIONS
         ********************************************/
        const sectionsContainer = document.getElementById("sectionsContainer");
        sectionsContainer.innerHTML = "";

        /********************************************
         * MERGE "Landscape" LINES ONLY IF NONE IN DB
         ********************************************/
        // "Budget" lines from your proposal_info totals
        const budgetLines = [
          {
            name: "Drains",
            value: formatValue(data.proposal_info.drains_total),
          },
          {
            name: "Irrigation",
            value: formatValue(data.proposal_info.irrigation_total),
          },
          {
            name: "Landscape",
            value: formatValue(data.proposal_info.landscaping_total),
          },
          {
            name: "90 Day Maintenance",
            value: formatValue(""),
          },
        ];

        // Attempt to find a "Landscape" component in DB
        let dbLandscape = data.components.find(
          (c) => (c.name || "").toLowerCase() === "landscape"
        );
        if (!dbLandscape) {
          dbLandscape = { name: "Landscape", lines: [] };
        }

        let finalLandscapeLines = [];
        if (dbLandscape.lines.length > 0) {
          // If we already have lines in the DB => skip merging
          console.log("Landscape already has DB lines. Skipping merge...");
          finalLandscapeLines = dbLandscape.lines.map((ln) => ({
            name: ln.name,
            value: formatValue(ln.value),
          }));
        } else {
          // DB Landscape is empty => merge the budget lines
          console.log(
            "Landscape is empty. Merging budget lines for first-time load."
          );
          finalLandscapeLines = [
            ...budgetLines,
            ...dbLandscape.lines.map((ln) => ({
              name: ln.name,
              value: formatValue(ln.value),
            })),
          ];
        }

        // Create and add landscape section
        const landDiv = document.createElement("div");
        landDiv.classList.add("component");
        landDiv.innerHTML = `
    <div class="component-header">
        <input type="text" class="form-control component-name" value="Landscape">
    </div>
    <div class="lines-container">
        <table class="table table-bordered">
            <thead>
                <tr>
                <th width="5%">Move</th>
                <th width="50%">Line Name</th>
                <th width="25%">Value $</th>
                <th width="20%">Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                <!-- This is the drag handle cell -->
                <td class="drag-handle text-center">
                    <i class="fas fa-grip-vertical"></i>
                </td>
                <td>
                    <input type="text" class="form-control line-name" value="Some line name" />
                </td>
                <td>
                    <input type="number" class="form-control line-value text-right" value="1234" />
                </td>
                <td>
                    <!-- The arrow buttons + Delete button -->
                    <button
                    type="button"
                    class="btn btn-sm btn-outline-secondary"
                    onclick="moveLineUp(this)"
                    title="Move Up"
                    >
                    <i class="fas fa-arrow-up"></i>
                    </button>
                    <button
                    type="button"
                    class="btn btn-sm btn-outline-secondary"
                    onclick="moveLineDown(this)"
                    title="Move Down"
                    >
                    <i class="fas fa-arrow-down"></i>
                    </button>
                    <button
                    type="button"
                    class="btn btn-danger btn-sm delete-btn"
                    onclick="removeLine(this)"
                    title="Delete Line"
                    >
                    <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
                </tr>
            </tbody>
            </table>
    </div>
    <hr class="component-separator">
`;
        sectionsContainer.appendChild(landDiv);

        /********************************************
         * RENDER OTHER COMPONENTS (NON-Landscape)
         ********************************************/
        (data.components || []).forEach((cmp) => {
          // Skip landscape as it's already handled
          if ((cmp.name || "").toLowerCase() === "landscape") return;

          const compDiv = document.createElement("div");
          compDiv.classList.add("component");

          // Find this section in renderProposalData where linesHTML is defined
          const linesHTML = (cmp.lines || [])
            .map(
              (ln) => `
        <tr>
            <td>
                <input type="text" class="form-control line-name" value="${
                  ln.name || ""
                }" />
            </td>
            <td>
                <input type="number" class="form-control line-value text-right" value="${formatValue(
                  ln.value
                )}" />
            </td>
            <td>
                <!-- Arrow buttons + Delete -->
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveLineUp(this)" title="Move Up">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveLineDown(this)" title="Move Down">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <button type="button" class="btn btn-danger btn-sm delete-btn" onclick="removeLine(this)">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        </tr>
        `
            )
            .join("");

          compDiv.innerHTML = `
        <div class="component-header mb-3">
            <input type="text" class="form-control component-name" value="${
              cmp.name || "New Section"
            }">
            <button type="button" class="btn btn-danger btn-sm delete-btn" onclick="removeComponent(this)">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
        <div class="lines-container">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th width="60%">Line Name</th>
                        <th width="30%">Value $</th>
                        <th width="10%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${linesHTML}
                </tbody>
            </table>
            <button type="button" class="btn btn-success btn-sm add-line-btn w-100 mt-3" onclick="addLine(this)">
                <i class="fas fa-plus"></i> Add Line
            </button>
        </div>
        <hr class="component-separator">
    `;
          sectionsContainer.appendChild(compDiv);
        });

        // Add Add Section button at the end
        const addSecBtn = document.createElement("button");
        addSecBtn.type = "button";
        addSecBtn.className = "btn btn-primary btn-sm mt-3";
        addSecBtn.onclick = addComponent;
        addSecBtn.innerHTML = '<i class="fas fa-plus"></i> Add Section/Phase';
        sectionsContainer.appendChild(addSecBtn);

        /********************************************
         * OPTIONS, SPECIAL NOTES, TERMS, EXCLUSIONS
         ********************************************/
        // Helper to parse or fallback
        function fallbackArray(input) {
          if (!input) return [];
          if (Array.isArray(input)) return input;
          return [];
        }

        // Populate Options
        populateOptions(data.options || []);

        // Special Notes
        populateSpecialNotesTable(data.proposal_info.special_notes || []);

        // Terms/Conditions
        populateTermsAndConditions(data.proposal_info.terms_conditions || []);

        // Exclusions
        setInputValue(
          "exclusionsTextarea",
          data.proposal_info.exclusions || "Default Exclusions here..."
        );

        // Update any budget summaries
        updateBudgetTotals({
          drains_total: formatValue(data.proposal_info.drains_total),
          irrigation_total: formatValue(data.proposal_info.irrigation_total),
          landscaping_total: formatValue(data.proposal_info.landscaping_total),
          maintenance_total: formatValue(data.proposal_info.maintenance_total),
          total_budget: formatValue(data.proposal_info.total_budget),
        });
        updateBudgetSummary();
      }

      function moveLineUp(button) {
        const currentRow = button.closest("tr");
        const previousRow = currentRow.previousElementSibling;
        if (previousRow) {
          // Insert the current row before the previous row
          currentRow.parentNode.insertBefore(currentRow, previousRow);
        }
      }

      function moveLineDown(button) {
        const currentRow = button.closest("tr");
        const nextRow = currentRow.nextElementSibling;
        if (nextRow) {
          // Insert the next row before the current row, effectively moving current row down
          currentRow.parentNode.insertBefore(nextRow, currentRow);
        }
      }

      // First, modify the gatherComponents function to properly collect all lines
      function gatherComponents() {
        const components = [];
        const componentElements = document.querySelectorAll(
          "#sectionsContainer .component"
        );
        console.log(`Found ${componentElements.length} component(s)`);

        componentElements.forEach((component, index) => {
          const componentNameInput = component.querySelector(".component-name");
          const componentName = componentNameInput
            ? componentNameInput.value.trim()
            : `Section ${index + 1}`;

          console.log(`Gathering data for component: ${componentName}`);

          const componentData = {
            type: "section",
            name: componentName,
            lines: [],
          };

          // Get all lines, including both readonly and editable ones
          const lines = component.querySelectorAll(".lines-container tbody tr");
          console.log(
            `Found ${lines.length} line(s) in component: ${componentName}`
          );

          lines.forEach((line, lineIndex) => {
            const nameInput = line.querySelector(".line-name");
            const valueInput = line.querySelector(".line-value");

            if (nameInput && valueInput) {
              const lineName = nameInput.value.trim();
              const lineValue = parseFormattedNumber(valueInput.value);

              console.log(
                ` - Line ${lineIndex + 1}: ${lineName} = ${lineValue}`
              );

              // Only add lines that have both a name and a value
              if (lineName && lineValue !== null) {
                componentData.lines.push({
                  name: lineName,
                  value: lineValue,
                });
              }
            }
          });

          // Only add components that have lines
          if (componentData.lines.length > 0) {
            components.push(componentData);
          }
        });

        console.log("Collected components:", components);
        return components;
      }
      // Function to add a new line to a section
      function addLine(button) {
        const tbody = button.previousElementSibling.querySelector("tbody");
        const row = document.createElement("tr");

        row.innerHTML = `
            <td>
                <input type="text" class="form-control line-name" placeholder="Enter line name">
            </td>
            <td>
                <input type="number" class="form-control line-value text-right" value="" 
                    onchange="updateBudgetSummary()">
            </td>
            <td>
                <!-- The arrow buttons + Delete button -->
                <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                onclick="moveLineUp(this)"
                title="Move Up"
                >
                <i class="fas fa-arrow-up"></i>
                </button>
                <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                onclick="moveLineDown(this)"
                title="Move Down"
                >
                <i class="fas fa-arrow-down"></i>
                </button>
                <button
                type="button"
                class="btn btn-danger btn-sm delete-btn"
                onclick="removeLine(this)"
                title="Delete Line"
                >
                <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        `;

        tbody.appendChild(row);
        updateBudgetSummary();
      }

      function gatherOptions() {
        const options = [];
        const optionRows = document.querySelectorAll("#optionsTable tbody tr");
        optionRows.forEach((row) => {
          const descriptionInput = row.querySelector(
            'input[name^="optionDescription"]'
          );
          const amountInput = row.querySelector('input[name^="optionAmount"]');
          if (descriptionInput && amountInput) {
            options.push({
              description: descriptionInput.value,
              amount: parseFloat(amountInput.value) || 0,
            });
          }
        });
        console.log("gatherOptions =>", options);
        return options;
      }

      function addExclusion() {
        const exclusionsTextarea =
          document.getElementById("exclusionsTextarea");
        exclusionsTextarea.value += "\nNew exclusion item.";
      }

      function gatherProposalData() {
        // Helper to safely parse numbers
        function parseFormattedNumber(value) {
          if (typeof value === "number") return value;
          if (!value) return 0;
          return parseFloat(value.replace(/[^0-9.-]+/g, "")) || 0;
        }

        function getValueById(id) {
          const elem = document.getElementById(id);
          return elem ? elem.value.trim() : "";
        }

        // Build the proposalData object
        const proposalData = {
          // Identifiers
          proposal_id: getValueById("bidJobId"),
          bid_id: getValueById("bidJobId"),
          bid_date: getValueById("bidDate"),

          // Budget
          total_budget: parseFormattedNumber(getValueById("totalBudget")),

          // Customer info
          customer_name: getValueById("customerName"),
          customer_address: getValueById("customerAddress"),
          customer_city: getValueById("customerCity"),
          customer_state: getValueById("customerState"),
          customer_zip: getValueById("customerZip"),

          // Architect
          architect_name: getValueById("architectName"),
          architect_specifications: getValueById("architectSpecifications"),
          architect_dated: getValueById("architectDated"),
          architect_sheets: getValueById("architectSheets"),

          // Engineer
          engineer_name: getValueById("engineerName"),
          engineer_specifications: getValueById("engineerSpecifications"),
          engineer_dated: getValueById("engineerDated"),
          engineer_sheets: getValueById("engineerSheets"),

          // Job info
          job_name: getValueById("jobName"),
          job_city: getValueById("jobCity"),
          revision_number: getValueById("revisionNumber"),

          // Labor rates
          drains_labor_rate: parseFormattedNumber(
            getValueById("drainsLaborRate")
          ),
          irrigation_labor_rate: parseFormattedNumber(
            getValueById("irrigationLaborRate")
          ),
          landscape_labor_rate: parseFormattedNumber(
            getValueById("landscapeLaborRate")
          ),
          maintenance_labor_rate: parseFormattedNumber(
            getValueById("maintenanceLaborRate")
          ),
          local_sales_tax: parseFormattedNumber(getValueById("localSalesTax")),

          // Additional heading fields
          point_of_contact: getValueById("pointOfContact"),

          // Special notes & Terms
          special_notes: getSpecialNotes(),
          terms_conditions: getTermsAndConditions(),
          exclusions: getExclusions(),

          // Components & Options
          components: gatherComponents(),
          options: gatherOptions(),
        };

        // If you want to recalc your totals from the line items:
        const totals = calculateBudgetBreakdown();
        proposalData.drains_total = totals.drains_total;
        proposalData.irrigation_total = totals.irrigation_total;
        proposalData.landscaping_total = totals.landscaping_total;
        proposalData.maintenance_total = totals.maintenance_total;
        proposalData.total_budget = totals.total_budget; // override with computed total

        console.log("Gathered proposal data:", proposalData);
        return proposalData;
      }

      // Special Notes management
      // Update the addSpecialNoteLine function
      function addSpecialNoteLine() {
        const tbody = document.querySelector("#specialNotesTable tbody");
        const row = tbody.insertRow();

        row.innerHTML = `
            <td>
                <textarea class="form-control special-note" rows="3" required></textarea>
            </td>
            <td>
                <button type="button" class="btn btn-danger" onclick="removeSpecialNoteLine(this)">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        `;
      }

      function removeSpecialNoteLine(btn) {
        var row = btn.closest("tr");
        if (row) {
          row.remove();
        }
      }

      function populateSpecialNotesTable(specialNotes) {
        const specialNotesTable = document
          .getElementById("specialNotesTable")
          .getElementsByTagName("tbody")[0];
        specialNotesTable.innerHTML = ""; // Clear existing notes

        if (typeof specialNotes === "string") {
          try {
            specialNotes = JSON.parse(specialNotes);
          } catch (e) {
            console.error("Error parsing specialNotes:", e);
            specialNotes = specialNotes
              .split("\n")
              .filter((note) => note.trim() !== "");
          }
        }

        specialNotes.forEach((note) => {
          const row = specialNotesTable.insertRow();
          const noteCell = row.insertCell(0);
          const actionCell = row.insertCell(1);

          noteCell.innerHTML = `<textarea class="form-control special-note" rows="2">${note}</textarea>`;
          actionCell.innerHTML = `
                <button type="button" class="btn btn-danger remove-btn" onclick="removeSpecialNoteLine(this)">
                    <i class="fas fa-trash-alt"></i>
                </button>`;
        });
      }

      async function fetchAndPopulateProposalData(bidId) {
        try {
          const response = await fetch(`/get-proposal-items/${bidId}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          console.log("Received proposal data:", data);

          renderProposalData(data);
          showAlert("success", "Proposal data loaded successfully!");
        } catch (error) {
          console.error("Error fetching proposal data:", error);
          showAlert(
            "error",
            "Failed to load proposal data. Please check the console for more details."
          );
        }
      }

      function formatCurrency(value) {
        if (value == null) return "$0.00";
        return `$${parseFloat(value).toFixed(2)}`;
      }

      function updateBudgetTotals(totals) {
        function updateElement(id, value) {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = formatNumberWithCommas(value);
          }
        }

        updateElement("drainsTotalValue", totals.drains_total);
        updateElement("irrigationTotalValue", totals.irrigation_total);
        updateElement("landscapeTotalValue", totals.landscaping_total);
        updateElement("maintenanceTotalValue", totals.maintenance_total);
        updateElement("grandTotalValue", totals.total_budget);
      }

      // Modify loadProposalData to preserve options
      async function loadProposalData(bidId, revision) {
        try {
          let url = `/get-proposal-items/${bidId}`;
          if (revision) {
            url += `?revision_number=${revision}`;
          }

          console.log("[LOAD_PROPOSAL_DATA] Fetching from URL:", url);

          // Store current options before load
          const currentOptions = preserveOptionsData();

          const response = await fetch(url);
          console.log("[LOAD_PROPOSAL_DATA] Response status:", response.status);

          if (!response.ok) {
            const errorText = await response.text();
            console.error("[LOAD_PROPOSAL_DATA] Error text:", errorText);
            throw new Error(
              `Failed to load proposal data. Status: ${response.status}`
            );
          }

          const data = await response.json();
          console.log("[LOAD_PROPOSAL_DATA] Received data:", data);

          // If data has no options, try to use current options or stored options
          if (!data.options || data.options.length === 0) {
            const storedOptions = localStorage.getItem(
              `proposal_options_${bidId}`
            );
            data.options =
              currentOptions.length > 0
                ? currentOptions
                : storedOptions
                ? JSON.parse(storedOptions)
                : [];
          }

          renderProposalData(data);
        } catch (err) {
          console.error("[LOAD_PROPOSAL_DATA] Error:", err);
          showAlert(
            "error",
            "Error loading proposal data. Check console logs."
          );
        }
      }

      // First, modify saveProposal to ensure options are included
      async function saveProposal() {
        console.log("[SAVE_PROPOSAL] Gathering proposal data...");
        const proposalData = gatherProposalData();

        // Store current options before save
        const currentOptions = preserveOptionsData();
        proposalData.options = currentOptions; // Ensure options are included in save

        console.log("[SAVE_PROPOSAL] Data to save:", proposalData);

        try {
          const csrfToken = document.getElementById("csrf_token").value;
          const response = await fetch("/save-proposal", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken,
            },
            body: JSON.stringify(proposalData),
          });

          console.log("[SAVE_PROPOSAL] Response status:", response.status);
          if (!response.ok) {
            const errorText = await response.text();
            console.error("[SAVE_PROPOSAL] Error text:", errorText);
            throw new Error(
              `Save proposal failed with status ${response.status}`
            );
          }

          const result = await response.json();
          console.log("[SAVE_PROPOSAL] Success response:", result);

          // Store options in localStorage as backup
          localStorage.setItem(
            `proposal_options_${proposalData.bid_id}`,
            JSON.stringify(currentOptions)
          );

          if (result.success) {
            showAlert("success", "Proposal saved successfully!");
          } else {
            console.error(
              "[SAVE_PROPOSAL] Save responded with success=false:",
              result
            );
            showAlert("error", `Failed to save proposal: ${result.message}`);
          }
        } catch (err) {
          console.error("[SAVE_PROPOSAL] Error:", err);
          showAlert("error", `Error saving proposal: ${err.message}`);
        }
      }

      // 1. Fix the data structure mapping
      function renderSections(data) {
        const sectionsContainer = document.getElementById("sectionsContainer");
        sectionsContainer.innerHTML = ""; // Clear existing content

        // First, create and add the landscape section with budget totals
        const landscapeComponent = {
          name: "Landscape",
          lines: [
            { name: "Drains", value: data.proposal_info.drains_total || "" },
            {
              name: "Irrigation",
              value: data.proposal_info.irrigation_total || "",
            },
            {
              name: "Landscape",
              value: data.proposal_info.landscaping_total || "",
            },
            {
              name: "Maintenance",
              value: data.proposal_info.maintenance_total || "",
            },
          ].filter((line) => line.value > 0),
        };

        if (landscapeComponent.lines.length > 0) {
          const landscapeDiv = createComponentElement(landscapeComponent);
          sectionsContainer.appendChild(landscapeDiv);
        }

        // Then add any additional components from the data
        if (data.components && Array.isArray(data.components)) {
          data.components.forEach((component) => {
            if (component.name.toLowerCase() !== "landscape") {
              const componentDiv = createComponentElement(component);
              sectionsContainer.appendChild(componentDiv);
            }
          });
        }
      }

      function editComponent(type, button) {
        const row = button.closest("tr");
        const nameCell = row.cells[1];
        const newName = prompt(`Edit ${type} name:`, nameCell.textContent);
        if (newName && newName !== nameCell.textContent) {
          nameCell.textContent = newName;
          updateBudgetSummary();
        }
      }

      function addLineToComponent(type, button) {
        const linesTable = button.previousElementSibling.querySelector("tbody");
        const lineName = prompt(`Enter line name for ${type}:`);
        if (lineName) {
          const lineValue = prompt(`Enter value for "${lineName}":`);
          if (lineValue) {
            const newRow = linesTable.insertRow();
            newRow.innerHTML = `
                    <td>${lineName}</td>
                    <td>$${formatNumberWithCommas(parseFloat(lineValue))}</td>
                    <td>
                        <button onclick="editLine(this)" class="btn btn-sm btn-primary mr-1">Edit</button>
                        <button onclick="removeLine(this)" class="btn btn-sm btn-danger">Remove</button>
                    </td>
                `;
            updateComponentTotal(button.closest("tr").previousElementSibling);
            updateBudgetSummary();
          }
        }
      }

      function toggleComponentLines(button) {
        const componentRow = button.closest("tr");
        const linesRow = componentRow.nextElementSibling;
        const linesCell = linesRow.querySelector("td");
        linesCell.style.display =
          linesCell.style.display === "none" ? "" : "none";
        button.innerHTML =
          linesCell.style.display === "none"
            ? '<i class="fas fa-chevron-right"></i>'
            : '<i class="fas fa-chevron-down"></i>';
      }

      function addSection() {
        const name = prompt("Enter section name:");
        if (name) {
          addComponentToTable("section", name);
        }
      }

      function addPhase() {
        const name = prompt("Enter phase name:");
        if (name) {
          addComponentToTable("phase", name);
        }
      }

      function removeComponent(button) {
        const component = button.closest(".component");
        if (
          confirm(
            `Are you sure you want to remove this ${
              component.classList.contains("section") ? "section" : "phase"
            }?`
          )
        ) {
          component.remove();
          updateBudgetSummary();
        }
      }

      function formatValue(value) {
        // Convert to number and round to 2 decimal places
        const num = parseFloat(parseFloat(value).toFixed(0));

        // Check if the number is effectively a whole number
        if (Math.abs(num - Math.round(num)) < 0.00001) {
          return Math.round(num);
        }

        // Return with 2 decimal places if it has decimals
        return num;
      }

      function editLine(button) {
        const row = button.closest("tr");
        const nameCell = row.cells[0];
        const valueCell = row.cells[1];

        const newName = prompt("Edit line name:", nameCell.textContent);
        if (newName !== null) {
          nameCell.textContent = newName;
        }

        const newValue = prompt(
          "Edit line value:",
          valueCell.textContent.replace("$", "")
        );
        if (newValue !== null) {
          valueCell.textContent =
            "$" + formatNumberWithCommas(parseFloat(newValue));
          updateComponentTotal(
            row.closest("table").closest("tr").previousElementSibling
          );
          updateBudgetSummary();
        }
      }

      function removeLine(button) {
        const row = button.closest("tr");
        row.remove();
        updateBudgetSummary();
      }

      function createLandscapeSection() {
        const container = document.getElementById("sectionsContainer");
        const existingLandscapeSection = container.querySelector(
          '.section .component-name[value="Landscape"]'
        );

        if (!existingLandscapeSection) {
          const landscapeSection = document.createElement("div");
          landscapeSection.classList.add("component", "section");

          landscapeSection.innerHTML = `
                <div class="component-header">
                    <input type="text" class="form-control component-name" value="Landscape">
                    <button type="button" class="btn btn-danger btn-sm delete-btn" onclick="removeLine(this)">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="lines-container">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Line Name</th>
                                <th>Value $</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Lines will be dynamically added here -->
                            <tr>
                                <td><input type="text" class="form-control line-name" value="Drains"></td>
                                <td><input type="number" class="form-control line-value" value="7169.11"></td>
                                <td>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeLine(this)">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><input type="text" class="form-control line-name" value="Irrigation"></td>
                                <td><input type="number" class="form-control line-value" value="2512.68"></td>
                                <td>
                                    <button type="button" class="btn btn-danger btn-sm delete-btn" onclick="removeLine(this)">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><input type="text" class="form-control line-name" value="Landscape"></td>
                                <td><input type="number" class="form-control line-value" value="0"></td>
                                <td>
                                    <button type="button" class="btn btn-danger btn-sm delete-btn" onclick="removeLine(this)">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><input type="text" class="form-control line-name" value="90 Day Maintenance"></td>
                                <td><input type="number" class="form-control line-value" value="359.41"></td>
                                <td>
                                    <button type="button" class="btn btn-danger btn-sm delete-btn" onclick="removeLine(this)">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="button" class="btn btn-success btn-block mt-3" onclick="addLine(this)">
                        <i class="fas fa-plus"></i> Add Line
                    </button>
                </div>
                <hr class="component-separator">
            `;

          container.appendChild(landscapeSection);
        }
      }

      function updateComponentTotal(componentRow) {
        const linesTable =
          componentRow.nextElementSibling.querySelector("table");
        const lines = linesTable.querySelectorAll("tbody tr");
        let total = 0;
        lines.forEach((line) => {
          total += parseFormattedNumber(line.cells[1].textContent);
        });
        componentRow.cells[2].textContent = lines.length;
        componentRow.cells[3].textContent = "$" + formatNumberWithCommas(total);
      }

      function updateTotalBudget() {
        const phasesSectionsContainer = document.getElementById(
          "phasesSectionsContainer"
        );
        let totalBudget = 0;

        // Calculate total from phases and sections
        const components =
          phasesSectionsContainer.querySelectorAll(".phase, .section");
        components.forEach((component) => {
          const lines = component.querySelectorAll(".line-value");
          lines.forEach((line) => {
            totalBudget += parseFloat(line.value) || 0;
          });
        });

        // Update total budget display
        document.getElementById("totalBudget").value =
          formatNumberWithCommas(totalBudget);

        // Update budget summary
        updateBudgetSummary(calculateBudgetBreakdown());
      }

      function getValueById(id) {
        const element = document.getElementById(id);
        return element ? element.value.trim() : "";
      }

      function parseFormattedNumber(value) {
        if (typeof value === "number") return value;
        return parseFloat(value.replace(/[^0-9.-]+/g, "")) || 0;
      }

      function calculateBudgetBreakdown() {
        let totals = {
          drains_total: 0,
          irrigation_total: 0,
          landscaping_total: 0,
          maintenance_total: 0,
          total_budget: 0,
        };

        const components = document.querySelectorAll(
          "#sectionsContainer .component"
        );
        components.forEach((component) => {
          const componentName = component
            .querySelector(".component-name")
            .value.toLowerCase();
          const lines = component.querySelectorAll(".line-value");

          lines.forEach((line) => {
            const value = parseFormattedNumber(line.value);
            totals.total_budget += value;

            if (componentName.includes("drain")) {
              totals.drains_total += value;
            } else if (componentName.includes("irrigation")) {
              totals.irrigation_total += value;
            } else if (componentName.includes("landscape")) {
              totals.landscaping_total += value;
            } else if (componentName.includes("maintenance")) {
              totals.maintenance_total += value;
            }
          });
        });

        return totals;
      }

      // Update the updateBudgetSummary function to only handle budget calculations
      function updateBudgetSummary() {
        let totalBudget = 0;
        const components = document.querySelectorAll(
          "#sectionsContainer .component"
        );

        components.forEach((component) => {
          const lineValues = component.querySelectorAll(".line-value");
          lineValues.forEach((value) => {
            totalBudget += parseFloat(value.value) || 0;
          });
        });

        // Update total budget field with formatted number
        const totalBudgetElement = document.getElementById("totalBudget");
        if (totalBudgetElement) {
          totalBudgetElement.value = formatValue(totalBudget);
        }

        // Don't touch the options tab data
      }

      // Add a function to preserve options data
      function preserveOptionsData() {
        const optionsData = [];
        const optionRows = document.querySelectorAll("#optionsTable tbody tr");

        optionRows.forEach((row) => {
          const descriptionInput = row.querySelector(
            'input[name^="optionDescription"]'
          );
          const amountInput = row.querySelector('input[name^="optionAmount"]');

          if (descriptionInput && amountInput) {
            optionsData.push({
              description: descriptionInput.value,
              amount: amountInput.value,
            });
          }
        });

        return optionsData;
      }

      function renderProposalData(data) {
        console.log("[renderProposalData] =>", data);

        // Store current options before updating
        const currentOptions = preserveOptionsData();

        /********************************************
         * HEADERS / BASIC FIELDS
         ********************************************/
        // Helper to set input values safely
        function setInputValue(id, value) {
          const element = document.getElementById(id);
          if (element) {
            element.value = value != null ? value : "";
            console.log(`Setting ${id} to: ${value}`);
          } else {
            console.warn(`Element with id '${id}' not found.`);
          }
        }

        // Format a numeric value for display
        function formatNumberWithCommas(num) {
          if (num == null || isNaN(num)) return "0.00";
          return Number(num).toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        }

        // Format raw numeric to integer or float
        function formatValue(value) {
          const num = parseFloat(value || "0");
          return Math.round(num); // Round to whole numbers
        }

        // Populate top-level fields
        setInputValue("jobName", data.proposal_info?.project_name);
        setInputValue("jobCity", data.proposal_info?.project_city);
        setInputValue("customerName", data.proposal_info?.customer_name);
        setInputValue("bidJobId", data.proposal_info?.bid_id);
        setInputValue("bidDate", data.proposal_info?.bid_date);
        setInputValue(
          "totalBudget",
          formatNumberWithCommas(data.proposal_info?.total_budget)
        );
        setInputValue("revisionNumber", data.proposal_info?.revision_number);
        setInputValue("pointOfContact", data.proposal_info?.point_of_contact);

        // Customer info
        setInputValue("customerAddress", data.customer_info?.address);
        setInputValue("customerCity", data.customer_info?.city);
        setInputValue("customerState", data.customer_info?.state);
        setInputValue("customerZip", data.customer_info?.zip);

        // Labor rates
        setInputValue("drainsLaborRate", data.labor_rates?.drains_labor_rate);
        setInputValue(
          "irrigationLaborRate",
          data.labor_rates?.irrigation_labor_rate
        );
        setInputValue(
          "landscapeLaborRate",
          data.labor_rates?.landscape_labor_rate
        );
        setInputValue(
          "maintenanceLaborRate",
          data.labor_rates?.maintenance_labor_rate
        );
        setInputValue("localSalesTax", data.labor_rates?.local_sales_tax);

        // Architect/Engineer
        setInputValue("architectName", data.proposal_info?.architect_name);
        setInputValue(
          "architectSpecifications",
          data.proposal_info?.architect_specifications
        );
        setInputValue("architectDated", data.proposal_info?.architect_dated);
        setInputValue("architectSheets", data.proposal_info?.architect_sheets);
        setInputValue("engineerName", data.proposal_info?.engineer_name);
        setInputValue(
          "engineerSpecifications",
          data.proposal_info?.engineer_specifications
        );
        setInputValue("engineerDated", data.proposal_info?.engineer_dated);
        setInputValue("engineerSheets", data.proposal_info?.engineer_sheets);

        /********************************************
         * CLEAR AND REBUILD SECTIONS
         ********************************************/
        const sectionsContainer = document.getElementById("sectionsContainer");
        if (!sectionsContainer) {
          console.error("Sections container not found");
          return;
        }
        sectionsContainer.innerHTML = "";

        /********************************************
         * HANDLE LANDSCAPE SECTION
         ********************************************/
        // "Budget" lines from proposal_info totals
        const budgetLines = [
          {
            name: "Drains",
            value: formatValue(data.proposal_info?.drains_total),
          },
          {
            name: "Irrigation",
            value: formatValue(data.proposal_info?.irrigation_total),
          },
          {
            name: "Landscape",
            value: formatValue(data.proposal_info?.landscaping_total),
          },
          {
            name: "90 Day Maintenance",
            value: ""
          },
        ];

        // Find existing landscape component or create new one
        let dbLandscape = data.components?.find(
          (c) => (c.name || "").toLowerCase() === "landscape"
        ) || { name: "Landscape", lines: [] };

        // Determine which lines to use
        let finalLandscapeLines =
          dbLandscape.lines.length > 0
            ? dbLandscape.lines.map((ln) => ({
                name: ln.name,
                value: formatValue(ln.value),
              }))
            : budgetLines;

        const landDiv = document.createElement("div");
        landDiv.classList.add("component");
        landDiv.innerHTML = `
            <div class="component-header">
                <input type="text" class="form-control component-name" value="Landscape">
            </div>
            <div class="lines-container">
                <table class="table table-bordered">
                <thead>
                    <tr>
                    <th width="60%">Line Name</th>
                    <th width="30%">Value $</th>
                    <th width="10%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${finalLandscapeLines
                      .map(
                        (line) => `
                        <tr>
        <td>
            <input type="text" class="form-control line-name" value="${line.name}" />
        </td>
        <td>
            <input type="number" class="form-control line-value text-right" value="${line.value}" />
        </td>
        <td>
            <!-- Arrow buttons + Delete -->
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveLineUp(this)" title="Move Up">
                <i class="fas fa-arrow-up"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveLineDown(this)" title="Move Down">
                <i class="fas fa-arrow-down"></i>
            </button>
            <button type="button" class="btn btn-danger btn-sm delete-btn" onclick="removeLine(this)">
                <i class="fas fa-trash-alt"></i>
            </button>
        </td>
                        </tr>
                    `
                      )
                      .join("")}
                </tbody>
                </table>
                <button
                type="button"
                class="btn btn-success btn-sm add-line-btn w-100 mt-3"
                onclick="addLine(this)"
                >
                <i class="fas fa-plus"></i> Add Line
                </button>
            </div>
            <hr class="component-separator">
            `;
        sectionsContainer.appendChild(landDiv);

        /********************************************
         * RENDER OTHER COMPONENTS
         ********************************************/
        (data.components || []).forEach((cmp) => {
          // Skip landscape as it's already handled
          if ((cmp.name || "").toLowerCase() === "landscape") return;

          const compDiv = document.createElement("div");
          compDiv.classList.add("component");

          // Find this section in renderProposalData where linesHTML is defined
          const linesHTML = (cmp.lines || [])
            .map(
              (ln) => `
                <tr>
                    <td>
                        <input type="text" class="form-control line-name" value="${
                          ln.name || ""
                        }" />
                    </td>
                    <td>
                        <input type="number" class="form-control line-value text-right" value="${formatValue(
                          ln.value
                        )}" />
                    </td>
                    <td>
                        <!-- Arrow buttons + Delete -->
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveLineUp(this)" title="Move Up">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveLineDown(this)" title="Move Down">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button type="button" class="btn btn-danger btn-sm delete-btn" onclick="removeLine(this)">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
                `
            )
            .join("");

          compDiv.innerHTML = `
            <div class="component-header mb-3">
                <input type="text" class="form-control component-name" value="${
                  cmp.name || "New Section"
                }">
                <button type="button" class="btn btn-danger btn-sm delete-btn" onclick="removeComponent(this)">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
            <div class="lines-container">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th width="60%">Line Name</th>
                            <th width="30%">Value $</th>
                            <th width="10%">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${linesHTML}
                    </tbody>
                </table>
                <button type="button" class="btn btn-success btn-sm add-line-btn w-100 mt-3" onclick="addLine(this)">
                    <i class="fas fa-plus"></i> Add Line
                </button>
            </div>
            <hr class="component-separator">
        `;
          sectionsContainer.appendChild(compDiv);
        });

        /********************************************
         * HANDLE OPTIONS TAB
         ********************************************/
        // Determine which options to use - either from data or preserve current
        const optionsToUse =
          data.options?.length > 0 ? data.options : currentOptions;
        populateOptions(optionsToUse);

        /********************************************
         * SPECIAL NOTES, TERMS, EXCLUSIONS
         ********************************************/
        // Special Notes
        populateSpecialNotesTable(data.proposal_info?.special_notes || []);

        // Terms/Conditions
        populateTermsAndConditions(data.proposal_info?.terms_conditions || []);

        // Exclusions
        setInputValue(
          "exclusionsTextarea",
          data.proposal_info?.exclusions ||
            "Water meter service and hot taps, power for clocks, permits, all hardscape, all grading, import/export of soil, clearing or removal of any existing erosion control devices, demolition, grubbing, rodent control, water cost, downspout connections unless noted, and overtime."
        );

        /********************************************
         * UPDATE TOTALS
         ********************************************/
        const totals = {
          drains_total: formatValue(data.proposal_info?.drains_total),
          irrigation_total: formatValue(data.proposal_info?.irrigation_total),
          landscaping_total: formatValue(data.proposal_info?.landscaping_total),
          maintenance_total: formatValue(data.proposal_info?.maintenance_total),
          total_budget: formatValue(data.proposal_info?.total_budget),
        };

        updateBudgetTotals(totals);
        updateBudgetSummary();
      }

      function addOptionLine(event) {
        event.preventDefault();
        const tableBody = document
          .getElementById("optionsTable")
          .querySelector("tbody");

        const newRow = tableBody.insertRow();

        const descCell = newRow.insertCell(0);
        const amountCell = newRow.insertCell(1);
        const actionCell = newRow.insertCell(2);

        descCell.innerHTML = `<input type="text" name="optionDescription[]" class="form-control" required>`;
        amountCell.innerHTML = `<input type="number" name="optionAmount[]" class="form-control" step="0.01" required>`;
        actionCell.innerHTML = `
            <button type="button" class="btn btn-danger remove-btn" onclick="removeOptionLine(this)">
            <i class="fas fa-trash-alt"></i>
            </button>`;
      }

      function removeOptionLine(btn) {
        var row = btn.closest("tr");
        if (row) {
          row.remove();
        }
      }

      // Update populateOptions to handle empty arrays better
      function populateOptions(options = []) {
        const optionsTable = document
          .getElementById("optionsTable")
          .getElementsByTagName("tbody")[0];
        if (!optionsTable) return;

        // Don't clear if we have no new options to add
        if (options && options.length > 0) {
          optionsTable.innerHTML = ""; // Only clear if we have new options

          options.forEach((option) => {
            const row = optionsTable.insertRow();
            const descCell = row.insertCell(0);
            const amountCell = row.insertCell(1);
            const actionCell = row.insertCell(2);

            descCell.innerHTML = `<input type="text" name="optionDescription[]" class="form-control" value="${
              option.description || ""
            }">`;
            amountCell.innerHTML = `<input type="number" name="optionAmount[]" class="form-control" value="${
              option.amount || 0
            }">`;
            actionCell.innerHTML = `
                    <button type="button" class="btn btn-danger remove-btn" onclick="removeOptionLine(this)">
                        <i class="fas fa-trash-alt"></i>
                    </button>`;
          });
        }
      }

      // Terms and Conditions management
      function addCustomTerm() {
        const termsContainer = document.querySelector(
          "#termsConditionsTable tbody"
        );
        const index = termsContainer.children.length;
        addTermRow(termsContainer, "", index);
        editTerm(index);
      }

      // Update the addTermRow function
      function addTermRow(container, termText, index) {
        const row = document.createElement("tr");
        row.className = "term-row";
        row.innerHTML = `
            <td>
                <div class="term-content">
                    <textarea class="term-textarea" id="term${index}" readonly>${termText}</textarea>
                    <div class="term-actions">
                        <button type="button" onclick="editTerm(${index})" class="btn btn-primary" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" onclick="removeTerm(${index})" class="btn btn-danger" title="Remove">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            </td>
        `;
        container.appendChild(row);
        adjustTextareaHeight(document.getElementById(`term${index}`));
      }

      // Function to edit a term
      function editTerm(index) {
        const textarea = document.getElementById(`term${index}`);
        textarea.readOnly = !textarea.readOnly;
        textarea.style.backgroundColor = textarea.readOnly
          ? "#f4f7f6"
          : "#ffffff";
        if (!textarea.readOnly) {
          textarea.focus();
        }
      }

      // Function to remove a term
      function removeTerm(index) {
        const row = document
          .getElementById(`term${index}`)
          .closest(".term-row");
        if (row) {
          row.remove();
        }
      }

      function populateTermsAndConditions(termsAndConditions) {
        const termsContainer = document.querySelector(
          "#termsConditionsTable tbody"
        );
        if (!termsContainer) {
          console.error("Terms and conditions table body not found");
          return;
        }

        // Clear existing terms
        termsContainer.innerHTML = "";

        // Default terms and conditions
        const defaultTerms = [
          "Contractor shall hold subcontractor harmless for damaged utility lines which are not buried to the depth specified by the utility companies. In addition, there will be an extra charge for all drainlines or pipes required to be placed deeper than shown on plans.",
          "Payment schedule: Progressive payments bi-weekly for all work completed and accepted. Five (5%) percent retention of contract amount may be held for thirty (30) days from the completion and acceptance of the work. This bid proposal will be considered a part of the contract if Buccola Landscape, Inc. is awarded the contract. It can either be an exhibit to the contract, or its pertinent points may be added to the contract.",
          "Prices are valid for work completed within six (6) months of proposal date.",
          "Bid is based on a five-day work week (Monday through Friday), 8 hour day maximum. All requested overtime work to be billed as extra.",
          "Any rock encountered below grade will be removed on a time and material basis.",
          "All costs for obtaining, transporting and utilization of water for construction, hydroseeding or irrigation are not included.",
          "Grade to be received by Buccola Landscape, Inc. at -40' of finish grade, and in a weed-free condition unless noted otherwise.",
          "This proposal is based on the entire job being completed in 1 phase(s). Any additional move-ins shall be compensated by the owner, including additional maintenance.",
          "Any specimen trees, park furniture, etc. that would require a deposit to initiate a hold order will require prompt reimbursement from the owner/client to Buccola Landscape, Inc. within seven (7) calendar days.",
          "Regarding palm/olive trees: The tree guarantee will apply to all palms/olives supplied in established boxes. Buccola Landscape, Inc. does not guarantee balled and burlaped palms, many of which have recently been relocated and/or transplanted by the tree suppliers. All palms/olives are subject to availability.",
          "Buccola Landscape, Inc. will agree to participate in an O.C.I.P. program if applicable to this project. Our bid reflects 'net' pricing and unless noted does not include additional monies for insurance premiums.",
          "This proposal is valid for thirty (30) days.",
        ];

        // Determine which terms to use
        let terms;
        if (
          Array.isArray(termsAndConditions) &&
          termsAndConditions.length > 0
        ) {
          terms = termsAndConditions;
        } else if (
          typeof termsAndConditions === "string" &&
          termsAndConditions.trim() !== ""
        ) {
          try {
            // Attempt to parse the string as JSON
            const parsedTerms = JSON.parse(termsAndConditions);
            if (Array.isArray(parsedTerms)) {
              terms = parsedTerms;
            } else {
              // If parsing doesn't result in an array, split by newlines
              terms = termsAndConditions
                .split("\n")
                .map((term) => term.trim())
                .filter((term) => term !== "");
            }
          } catch (e) {
            // If JSON parsing fails, split by newlines
            terms = termsAndConditions
              .split("\n")
              .map((term) => term.trim())
              .filter((term) => term !== "");
          }
        } else {
          terms = defaultTerms;
        }

        // Add each term as a new row
        terms.forEach((term, index) => {
          addTermRow(termsContainer, term, index);
        });
      }

      // Call this function when the document is loaded
      document.addEventListener("DOMContentLoaded", function () {
        initializeTermsAndConditions();
      });

      // 4. Ensure proper event binding on page load
      document.addEventListener("DOMContentLoaded", function () {
        const bidId = new URLSearchParams(window.location.search).get("bid_id");
        if (bidId) {
          loadProposalData(bidId);
        }

        // Add event listeners for real-time updates
        document.addEventListener("input", function (event) {
          if (
            event.target.classList.contains("line-value") ||
            event.target.classList.contains("line-name")
          ) {
            updateBudgetSummary();
          }
        });
      });

      // Textarea auto-adjust function
      function adjustTextareaHeight(textarea) {
        textarea.style.height = "auto";
        const computedStyle = window.getComputedStyle(textarea);
        const height =
          textarea.scrollHeight +
          parseInt(computedStyle.getPropertyValue("border-top-width"), 10) +
          parseInt(computedStyle.getPropertyValue("border-bottom-width"), 10);
        textarea.style.height = `${height}px`;
      }

      // Function to collapse all components
      function collapseAllComponents() {
        const components = document.querySelectorAll(".phase, .section");
        components.forEach((component) => {
          const linesContainer = component.querySelector(".lines-container");
          const addLineBtn = component.querySelector(".btn-outline-primary");
          const collapseBtn = component.querySelector(".toggle-collapse");

          if (linesContainer && addLineBtn && collapseBtn) {
            linesContainer.style.display = "none";
            addLineBtn.style.display = "none";
            collapseBtn.innerHTML = '<i class="fas fa-chevron-down"></i>';
          }
        });
      }

      function populateSectionsAndPhases(items) {
        const table = document
          .getElementById("sectionsTable")
          .getElementsByTagName("tbody")[0];
        if (!table) {
          console.error("Sections table not found");
          return;
        }
        table.innerHTML = ""; // Clear existing content

        for (const [category, categoryItems] of Object.entries(items)) {
          addComponentToTable("section", category, categoryItems);
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const bidId = urlParams.get("bid_id");
        const revision = urlParams.get("revision"); // e.g. "3"

        if (bidId && revision) {
          // fetch with revision
          fetch(`/get-proposal-items/${bidId}?revision_number=${revision}`)
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              renderProposalData(data);
            })
            .catch((error) => console.error("Error:", error));
        } else if (bidId) {
          // fallback if no revision param was provided
          fetch(`/get-proposal-items/${bidId}`)
            .then((response) => response.json())
            .then((data) => {
              renderProposalData(data);
            })
            .catch((error) => console.error("Error:", error));
        } else {
          // Set default exclusions if there's no proposal data
          document.getElementById("exclusionsTextarea").value =
            "Water meter service and hot taps, power for clocks, permits, all hardsce, all grading, import/export of soil, clearing or removal of any existing erosion control devices, demolition, grubbing, rodent control, water cost, downspout connections unless noted, and overtime.";
        }

        // Create initial sections and populate tables
        createLandscapeSection();
        populateSpecialNotesTable([]);
        // Add Section/Phase button
        const addComponentBtn = document.querySelector(
          'button[onclick="addComponent()"]'
        );
        if (addComponentBtn) {
          // Remove the inline onclick attribute
          addComponentBtn.removeAttribute("onclick");
          // Add the event listener here
          addComponentBtn.addEventListener("click", addComponent);
        } else {
          console.warn("Add Section/Phase button not found");
        }

        // Save Proposal button
        const saveProposalBtn = document.getElementById("saveProposalBtn");
        if (saveProposalBtn) {
          saveProposalBtn.addEventListener("click", saveProposal);
        } else {
          console.warn("Save Proposal button not found");
        }

        // Handle tab selection
        const tab = urlParams.get("tab") || "Heading";
        const tabButton = document.querySelector(
          `.tab-button[onclick="openTab(event, '${tab}')"]`
        );
        if (tabButton) {
          tabButton.click();
        } else {
          // If specified tab not found, click the first tab
          const firstTab = document.querySelector(".tab-button");
          if (firstTab) {
            firstTab.click();
          }
        }

        // Adjust textarea heights
        document
          .querySelectorAll("textarea.auto-adjust")
          .forEach(adjustTextareaHeight);

        // Prevent form submission on button click
        const proposalForm = document.getElementById("proposalForm");
        if (proposalForm) {
          proposalForm.addEventListener("submit", function (event) {
            const nextTab = document.getElementById("nextTabField").value;
            if (!nextTab) {
              event.preventDefault();
            }
          });
        } else {
          console.warn("Proposal form not found");
        }

        // Add event listener for input changes in the Sections tab
        document.addEventListener("input", function (event) {
          if (event.target.classList.contains("line-value")) {
            updateBudgetSummary();
          }
          if (
            event.target.tagName.toLowerCase() === "textarea" &&
            event.target.classList.contains("auto-adjust")
          ) {
            adjustTextareaHeight(event.target);
          }
        });
      });
    </script>
    {% endblock %}
  </form>
</div>
