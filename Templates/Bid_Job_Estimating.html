<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bid Job Estimating - {{ bid.bid_id }}</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <!-- Include jQuery first -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Include jQuery UI after jQuery (if needed) -->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

    <!-- Include Bootstrap JS -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.6.0/js/bootstrap.bundle.min.js"></script>

    <!-- Other scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .adjustment-container {
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 0;
        }

        .adjustment-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .adjustment-section {
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .section-title {
            font-size: 14px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
        }

        .radio-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        #sectionGroup {
            grid-template-columns: 1fr;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .radio-group label:hover {
            background-color: #e9ecef;
        }

        .radio-group input[type="radio"] {
            margin: 0;
        }

        .radio-group label.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .percentage-section {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .percentage-input:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        }
        .percentage-input {
            width: 120px;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-top: 0;
        }

        .results-table th,
        .results-table td {
            padding: 12px 16px;
            text-align: left;
            border: 1px solid #dee2e6;
            font-size: 14px;
        }

        .results-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            text-align: center;
        }

        .results-table .current-value,
        .results-table .adjusted-value {
            font-family: monospace;
            text-align: right;
        }

        .results-table .key-value {
            text-align: center;
            font-weight: 500;
            color: #495057;
        }

        .results-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .results-table .adjusted-value {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .results-table .adjusted-value:not(.na-value):hover {
            background-color: #e9ecef;
        }

        .na-value {
            color: #6c757d;
            font-style: italic;
        }

        .table-note {
            grid-column: 2;
            text-align: center;
            color: #6c757d;
            font-size: 12px;
            font-style: italic;
            margin-top: 8px;
        }
        /* Update these styles in your existing CSS */
        .results-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Styles for adjustment history and notifications */
        .adjustment-history-container {
            margin-top: 30px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #adjustmentHistoryTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        #adjustmentHistoryTable th,
        #adjustmentHistoryTable td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        #adjustmentHistoryTable th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        #adjustmentHistoryTable tr:hover {
            background-color: #f5f5f5;
        }

        .undo-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .undo-btn:hover {
            background-color: #c82333;
        }

        /* Notification styles */
        .notification {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            opacity: 1;
            transition: opacity 0.5s;
        }

        .notification.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .notification.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .notification.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }


        .percentage-container {
            text-align: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        /* Ensure proper spacing in mobile view */
        @media (max-width: 768px) {
            .percentage-container {
                margin-bottom: 15px;
            }
            
            .percentage-section {
                flex-direction: column;
                align-items: center;
            }

            .percentage-input {
                width: 100%;
                max-width: 200px;
            }
        }
        
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .dragging {
            background-color: #f0f0f0;
            opacity: 0.8;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
    
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    
        body {
            font-family: 'Open Sans', sans-serif;
            text-align: center;
            background: #f4f7f6;
            margin: 0;
            padding: 20px;
        }





        .itemsTable tbody tr.ui-sortable-helper {
            background-color: #f0f8ff; /* Alice blue background for the row being dragged */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            opacity: 0.9;
        }

        .itemsTable tbody tr.ui-sortable-placeholder {
            background-color: #e0f0ff; /* Light blue background for the placeholder */
            height: 40px; /* Adjust as needed */
            visibility: visible !important;
            border: 2px dashed #4a90e2; /* Blue dashed border for the placeholder */
        }

        .tab {
            overflow: hidden;
            border: 1px solid #007bff;
            background-color: #e7f0fa;
        }
    
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
            color: #007bff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    
        .tab button:hover, .tab button.active {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
    
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #007bff;
            border-top: none;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            font-size: 100%;
        }
        .tabcontent {
            display: none;
        }

        .tabcontent.active {
            display: block;
        }
        .heading-info {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 20px;
        }
    
        .heading-content {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
    
        .budget-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
        }

        .budget-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .section-title {
            font-size: 14px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
        }

        .budget-grid {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .budget-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            background-color: #f0f8ff;
            border: 1px solid #d1e8ff;
        }

        .budget-label {
            font-size: 14px;
            color: #333;
        }

        .budget-value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .grand-total {
            background-color: #e6f3ff;
            border: 1px solid #b3d9ff;
        }
        
        .grand-total .budget-value {
            color: #007bff;
        }

        .total-budget {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 15px;
        }

        .total-budget .section-title {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        @media (max-width: 480px) {
            .budget-grid {
                grid-template-columns: 1fr;
            }
        }

        .info-table-container {
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #007bff;
        }
    
        .info-table-container input[type="text"].partNumInput,
        .info-table-container input[type="text"].factorCodeInput {
            padding: 24px 30px;
            font-size: 1.2em;
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
        }
    
        .placeholder {
            color: #999;
            font-style: italic;
        }
    
        .itemsTable input[type="text"],
        .itemsTable input[type="number"] {
            height: 35px;
            padding: 6px 12px;
            font-size: 1.1em;
            border: 1px solid #ccc;
            box-sizing: border-box;
            width: 100%;
        }
    
        /* Enhanced styles for autocomplete dropdowns */
        .ui-autocomplete {
            max-width: 600px;
            width: auto !important;
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 1000;
            border: 1px solid #ddd;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    
        .ui-menu-item {
            padding: 8px 10px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1.4;
            border-bottom: 1px solid #f0f0f0;
        }
    
        .ui-menu-item:last-child {
            border-bottom: none;
        }
    
        .ui-menu-item:hover,
        .ui-state-active {
            background-color: #f0f0f0;
            border-color: #f0f0f0;
        }
    
        .ui-autocomplete .part-number-item,
        .ui-autocomplete .factor-code-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    
        .ui-autocomplete .part-number-item .item-details,
        .ui-autocomplete .factor-code-item .item-details {
            flex-grow: 1;
        }
    
        .ui-autocomplete .part-number-item .item-price {
            white-space: nowrap;
            margin-left: 10px;
            color: #007bff;
            font-weight: bold;
        }
    
        .ui-autocomplete .factor-code-item .item-labor-hours {
            white-space: nowrap;
            margin-left: 10px;
            color: #28a745;
            font-weight: bold;
        }
    
        .ui-autocomplete::-webkit-scrollbar {
            width: 8px;
        }
    
        .ui-autocomplete::-webkit-scrollbar-thumb {
            background: #007bff;
            border-radius: 4px;
        }
    
        .ui-autocomplete::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
    
        .action-buttons {
            margin-bottom: 20px;
            text-align: center;
        }
    
        table.itemsTable th, 
        table.itemsTable td {
            padding: 12px;
            font-size: 1em;
        }
    
        .budget-container {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 15px;
            max-width: 100%;
            box-sizing: border-box;
        }
    
        @media (max-width: 480px) {
            .budget-grid {
                grid-template-columns: 1fr;
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
            margin-bottom: 20px;
        }
    
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e1e1e1;
        }
    
        th {
            background: linear-gradient(180deg, #e9eff9 0%, #dce4f1 100%);
            color: #333;
            font-weight: 600;
            border-bottom: 2px solid #007bff;
        }
    
        tbody tr:nth-child(odd) {
            background-color: #f9f9f9;
        }
    
        tbody tr:hover {
            background-color: #eef4fb;
        }
    
        .action-buttons button, .removeBtn {
            padding: 12px 18px;
            font-size: 21px;
            border-radius: 6px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
    
        .action-buttons button:hover, .removeBtn:hover {
            background-color: #007BFF;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16);
        }
    
        .removeBtn {
            background-color: #dc3545;
        }
    
        .removeBtn:hover {
            background-color: #c82333;
        }
    
        .total-cost {
            text-align: right;
            font-size: 1.5rem;
            font-weight: 600;
            color: #007bff;
            margin-top: 20px;
        }
    
        label {
            margin-right: 10px;
        }
    
        .heading-details {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
        }
    
        .detail-container {
            flex-grow: 1;
            min-width: 250px;
            padding: 10px;
            box-sizing: border-box;
        }
    
        .heading-details label {
            font-size: 1.5em;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
    
        .heading-details input[type="text"] {
            font-size: 1.2em;
            padding: 10px;
            margin-bottom: 10px;
        }
    
        .tabcontent caption,
        .tabcontent h3 {
            font-weight: bold;
            font-size: 2.1em;
        }
    
        .itemsTable th.lineNumber, .itemsTable td.lineNumber {
            width: 5%;
        }
    
        .itemsTable th.partNumber, .itemsTable td.partNumber {
            width: 9%;
        }
    
        .itemsTable th.description, .itemsTable td.description {
            width: auto;
        }
        .itemsTable th.factorCode, .itemsTable td.factorCode {
            width: 8%;
        }
        .itemsTable th.quantity, .itemsTable td.quantity {
            width: 5%;
        }
        .itemsTable th.cost, .itemsTable td.cost,
        .itemsTable th.lineCost, .itemsTable td.lineCost,
        .itemsTable th.laborHours, .itemsTable td.laborHours,
        .itemsTable th.action, .itemsTable td.action {
            width: 10%;
        }
        .selected {
            background-color: #e0e0e0;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
            position: relative;
        }
        .save-and-close-btn.top-right {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }

        .additional-description-row td {
            padding: 10px;
        }

        .additional-description-row .additionalDescriptionInput {
            width: 100%;
            padding: 5px;
        }

        .additional-description-row .line-ext-cost {
            text-align: right;
            font-weight: bold;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .save-and-close-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        .save-and-close-btn:hover {
            background-color: #45a049;
        }
        .popout {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
        }
        .itemsTable tbody tr.selected {
            background-color: #e6f3ff; /* Light blue background for selected rows */
        }

        .itemsTable tbody tr.active-dropdown {
            background-color: #4a90e2; /* Darker blue for rows with active dropdown */
        }

        .itemsTable tbody tr.active-dropdown input {
            background-color: white; /* Keep input backgrounds white for readability */
            color: black; /* Keep input text black */
        }

        /* New style to maintain blue color on hover for active-dropdown rows */
        .itemsTable tbody tr.active-dropdown:hover {
            background-color: #4a90e2; /* Keep the same blue color on hover */
        }

        /* If you have a general hover style for rows, you might want to update it like this: */
        .itemsTable tbody tr:hover {
            background-color: #f5f5f5; /* Light grey for normal hover */
        }

        /* This ensures that the active-dropdown color takes precedence over the normal hover color */
        .itemsTable tbody tr.active-dropdown:hover {
            background-color: #4a90e2 !important; /* Use !important to override any other hover styles */
        }

        .additional-info-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            width: 100%;
        }
        .additional-description, .line-ext-cost {
            flex: 1;
        }
        .additional-description {
            margin-right: 20px;
            text-align: left;
        }
        .additional-description input {
            width: 100%;
            max-width: 500px;
            padding: 8px;
            font-size: 1em;
        }
        .line-ext-cost {
            text-align: right;
        }
        .line-ext-cost label {
            margin-right: 10px;
        }
        .sub-bid-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #e7f0fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .sub-bid-entry div {
            flex: 1;
            text-align: left;
            color: #007bff;
            font-weight: bold;
        }
        .sub-bid-entry button {
            padding: 10px 20px;
            font-size: 16px;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .sub-bid-entry button:hover {
            background-color: #0056b3;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16);
        }
        .save-button-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        #saveButton {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #saveButton:hover {
            background-color: #45a049;
        }
        /* Modal content table styles */
        .modal-content .itemsTable {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .modal-content .itemsTable th,
        .modal-content .itemsTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .modal-content .itemsTable th {
            background-color: #f2f2f2;
        }
        .modal-content .itemsTable input[type="text"],
        .modal-content .itemsTable input[type="number"] {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }
        /* Responsive adjustments */
        @media screen and (max-width: 1024px) {
            .modal-content {
                width: 95%;
                margin: 2% auto;
            }
        }
        @media screen and (max-width: 768px) {
            .modal-content {
                width: 98%;
                margin: 1% auto;
                padding: 10px;
            }
            .modal-content .itemsTable {
                font-size: 14px;
            }
            .modal-content .itemsTable th,
            .modal-content .itemsTable td {
                padding: 5px;
            }
        }
        .drag-handle {
            cursor: move;
            user-select: none;
            width: 20px;
            text-align: center;
        }
        .itemsTable tbody tr {
            cursor: move;
        }

        .ui-sortable-helper {
            display: table;
            table-layout: fixed;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        /* Reduce font size for description column */
        .itemsTable td input.descriptionInput {
            font-size: 0.95em; /* Adjust this value as needed */
            padding: 4px 6px; /* Reduce padding to fit smaller text */
        }

        /* Optionally, adjust the width of the description column if needed */
        .itemsTable th.description,
        .itemsTable td:nth-child(3) {
            width: auto; /* or set a specific width, e.g., width: 25%; */
        }

        /* If the text is still truncated, you can add this to show full content */
        .itemsTable td input.descriptionInput {
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <input type="hidden" name="csrf_token" id="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" id="bidId" value="{{ bid.bid_id }}">
    <input type="hidden" id="currentUsername" value="{{ current_user.username }}">
    <input type="hidden" id="currentUserId" value="{{ current_user.id }}">
    <div id="confirmDialog" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">{content}
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 300px; text-align: center;">
            <p id="confirmMessage"></p>
            <button id="confirmYes">Yes</button>
            <button id="confirmNo">No</button>
            <p style="font-size: 0.8em; margin-top: 10px;">Press Enter to confirm</p>
        </div>
        <div id="subBidConfirmDialog" style="display: none; position: absolute; z-index: 2000; left: 50%; top: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <p id="subBidConfirmMessage">Are you sure you want to delete this item?</p>
            <button id="subBidConfirmYes">Yes</button>
            <button id="subBidConfirmNo">No</button>
            <p style="font-size: 0.8em; margin-top: 10px;">Press Enter to confirm</p>
        </div>
    </div>
    <div id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    
    <div class="bid-header-container">
        <div class="home-button-container">
            <a href="/" class="home-button">Home</a>
        </div>
        <h1 class="bid-title"><span id="bidTitleText">{{ bid.project_name }}: {{ bid.bid_id }}</span></h1>
        <div class="save-button-container">
            <button id="saveButton" onclick="saveBid()">Save</button>
        </div>
    </div>
    <div class="tab">
        <button class="tablinks" onclick="openCategory(event, 'Heading')">Heading</button>
        <button class="tablinks" onclick="openCategory(event, 'Drains')">Drains</button>
        <button class="tablinks" onclick="openCategory(event, 'Irrigation')">Irrigation</button>
        <button class="tablinks" onclick="openCategory(event, 'Landscape')">Landscape</button>
        <button class="tablinks" onclick="openCategory(event, 'Maintenance')">Maintenance</button>
        <button class="tablinks" onclick="openCategory(event, 'Subcontractor')">Subcontractor</button>
        <button class="tablinks" onclick="openCategory(event, 'Adjustment')">Adjustment</button>
    </div>
    <div id="Heading" class="tabcontent">
        <h3>{{ bid.bid_id }} Summary</h3>
        <div class="heading-details">
            <div class="detail-container">
                <label for="bidJobId">Bid/Job ID</label>
                <input type="text" id="bidJobId" value="{{ bid.bid_id }}" readonly>
            </div>
            <div class="detail-container">
                <label for="bidDate">Bid Created</label>
                <input type="text" id="bidDate" value="2024-08-27" readonly>
            </div>
            <div class="detail-container">
                <label for="architectName">Architect</label>
                <input type="text" id="architectName" value="">
            </div>
            <div class="detail-container">
                <label for="engineerName">Engineer</label>
                <input type="text" id="engineerName" value="">
            </div>
            <div class="detail-container">
                <label for="bidAmount">Bid Amount</label>
                <input type="text" id="bidAmount" value="">
            </div>
        </div>
        <div class="heading-content">
            <div class="info-table-container">
                <table>
                    <caption>Customer Information</caption>
                    <tr>
                        <th>Name</th>
                        <td>
                            <input type="text" id="customerName" value="{{ bid.customer_name }}" autocomplete="off">
                            <div id="customerSearchResults"></div>
                        </td>
                    </tr>
                    <tr><th>Address</th><td><input type="text" id="customerAddress" value="{{ bid.customer.customer_address }}"></td></tr>
                    <tr><th>State</th><td><input type="text" id="customerState" value="{{ bid.customer.customer_state }}"></td></tr>
                    <tr><th>City</th><td><input type="text" id="customerCity" value="{{ bid.customer.customer_city }}"></td></tr>
                    <tr><th>Zip Code</th><td><input type="text" id="customerZip" value="{{ bid.customer.customer_zip }}"></td></tr>
                </table>
            </div>
            <div class="info-table-container">
                <table>
                    <caption>Labor Rates (Hourly)</caption>
                    <tr><th>Drains</th><td><input type="number" id="laborRateDrains" value="31"></td></tr>
                    <tr><th>Irrigation</th><td><input type="number" id="laborRateIrrigation" value="31"></td></tr>
                    <tr><th>Landscape</th><td><input type="number" id="laborRateLandscape" value="31"></td></tr>
                    <tr><th>Maintenance</th><td><input type="number" id="laborRateMaintenance" value="31"></td></tr>
                    <tr><th>Local Sales Tax (%)</th><td><input type="number" id="localSalesTax" value="8.75"></td></tr>
                </table>
            </div>
            <div class="info-table-container">
                <table>
                    <caption>Project Details</caption>
                    <tr><th>Name</th><td><input type="text" id="projectName" value="{{ bid.project_name }}"></td></tr>
                    <tr><th>Address</th><td><input type="text" id="projectAddress" value="{{ bid.project_address }}"></td></tr>
                    <tr><th>State</th><td><input type="text" id="projectState" value="{{ bid.project_state }}"></td></tr>
                    <tr><th>City</th><td><input type="text" id="projectCity" value="{{ bid.project_city }}"></td></tr>
                    <tr><th>Zip Code</th><td><input type="text" id="projectZip" value="{{ bid.project_zip }}"></td></tr>
                    <tr><th>Point of Contact</th><td><input type="text" id="pointOfContact" value="{{ bid.point_of_contact }}"></td></tr>
                    <tr>
                        <th>Comments</th>
                        <td>
                            <textarea id="bidComments" rows="4" style="width: 100%; padding: 8px; resize: vertical;"
                                placeholder="Enter any comments or notes about this bid...">{{ bid.comments }}</textarea>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="info-table-container">
                <table class="budget-summary-table">
                    <caption>Project Budget Summary</caption>
                    <tr>
                        <th colspan="2">Category Totals</th>
                    </tr>
                    <tr>
                        <td>Drains:</td>
                        <td><span id="drainsTotalValue">$185.00</span></td>
                    </tr>
                    <tr>
                        <td>Irrigation:</td>
                        <td><span id="irrigationTotalValue">$0.00</span></td>
                    </tr>
                    <tr>
                        <td>Landscape:</td>
                        <td><span id="landscapeTotalValue">$0.00</span></td>
                    </tr>
                    <tr>
                        <td>Maintenance:</td>
                        <td><span id="maintenanceTotalValue">$0.00</span></td>
                    </tr>
                    <tr>
                        <th colspan="2">Total Budget</th>
                    </tr>
                    <tr>
                        <td>Material:</td>
                        <td><span id="materialTotalValue">$185.00</span></td>
                    </tr>
                    <tr>
                        <td>Labor:</td>
                        <td><span id="laborTotalValue">$99.20</span></td>
                    </tr>
                    <tr>
                        <td>Subcontractor:</td>
                        <td><span id="subcontractorTotalValue">$53.18</span></td>
                    </tr>
                    <tr>
                        <td>Other Materials:</td>
                        <td><span id="otherMaterialsTotalValue">$20.84</span></td>
                    </tr>
                    <tr>
                        <td>Tax:</td>
                        <td><span id="taxTotalValue">$0.00</span></td>
                    </tr>
                    <tr class="grand-total">
                        <td>Grand Total:</td>
                        <td><span id="grandTotalValue">$358.22</span></td>
                    </tr>
                </table>
            </div>
        </div>    
    </div>      
    <!-- Drains Section -->
    <div id="Drains" class="tabcontent">
        <h3>Drains</h3>
        <div class="content-wrapper" id="drainsWrapper">
            <div class="action-buttons">
                <button class="addBtn" onclick="addBlankLineItem('drainsWrapper')">Add Line Item</button>
                <button class="insertBtn" onclick="insertBlankLineItem('drainsWrapper')">Insert Line Item</button>
                <button class="otherMaterialsBtn" onclick="showOtherMaterials('drains')">Other Materials</button>
                <button class="subBidBtn" onclick="openSubBidModal('drains')">Sub Bid</button>
                <button class="generateReportBtn" onclick="generateCombinedReport('drains')">Generate Report</button>
            </div>
            
            <div class="factor-code-search-container">
                <input type="text" id="factorCodeSearchDrains" placeholder="Search Factor Codes..." oninput="searchFactorCodes('factorCodeSearchDrains', 'factorCodeSearchResultsDrains')">
                <div id="factorCodeSearchResultsDrains" class="factor-code-dropdown" style="display: none;"></div>
            </div>

            <table class="itemsTable">
                <thead>
                    <tr>
                        <th class="lineNumber">Line Number</th>
                        <th class="partNumber">Part Number</th>
                        <th class="description">Description</th>
                        <th class="factorCode">Factor Code</th>
                        <th class="quantity">Quantity</th>
                        <th class="cost">Bid Price</th>
                        <th class="laborHours">Labor Hours</th>
                        <th class="otherMaterials">Other Materials</th>
                        <th class="total">Total</th>
                        <th class="action">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamically generated rows will be inserted here -->
                </tbody>
            </table>
            <div class="total-cost">
                <h2>Material Cost: <span class="totalMaterialCost">$0.00</span></h2>
                <h2>Labor Cost: <span class="totalLaborCost">$0.00</span></h2>
                <h2>Other Materials Cost: <span class="totalOtherMaterialsCost">$0.00</span></h2>
                <h2>Total Cost: <span class="totalCost">$0.00</span></h2>
            </div>
        </div>
    </div>

    <!-- Irrigation Section -->
    <div id="Irrigation" class="tabcontent">
        <h3>Irrigation</h3>
        <div class="content-wrapper" id="irrigationWrapper">
            <div class="action-buttons">
                <button class="addBtn" onclick="addBlankLineItem('irrigationWrapper')">Add Line Item</button>
                <button class="insertBtn" onclick="insertBlankLineItem('irrigationWrapper')">Insert Line Item</button>
                <button class="otherMaterialsBtn" onclick="showOtherMaterials('irrigation')">Other Materials</button>
                <button class="subBidBtn" onclick="openSubBidModal('irrigation')">Sub Bid</button>
                <button class="generateReportBtn" onclick="generateCombinedReport('irrigation')">Generate Report</button>
            </div>
            
            <div class="factor-code-search-container">
                <input type="text" id="factorCodeSearchIrrigation" placeholder="Search Factor Codes..." oninput="searchFactorCodes('factorCodeSearchIrrigation', 'factorCodeSearchResultsIrrigation')">
                <div id="factorCodeSearchResultsIrrigation" class="factor-code-dropdown" style="display: none;"></div>
            </div>

            <table class="itemsTable">
                <thead>
                    <tr>
                        <th class="lineNumber">Line Number</th>
                        <th class="partNumber">Part Number</th>
                        <th class="description">Description</th>
                        <th class="factorCode">Factor Code</th>
                        <th class="quantity">Quantity</th>
                        <th class="cost">Bid Price</th>
                        <th class="laborHours">Labor Hours</th>
                        <th class="otherMaterials">Other Materials</th>
                        <th class="total">Total</th>
                        <th class="action">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamically generated rows will be inserted here -->
                </tbody>
            </table>
            <div class="total-cost">
                <h2>Material Cost: <span class="totalMaterialCost">$0.00</span></h2>
                <h2>Labor Cost: <span class="totalLaborCost">$0.00</span></h2>
                <h2>Other Materials Cost: <span class="totalOtherMaterialsCost">$0.00</span></h2>
                <h2>Total Cost: <span class="totalCost">$0.00</span></h2>
            </div>
        </div>
    </div>

    <!-- Landscape Section -->
    <div id="Landscape" class="tabcontent">
        <h3>Landscape</h3>
        <div class="content-wrapper" id="landscapeWrapper">
            <div class="action-buttons">
                <button class="addBtn" onclick="addBlankLineItem('landscapeWrapper')">Add Line Item</button>
                <button class="insertBtn" onclick="insertBlankLineItem('landscapeWrapper')">Insert Line Item</button>
                <button class="otherMaterialsBtn" onclick="showOtherMaterials('landscape')">Other Materials</button>
                <button class="subBidBtn" onclick="openSubBidModal('landscape')">Sub Bid</button>
                <button class="generateReportBtn" onclick="generateCombinedReport('landscape')">Generate Report</button>
            </div>
            
            <div class="factor-code-search-container">
                <input type="text" id="factorCodeSearchLandscape" placeholder="Search Factor Codes..." oninput="searchFactorCodes('factorCodeSearchLandscape', 'factorCodeSearchResultsLandscape')">
                <div id="factorCodeSearchResultsLandscape" class="factor-code-dropdown" style="display: none;"></div>
            </div>

            <table class="itemsTable">
                <thead>
                    <tr>
                        <th class="lineNumber">Line Number</th>
                        <th class="partNumber">Part Number</th>
                        <th class="description">Description</th>
                        <th class="factorCode">Factor Code</th>
                        <th class="quantity">Quantity</th>
                        <th class="cost">Bid Price</th>
                        <th class="laborHours">Labor Hours</th>
                        <th class="otherMaterials">Other Materials</th>
                        <th class="total">Total</th>
                        <th class="action">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamically generated rows will be inserted here -->
                </tbody>
            </table>
            <div class="total-cost">
                <h2>Material Cost: <span class="totalMaterialCost">$0.00</span></h2>
                <h2>Labor Cost: <span class="totalLaborCost">$0.00</span></h2>
                <h2>Other Materials Cost: <span class="totalOtherMaterialsCost">$0.00</span></h2>
                <h2>Total Cost: <span class="totalCost">$0.00</span></h2>
            </div>
        </div>
    </div>

    <!-- Maintenance Section -->
    <div id="Maintenance" class="tabcontent">
        <h3>Maintenance</h3>
        <div class="content-wrapper" id="maintenanceWrapper">
            <div class="action-buttons">
                <button class="addBtn" onclick="addBlankLineItem('maintenanceWrapper')">Add Line Item</button>
                <button class="insertBtn" onclick="insertBlankLineItem('maintenanceWrapper')">Insert Line Item</button>
                <button class="otherMaterialsBtn" onclick="showOtherMaterials('maintenance')">Other Materials</button>
                <button class="subBidBtn" onclick="openSubBidModal('maintenance')">Sub Bid</button>
                <button class="generateReportBtn" onclick="generateCombinedReport('maintenance')">Generate Report</button>
            </div>
            
            <div class="factor-code-search-container">
                <input type="text" id="factorCodeSearchMaintenance" placeholder="Search Factor Codes..." oninput="searchFactorCodes('factorCodeSearchMaintenance', 'factorCodeSearchResultsMaintenance')">
                <div id="factorCodeSearchResultsMaintenance" class="factor-code-dropdown" style="display: none;"></div>
            </div>

            <table class="itemsTable">
                <thead>
                    <tr>
                        <th class="lineNumber">Line Number</th>
                        <th class="partNumber">Part Number</th>
                        <th class="description">Description</th>
                        <th class="factorCode">Factor Code</th>
                        <th class="quantity">Quantity</th>
                        <th class="cost">Bid Price</th>
                        <th class="laborHours">Labor Hours</th>
                        <th class="otherMaterials">Other Materials</th>
                        <th class="total">Total</th>
                        <th class="action">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamically generated rows will be inserted here -->
                </tbody>
            </table>
            <div class="total-cost">
                <h2>Material Cost: <span class="totalMaterialCost">$0.00</span></h2>
                <h2>Labor Cost: <span class="totalLaborCost">$0.00</span></h2>
                <h2>Other Materials Cost: <span class="totalOtherMaterialsCost">$0.00</span></h2>
                <h2>Total Cost: <span class="totalCost">$0.00</span></h2>
            </div>
        </div>
    </div>

    <!-- Subcontractor Section -->
    <div id="Subcontractor" class="tabcontent">
        <h3>Subcontractor</h3>
        <div class="content-wrapper" id="subcontractorWrapper">
            <div class="action-buttons">
                <button class="addBtn" onclick="addBlankLineItem('subcontractorWrapper')">Add Line Item</button>
                <button class="insertBtn" onclick="insertBlankLineItem('subcontractorWrapper')">Insert Line Item</button>
                <button class="otherMaterialsBtn" onclick="showOtherMaterials('subcontractor')">Other Materials</button>
                <button class="subBidBtn" onclick="openSubBidModal('subcontractor')">Sub Bid</button>
                <button class="generateReportBtn" onclick="generateCombinedReport('subcontractor')">Generate Report</button>
            </div>
            
            <div class="factor-code-search-container">
                <input type="text" id="factorCodeSearchSubcontractor" placeholder="Search Factor Codes..." oninput="searchFactorCodes('factorCodeSearchSubcontractor', 'factorCodeSearchResultsSubcontractor')">
                <div id="factorCodeSearchResultsSubcontractor" class="factor-code-dropdown" style="display: none;"></div>
            </div>

            <table class="itemsTable">
                <thead>
                    <tr>
                        <th class="lineNumber">Line Number</th>
                        <th class="partNumber">Part Number</th>
                        <th class="description">Description</th>
                        <th class="quantity">Quantity</th>
                        <th class="cost">Bid Price</th>
                        <th class="total">Total</th>
                        <th class="action">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamically generated rows -->
                </tbody>
            </table>
            <div class="total-cost">
                <h2>Total Cost: <span class="totalCost">$0.00</span></h2>
            </div>
        </div>
    </div>

    <div id="Adjustment" class="tabcontent">
        <h3>Proposal Adjustment</h3>
        <div class="adjustment-container">
            <div class="adjustment-controls">
                <div class="adjustment-section">
                    <div class="section-title">Select Section:</div>
                    <div class="radio-group" id="sectionGroup">
                        <label>
                            <input type="radio" name="category" value="Drains">
                            Drains
                        </label>
                        <label>
                            <input type="radio" name="category" value="Irrigation">
                            Irrigation
                        </label>
                        <label>
                            <input type="radio" name="category" value="Landscape">
                            Landscape
                        </label>
                        <label>
                            <input type="radio" name="category" value="Maintenance">
                            Maintenance
                        </label>
                    </div>
                </div>
        
                <div class="adjustment-section">
                    <div class="section-title">Adjustment Type:</div>
                    <div class="radio-group" id="typeGroup">
                        <label>
                            <input type="radio" name="adjustmentType" value="Materials">
                            Materials
                        </label>
                        <label>
                            <input type="radio" name="adjustmentType" value="Labor">
                            Labor
                        </label>
                    </div>
                </div>
        
                <div class="adjustment-section">
                    <div class="section-title">Direction:</div>
                    <div class="radio-group" id="directionGroup">
                        <label>
                            <input type="radio" name="direction" value="increase">
                            Increase
                        </label>
                        <label>
                            <input type="radio" name="direction" value="decrease">
                            Decrease
                        </label>
                    </div>
                </div>
            </div>
        
            <div class="results-section">
                <div class="percentage-container">
                    <div class="section-title">Adjustment Percentage:</div>
                    <div class="percentage-section">
                        <input type="number" id="adjustmentPercentage" class="percentage-input" 
                               min="0" max="100" step="0.1" placeholder="Enter %">
                    </div>
                </div>
        
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Current</th>
                            <th>Key</th>
                            <th>Adjusted</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="material-row">
                            <td class="current-value">$0.00</td>
                            <td class="key-value">Material</td>
                            <td class="adjusted-value na-value">N/A</td>
                        </tr>
                        <tr class="labor-row">
                            <td class="current-value">$0.00</td>
                            <td class="key-value">Labor</td>
                            <td class="adjusted-value na-value">N/A</td>
                        </tr>
                    </tbody>
                </table>
        
                <!-- Make sure this button ID is correct -->
                <button id="applyAdjustment" class="submit-btn" disabled>
                    Apply Adjustment
                </button>
            </div>
        </div>
        
        <!-- Add the history section -->
        <div class="adjustment-history-container">
            <h4>Adjustment History</h4>
            <table id="adjustmentHistoryTable" class="results-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>User</th>
                        <th>Section</th>
                        <th>Type</th>
                        <th>Direction</th>
                        <th>Percentage</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Adjustment history rows will be dynamically added here -->
                </tbody>
            </table>
        </div>
    </div>
    
    <div id="drainsSubBidModal" class="modal">
        <div class="modal-content">
            <button class="save-and-close-btn top-right" onclick="saveAndCloseSubBid('drains')">Save and Close</button>
            <div id="drainsSubBidsList"></div>
            <div class="create-sub-bid" id="createSubBidDrains">
                <input type="text" id="newSubBidNameDrains" placeholder="Enter Sub Bid Name">
                <button onclick="createNewSubBid('drains')">Create New Sub Bid</button>
            </div>
            <div id="drainsSubBidContent"></div>
        </div>
    </div>
    
    <div id="irrigationSubBidModal" class="modal">
        <div class="modal-content">
            <button class="save-and-close-btn top-right" onclick="saveAndCloseSubBid('irrigation')">Save and Close</button>
            <div id="irrigationSubBidsList"></div>
            <div class="create-sub-bid" id="createSubBidIrrigation">
                <input type="text" id="newSubBidNameIrrigation" placeholder="Enter Sub Bid Name">
                <button onclick="createNewSubBid('irrigation')">Create New Sub Bid</button>
            </div>
            <div id="irrigationSubBidContent"></div>
        </div>
    </div>
    
    <div id="landscapeSubBidModal" class="modal">
        <div class="modal-content">
            <button class="save-and-close-btn top-right" onclick="saveAndCloseSubBid('landscape')">Save and Close</button>
            <div id="landscapeSubBidsList"></div>
            <div class="create-sub-bid" id="createSubBidLandscape">
                <input type="text" id="newSubBidNameLandscape" placeholder="Enter Sub Bid Name">
                <button onclick="createNewSubBid('landscape')">Create New Sub Bid</button>
            </div>
            <div id="landscapeSubBidContent"></div>
        </div>
    </div>
    
    <div id="maintenanceSubBidModal" class="modal">
        <div class="modal-content">
            <button class="save-and-close-btn top-right" onclick="saveAndCloseSubBid('maintenance')">Save and Close</button>
            <div id="maintenanceSubBidsList"></div>
            <div class="create-sub-bid" id="createSubBidMaintenance">
                <input type="text" id="newSubBidNameMaintenance" placeholder="Enter Sub Bid Name">
                <button onclick="createNewSubBid('maintenance')">Create New Sub Bid</button>
            </div>
            <div id="maintenanceSubBidContent"></div>
        </div>
    </div>
    
    <div id="subcontractorSubBidModal" class="modal">
        <div class="modal-content">
            <button class="save-and-close-btn top-right" onclick="saveAndCloseSubBid('subcontractor')">Save and Close</button>
            <div id="subcontractorSubBidsList"></div>
            <div class="create-sub-bid" id="createSubBidSubcontractor">
                <input type="text" id="newSubBidNameSubcontractor" placeholder="Enter Sub Bid Name">
                <button onclick="createNewSubBid('subcontractor')">Create New Sub Bid</button>
            </div>
            <div id="subcontractorSubBidContent"></div>
        </div>
    <script>
        // 1. Add this function definition near the top of your script:
        function getFloatValueSafely(id) {
            const element = document.getElementById(id);
            if (!element) return 0;
            
            const value = element.value.trim();
            if (value === '') return 0;
            
            const parsed = parseFloat(value);
            return isNaN(parsed) ? 0 : parsed;
        }

        function calculateAdjustment() {
            // Validate inputs
            const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked'))
                .map(checkbox => checkbox.value);
            
            const adjustmentType = document.querySelector('input[name="adjustmentType"]:checked')?.value;
            const direction = document.querySelector('input[name="direction"]:checked')?.value;
            const percentage = parseFloat(document.getElementById('adjustmentPercentage').value);

            if (selectedCategories.length === 0 || !adjustmentType || !direction || isNaN(percentage)) {
                alert('Please fill in all fields');
                return;
            }

            // Calculate adjustments for each selected category
            let totalCurrentMaterial = 0;
            let totalCurrentLabor = 0;
            let totalAdjustedMaterial = 0;
            let totalAdjustedLabor = 0;

            selectedCategories.forEach(category => {
                const wrapper = $(`#${category.toLowerCase()}Wrapper`);
                const categoryTotals = calculateCategoryTotal(
                    `${category.toLowerCase()}Wrapper`,
                    getLaborRate(`${category.toLowerCase()}Wrapper`)
                );

                totalCurrentMaterial += categoryTotals.materialTotal;
                totalCurrentLabor += categoryTotals.laborTotal;

                const multiplier = direction === 'increase' ? (1 + percentage / 100) : (1 - percentage / 100);
                
                if (adjustmentType === 'Materials') {
                    totalAdjustedMaterial += categoryTotals.materialTotal * multiplier;
                    totalAdjustedLabor += categoryTotals.laborTotal;
                } else {
                    totalAdjustedMaterial += categoryTotals.materialTotal;
                    totalAdjustedLabor += categoryTotals.laborTotal * multiplier;
                }
            });

            // Show results table
            const resultsTable = document.querySelector('.results-table');
            resultsTable.style.display = 'block';

            const materialRow = resultsTable.querySelector('.material-row');
            const laborRow = resultsTable.querySelector('.labor-row');

            materialRow.querySelector('.current-value').textContent = `$${totalCurrentMaterial.toFixed(2)}`;
            materialRow.querySelector('.adjusted-value').textContent = `$${totalAdjustedMaterial.toFixed(2)}`;
            laborRow.querySelector('.current-value').textContent = `$${totalCurrentLabor.toFixed(2)}`;
            laborRow.querySelector('.adjusted-value').textContent = `$${totalAdjustedLabor.toFixed(2)}`;

            // Show submit button
            document.getElementById('submitAdjustment').style.display = 'inline-block';
        }

        function submitAdjustment() {
            const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked'))
                .map(checkbox => checkbox.value);
            const adjustmentType = document.querySelector('input[name="adjustmentType"]:checked').value;
            const direction = document.querySelector('input[name="direction"]:checked').value;
            const percentage = parseFloat(document.getElementById('adjustmentPercentage').value);
            const multiplier = direction === 'increase' ? (1 + percentage / 100) : (1 - percentage / 100);

            selectedCategories.forEach(category => {
                const wrapper = $(`#${category.toLowerCase()}Wrapper`);
                wrapper.find('.itemsTable tbody tr').each(function() {
                    if (adjustmentType === 'Materials') {
                        const costInput = $(this).find('.costInput');
                        const currentCost = parseFloat(costInput.val()) || 0;
                        costInput.val((currentCost * multiplier).toFixed(2));
                    } else {
                        const laborInput = $(this).find('.laborHoursInput');
                        const currentLabor = parseFloat(laborInput.val()) || 0;
                        laborInput.val((currentLabor * multiplier).toFixed(4));
                    }
                    updateLineAndTotalCosts($(this).find('.quantity input')[0]);
                });
            });

            // Update all totals
            updateBudgetTotals();
            
            // Hide results and submit button
            document.querySelector('.results-table').style.display = 'none';
            document.getElementById('submitAdjustment').style.display = 'none';
            
            // Clear inputs
            document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => input.checked = false);
            document.getElementById('adjustmentPercentage').value = '';

            alert('Adjustments have been applied successfully!');
        }


        // Ensure jsPDF is correctly referenced
        const { jsPDF } = window.jspdf;
        var currentBidId = "{{ bid.bid_id }}";

        var inventory = [];
        var factors = [];
        document.addEventListener("DOMContentLoaded", function() {
            initializeTable('subcontractorWrapper');
            enableDragAndDrop('#subcontractorWrapper .itemsTable');
            
            // Automatically click the "Heading" tab to open it on page load
            document.querySelector(".tablinks[onclick*='Heading']").click();
            document.querySelectorAll("#Heading .heading-details input[type='text'], #Heading .heading-details input[type='number']").forEach(input => {
            // Load saved bid items
            loadSavedBidItems();
                //input.addEventListener('input', () => autoSaveBidData());
            });

            // Attach auto-save listeners to line item inputs
            document.querySelectorAll(".itemsTable input").forEach(input => {
                //input.addEventListener('input', () => autoSaveBidData());
            });

            // Attach auto-save listeners to additional description inputs
            document.querySelectorAll(".additional-description input").forEach(input => {
                //input.addEventListener('input', () => autoSaveBidData());
            });            // Set default inventory items in the dropdown
            populateDefaultInventoryDropdown();
    
            // Initialize tables for each category
            initializeTable('drainsWrapper');
            initializeTable('irrigationWrapper');
            initializeTable('landscapeWrapper');
            initializeTable('maintenanceWrapper');
    

            // Add these lines after table initialization
            enableDragAndDrop('#drainsWrapper .itemsTable');
            enableDragAndDrop('#irrigationWrapper .itemsTable');
            enableDragAndDrop('#landscapeWrapper .itemsTable');
            enableDragAndDrop('#maintenanceWrapper .itemsTable');
            // Attach event listeners to labor rate inputs for dynamic updates
            document.getElementById('laborRateDrains').addEventListener('input', function() {
                updateTotalsBasedOnLaborRateChange('drainsWrapper', parseFloat(this.value) || 31);
            });
            document.getElementById('laborRateIrrigation').addEventListener('input', function() {
                updateTotalsBasedOnLaborRateChange('irrigationWrapper', parseFloat(this.value) || 31);
            });
            document.getElementById('laborRateLandscape').addEventListener('input', function() {
                updateTotalsBasedOnLaborRateChange('landscapeWrapper', parseFloat(this.value) || 31);
            });
            document.getElementById('laborRateMaintenance').addEventListener('input', function() {
                updateTotalsBasedOnLaborRateChange('maintenanceWrapper', parseFloat(this.value) || 31);
            });
    
            // Attach event listeners for labor rate inputs in the heading tab
            document.querySelectorAll("#Heading .heading-details input[type='text']").forEach(input => {
                input.addEventListener('input', function() {
                    //updateBudgetTotals();
                });
            });
    
            // Initialize the budget totals based on the current values in the input fields
            initializeHeadingTab();
        });
    
        function initializeAutoSave() {
            // Select all input fields in the heading tab and attach auto-save on input, excluding labor rates
            const headingInputs = document.querySelectorAll("#Heading .heading-details input[type='text']:not([id^='laborRate']):not(#localSalesTax)");
            headingInputs.forEach(input => {
                input.addEventListener('input', () => autoSaveBidData());
            });

            // Select all line item inputs and attach auto-save on input
            const lineItemInputs = document.querySelectorAll(".itemsTable input");
            lineItemInputs.forEach(input => {
                input.addEventListener('input', () => autoSaveBidData());
            });

            // Select all additional description inputs and attach auto-save on input
            const additionalDescriptionInputs = document.querySelectorAll(".additional-description input");
            additionalDescriptionInputs.forEach(input => {
                input.addEventListener('input', () => autoSaveBidData());
            });
        }

        function autoSaveBidData() {
            const bidId = document.getElementById('bidId').value;
            if (!bidId) {
                console.error('No bid ID found');
                return;
            }

            const bidData = {
                bid_id: bidId,
                heading_info: {
                    bid_job_id: $('#bidJobId').val(),
                    bid_date: $('#bidDate').val(),
                    customer_name: $('#customerName').val(),
                    customer_address: $('#customerAddress').val(),
                    customer_state: $('#customerState').val(),
                    customer_city: $('#customerCity').val(),
                    customer_zip: $('#customerZip').val(),
                    project_name: $('#projectName').val(),
                    project_address: $('#projectAddress').val(),
                    project_state: $('#projectState').val(),
                    project_city: $('#projectCity').val(),
                    project_zip: $('#projectZip').val()
                },
                labor_rates: {
                    drains_labor_rate: getFloatValueSafely('laborRateDrains'),
                    irrigation_labor_rate: getFloatValueSafely('laborRateIrrigation'),
                    landscape_labor_rate: getFloatValueSafely('laborRateLandscape'),
                    maintenance_labor_rate: getFloatValueSafely('laborRateMaintenance'),
                    subcontractor_labor_rate: getFloatValueSafely('laborRateSubcontractor'),
                    local_sales_tax: getFloatValueSafely('localSalesTax')
                },
                items: {
                    drains: collectLineItems('drainsWrapper'),
                    irrigation: collectLineItems('irrigationWrapper'),
                    landscape: collectLineItems('landscapeWrapper'),
                    maintenance: collectLineItems('maintenanceWrapper'),
                    subcontractor: collectLineItems('subcontractorWrapper')
                }
            };

            // Send the data to the server
            fetch('/auto-save-bid', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(bidData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Auto-save successful:', data);
            })
            .catch(error => {
                console.error('Error during auto-save:', error);
            });
        }

        // Add this function definition to fix the "getFloatValueSafely is not defined" error
        function getFloatValueSafely(id) {
            const element = document.getElementById(id);
            if (!element) return 0;
            
            const value = element.value.trim();
            if (value === '') return 0;
            
            const parsed = parseFloat(value);
            return isNaN(parsed) ? 0 : parsed;
        }

        // Add this to your existing JavaScript - handles updating the bid amount
        document.addEventListener("DOMContentLoaded", function() {
            // Get the bid amount input element
            const bidAmountInput = document.getElementById("bidAmount");
            
            // Add event listener for bid amount changes
            if (bidAmountInput) {
                bidAmountInput.addEventListener('input', function() {
                    // Validate that the input is a valid number
                    const value = this.value.trim();
                    if (value === "" || !isNaN(parseFloat(value))) {
                        // Valid input or empty - update the data
                        autoSaveBidData();
                    } else {
                        // Invalid input - show error and reset
                        alert("Please enter a valid number for Bid Amount");
                        this.value = "";
                    }
                });
            }
        });

        function showValidationError(message) {
            // Create a modal for the error message
            const errorModal = document.createElement('div');
            errorModal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                z-index: 1000;
                max-width: 80%;
                max-height: 80vh;
                overflow-y: auto;
            `;

            errorModal.innerHTML = `
                <h3 style="color: #dc3545; margin-top: 0;">Validation Error</h3>
                <div style="margin: 10px 0; white-space: pre-line;">${message}</div>
                <button onclick="this.parentElement.remove()" style="
                    background: #dc3545;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                    float: right;
                ">Close</button>
                <div style="clear: both;"></div>
            `;

            document.body.appendChild(errorModal);
        }

        function showSuccessMessage(message) {
            // Create a modal for the success message
            const successModal = document.createElement('div');
            successModal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                z-index: 1000;
            `;

            successModal.innerHTML = `
                <h3 style="color: #28a745; margin-top: 0;">Success</h3>
                <div style="margin: 10px 0;">${message}</div>
                <button onclick="this.parentElement.remove()" style="
                    background: #28a745;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                    float: right;
                ">Close</button>
                <div style="clear: both;"></div>
            `;

            document.body.appendChild(successModal);
        }
        // Update the saveBid function to include comments
        function saveBid() {
            const csrfToken = getCsrfToken();
            if (!csrfToken) {
                showValidationError('CSRF token is missing. Please reload the page and try again.');
                return;
            }

            $('#loadingOverlay').show();

            function getValueSafely(id) {
                const element = document.getElementById(id);
                return element ? element.value : '';
            }

            function getFloatValueSafely(id) {
                const value = getValueSafely(id);
                return parseFloat(value) || 0;
            }

            const bidId = getValueSafely('bidId');
            if (!bidId) {
                showValidationError('Bid ID is missing. Please reload the page and try again.');
                $('#loadingOverlay').hide();
                return;
            }

            // Special handling for bid amount line item
            const bidAmountValue = getFloatValueSafely('bidAmount');
            let bidAmountLineItem = null;

            // Prepare bid data with special handling for bid amount
            const bidData = {
                bid_id: bidId,
                heading_info: {
                    bid_id: getValueSafely('bidJobId'),
                    bid_date: getValueSafely('bidDate'),
                    customer_name: $('#customerName').val(),
                    customer_address: $('#customerAddress').val(),
                    customer_state: $('#customerState').val(),
                    customer_city: $('#customerCity').val(),
                    customer_zip: $('#customerZip').val(),
                    project_name: $('#projectName').val(),
                    project_address: $('#projectAddress').val(),
                    project_state: $('#projectState').val(),
                    project_city: $('#projectCity').val(),
                    project_zip: $('#projectZip').val(),
                    architect_name: getValueSafely('architectName'),
                    engineer_name: getValueSafely('engineerName'),
                    point_of_contact: getValueSafely('pointOfContact'),
                    bid_amount: bidAmountValue,
                    comments: getValueSafely('bidComments') // Add this line for comments
                },
                labor_rates: {
                    drains_labor_rate: getFloatValueSafely('laborRateDrains'),
                    irrigation_labor_rate: getFloatValueSafely('laborRateIrrigation'),
                    landscape_labor_rate: getFloatValueSafely('laborRateLandscape'),
                    maintenance_labor_rate: getFloatValueSafely('laborRateMaintenance'),
                    local_sales_tax: getFloatValueSafely('localSalesTax')
                },
                items: {
                    drains: collectLineItems('drainsWrapper'),
                    irrigation: collectLineItems('irrigationWrapper'),
                    landscape: collectLineItems('landscapeWrapper'),
                    maintenance: collectLineItems('maintenanceWrapper'),
                    subcontractor: collectLineItems('subcontractorWrapper')
                }
            };


            // If bid amount is non-zero, create a special line item
            if (bidAmountValue > 0) {
                bidAmountLineItem = {
                    part_number: 'BID_TOTAL',
                    description: 'Total Bid Amount',
                    quantity: 1,
                    cost: bidAmountValue,
                    factor_code: 'MISC',
                    line_ext_cost: bidAmountValue
                };
                
                // Add bid amount to the first available category
                const categoriesWithItems = ['drains', 'irrigation', 'landscape', 'maintenance', 'subcontractor'];
                for (let category of categoriesWithItems) {
                    if (bidData.items[category].length > 0) {
                        bidData.items[category].push(bidAmountLineItem);
                        break;
                    }
                }
            }

            // Validate bid data
            const validationErrors = validateBidData(bidData);
            if (validationErrors.length > 0) {
                showValidationError(validationErrors.join('\n'));
                $('#loadingOverlay').hide();
                return;
            }

            // Calculate category totals
            const taxRate = bidData.labor_rates.local_sales_tax / 100;
            const categoryCalculations = {
                drains: calculateCategoryTotal('drainsWrapper', bidData.labor_rates.drains_labor_rate, taxRate),
                irrigation: calculateCategoryTotal('irrigationWrapper', bidData.labor_rates.irrigation_labor_rate, taxRate),
                landscape: calculateCategoryTotal('landscapeWrapper', bidData.labor_rates.landscape_labor_rate, taxRate),
                maintenance: calculateCategoryTotal('maintenanceWrapper', bidData.labor_rates.maintenance_labor_rate, taxRate)
            };

            // Format category totals
            bidData.category_totals = {
                drains: categoryCalculations.drains.materialTotal + 
                        categoryCalculations.drains.laborTotal + 
                        categoryCalculations.drains.otherMaterialsTotal + 
                        categoryCalculations.drains.taxTotal,
                irrigation: categoryCalculations.irrigation.materialTotal + 
                        categoryCalculations.irrigation.laborTotal + 
                        categoryCalculations.irrigation.otherMaterialsTotal + 
                        categoryCalculations.irrigation.taxTotal,
                landscape: categoryCalculations.landscape.materialTotal + 
                        categoryCalculations.landscape.laborTotal + 
                        categoryCalculations.landscape.otherMaterialsTotal + 
                        categoryCalculations.landscape.taxTotal,
                maintenance: categoryCalculations.maintenance.materialTotal + 
                            categoryCalculations.maintenance.laborTotal + 
                            categoryCalculations.maintenance.otherMaterialsTotal + 
                            categoryCalculations.maintenance.taxTotal
            };

            // Proceed with saving
            saveCustomer()
                .then(() => saveProject(bidData.heading_info))
                .then(() => {
                    return fetch('/save-bid', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify(bidData)
                    });
                })
                .then(response => {
                    return response.text().then(text => {
                        try {
                            const data = JSON.parse(text);
                            if (!response.ok) {
                                throw new Error(data.error || data.message || 'Unknown server error');
                            }
                            return data;
                        } catch (e) {
                            // If JSON parsing fails, try to extract error details from the text
                            if (text.includes('TypeError')) {
                                const errorMatch = text.match(/TypeError: (.*)/);
                                if (errorMatch) {
                                    throw new Error(`Data format error: ${errorMatch[1]}`);
                                }
                            }
                            throw new Error(text || 'Unknown server error');
                        }
                    });
                })
                .then(data => {
                    $('#loadingOverlay').hide();
                    if (data.success) {
                        showSuccessMessage('Bid saved successfully!');
                    } else {
                        showValidationError(data.message || 'Failed to save bid.');
                    }
                })
                .catch((error) => {
                    $('#loadingOverlay').hide();
                    console.error('Error:', error);
                    showValidationError('Error saving bid: ' + (error.message || 'An unexpected error occurred.'));
                });
        }   


        function saveCustomer() {
            return new Promise((resolve, reject) => {
                const csrfToken = document.getElementById('csrf_token').value;
                if (!csrfToken) {
                    console.error('CSRF token is missing');
                    reject(new Error('CSRF token is missing'));
                    return;
                }

                const customerData = {
                    customer_name: $('#customerName').val(),
                    customer_address: $('#customerAddress').val(),
                    customer_state: $('#customerState').val(),
                    customer_city: $('#customerCity').val(),
                    customer_zip: $('#customerZip').val()
                };

                console.log('Sending customer data:', customerData);

                $.ajax({
                    url: '/save-customer',
                    method: 'POST',
                    data: JSON.stringify(customerData),
                    contentType: 'application/json',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    success: function(response) {
                        console.log('Save customer response:', response);
                        if (response.status === 'new') {
                            if (confirm('Customer not found. Would you like to create a new customer?')) {
                                createNewCustomer(customerData, csrfToken)
                                    .then(() => {
                                        console.log('New customer created successfully');
                                        resolve();
                                    })
                                    .catch(reject);
                            } else {
                                clearCustomerFields();
                                resolve();
                            }
                        } else {
                            console.log('Customer updated successfully');
                            resolve();
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Error saving customer:', textStatus, errorThrown);
                        console.error('Response:', jqXHR.responseText);
                        reject(new Error(`Error saving customer: ${textStatus}`));
                    }
                });
            });
        }


        function collectLineItems(wrapperId) {
            const lineItems = [];
            $(`#${wrapperId} .itemsTable tbody tr:not(.additional-description-row)`).each(function() {
                const partNumber = $(this).find('.partNumInput').val().trim();
                
                // Skip this line item if the part number is empty
                if (!partNumber) {
                    return true; // This is equivalent to 'continue' in a jQuery each loop
                }

                const inventoryDescription = $(this).find('.partNumInput').data('inventoryDescription') || '';
                const currentDescription = $(this).find('.descriptionInput').val() || '';
                const additionalDescription = $(this).data('additionalDescription') || '';

                const item = {
                    line_number: $(this).find('.lineNumber').text() || '',
                    part_number: partNumber,
                    description: encodeURIComponent(currentDescription),
                    inventory_description: encodeURIComponent(inventoryDescription),
                    custom_description: currentDescription !== inventoryDescription,
                    factor_code: $(this).find('.factorCodeInput').val() || '',
                    quantity: parseFloat($(this).find('.quantity input').val()) || 0,
                    cost: parseFloat($(this).find('.costInput').val()) || 0,
                    labor_hours: parseFloat($(this).find('.laborHoursInput').val()) || 0,
                    line_ext_cost: parseFloat($(this).find('.lineExtCost').text().replace('$', '')) || 0,
                    additional_description: encodeURIComponent(additionalDescription),
                    other_materials_cost: parseFloat($(this).find('.otherMaterials').text().replace('$', '')) || 0,
                    tax: parseFloat($(this).find('.tax').text().replace('$', '')) || 0
                };
                lineItems.push(item);
            });
            return lineItems;
        }

        function createNewSubBid(category) {
            var subBidNameInput = document.getElementById('newSubBidName' + capitalizeFirstLetter(category));
            if (!subBidNameInput) {
                console.error('Sub bid name input not found for category:', category);
                return;
            }
            var subBidName = subBidNameInput.value;
            if (!subBidName) {
                alert("Please enter a sub bid name.");
                return;
            }

            var bidId = document.getElementById('bidId').value;
            var csrfToken = getCsrfToken();

            fetch(`/api/subbids/${bidId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    category: category,
                    name: subBidName,
                    total_cost: 0,
                    labor_hours: 0
                }),
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                console.log('Success:', data);
                subBidNameInput.value = '';
                populateSubBidsList(category);
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Error creating sub-bid: ' + error.message);
            });
        }


        function initializeAutoSave() {
            // Select all input fields in the heading tab and attach auto-save on input, excluding labor rates
            const headingInputs = document.querySelectorAll("#Heading .heading-details input[type='text']:not([id^='laborRate']):not(#localSalesTax)");
            headingInputs.forEach(input => {
                input.addEventListener('input', () => autoSaveBidData());
            });

            // Select all line item inputs and attach auto-save on input
            const lineItemInputs = document.querySelectorAll(".itemsTable input");
            lineItemInputs.forEach(input => {
                input.addEventListener('input', () => autoSaveBidData());
            });

            // Select all additional description inputs and attach auto-save on input
            const additionalDescriptionInputs = document.querySelectorAll(".additional-description input");
            additionalDescriptionInputs.forEach(input => {
                input.addEventListener('input', () => autoSaveBidData());
            });
        }
        
        function fetchInventoryAndFactors() {
            return Promise.all([
                new Promise((resolve, reject) => {
                    $.getJSON('/inventory', function(data) {
                        // Validate inventory data
                        const validatedInventory = data.map(item => ({
                            ...item,
                            cost: parseFloat(item.cost) || 0,
                            labor_hours: parseFloat(item.labor_hours) || 0
                        }));
                        inventory = validatedInventory;
                        console.log("Loaded Inventory:", inventory);
                        resolve(inventory);
                    }).fail(function(jqXHR, textStatus, errorThrown) {
                        console.error("An error occurred while fetching the inventory:", textStatus, errorThrown);
                        resolve([]); // Resolve with empty array instead of rejecting
                    });
                }),
                new Promise((resolve, reject) => {
                    $.ajax({
                        url: '/factors',
                        dataType: 'text',
                        success: function(rawData) {
                            try {
                                // Replace NaN with 0 in the raw JSON string
                                const cleanedData = rawData.replace(/:NaN/g, ':0');
                                const data = JSON.parse(cleanedData);
                                
                                // Continue with your existing code...
                                const validatedFactors = data.map(factor => ({
                                    ...factor,
                                    labor_hours: parseFloat(factor.labor_hours) || 0,
                                    total: parseFloat(factor.total) || 0,
                                    items: Array.isArray(factor.items) ? factor.items.map(item => ({
                                        ...item,
                                        quantity: parseFloat(item.quantity) || 0,
                                        cost: parseFloat(item.cost) || 0
                                    })) : []
                                }));
                                factors = validatedFactors;
                                console.log("Loaded Factors:", factors);
                                resolve(factors);
                            } catch (error) {
                                console.error("Error parsing factors JSON:", error);
                                resolve([]);
                            }
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                            console.error("An error occurred while fetching the factors:", textStatus, errorThrown);
                            resolve([]);
                        }
                    });
                })
            ]).then(([inventoryData, factorsData]) => {
                console.log("Successfully loaded both inventory and factors");
                // Attach autocomplete after both data sets are loaded
                attachAutocomplete($('.partNumInput'), inventoryData);
                attachFactorAutocomplete($('.factorCodeInput'), factorsData);
                
                // Process the labor hours queue
                processlaborHoursQueue();
                
                return { inventory: inventoryData, factors: factorsData };
            }).catch(error => {
                console.error("Error in fetchInventoryAndFactors:", error);
                // Continue with empty arrays rather than throwing
                return { inventory: [], factors: [] };
            });
        }


        function populateDefaultInventoryDropdown() {
            var dropdown = $('#partDropdown');
            inventory.slice(0, 10).forEach(function(part) {
                var div = $('<div>').text(part.part_number + ' - ' + part.description);
                div.on('click', function() {
                    $('#PartNum').val(part.part_number);
                    $('#Description').val(part.description);
                    $('#Cost').val(part.cost);
                    $('#FactorCode').val(part.factor_code);
                    dropdown.empty();  // Clear the dropdown after selection
                });
                dropdown.append(div);
            });
        }
    
        // Update the openCategory function to clear the additional description input when switching tabs
        function openCategory(evt, categoryName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            var selectedTab = document.getElementById(categoryName);
            if (selectedTab) {
                selectedTab.style.display = "block";
                console.log("Opened tab:", categoryName); // Debug log
            } else {
                console.error("Tab not found:", categoryName); // Error log
            }
            evt.currentTarget.className += " active";
        }

        function removeLineItem(button) {
            if ($(button).data('removing')) {
                return;
            }

            $(button).data('removing', true);

            const isSubBid = $(button).closest('.sub-bid-wrapper').length > 0;
            const confirmDialog = isSubBid ? $('#subBidConfirmDialog') : $('#confirmDialog');
            const confirmMessage = isSubBid ? $('#subBidConfirmMessage') : $('#confirmMessage');
            const confirmYes = isSubBid ? $('#subBidConfirmYes') : $('#confirmYes');
            const confirmNo = isSubBid ? $('#subBidConfirmNo') : $('#confirmNo');

            confirmMessage.text("Are you sure you want to delete this item?");
            
            if (isSubBid) {
                const subBidModal = $(button).closest('.modal-content');
                confirmDialog.appendTo(subBidModal).show();
            } else {
                confirmDialog.show();
            }

            function handleConfirmation(isConfirmed) {
                confirmDialog.hide();
                if (isConfirmed) {
                    var tr = $(button).closest('tr');
                    var contentWrapper = tr.closest('.content-wrapper, .sub-bid-wrapper');
                    
                    // Remove the additional description row if it exists
                    var additionalDescRow = tr.next('.additional-description-row');
                    if (additionalDescRow.length) {
                        additionalDescRow.remove();
                    }
                    
                    tr.remove();
                    updateLineNumbers(contentWrapper);
                    updateTotalCost(contentWrapper);
                    updateBudgetTotals();
                }
                $(button).removeData('removing');
                $(document).off('keydown.confirmDialog');
            }

            confirmYes.one('click', function() {
                handleConfirmation(true);
            });

            confirmNo.one('click', function() {
                handleConfirmation(false);
            });

            // Handle Enter key press
            $(document).on('keydown.confirmDialog', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleConfirmation(true);
                }
            });
        }

        function updateLineNumbers(contentWrapper) {
            var lineNumber = 1;
            contentWrapper.find(".itemsTable tbody tr").each(function() {
                if (!$(this).hasClass('additional-description-row')) {
                    $(this).find('.lineNumber').text(lineNumber);
                    lineNumber++;
                }
            });
        }


        $(document).ready(function() {
            // Loading overlay
            $('#loadingOverlay').show();

            $('.generateReportBtn').on('click', function() {
                var category = $(this).closest('.content-wrapper').attr('id').replace('Wrapper', '');
                generateCombinedReport(category);
            });

            // Add the new event listener here
            $('#localSalesTax').on('input', function() {
                $('.itemsTable tbody tr').each(function() {
                    updateLineAndTotalCosts($(this).find('.quantity input')[0]);
                });
            });

            // Customer search initialization
            $('#customerName').on('input', function() {
                clearTimeout(customerSearchTimeout);
                const query = $(this).val();
                if (query.length >= 2) {
                    customerSearchTimeout = setTimeout(() => searchCustomers(query), 300);
                } else {
                    $('#customerSearchResults').empty();
                }
            });

            $('#laborRateDrains, #laborRateIrrigation, #laborRateLandscape, #laborRateMaintenance, #localSalesTax').on('input', function() {
                updateBudgetTotals();
            });

            // Initialize tables
            ['drainsWrapper', 'irrigationWrapper', 'landscapeWrapper', 'maintenanceWrapper','subcontractorWrapper'].forEach(wrapperId => {
                initializeTable(wrapperId);
            });

            // Minimum delay promise
            const minDelay = new Promise(resolve => setTimeout(resolve, 1000));

            // Fetch inventory and factors first
            fetchInventoryAndFactors()
                .then(() => {
                    console.log("Inventory and factors loaded");
                    // Then load saved bid items
                    return loadSavedBidItems();
                })
                .then(() => {
                    console.log("Saved bid items loaded");
                    // Reinitialize autocomplete for all part number and description inputs
                    reinitializeAutocomplete();
                    // Initialize existing rows
                    initializeExistingRows();
                    // Initialize labor rate listeners
                    initializeLaborRateListeners();
                    // Update budget totals
                    updateBudgetTotals();
                    return minDelay;
                })
                .catch((error) => {
                    console.error('Error loading data:', error);
                    alert('Error loading data. Please refresh the page and try again.');
                })
                .finally(() => {
                    $('#loadingOverlay').hide();
                });

            // Automatically click the "Heading" tab to open it on page load
            document.querySelector(".tablinks[onclick*='Heading']").click();

            // Event delegation for remove buttons
            $(document).on('click', '.removeBtn', function(e) {
                e.preventDefault();
                removeLineItem(this);
            });

            // Hide unwanted UI elements on interval
            setInterval(function() {
                $('.ui-helper-hidden-accessible, .ui-helper-hidden-accessible div').css('display', 'none');
            }, 100);

            // Initialize auto-save functionality
            initializeAutoSave();

            // Add event listener for saving default labor rates
            $('#save-labor-rates').on('click', function() {
                saveDefaultLaborRates();
            });
        });

        // Function to update all sub-bids for a category
        function updateAllSubBidsForCategory(category, laborRate) {
            // Find all sub-bids for this category
            $(`.sub-bid-wrapper[data-category="${category}"]`).each(function() {
                const subBidWrapper = $(this);
                const subBidId = subBidWrapper.attr('id');
                
                // Recalculate totals for this sub-bid
                updateSubBidTotals(subBidWrapper, laborRate);
            });
        }

        // Function to update totals when labor rate changes
        function updateTotalsBasedOnLaborRateChange(wrapperId, newLaborRate) {
            // Update main category totals
            var categoryData = calculateCategoryTotal(wrapperId, newLaborRate);
            updateTotalCost($('#' + wrapperId));
            
            // Update associated sub-bids if they exist
            const category = wrapperId.replace('Wrapper', '').toLowerCase();
            updateAllSubBidsForCategory(category, newLaborRate);
            
            // Update overall budget totals
            updateBudgetTotals();
        }
    
        function getSubBidLaborRate(subBidId) {
            var category = $('#' + subBidId).data('category');
            return getLaborRate(category + 'Wrapper');
        }

        function updateTotalCost(contentWrapper) {
            var isSubcontractor = contentWrapper.attr('id') === 'subcontractorWrapper';
            var totalMaterialCost = 0;
            var totalLaborCost = 0;
            var totalOtherMaterialsCost = 0;
            var totalTax = 0;
            var laborRate = getLaborRate(contentWrapper.attr('id'));

            contentWrapper.find(".itemsTable tbody tr").each(function() {
                var quantity = parseFloat($(this).find('.quantity input').val()) || 0;
                var cost = parseFloat($(this).find('.costInput').val()) || 0;
                totalMaterialCost += quantity * cost;

                if (!isSubcontractor) {
                    var laborHours = parseFloat($(this).find('.laborHoursInput').val()) || 0;
                    totalLaborCost += quantity * laborHours * laborRate;
                    var otherMaterialsCost = parseFloat($(this).find('.otherMaterials').text().replace('$', '')) || 0;
                    totalOtherMaterialsCost += otherMaterialsCost;

                    var taxRate = parseFloat($('#localSalesTax').val()) / 100 || 0;
                    var lineTaxableAmount = (quantity * cost) + otherMaterialsCost;
                    var lineTax = lineTaxableAmount * taxRate;
                    totalTax += lineTax;
                }
            });

            var totalCost = totalMaterialCost + totalLaborCost + totalOtherMaterialsCost + (isSubcontractor ? 0 : totalTax);

            var totalCostContainer = contentWrapper.find(".total-cost");
            
            if (!isSubcontractor) {
                totalCostContainer.find(".totalMaterialCost").text(`$${totalMaterialCost.toFixed(2)}`);
                totalCostContainer.find(".totalLaborCost").text(`$${totalLaborCost.toFixed(2)}`);
                totalCostContainer.find(".totalOtherMaterialsCost").text(`$${totalOtherMaterialsCost.toFixed(2)}`);
                totalCostContainer.find(".totalTax").text(`$${totalTax.toFixed(2)}`);
            }
            
            totalCostContainer.find(".totalCost").text(`$${totalCost.toFixed(2)}`);
        }

        // Attach event listeners to all inputs that can affect the totals
        $('.content-wrapper').on('input', '.quantity input, .costInput, .laborHoursInput', function() {
            updateLineAndTotalCosts(this);
        });


        // Add event listeners for labor rate changes
        function initializeLaborRateListeners() {
            const laborRateFields = [
                { id: 'laborRateDrains', wrapper: 'drainsWrapper' },
                { id: 'laborRateIrrigation', wrapper: 'irrigationWrapper' },
                { id: 'laborRateLandscape', wrapper: 'landscapeWrapper' },
                { id: 'laborRateMaintenance', wrapper: 'maintenanceWrapper' }
            ];

            laborRateFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.addEventListener('input', function() {
                        const newRate = parseFloat(this.value) || 31;
                        updateTotalsBasedOnLaborRateChange(field.wrapper, newRate);
                        saveBidLaborRate(field.wrapper, newRate);
                    });
                } else {
                    console.warn(`Element not found: ${field.id}`);
                }
            });
        }

  
        // Function to calculate line extension cost
        function calculateLineExtCost(factorCode, quantity) {
            var factor = factors.find(f => f.factor_code === factorCode);
            if (!factor || !factor.items) return 0;
            
            return factor.items.reduce((total, item) => {
                var inventoryItem = inventory.find(i => i.part_number === item.part_number);
                if (!inventoryItem) return total;
                return total + (inventoryItem.cost * item.quantity * quantity);
            }, 0);
        }

        function fetchFactorCodeAndLaborHoursForPart(partNumber, tr) {
            return new Promise((resolve, reject) => {
                console.log(`Fetching factor code and labor hours for part: ${partNumber}`);
                $.ajax({
                    url: `/get-factor-code-and-labor-hours/${partNumber}`,
                    success: function(data) {
                        console.log(`Received data for part ${partNumber}:`, data);
                        if (data && typeof data === 'object') {
                            tr.find('.factorCodeInput').val(data.factor_code || '');
                            var laborHours = data.labor_hours !== undefined ? data.labor_hours : 0;
                            tr.find('.laborHoursInput').val(laborHours.toFixed(4));
                        } else {
                            console.warn(`No valid data received for part ${partNumber}`);
                            tr.find('.factorCodeInput').val('');
                            tr.find('.laborHoursInput').val('0.00');
                        }
                        resolve();
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error(`Error fetching data for part ${partNumber}:`, textStatus, errorThrown);
                        tr.find('.factorCodeInput').val('');
                        tr.find('.laborHoursInput').val('0.00');
                        reject(errorThrown);
                    }
                });
            });
        }
        
        // Global caches
        const factorCodeCache = new Map();
        const customerCache = new Map();
        const projectCache = new Map();
        let bidDataCache = null;

        

        function calculateOtherMaterials(category) {
            console.log(`Calculating other materials for category: ${category}`);
            var otherMaterials = [];

            var isSubBid = category.startsWith('subbid-');
            var subBidId = isSubBid ? category.replace('subbid-', '') : null;
            var wrapperSelector = isSubBid ? 
                `#subBid_${subBidId}` : 
                `#${category.toLowerCase()}Wrapper`;
            console.log(`Using wrapper selector: ${wrapperSelector}`);

            var wrapper = $(wrapperSelector);
            if (wrapper.length === 0) {
                console.error(`Wrapper not found: ${wrapperSelector}`);
                return otherMaterials;
            }

            // Add debug logging
            console.log(`Found ${wrapper.find('.itemsTable tbody tr').length} rows in the wrapper`);

            wrapper.find('.itemsTable tbody tr').each(function() {
                var tr = $(this);
                var factorCode = tr.find('.factorCodeInput').val();
                var quantity = parseFloat(tr.find('.quantity input').val()) || 0;
                var absQuantity = Math.abs(quantity); // Use absolute value for calculations
                console.log(`Row data - Factor Code: ${factorCode}, Main Quantity: ${quantity}, Abs Quantity: ${absQuantity}`);

                // Add debugging for the cache state
                if (factorCode) {
                    console.log(`Cache status for ${factorCode}: ${!!(window.factorCodeItemsCache && window.factorCodeItemsCache[factorCode])}`);
                    
                    // If it's not in the cache, fetch it immediately
                    if (!window.factorCodeItemsCache || !window.factorCodeItemsCache[factorCode]) {
                        console.log(`Fetching missing factor code items for ${factorCode}`);
                        // We're in an each() loop, so we need to use synchronous approach or a different pattern
                        // For now, we'll just log this and handle it separately
                    }
                }

                if (factorCode && window.factorCodeItemsCache && window.factorCodeItemsCache[factorCode]) {
                    console.log(`Processing items for factor code: ${factorCode}`);
                    window.factorCodeItemsCache[factorCode].forEach(item => {
                        var totalQuantity = (item.quantity || 0) * absQuantity;
                        if (totalQuantity > 0) {
                            console.log(`Adding item: ${item.part_number}, Qty: ${totalQuantity}, Cost: ${item.cost || 0}`);
                            
                            var existingMaterial = otherMaterials.find(m => m.part_number === item.part_number);
                            if (existingMaterial) {
                                existingMaterial.quantity += totalQuantity;
                            } else {
                                otherMaterials.push({
                                    part_number: item.part_number,
                                    description: item.description || 'No description',
                                    quantity: totalQuantity,
                                    cost: item.cost || 0
                                });
                            }
                        }
                    });
                }
            });

            // Log the final calculation result
            const totalCost = otherMaterials.reduce((sum, item) => sum + (item.quantity * item.cost), 0);
            console.log(`Calculated ${otherMaterials.length} other materials items with total cost: $${totalCost.toFixed(2)}`);
            
            return otherMaterials;
        }             

        function ensureFactorCodesLoaded(category) {
            const isSubBid = category.startsWith('subbid-');
            const subBidId = isSubBid ? category.replace('subbid-', '') : null;
            const wrapperSelector = isSubBid ? 
                `#subBid_${subBidId}` : 
                `#${category.toLowerCase()}Wrapper`;
            
            const wrapper = $(wrapperSelector);
            if (wrapper.length === 0) {
                console.error(`Wrapper not found: ${wrapperSelector}`);
                return Promise.reject(`Wrapper not found: ${wrapperSelector}`);
            }
            
            // Collect all factor codes in the wrapper
            const factorCodes = new Set();
            wrapper.find('.factorCodeInput').each(function() {
                const factorCode = $(this).val();
                if (factorCode) {
                    factorCodes.add(factorCode);
                }
            });
            
            console.log(`Found ${factorCodes.size} unique factor codes in ${category}`);
            
            // Fetch all factor codes that aren't in the cache
            const fetchPromises = [];
            factorCodes.forEach(factorCode => {
                if (!window.factorCodeItemsCache || !window.factorCodeItemsCache[factorCode]) {
                    console.log(`Prefetching factor code: ${factorCode}`);
                    fetchPromises.push(fetchFactorCodeItems(factorCode));
                }
            });
            
            return Promise.all(fetchPromises)
                .then(() => {
                    console.log(`Successfully loaded all factor codes for ${category}`);
                    return true;
                })
                .catch(error => {
                    console.error(`Error loading factor codes for ${category}:`, error);
                    return false;
                });
        }

        function saveProject(projectData) {
            return new Promise((resolve, reject) => {
                const csrfToken = getCsrfToken();
                if (!csrfToken) {
                    console.error('CSRF token is missing');
                    reject(new Error('CSRF token is missing'));
                    return;
                }

                const data = {
                    project_name: projectData.project_name,
                    project_address: projectData.project_address,
                    project_state: projectData.project_state,
                    project_city: projectData.project_city,
                    project_zip: projectData.project_zip
                };

                console.log('Sending project data:', data);

                $.ajax({
                    url: '/save-project',
                    method: 'POST',
                    data: JSON.stringify(data),
                    contentType: 'application/json',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    success: function(response) {
                        console.log('Save project response:', response);
                        if (response.success) {
                            console.log('Project saved successfully');
                            resolve();
                        } else {
                            console.error('Error saving project:', response.error);
                            reject(new Error(response.error));
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Error saving project:', textStatus, errorThrown);
                        console.error('Response:', jqXHR.responseText);
                        reject(new Error(`Error saving project: ${textStatus}`));
                    }
                });
            });
        }


        function clearCustomerFields() {
            $('#customerName').val('');
            $('#customerAddress').val('');
            $('#customerState').val('');
            $('#customerCity').val('');
            $('#customerZip').val('f');
        }

        function loadSavedBidItems() {
            return new Promise((resolve, reject) => {
                const bidIdElement = document.getElementById('bidId');
                if (!bidIdElement) {
                    console.error('Bid ID element not found');
                    resolve();
                    return;
                }
                const bidId = bidIdElement.value;
                if (!bidId) {
                    console.error('No bid ID found');
                    resolve();
                    return;
                }
                if (bidDataCache) {
                    console.log('Using cached bid data');
                    processBidData(bidDataCache)
                        .then(() => {
                            updateBudgetTotals();
                            resolve();
                        })
                        .catch(error => {
                            console.error('Error processing bid data:', error);
                            reject(error);
                        });
                    return;
                }
                fetch(`/get-bid-items/${bidId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(bidData => {
                        console.log('Fetched bid data:', bidData);
                        bidDataCache = bidData;
                        
                        // Explicitly handle bid amount
                        if (bidData.heading_info && bidData.heading_info.bid_amount) {
                            const bidAmount = parseFloat(bidData.heading_info.bid_amount);
                            $('#bidAmount').val(bidAmount.toFixed(2));
                            console.log('Loaded bid amount:', bidAmount);
                        }

                        return processBidData(bidData)
                            .then(() => {
                                updateBudgetTotals();

                                // Load architect and engineer names
                                if (bidData.heading_info) {
                                    $('#architectName').val(bidData.heading_info.architect_name || '');
                                    $('#engineerName').val(bidData.heading_info.engineer_name || '');
                                    $('#pointOfContact').val(bidData.heading_info.point_of_contact || '');
                                }

                                // Reinitialize autocomplete after loading bid items
                                reinitializeAutocomplete();

                                // Enable drag-and-drop for all tables
                                enableDragAndDrop('#drainsWrapper .itemsTable');
                                enableDragAndDrop('#irrigationWrapper .itemsTable');
                                enableDragAndDrop('#landscapeWrapper .itemsTable');
                                enableDragAndDrop('#maintenanceWrapper .itemsTable');
                                enableDragAndDrop('#subcontractorWrapper .itemsTable');

                                resolve();
                            });
                    })
                    .catch(error => {
                        console.error('Error loading saved bid items:', error);
                        alert('Error loading saved bid items. Please try again.');
                        reject(error);
                    });
            });
        }

            
        function initializeExistingRows() {
            $('.itemsTable tbody tr').each(function() {
                initializeRow($(this));
                updateLineAndTotalCosts($(this).find('.quantity input')[0]);
            });
        }

        // Update the reinitializeAutocomplete function
        function reinitializeAutocomplete() {
            $('.partNumInput').each(function() {
                attachAutocompleteToPartNumber($(this));
            });
            $('.descriptionInput').each(function() {
                attachAutocompleteToDescription($(this));
            });
            $('.factorCodeInput').each(function() {
                attachFactorAutocomplete($(this));
            });
        }

        function processBidData(bidData) {
            return new Promise((resolve, reject) => {
                try {
                    // Log the entire bid data for debugging
                    console.log('Processing Bid Data in detail:', JSON.stringify(bidData, null, 2));

                    if (bidData.heading_info) {
                        // Explicitly handle bid amount with multiple methods
                        let bidAmount = 0;

                        // 1. First, check for bid_amount in heading_info
                        if (bidData.heading_info.bid_amount !== undefined) {
                            bidAmount = parseFloat(bidData.heading_info.bid_amount);
                            console.log('Bid amount from heading_info:', bidAmount);
                        }

                        // 2. If no bid amount or zero, search line items for bid total
                        if ((!bidAmount || bidAmount === 0) && bidData.items) {
                            const categories = ['drains', 'irrigation', 'landscape', 'maintenance', 'subcontractor'];
                            
                            categories.some(category => {
                                if (Array.isArray(bidData.items[category])) {
                                    const bidTotalItem = bidData.items[category].find(item => 
                                        item.part_number === 'BID_TOTAL' || 
                                        item.description === 'Total Bid Amount'
                                    );

                                    if (bidTotalItem) {
                                        bidAmount = parseFloat(bidTotalItem.cost || bidTotalItem.line_ext_cost || 0);
                                        console.log(`Bid amount from ${category} line items:`, bidAmount);
                                        return true; // Stop searching
                                    }
                                }
                                return false;
                            });
                        }

                        // Ensure bid amount is a valid number
                        bidAmount = isNaN(bidAmount) ? 0 : bidAmount;

                        // Set the bid amount with detailed logging
                        console.log('Setting bid amount to:', bidAmount);
                        $('#bidAmount').val(bidAmount.toFixed(2));

                        // Update other heading info
                        updateHeadingInfo(bidData.heading_info);
                    }

                    if (bidData.labor_rates) {
                        updateLaborRates(bidData.labor_rates);
                    }

                    // The rest of the existing processing logic remains the same
                    const laborRateIds = ['laborRateDrains', 'laborRateIrrigation', 'laborRateLandscape', 'laborRateMaintenance'];
                    const anyZeroRate = laborRateIds.some(id => parseFloat(document.getElementById(id).value) === 0);
                    
                    if (anyZeroRate) {
                        loadDefaultLaborRates();
                    }

                    if (bidData.items) {
                        const categories = ['drains', 'irrigation', 'landscape', 'maintenance', 'subcontractor'];
                        const uniqueFactorCodes = new Set();

                        categories.forEach(category => {
                            if (Array.isArray(bidData.items[category])) {
                                // Remove bid total line item if found
                                bidData.items[category] = bidData.items[category].filter(item => 
                                    item.part_number !== 'BID_TOTAL' && 
                                    item.description !== 'Total Bid Amount'
                                );

                                // Collect unique factor codes
                                bidData.items[category].forEach(item => {
                                    if (item.factor_code) {
                                        uniqueFactorCodes.add(item.factor_code);
                                    }
                                });
                            }
                        });

                        const factorCodePromises = Array.from(uniqueFactorCodes).map(fetchFactorCodeItems);

                        Promise.all(factorCodePromises)
                            .then(() => {
                                return Promise.all(categories.map(category => {
                                    if (Array.isArray(bidData.items[category])) {
                                        return loadCategoryItemsBatch(category, bidData.items[category]);
                                    }
                                    return Promise.resolve();
                                }));
                            })
                            .then(() => {
                                updateBudgetTotals();
                                reinitializeAutocomplete();
                                resolve();
                            })
                            .catch(error => {
                                console.error('Error loading category items:', error);
                                reject(error);
                            });
                    } else {
                        resolve();
                    }
                } catch (error) {
                    console.error('Error in processBidData:', error);
                    reject(error);
                }
            });
        }
        function fetchFactorCodeItems(factorCode) {
            if (factorCodeCache.has(factorCode)) {
                return Promise.resolve(factorCodeCache.get(factorCode));
            }

            return fetch(`/get-factor-code-items/${factorCode}`)
                .then(response => response.json())
                .then(data => {
                    factorCodeCache.set(factorCode, data);
                    if (!window.factorCodeItemsCache) {
                        window.factorCodeItemsCache = {};
                    }
                    window.factorCodeItemsCache[factorCode] = data.items || [];
                    return data;
                });
        }

        function loadCategoryItemsBatch(category, items) {
            const wrapperId = `${category}Wrapper`;
            const tableBody = $(`#${wrapperId} .itemsTable tbody`);
            tableBody.empty();
            const isSubcontractor = category === 'subcontractor';

            items.forEach((item, index) => {
                const newRow = $(`
                    <tr>
                        <td class="lineNumber">${index + 1}</td>
                        <td class="partNumber"><input type='text' class='partNumInput' value='${item.part_number || ''}' autocomplete='off'></td>
                        <td><input type='text' class='descriptionInput' value='${decodeURIComponent(item.description || '')}' autocomplete='off'></td>
                        ${!isSubcontractor ? `<td><input type="text" class="factorCodeInput" value='${item.factor_code || ''}' autocomplete="off"></td>` : ''}
                        <td class="quantity"><input type='text' class='quantity' value='${item.quantity || ''}' oninput='updateLineAndTotalCosts(this)'></td>
                        <td><input type='text' class='costInput' value='${item.cost !== undefined ? item.cost.toFixed(2) : ''}' oninput='updateLineAndTotalCosts(this)'></td>
                        ${!isSubcontractor ? `
                            <td><input type='text' class='laborHoursInput' value='${item.labor_hours !== undefined ? item.labor_hours.toFixed(4) : '0.00'}' oninput='updateLineAndTotalCosts(this)'></td>
                            <td class="otherMaterials">$${(item.other_materials_cost || 0).toFixed(2)}</td>
                        ` : ''}
                        <td class="total">$${(item.line_ext_cost || 0).toFixed(2)}</td>
                        <td class="action"><button class='removeBtn'>Remove</button></td>
                    </tr>
                `);

                newRow.data('additionalDescription', decodeURIComponent(item.additional_description || ''));

                tableBody.append(newRow);
                attachAutocompleteToPartNumber(newRow.find('.partNumInput'));
                attachAutocompleteToDescription(newRow.find('.descriptionInput'));
                if (!isSubcontractor) {
                    attachFactorAutocomplete(newRow.find('.factorCodeInput'));
                }
                initializeRow(newRow);
            });

            const wrapper = $(`#${wrapperId}`);
            updateLineNumbers(wrapper);
            showOtherMaterials(category, false);
            attachEventHandlers(wrapper);

            $(`#additionalDescription-${wrapperId}`).val(decodeURIComponent(items[0]?.additional_description || ''));

            // Update costs for all rows
            wrapper.find('.itemsTable tbody tr').each(function() {
                updateLineAndTotalCosts($(this).find('.quantity input')[0]);
            });

            // Update the total cost for the category
            updateTotalCost(wrapper);
        }

        function updateHeadingInfo(headingInfo) {
            $('#bidDate').val(headingInfo.bid_date || '');
            $('#projectName').val(headingInfo.project_name || '');
            $('#projectAddress').val(headingInfo.project_address || '');
            $('#projectState').val(headingInfo.project_state || '');
            $('#projectCity').val(headingInfo.project_city || '');
            $('#projectZip').val(headingInfo.project_zip || '');
            $('#architectName').val(headingInfo.architect_name || '');
            $('#engineerName').val(headingInfo.engineer_name || '');
            $('#pointOfContact').val(headingInfo.point_of_contact || '');
            $('#bidComments').val(headingInfo.comments || ''); // Add this line
            
            // Explicitly handle bid amount
            if (headingInfo.bid_amount) {
                $('#bidAmount').val(parseFloat(headingInfo.bid_amount).toFixed(2));
            }

            loadCustomerData(headingInfo.customer_name);
            loadProjectData(headingInfo.project_name);
        }


        function loadCustomerData(customerName) {
            if (customerCache.has(customerName)) {
                fillCustomerDetails(customerCache.get(customerName));
                return;
            }

            fetch(`/search-customers?query=${encodeURIComponent(customerName)}`)
                .then(response => response.json())
                .then(customers => {
                    if (customers.length > 0) {
                        const customerData = customers[0];
                        customerCache.set(customerName, customerData);
                        fillCustomerDetails(customerData);
                    }
                })
                .catch(error => console.error('Error fetching customer data:', error));
        }

        function loadProjectData(projectName) {
            if (projectCache.has(projectName)) {
                fillProjectDetails(projectCache.get(projectName));
                return;
            }

            fetch(`/search-projects?query=${encodeURIComponent(projectName)}`)
                .then(response => response.json())
                .then(projects => {
                    if (projects.length > 0) {
                        const projectData = projects[0];
                        projectCache.set(projectName, projectData);
                        fillProjectDetails(projectData);
                    }
                })
                .catch(error => console.error('Error fetching project data:', error));
        }

        function fillCustomerDetails(customerData) {
            $('#customerName').val(customerData.customer_name || '');
            $('#customerAddress').val(customerData.customer_address || '');
            $('#customerState').val(customerData.customer_state || '');
            $('#customerCity').val(customerData.customer_city || '');
            $('#customerZip').val(customerData.customer_zip || '');
        }

        function fillProjectDetails(projectData) {
            $('#projectName').val(projectData.project_name || '');
            $('#projectAddress').val(projectData.project_address || '');
            $('#projectState').val(projectData.project_state || '');
            $('#projectCity').val(projectData.project_city || '');
            $('#projectZip').val(projectData.project_zip || '');
        }

        function updateLaborRates(laborRates) {
            const setLaborRate = (id, value) => {
                const element = document.getElementById(id);
                if (element && value !== null && value !== undefined && value !== 0) {
                    element.value = value;
                }
            };

            setLaborRate('laborRateDrains', laborRates.drains_labor_rate);
            setLaborRate('laborRateIrrigation', laborRates.irrigation_labor_rate);
            setLaborRate('laborRateLandscape', laborRates.landscape_labor_rate);
            setLaborRate('laborRateMaintenance', laborRates.maintenance_labor_rate);
            setLaborRate('localSalesTax', laborRates.local_sales_tax);
        }
        
        let laborHoursUpdateQueue = [];

        //async function generateCombinedReport(category) {
        //    const { jsPDF } = window.jspdf;
        //    let combinedDoc = new jsPDF();
            
            // Generate main bid report
        //    await generateReport(category, combinedDoc, `${category.charAt(0).toUpperCase() + category.slice(1)} - Main Bid`);
            
            // Fetch all sub-bids for the category
        //    const subBids = await fetchAllSubBids(category);
            
            // Generate reports for each sub-bid
        //    for (const subBid of subBids) {
        //        // Add a page break between bids
        //        combinedDoc.addPage();
                
                // Generate sub-bid report
        //        await generateReport(category, combinedDoc, `${category.charAt(0).toUpperCase() + category.slice(1)} - Sub-Bid: ${subBid.name}`, subBid.id);
        //    }
            
         //   const totalPages = combinedDoc.getNumberOfPages();
            
            // Add page numbers to all pages
        //    for (let i = 1; i <= totalPages; i++) {
        //        combinedDoc.setPage(i);
        //        combinedDoc.setFont("helvetica", "normal");
        //        combinedDoc.setFontSize(10);
        //        combinedDoc.text(`Page ${i} of ${totalPages}`, 105, 287, { align: 'center' });
        //    }
            
        //    combinedDoc.save(`${category}_combined_bid_report.pdf`);
        //}

        async function generateCombinedReport(category) {
            const { jsPDF } = window.jspdf;
            let combinedDoc = new jsPDF();
            
            // Generate main bid report
            await generateReport(category, combinedDoc, `${category.charAt(0).toUpperCase() + category.slice(1)} - Bid`);
            
            // Add page numbers
            const totalPages = combinedDoc.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                combinedDoc.setPage(i);
                combinedDoc.setFont("helvetica", "normal");
                combinedDoc.setFontSize(10);
                combinedDoc.text(`Page ${i} of ${totalPages}`, 105, 287, { align: 'center' });
            }
            
            combinedDoc.save(`${category}_bid_report.pdf`);
        }

        // New function to fetch all sub-bids for a category
        async function fetchAllSubBids(category) {
            try {
                const bidId = document.getElementById('bidId').value;
                const response = await fetch(`/api/subbids/${bidId}?category=${category}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching sub-bids:', error);
                return [];
            }
        }


        async function generateReport(category, doc, title, subBidId = null) {
            const bidId = $('#bidId').val();
            const bidDate = $('#bidDate').val();
                                                                                                                                        
            let pageNumber = 1;
            let totalPages = 1;

            function formatNumber(number, decimalPlaces = 2, forceDecimals = true) {
                return Number(number).toLocaleString('en-US', {
                    minimumFractionDigits: forceDecimals ? decimalPlaces : 0,
                    maximumFractionDigits: decimalPlaces
                });
            }

            function formatDate(dateString) {
                const date = new Date(dateString);
                const utcDate = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
                return `${utcDate.getUTCMonth() + 1}/${utcDate.getUTCDate()}/${utcDate.getUTCFullYear()}`;
            }

            const formattedBidDate = formatDate(bidDate);
            const formattedPrintDate = formatDate(new Date().toISOString());

            const customerName = $('#customerName').val();
            const customerAddress = $('#customerAddress').val();
            const customerCity = $('#customerCity').val();
            const customerState = $('#customerState').val();
            const customerZip = $('#customerZip').val();
            const projectName = $('#projectName').val();
            const projectAddress = $('#projectAddress').val();
            const projectCity = $('#projectCity').val();
            const projectState = $('#projectState').val();
            const projectZip = $('#projectZip').val();
            const taxRate = parseFloat($('#localSalesTax').val()) / 100;
            const laborRate = category !== 'subcontractor' ? parseFloat($(`#laborRate${category.charAt(0).toUpperCase() + category.slice(1)}`).val()) : 0;
            const architectName = $('#architectName').val();
            const engineerName = $('#engineerName').val();
            const pointOfContact = $('#pointOfContact').val();

            function addFullHeader() {
                // MODIFIED: Increase starting Y position for title from 15 to 25
                // This moves the title down by 10 units to prevent it being cut off when printing
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.text(title, 105, 25, { align: 'center' });

                // Adjust all subsequent Y positions by adding 10 to maintain proper spacing
                doc.setFontSize(10);
                doc.setFont("helvetica", "bold");
                doc.text(`BID #: ${bidId}`, 15, 35);  // Was 25
                doc.setFont("helvetica", "normal");
                doc.text(`Bid Created: ${formattedBidDate}`, 195, 35, { align: 'right' });  // Was 25
                doc.text(`Date Printed: ${formattedPrintDate}`, 195, 40, { align: 'right' });  // Was 30

                doc.setFontSize(10);
                doc.setFont("helvetica", "bold");
                doc.text("CUSTOMER", 15, 50);  // Was 40
                doc.text("PROJECT", 110, 50);  // Was 40

                doc.setFont("helvetica", "normal");
                doc.setFontSize(9);
                doc.text(customerName, 15, 55);  // Was 45
                doc.text(customerAddress, 15, 60);  // Was 50
                doc.text(`${customerCity}, ${customerState} ${customerZip}`, 15, 65);  // Was 55

                doc.text(projectName, 110, 55);  // Was 45
                doc.text(projectAddress, 110, 60);  // Was 50
                doc.text(`${projectCity}, ${projectState} ${projectZip}`, 110, 65);  // Was 55

                doc.setLineWidth(0.5);
                doc.line(15, 70, 195, 70);  // Was 60

                doc.setFont("helvetica", "bold");
                doc.text("RATES & CONTACTS", 15, 75);  // Was 65
                doc.setFont("helvetica", "normal");
                doc.text(`Tax Rate: ${(taxRate * 100).toFixed(2)}%`, 15, 80);  // Was 70
                doc.text(`Labor Rate: $${laborRate.toFixed(2)}/hr`, 15, 85);  // Was 75
                doc.text(`Architect: ${architectName || 'N/A'}`, 80, 80);  // Was 70
                doc.text(`Engineer: ${engineerName || 'N/A'}`, 80, 85);  // Was 75
                doc.text(`Point of Contact: ${pointOfContact || 'N/A'}`, 145, 80);  // Was 70

                doc.line(15, 90, 195, 90);  // Was 80

                return 95;  // Return new starting Y position (was 85)
            }


            function addTableHeader(startY, colWidths) {
                let headers;
                if (category === 'subcontractor') {
                    headers = ["#", "ITEM", "QTY", "COST", "TOTAL"];
                } else {
                    headers = ["#", "ITEM", "FACTOR", "QTY", "COST", "X-COST", "OT MATL", "TAX", "LABHR", "LABOR $", "TOTAL"];
                }

                const tableWidth = colWidths.reduce((sum, width) => sum + width, 0);
                const startX = (doc.internal.pageSize.width - tableWidth) / 2;
                let x = startX;

                doc.setFillColor(240, 240, 240);
                doc.rect(startX, startY, tableWidth, 7, 'F');
                doc.setFontSize(8);
                doc.setFont("helvetica", "bold");
                headers.forEach((header, i) => {
                    if (i <= 2) {
                        doc.text(header, x + 2, startY + 5, { align: 'left', maxWidth: colWidths[i] - 4 });
                    } else {
                        doc.text(header, x + colWidths[i] - 2, startY + 5, { align: 'right', maxWidth: colWidths[i] - 4 });
                    }
                    x += colWidths[i];
                });

                return { startX, colWidths, tableWidth, headers };
            }

            let startY = addFullHeader();

            // Fetch items based on whether it's a main bid or sub-bid
            let items;
            // In the generateReport function, around line 7720
            if (subBidId) {
                items = await fetchSubBidItems(subBidId);
                
                // Add this block to fetch other materials and associate them with items
                const otherMaterials = await fetchSubBidOtherMaterials(subBidId);
                
                // Create a mapping from factor codes to their associated other materials costs
                const factorCodeMaterialCosts = {};
                items.forEach(item => {
                    // Calculate other materials cost for this item's factor code
                    if (item.factor_code) {
                        // Find materials associated with this item's factor code and quantity
                        let materialCost = 0;
                        const quantity = parseFloat(item.quantity) || 0;
                        
                        // Use the cached factor code items if available
                        if (window.factorCodeItemsCache && window.factorCodeItemsCache[item.factor_code]) {
                            materialCost = window.factorCodeItemsCache[item.factor_code].reduce((total, material) => {
                                return total + ((parseFloat(material.cost) || 0) * 
                                            (parseFloat(material.quantity) || 0) * quantity);
                            }, 0);
                        }
                        factorCodeMaterialCosts[item.factor_code] = materialCost;
                    }
                });
                
                // Map items with the calculated other materials costs
                items = items.map(item => ({
                    part_number: item.part_number || '',
                    description: decodeURIComponent(item.description || ''),
                    additional_description: decodeURIComponent(item.additional_description || ''),
                    quantity: parseFloat(item.quantity) || 0,
                    cost: parseFloat(item.cost) || 0,
                    factor_code: item.factor_code || '',
                    other_materials_cost: factorCodeMaterialCosts[item.factor_code] || 0,
                    labor_hours: parseFloat(item.labor_hours) || 0,
                    tax: parseFloat(item.tax) || 0,
                    line_ext_cost: parseFloat(item.line_ext_cost) || 0
                }));
            } else {
                const wrapper = $(`#${category}Wrapper`);
                items = wrapper.find(".itemsTable tbody tr").map(function() {
                    const $row = $(this);
                    // Skip additional description rows
                    if ($row.hasClass('additional-description-row')) {
                        return null;
                    }
                    return {
                        part_number: $row.find('.partNumInput').val() || '',
                        description: $row.find('.descriptionInput').val() || '',
                        additional_description: $row.data('additionalDescription') || '',
                        quantity: parseFloat($row.find('.quantity input').val()) || 0,
                        cost: parseFloat($row.find('.costInput').val()) || 0,
                        factor_code: $row.find('.factorCodeInput').val() || '',
                        other_materials_cost: parseFloat($row.find('.otherMaterials').text().replace('$', '')) || 0,
                        labor_hours: parseFloat($row.find('.laborHoursInput').val()) || 0,
                        tax: 0, // Add tax if available in the main bid
                        line_ext_cost: parseFloat($row.find('.total').text().replace('$', '')) || 0
                    };
                }).get();
            }

            // Filter out any null (skipped) or empty rows
            items = items.filter(item => item && (item.part_number || item.description));

            // Initialize headers and column widths
            let headers, defaultColWidths, minColWidths, maxColWidths;
            if (category === 'subcontractor') {
                headers = ["#", "ITEM", "QTY", "COST", "TOTAL"];
                defaultColWidths = [10, 125, 25, 25, 25];
                minColWidths = [10, 40, 20, 20, 20];
                maxColWidths = [15, 150, 35, 35, 35];
            } else {
                headers = ["#", "ITEM", "FACTOR", "QTY", "COST", "X-COST", "OT MATL", "TAX", "LABHR", "LABOR $", "TOTAL"];
                defaultColWidths = [10, 35, 20, 15, 15, 18, 18, 15, 15, 18, 16];
                minColWidths = [10, 25, 15, 15, 15, 15, 15, 15, 15, 15, 15];
                maxColWidths = [15, 50, 25, 20, 20, 30, 30, 25, 25, 30, 30];
            }

            let colWidths = defaultColWidths.slice();

            // Adjust column widths based on headers
            doc.setFontSize(8);
            headers.forEach((header, i) => {
                const textWidth = doc.getTextWidth(header);
                const desiredWidth = textWidth + 4; // Add some padding
                colWidths[i] = Math.max(colWidths[i], desiredWidth, minColWidths[i]);
                colWidths[i] = Math.min(colWidths[i], maxColWidths[i]);
            });

            // Ensure the table fits within the page width
            const tableWidth = colWidths.reduce((sum, width) => sum + width, 0);
            const maxTableWidth = doc.internal.pageSize.width - 20; // Assuming 20 units margin
            if (tableWidth > maxTableWidth) {
                const scalingFactor = maxTableWidth / tableWidth;
                colWidths = colWidths.map((width, i) => Math.max(width * scalingFactor, minColWidths[i]));
            }

            // Now, call addTableHeader with adjusted colWidths
            let { startX, headers: adjustedHeaders } = addTableHeader(startY, colWidths);
            startY += 10;

            let totalMaterialCost = 0;
            let totalLaborCost = 0;
            let totalOtherMaterialsCost = 0;
            let totalTax = 0;
            let grandTotal = 0;
            let totalLaborHours = 0;

            doc.setFont("helvetica", "normal");

            for (let index = 0; index < items.length; index++) {
                const item = items[index];

                // Add safeguards for all calculations
                const xCost = (item.quantity || 0) * (item.cost || 0);
                const otherMaterials = item.other_materials_cost || 0;
                const taxableAmount = xCost + otherMaterials;
                const itemTax = taxableAmount * taxRate;
                const laborHours = (item.labor_hours || 0) * (item.quantity || 0);
                const labor = laborHours * laborRate;
                let total;

                if (category === 'subcontractor') {
                    total = xCost;
                } else {
                    total = xCost + otherMaterials + itemTax + labor;
                }


                let rowData1, rowData2;
                    if (category === 'subcontractor') {
                        rowData1 = [
                            (index + 1).toString(),
                            item.part_number,
                            formatNumber(Math.round(item.quantity || 0), 0, false),
                            formatNumber(item.cost || 0, 2),
                            formatNumber(xCost, 2)
                        ];
                        rowData2 = [
                            '',
                            item.description + (item.additional_description ? '\n* ' + item.additional_description : ''),
                            '',
                            '',
                            ''
                        ];
                    } else {
                        rowData1 = [
                            (index + 1).toString(),
                            item.part_number,
                            item.factor_code || '',
                            formatNumber(Math.round(item.quantity || 0), 0, false),
                            formatNumber(item.cost || 0, 2),
                            formatNumber(xCost, 2),
                            formatNumber(otherMaterials, 2),
                            formatNumber(itemTax, 2),
                            formatNumber(laborHours, 2),
                            formatNumber(labor, 2),
                            formatNumber(total, 2)
                        ];
                        rowData2 = [
                            '',
                            item.description + (item.additional_description ? '\n* ' + item.additional_description : ''),
                            '',
                            '',
                            '',
                            '',
                            '',
                            '',
                            '',
                            '',
                            ''
                        ];
                    }

                // Compute the height of the description text
                const descText = rowData2[1];
                let xDesc = startX + colWidths[0]; // Start from the ITEM column
                let descColSpan = colWidths[1] + (category !== 'subcontractor' ? colWidths[2] : 0); // ITEM and FACTOR columns

                doc.setFontSize(8);
                doc.setFont("helvetica", "italic");
                const descOptions = { maxWidth: descColSpan - 4 };
                const descDimensions = doc.getTextDimensions(descText, descOptions);
                const descHeight = descDimensions.h;

                // Calculate total item height
                const itemHeight = 6 /* first row */ + descHeight + 2 /* gap and line */;

                // Check if the item fits on the current page
                if (startY + itemHeight > 270) {
                    doc.addPage();
                    pageNumber++;
                    startY = 15;

                    let headerInfo = addTableHeader(startY, colWidths);
                    startX = headerInfo.startX;
                    startY += 10;
                }

                // Draw the first row (part number and other columns)
                let x = startX;
                doc.setFont("helvetica", "normal");

                rowData1.forEach((cell, i) => {
                    let fontSize = 8;
                    const maxFontSize = 8;
                    const minFontSize = 6;

                    // Add a check for undefined or null cell values
                    const cellContent = (cell !== undefined && cell !== null) ? cell.toString() : '';
                    const cellWidth = colWidths[i] - 4; // Padding
                    doc.setFontSize(fontSize);

                    // Only adjust font size for numeric cells (i > 2)
                    if (i > 2) {
                        let textWidth = doc.getTextWidth(cellContent);

                        // Reduce font size until text fits or until minimum font size is reached
                        while (textWidth > cellWidth && fontSize > minFontSize) {
                            fontSize -= 0.5;
                            doc.setFontSize(fontSize);
                            textWidth = doc.getTextWidth(cellContent);
                        }
                    }

                    const options = {
                        align: i <= 2 ? 'left' : 'right',
                        maxWidth: cellWidth
                    };
                    doc.text(cellContent, x + (i <= 2 ? 2 : colWidths[i] - 2), startY + 4, options);
                    x += colWidths[i];
                });

                startY += 6; // Move to the next line for the description

                // Draw the description
                doc.setFontSize(8);
                doc.setFont("helvetica", "italic");
                doc.text(descText, xDesc + 2, startY + 4, { align: 'left', maxWidth: descColSpan - 4 });

                // Adjust startY based on description height
                startY += descHeight + 2;

                // Draw a line under the item
                doc.setLineWidth(0.1);
                doc.line(startX, startY, startX + tableWidth, startY);

                startY += 2; // Add a small gap after the line

                // Update totals
                totalMaterialCost += xCost;
                totalLaborCost += labor;
                totalOtherMaterialsCost += otherMaterials;
                totalTax += itemTax;
                grandTotal += total;
                totalLaborHours += laborHours;
            }

             // Totals
             startY += 10;
            if (startY > 270) {
                doc.addPage();
                pageNumber++;
                startY = 20;
            }
            doc.setFontSize(8);
            doc.setFont("helvetica", "bold");
            doc.text("REPORT TOTALS:", startX, startY);

            if (category === 'subcontractor') {
                doc.text(grandTotal.toFixed(2), startX + tableWidth, startY, { align: 'right' });
            } else {
                const colXOffsets = [
                    startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4],
                    startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5],
                    startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + colWidths[6],
                    startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + colWidths[6] + colWidths[7],
                    startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + colWidths[6] + colWidths[7] + colWidths[8],
                    startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + colWidths[6] + colWidths[7] + colWidths[8] + colWidths[9]
                ];

                // For the report totals alignment, modify the totalRowY section:
                const totalRowY = startY;
                doc.setFont("helvetica", "normal");
                const materialTotal = totalMaterialCost + totalOtherMaterialsCost + totalTax;

                function drawSlightlyAdjustedBox(startX, endX, y, height) {
                    const boxWidth = endX - startX;
                    const boxY = y - 5;
                    const shiftAmount = 2.5;
                    doc.setLineWidth(0.1);
                    doc.rect(startX + shiftAmount, boxY, boxWidth, height);
                }
                // Modify the totals display section
                doc.setFont("helvetica", "bold");
                
// Calculate the totals row positions with precise column alignment
const totalsStartX = colXOffsets[0];
                
                // For the totals row, align with X-COST, OT MATL, and TAX columns
                const xCostOffset = startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4];
                const otMatlOffset = xCostOffset + colWidths[5];
                const taxOffset = otMatlOffset + colWidths[6];
                const laborHrsOffset = taxOffset + colWidths[7];
                const laborCostOffset = laborHrsOffset + colWidths[8];
                const totalOffset = laborCostOffset + colWidths[9];

                // Set smaller font size for totals
                doc.setFontSize(7);
                
                // Write REPORT TOTALS: in bold
                doc.setFontSize(8);
                doc.setFont("helvetica", "bold");
                doc.text("REPORT TOTALS:", startX, totalRowY);

                // Set smaller font size for numbers
                doc.setFontSize(7);
                doc.setFont("helvetica", "normal");
                
                // Draw clean box around first three totals first (so text appears on top)
                doc.rect(xCostOffset - 2, totalRowY - 5, (taxOffset + colWidths[7]) - (xCostOffset - 2), 7);
                
                // Material costs line inside box
                doc.text(formatNumber(totalMaterialCost, 2), xCostOffset + colWidths[5] - 2, totalRowY, { align: 'right' });
                doc.text(formatNumber(totalOtherMaterialsCost, 2), otMatlOffset + colWidths[6] - 2, totalRowY, { align: 'right' });
                doc.text(formatNumber(totalTax, 2), taxOffset + colWidths[7] - 2, totalRowY, { align: 'right' });
                
                // Labor totals
                doc.text(formatNumber(totalLaborHours, 2), laborHrsOffset + colWidths[8], totalRowY, { align: 'right' });
                doc.text(formatNumber(totalLaborCost, 2), laborCostOffset + colWidths[9], totalRowY, { align: 'right' });
                
                // Grand total
                doc.text(formatNumber(grandTotal, 2), totalOffset + colWidths[10], totalRowY, { align: 'right' });  
                
                // Material total section with bold text on left
                startY += 10;
                doc.setFontSize(8);
                doc.setFont("helvetica", "bold");
                doc.text("Material Total", 15, startY);
                
                // Draw clean box for material total
                doc.rect(xCostOffset - 2, startY - 5, colWidths[5] + 2, 7);
                
                // Place number inside box with smaller font
                doc.setFontSize(7);
                doc.setFont("helvetica", "normal");
                doc.text(formatNumber(materialTotal, 2), xCostOffset + colWidths[5] - 2, startY, { align: 'right' });
            }
            // Other Materials Section (if applicable)
            if (category !== 'subcontractor') {
                doc.addPage();
                pageNumber++;
                startY = 15;

                doc.setFont("helvetica", "bold");
                doc.setFontSize(14);
                doc.text("Other Materials", 105, startY, { align: 'center' });

                doc.setFontSize(12);
                doc.text(category.toUpperCase(), 105, startY + 7, { align: 'center' });

                doc.setFontSize(10);
                doc.text(`BID #: ${bidId}`, 15, startY + 15);
                doc.text(`PROJECT NAME: ${projectName}`, 195, startY + 15, { align: 'right' });

                startY += 25;
                const otherMaterialsHeaders = ["PART NUMBER", "DESCRIPTION", "QTY", "UNIT COST", "TOTAL COST"];
                const otherMaterialsColWidths = [35, 75, 20, 25, 25];

                let x = startX;
                const otherMaterialsTableWidth = otherMaterialsColWidths.reduce((sum, width) => sum + width, 0);

                doc.setFillColor(240, 240, 240);
                doc.rect(startX, startY, otherMaterialsTableWidth, 7, 'F');
                doc.setFontSize(8);
                doc.setFont("helvetica", "bold");
                otherMaterialsHeaders.forEach((header, i) => {
                    if (i === 0 || i === 1) {
                        doc.text(header, x + 2, startY + 5, { align: 'left', maxWidth: otherMaterialsColWidths[i] - 4 });
                    } else {
                        doc.text(header, x + otherMaterialsColWidths[i] - 2, startY + 5, { align: 'right', maxWidth: otherMaterialsColWidths[i] - 4 });
                    }
                    x += otherMaterialsColWidths[i];
                });
                startY += 10;
                doc.setFont("helvetica", "normal");

                const otherMaterials = subBidId ? await fetchSubBidOtherMaterials(subBidId) : calculateOtherMaterials(category);
                let otherMaterialsTotalCost = 0;

                for (const item of otherMaterials) {
                    // Compute itemHeight
                    const descText = item.description;
                    const descOptions = { maxWidth: otherMaterialsColWidths[1] - 4 };
                    const descDimensions = doc.getTextDimensions(descText, descOptions);
                    const descHeight = descDimensions.h;
                    const itemHeight = Math.max(descHeight, 6) + 2; // Adjust as needed

                    // Check if the item fits
                    if (startY + itemHeight > 270) {
                        doc.addPage();
                        pageNumber++;
                        startY = 15;
                        x = startX;
                        doc.setFillColor(240, 240, 240);
                        doc.rect(startX, startY, otherMaterialsTableWidth, 7, 'F');
                        doc.setFontSize(8);
                        doc.setFont("helvetica", "bold");
                        otherMaterialsHeaders.forEach((header, i) => {
                            if (i === 0 || i === 1) {
                                doc.text(header, x + 2, startY + 5, { align: 'left', maxWidth: otherMaterialsColWidths[i] - 4 });
                            } else {
                                doc.text(header, x + otherMaterialsColWidths[i] - 2, startY + 5, { align: 'right', maxWidth: otherMaterialsColWidths[i] - 4 });
                            }
                            x += otherMaterialsColWidths[i];
                        });
                        startY += 10;
                        doc.setFont("helvetica", "normal");
                    }

                    const itemTotalCost = item.quantity * item.cost;
                    otherMaterialsTotalCost += itemTotalCost;

                    const rowData = [
                        item.part_number,
                        item.description,
                        formatNumber(item.quantity, 2),
                        formatNumber(item.cost, 2),
                        formatNumber(itemTotalCost, 2)
                    ];

                    x = startX;
                    doc.setFontSize(8);
                    rowData.forEach((cell, i) => {
                        if (i === 1) {
                            doc.text(cell, x + 2, startY + 4, { maxWidth: otherMaterialsColWidths[i] - 4 });
                        } else {
                            doc.text(cell, x + otherMaterialsColWidths[i] - 2, startY + 4, { align: 'right', maxWidth: otherMaterialsColWidths[i] - 4 });
                        }
                        x += otherMaterialsColWidths[i];
                    });

                    // Adjust startY based on description height
                    startY += Math.max(descHeight, 6) + 2;
                }

                startY += 5;
                if (startY > 270) {
                    doc.addPage();
                    pageNumber++;
                    startY = 15;
                }
                doc.setFontSize(10);
                doc.setFont("helvetica", "bold");
                doc.text("OTHER MATERIALS TOTAL:", startX, startY + 5);
                doc.text(formatNumber(otherMaterialsTotalCost, 2), startX + otherMaterialsTableWidth - 2, startY + 5, { align: 'right' });
            }

            return doc;
        }


        async function fetchSubBidItems(subBidId) {
            try {
                const response = await fetch(`/api/subbids/${subBidId}/items`);
                if (!response.ok) {
                    throw new Error('Failed to fetch sub-bid items');
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching sub-bid items:', error);
                return []; // Return an empty array if there's an error
            }
        }

        async function fetchSubBidOtherMaterials(subBidId) {
            const response = await fetch(`/api/subbids/${subBidId}/other-materials`);
            if (!response.ok) {
                throw new Error('Failed to fetch sub-bid other materials');
            }
            return await response.json();
        }

        function queueLaborHoursUpdate(partNumber, quantity, rowElement) {
            laborHoursUpdateQueue.push({ partNumber, quantity, rowElement });
        }

        function processlaborHoursQueue() {
            console.log("Processing labor hours queue");
            laborHoursUpdateQueue.forEach(item => {
                updateLaborHours(item.partNumber, item.quantity, item.rowElement);
            });
            laborHoursUpdateQueue = []; // Clear the queue after processing
        }

        function updateLaborHours(partNumber, quantity, rowElement) {
            if (factors.length === 0) {
                console.log("Factors not loaded yet, queuing update");
                queueLaborHoursUpdate(partNumber, quantity, rowElement);
                return;
            }
            
            const inventoryItem = inventory.find(item => item.part_number === partNumber);
            if (inventoryItem && inventoryItem.factor_code) {
                const factor = factors.find(f => f.factor_code === inventoryItem.factor_code);
                if (factor) {
                    const laborHours = factor.labor_hours * quantity;
                    $(rowElement).find('.laborHours').text(laborHours.toFixed(2));
                    updateTotalCost($(rowElement).closest('.content-wrapper'));
                }
            }
        }

        // Update the calculateSubBidOtherMaterials function
        function calculateSubBidOtherMaterials(subBidId) {
            var otherMaterials = [];
            var subBidWrapper = $(`#subBid_${subBidId}`);

            if (subBidWrapper.length === 0) {
                console.error(`Sub-bid wrapper not found for ID: ${subBidId}`);
                return otherMaterials;
            }

            subBidWrapper.find('.itemsTable tbody tr').each(function() {
                var factorCode = $(this).find('.factorCodeInput').val();
                var quantity = parseFloat($(this).find('.quantity input').val()) || 0;

                if (factorCode && window.factorCodeItemsCache && window.factorCodeItemsCache[factorCode]) {
                    window.factorCodeItemsCache[factorCode].forEach(item => {
                        var totalQuantity = (item.quantity || 0) * quantity;
                        if (totalQuantity > 0) {
                            var existingMaterial = otherMaterials.find(m => m.part_number === item.part_number);
                            if (existingMaterial) {
                                existingMaterial.quantity += totalQuantity;
                            } else {
                                otherMaterials.push({
                                    part_number: item.part_number,
                                    description: item.description,
                                    quantity: totalQuantity,
                                    cost: item.cost || 0
                                });
                            }
                        }
                    });
                }
            });

            return otherMaterials;
        }



        function updateLineNumbers(contentWrapper) {
            contentWrapper.find(".itemsTable tbody tr").each(function(index) {
                $(this).find('.lineNumber').text(index + 1);
            });
        }

        function showOtherMaterials(category, shouldDisplay = true) {
            console.log(`Showing other materials for category: ${category}`);
            
            // First ensure all factor codes are loaded
            ensureFactorCodesLoaded(category)
                .then(() => {
                    // Now calculate the other materials with a fully populated cache
                    var otherMaterials = calculateOtherMaterials(category);
                    var isSubBid = category.startsWith('subbid-');
                    var subBidId = isSubBid ? category.replace('subbid-', '') : null;
                    
                    // Simplified title logic - always use "Sub Bid Other Materials" for sub-bids
                    var title = isSubBid ? 
                        "Sub Bid Other Materials" : 
                        category.charAt(0).toUpperCase() + category.slice(1);
                    
                    var wrapperSelector = isSubBid ? `#subBid_${subBidId}` : `#${category.toLowerCase()}Wrapper`;
                    var wrapper = $(wrapperSelector);

                    if (wrapper.length === 0) {
                        console.error(`Wrapper not found: ${wrapperSelector}`);
                        return;
                    }

                    var totalCost = 0;

                    var popoutHTML = `
                        <div id="otherMaterialsPopout" class="popout">
                            <h3>${title}</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Part Number</th>
                                        <th>Description</th>
                                        <th>Quantity</th>
                                        <th>Unit Cost</th>
                                        <th>Total Cost</th>
                                    </tr>
                                </thead>
                                <tbody id="otherMaterialsBody">
                    `;

                    otherMaterials.forEach(function(item) {
                        var itemTotalCost = item.quantity * item.cost;
                        totalCost += itemTotalCost;
                        popoutHTML += `
                            <tr>
                                <td>${item.part_number}</td>
                                <td>${item.description}</td>
                                <td>${item.quantity.toFixed(2)}</td>
                                <td>$${item.cost.toFixed(2)}</td>
                                <td>$${itemTotalCost.toFixed(2)}</td>
                            </tr>
                        `;
                    });

                    popoutHTML += `
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="4">Total Other Material Cost:</td>
                                        <td>$${totalCost.toFixed(2)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                            <button onclick="closeOtherMaterials()">Close</button>
                        </div>`;

                    $('#otherMaterialsPopout').remove();
                    $('body').append(popoutHTML);

                    if (shouldDisplay) {
                        $('#otherMaterialsPopout').show();
                    } else {
                        $('#otherMaterialsPopout').hide();
                    }

                    // Update the Other Materials cost for each row
                    wrapper.find('.itemsTable tbody tr').each(function() {
                        var tr = $(this);
                        var factorCode = tr.find('.factorCodeInput').val();
                        var quantity = parseFloat(tr.find('.quantity input').val()) || 0;
                        var otherMaterialsCost = calculateOtherMaterialsCost(factorCode, quantity);
                        tr.find('.otherMaterials').text(`$${otherMaterialsCost.toFixed(2)}`);
                    });

                    // Update the total Other Materials cost
                    wrapper.find('.totalOtherMaterialsCost').text(`$${totalCost.toFixed(2)}`);

                    updateTotalLineExtCost(wrapper);
                    updateTotalCost(wrapper);

                    console.log(`Finished showing other materials for ${category}. Total cost: $${totalCost.toFixed(2)}`);
                })
                .catch(error => {
                    console.error(`Error showing other materials for ${category}:`, error);
                });
        }

        // Function to calculate other materials cost for a specific row in a sub-bid
        function calculateSubBidRowOtherMaterialsCost(tr, otherMaterials) {
            var partNumber = tr.find('.partNumInput').val();
            var quantity = parseFloat(tr.find('.quantity input').val()) || 0;
            var matchingMaterial = otherMaterials.find(m => m.part_number === partNumber);
            return matchingMaterial ? matchingMaterial.quantity * matchingMaterial.cost : 0;
        }

        function getSubBidName(subBidId) {
            var subBidElement = document.getElementById(subBidId);
            if (subBidElement) {
                var nameElement = subBidElement.querySelector('h3');
                if (nameElement) {
                    return nameElement.textContent;
                }
            }
            return 'Unknown Sub Bid';
        }

        function closeOtherMaterials() {
            $('#otherMaterialsPopout').remove();
        }
        function initializeTable(wrapperId) {
            var contentWrapper = $('#' + wrapperId);
            var isSubcontractor = wrapperId === 'subcontractorWrapper';
            var category = wrapperId.replace('Wrapper', '').toLowerCase();
            
            var tableHTML = `
                <div class="action-buttons">
                    <button class="addBtn" onclick="addBlankLineItem('${wrapperId}')">Add Line Item</button>
                    <button class="insertBtn" onclick="insertBlankLineItem('${wrapperId}')">Insert Line Item</button>
                    ${!isSubcontractor ? `
                        <button class="otherMaterialsBtn" onclick="showOtherMaterials('${category}')">Other Materials</button>
                        <button class="subBidBtn" onclick="openSubBidModal('${category}')">Sub Bid</button>
                    ` : ''}
                    <button class="generateReportBtn" onclick="generateCombinedReport('${category}')">Generate Report</button>
                </div>
                <div class="table-container">
                    <table class="itemsTable">
                        <thead>
                            <tr>
                                <th class="lineNumber">Line Number</th>
                                <th class="partNumber">Part Number</th>
                                <th class="description">Description</th>
                                ${!isSubcontractor ? `<th class="factorCode">Factor Code</th>` : ''}
                                <th class="quantity">Quantity</th>
                                <th class="cost">Bid Price</th>
                                ${!isSubcontractor ? `
                                    <th class="laborHours">Labor Hours</th>
                                    <th class="otherMaterials">Other Materials</th>
                                ` : ''}
                                <th class="total">Total</th>
                                <th class="action">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dynamic content will be appended here -->
                        </tbody>
                    </table>
                </div>
                <div class="total-cost">
                    ${!isSubcontractor ? `
                        <h2>Material Cost: <span class="totalMaterialCost">$0.00</span></h2>
                        <h2>Labor Cost: <span class="totalLaborCost">$0.00</span></h2>
                        <h2>Other Materials Cost: <span class="totalOtherMaterialsCost">$0.00</span></h2>
                        <h2>Tax: <span class="totalTax">$0.00</span></h2>
                    ` : ''}
                    <h2>Total Cost: <span class="totalCost">$0.00</span></h2>
                </div>`;
            
            contentWrapper.html(tableHTML);
            attachEventHandlers(contentWrapper);
            
            // Attach autocomplete to part number inputs after adding them to the DOM
            contentWrapper.find('.partNumInput').each(function() {
                attachAutocompleteToPartNumber($(this));
            });
        }

        function updateLaborHoursFromFactorCode(tr, factorCode, quantity) {
            if (!factorCode) {
                tr.find('.laborHoursInput').val('0.00');
                updateLineAndTotalCosts(tr.find('.laborHoursInput')[0]);
                return;
            }

            $.ajax({
                url: `/get-factor-code-labor-hours/${factorCode}`,
                method: 'GET',
                success: function(data) {
                    if (data && typeof data.labor_hours !== 'undefined') {
                        var laborHours = data.labor_hours;
                        tr.find('.laborHoursInput').val(laborHours.toFixed(4));
                        updateLineAndTotalCosts(tr.find('.laborHoursInput')[0]);
                    } else {
                        console.warn(`No valid labor hours data received for factor code ${factorCode}`);
                        tr.find('.laborHoursInput').val('0.00');
                        updateLineAndTotalCosts(tr.find('.laborHoursInput')[0]);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error(`Error fetching labor hours for factor code ${factorCode}:`, textStatus, errorThrown);
                    tr.find('.laborHoursInput').val('0.00');
                    updateLineAndTotalCosts(tr.find('.laborHoursInput')[0]);
                }
            });
        }

        function attachEventHandlers(contentWrapper) {
            var wrapperId = contentWrapper.attr('id');
            var isSubcontractor = wrapperId === 'subcontractorWrapper';

            // Use event delegation for row clicks
            contentWrapper.on('click', 'table tbody tr:not(.additional-description-row)', handleRowClick);

            contentWrapper.on('change', '.factorCodeInput', function() {
                var tr = $(this).closest('tr');
                var factorCode = $(this).val();
                updateLaborHoursFromFactorCode(tr, factorCode);
            });

            contentWrapper.on('input', '.quantity input, .costInput, .laborHoursInput, .factorCodeInput', function() {
                updateLineAndTotalCosts(this);
            });

            // Single click handler
            contentWrapper.on('click', 'input', function(e) {
                if (!$(this).data('doubleClicked')) {
                    e.preventDefault();
                    $(this).prop('readonly', false);
                    $(this).focus();
                    $(this).select();
                }
            });

            // Double click handler
            contentWrapper.on('dblclick', 'input', function(e) {
                $(this).data('doubleClicked', true);
                $(this).prop('readonly', false);
                // Remove any text selection
                if (window.getSelection) {
                    window.getSelection().removeAllRanges();
                }
                setTimeout(() => {
                    $(this).data('doubleClicked', false);
                }, 500); // Reset after 500ms
            });

            attachAutocompleteToPartNumber(contentWrapper.find('.partNumInput'));
            attachFactorAutocomplete(contentWrapper.find('.factorCodeInput'));

            contentWrapper.on('click', '.removeBtn', function(event) {
                event.preventDefault();
                removeLineItem(this);
            });

            contentWrapper.on('keydown', 'input[type="number"]', function(e) {
                if (e.which === 38 || e.which === 40) {
                    e.preventDefault();
                }
            });

            // Handle keyboard navigation
            contentWrapper.on('keydown', 'input', handleTabNavigation);
        }
    function closeAndSaveSubBid(subBidId, category) {
        saveSubBidItems(subBidId, category);
        showSubBidsList(category);
    }
    
    function initializeModalCloseButtons() {
        var closeButtons = document.getElementsByClassName("close");
        for (var i = 0; i < closeButtons.length; i++) {
            closeButtons[i].onclick = function() {
                var modal = this.closest('.modal');
                if (modal) {
                    closeModal(modal.id);
                }
            }
        }
    }

    function updateOtherMaterialsCost(tr, factorCode, quantity) {
        var contentWrapper = tr.closest('.content-wrapper, .modal-content, .sub-bid-wrapper');
        var isSubBid = contentWrapper.hasClass('sub-bid-wrapper');
        var otherMaterialsCost;

        if (isSubBid) {
            var subBidOtherMaterials = calculateSubBidOtherMaterials(contentWrapper);
            otherMaterialsCost = calculateSubBidRowOtherMaterialsCost(tr, subBidOtherMaterials);
        } else {
            otherMaterialsCost = calculateOtherMaterialsCost(factorCode, quantity);
        }

        tr.find('.otherMaterials').text(`$${otherMaterialsCost.toFixed(2)}`);

        updateTotalOtherMaterialsCost(contentWrapper);
    }

    function updateTotalOtherMaterialsCost(contentWrapper) {
        var totalOtherMaterialsCost = 0;
        contentWrapper.find('.itemsTable tbody tr').each(function() {
            var otherMaterialsCost = parseFloat($(this).find('.otherMaterials').text().replace('$', '')) || 0;
            totalOtherMaterialsCost += otherMaterialsCost;
        });
        contentWrapper.find('.totalOtherMaterialsCost').text(`$${totalOtherMaterialsCost.toFixed(2)}`);
    }

    function calculateTax(cost, quantity, otherMaterialsCost) {
        var taxRate = parseFloat($('#localSalesTax').val()) / 100 || 0;
        var taxableAmount = (cost * quantity) + otherMaterialsCost;
        return taxableAmount * taxRate;
    }

    // Helper function to get the correct sub-bid ID
    function getSubBidId(element) {
        var wrapper = $(element).closest('.sub-bid-wrapper');
        if (wrapper.length) {
            return wrapper.attr('id').replace('subBid_', '');
        }
        return null;
    }   
    function updateLineAndTotalCosts(inputElement) {
        var tr = $(inputElement).closest('tr');
        var contentWrapper = tr.closest('.content-wrapper, .modal-content, .sub-bid-wrapper');
        var isSubcontractor = contentWrapper.attr('id') === 'subcontractorWrapper';

        // Parse values with strict error checking
        let quantity = 0;
        let cost = 0;
        let laborHours = 0;
        let otherMaterialsCost = 0;

        try {
            quantity = parseFloat(tr.find('.quantity input').val()) || 0;
            cost = parseFloat(tr.find('.costInput').val()) || 0;
            if (!isSubcontractor) {
                laborHours = parseFloat(tr.find('.laborHoursInput').val()) || 0;
                otherMaterialsCost = parseFloat(tr.find('.otherMaterials').text().replace('$', '')) || 0;
            }
        } catch (e) {
            console.error('Error parsing values:', e);
        }

        // Calculate components safely
        const materialCost = quantity * cost;
        let laborCost = 0;
        let tax = 0;

        if (!isSubcontractor) {
            const laborRate = getLaborRate(contentWrapper.attr('id')) || 0;
            laborCost = quantity * laborHours * laborRate;

            const taxRate = parseFloat($('#localSalesTax').val()) / 100 || 0;
            const taxableAmount = materialCost + otherMaterialsCost;
            tax = taxableAmount * taxRate;
        }

        // Calculate total with null/NaN checking
        const totalLineCost = (materialCost || 0) + (laborCost || 0) + (otherMaterialsCost || 0) + (tax || 0);

        // Update the row's total
        tr.find('.total').text(`$${totalLineCost.toFixed(2)}`);

        // Update the wrapper totals
        updateAllRowTotals(contentWrapper);
    }

    // New function to update all row totals
    function updateAllRowTotals(contentWrapper) {
        let totalMaterialCost = 0;
        let totalLaborCost = 0;
        let totalOtherMaterialsCost = 0;
        let totalTax = 0;

        contentWrapper.find('.itemsTable tbody tr').each(function() {
            try {
                const quantity = parseFloat($(this).find('.quantity input').val()) || 0;
                const cost = parseFloat($(this).find('.costInput').val()) || 0;
                const laborHours = parseFloat($(this).find('.laborHoursInput').val()) || 0;
                const otherMaterials = parseFloat($(this).find('.otherMaterials').text().replace('$', '')) || 0;
                const laborRate = getLaborRate(contentWrapper.attr('id')) || 0;

                // Calculate components safely
                const rowMaterialCost = quantity * cost;
                const rowLaborCost = quantity * laborHours * laborRate;
                const taxRate = parseFloat($('#localSalesTax').val()) / 100 || 0;
                const taxableAmount = rowMaterialCost + otherMaterials;
                const rowTax = taxableAmount * taxRate;

                // Update row total
                const rowTotal = (rowMaterialCost || 0) + (rowLaborCost || 0) + (otherMaterials || 0) + (rowTax || 0);
                $(this).find('.total').text(`$${rowTotal.toFixed(2)}`);

                // Add to running totals
                totalMaterialCost += rowMaterialCost || 0;
                totalLaborCost += rowLaborCost || 0;
                totalOtherMaterialsCost += otherMaterials || 0;
                totalTax += rowTax || 0;
            } catch (e) {
                console.error('Error calculating row totals:', e);
            }
        });

        // Update wrapper totals display
        const totalCostContainer = contentWrapper.find('.total-cost');
        totalCostContainer.find('.totalMaterialCost').text(`$${totalMaterialCost.toFixed(2)}`);
        totalCostContainer.find('.totalLaborCost').text(`$${totalLaborCost.toFixed(2)}`);
        totalCostContainer.find('.totalOtherMaterialsCost').text(`$${totalOtherMaterialsCost.toFixed(2)}`);
        totalCostContainer.find('.totalTax').text(`$${totalTax.toFixed(2)}`);
        totalCostContainer.find('.totalCost').text(`$${(totalMaterialCost + totalLaborCost + totalOtherMaterialsCost + totalTax).toFixed(2)}`);

        // Update budget totals
        updateBudgetTotals();
    }
        
    
    function updateSubBidListEntry(subBidId) {
        var subBidWrapper = $(`#subBid_${subBidId}`);
        if (subBidWrapper.length === 0) {
            console.error(`Sub-bid wrapper not found for ID: ${subBidId}`);
            return;
        }

        var totalCost = parseFloat(subBidWrapper.find('.totalCost').text().replace('$', '')) || 0;
        var totalLaborHours = 0;

        subBidWrapper.find('.itemsTable tbody tr').each(function() {
            var quantity = parseFloat($(this).find('.quantity input').val()) || 0;
            var laborHours = parseFloat($(this).find('.laborHoursInput').val()) || 0;
            totalLaborHours += quantity * laborHours;
        });

        var subBidEntry = $(`[data-subbid-id="${subBidId}"]`);
        if (subBidEntry.length) {
            subBidEntry.find('.sub-bid-total').text(`$${totalCost.toFixed(2)}`);
            subBidEntry.find('.sub-bid-labor-hours').text(totalLaborHours.toFixed(2));
        }
    }   

    function updateLineItemCost(tr) {
        var lineExtCost = tr.data('lineExtCost') || 0;
        var wrapperId = tr.closest('.content-wrapper').attr('id');
        $(`#lineItemCost-${wrapperId}`).text(`$${lineExtCost.toFixed(2)}`);
    }


    function insertBlankLineItem(wrapperId) {
        var lineNum = prompt("Enter the line number after which you want to insert a new line item:");
        if (!lineNum || isNaN(lineNum) || parseInt(lineNum) < 1) {
            alert("Please enter a valid line number.");
            return;
        }
        lineNum = parseInt(lineNum);

        var contentWrapper = $('#' + wrapperId);
        var itemsTableBody = contentWrapper.find(".itemsTable tbody");
        var existingRows = itemsTableBody.find('tr:not(.additional-description-row)').length;

        if (lineNum > existingRows) {
            alert("Line number exceeds the current number of items. Adding at the end.");
            addBlankLineItem(wrapperId);
        } else {
            const bidId = document.getElementById('bidId').value;
            const isSubcontractor = wrapperId === 'subcontractorWrapper';

            fetch('/add-blank-line-item', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ wrapper_id: wrapperId, bid_id: bidId, insert_after: lineNum - 1 })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    var newRow = $(getTableRow(data.total_items, isSubcontractor));
                    var targetRow = itemsTableBody.find("tr:not(.additional-description-row)").eq(lineNum - 1);
                    newRow.insertAfter(targetRow);

                    initializeRow(newRow);
                    
                    // Reattach event handlers to the entire table
                    contentWrapper.off('click', 'table tbody tr:not(.additional-description-row)').on('click', 'table tbody tr:not(.additional-description-row)', handleRowClick);

                    updateLineNumbers(contentWrapper);
                    updateLineAndTotalCosts(newRow.find('.quantity input')[0]);

                    newRow.find('.partNumInput').focus();

                    updateTotalCost(contentWrapper);
                    updateBudgetTotals();

                    $(`#additionalDescription-${wrapperId}`).val('');
                } else {
                    console.error('Error inserting new line item:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    }


    function reinitializeAutocompleteForAll(contentWrapper) {
        var partNumInputs = contentWrapper.find('.partNumInput');
        var factorCodeInputs = contentWrapper.find('.factorCodeInput');

        partNumInputs.each(function() {
            attachAutocomplete($(this), inventory);
        });

        factorCodeInputs.each(function() {
            attachFactorAutocomplete($(this), factors);
        });
    }

    function addBlankLineItem(wrapperId) {
        console.log(`Adding blank line item to ${wrapperId}`);
        
        if ($('body').hasClass(`${wrapperId}-adding-line`)) {
            console.log('Already adding a line, skipping');
            return;
        }
        
        $('body').addClass(`${wrapperId}-adding-line`);
        
        const bidId = document.getElementById('bidId').value;
        const isSubcontractor = wrapperId === 'subcontractorWrapper';
        
        fetch('/add-blank-line-item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ wrapper_id: wrapperId, bid_id: bidId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                var contentWrapper = $('#' + wrapperId);
                var tableBody = contentWrapper.find('.itemsTable tbody');
                var newRow = $(getTableRow(data.total_items, isSubcontractor));
                tableBody.append(newRow);

                initializeRow(newRow);
                
                // Reattach event handlers to the entire table
                contentWrapper.off('click', 'table tbody tr:not(.additional-description-row)').on('click', 'table tbody tr:not(.additional-description-row)', handleRowClick);

                updateLineNumbers(contentWrapper);
                updateLineAndTotalCosts(newRow.find('.quantity input')[0]);

                var scrollContainer = tableBody.closest('.table-container');
                scrollContainer.animate({
                    scrollTop: scrollContainer[0].scrollHeight
                }, 500);

                updateTotalCost(contentWrapper);
                updateBudgetTotals();

                newRow.find('.partNumInput').focus();
            } else {
                console.error('Error adding new line item:', data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        })
        .finally(() => {
            $('body').removeClass(`${wrapperId}-adding-line`);
        });
    }

    function updateOtherMaterials(category) {
        console.log(`Updating other materials for category: ${category}`);
        var otherMaterials = calculateOtherMaterials(category);
        updateOtherMaterialsList(otherMaterials);

        var wrapperSelector = category.startsWith('subbid-') ? `#${category.replace('subbid-', '')}` : `#${category.toLowerCase()}Wrapper`;
        var wrapper = $(wrapperSelector);

        // Update the Other Materials cost for each row
        wrapper.find('.itemsTable tbody tr').each(function() {
            var tr = $(this);
            var factorCode = tr.find('.factorCodeInput').val();
            var quantity = parseFloat(tr.find('.quantity input').val()) || 0;
            var otherMaterialsCost = calculateOtherMaterialsCost(factorCode, quantity);
            tr.find('.otherMaterials').text(`$${otherMaterialsCost.toFixed(2)}`);
        });

        // Update the total Other Materials cost
        var totalCost = otherMaterials.reduce((sum, item) => sum + item.quantity * item.cost, 0);
        wrapper.find('.totalOtherMaterialsCost').text(`$${totalCost.toFixed(2)}`);

        updateTotalLineExtCost(wrapper);
        updateTotalCost(wrapper);
    }

    function getTableRow(rowNum, isSubcontractor = false) {
        return `
            <tr>
                <td class="lineNumber">${rowNum}</td>
                <td class="partNumber"><input type='text' class='partNumInput' autocomplete='off'></td>
                <td><input type='text' class='descriptionInput' autocomplete='off'></td>
                ${!isSubcontractor ? `<td><input type="text" class="factorCodeInput" autocomplete="off"></td>` : ''}
                <td class="quantity"><input type='text' class='quantity' value='1' oninput='updateLineAndTotalCosts(this)'></td>
                <td><input type='text' class='costInput' value='0.00' oninput='updateLineAndTotalCosts(this)'></td>
                ${!isSubcontractor ? `
                    <td><input type='text' class='laborHoursInput' value='0' oninput='updateLineAndTotalCosts(this)'></td>
                    <td class="otherMaterials">$0.00</td>
                ` : ''}
                <td class="total">$0.00</td>
                <td class="action"><button class='removeBtn'>Remove</button></td>
            </tr>`;
    }


    function calculateCategoryTotal(wrapperId, laborRate, taxRate) {
        var contentWrapper = $('#' + wrapperId);
        var isSubcontractor = wrapperId === 'subcontractorWrapper';
        var materialTotal = 0;
        var laborTotal = 0;
        var otherMaterialsTotal = 0;
        var taxTotal = 0;

        contentWrapper.find(".itemsTable tbody tr").each(function() {
            var quantity = parseFloat($(this).find('.quantity input').val()) || 0;
            var cost = parseFloat($(this).find('.costInput').val()) || 0;
            var lineCost = quantity * cost;
            materialTotal += lineCost;

            if (!isSubcontractor) {
                var laborHours = parseFloat($(this).find('.laborHoursInput').val()) || 0;
                var laborCost = quantity * laborHours * laborRate;
                laborTotal += laborCost;

                var otherMaterialsCost = parseFloat($(this).find('.otherMaterials').text().replace('$', '')) || 0;
                otherMaterialsTotal += otherMaterialsCost;

                var taxableAmount = lineCost + otherMaterialsCost;
                taxTotal += taxableAmount * taxRate;
            }
        });

        return {
            materialTotal: materialTotal,
            laborTotal: laborTotal,
            otherMaterialsTotal: otherMaterialsTotal,
            taxTotal: isSubcontractor ? 0 : taxTotal
        };
    }

    function recalculateLaborHours(tr, quantity) {
        var partNumber = tr.find('.partNumInput').val();
        var baseLaborHours = tr.data('baseLaborHours');
        
        if (baseLaborHours === undefined) {
            // If baseLaborHours is not set, fetch it from the server
            fetchFactorCodeAndLaborHoursForPart(partNumber, tr, quantity);
        } else {
            var scaledLaborHours = baseLaborHours * quantity;
            tr.find('.laborHours').text(scaledLaborHours.toFixed(2));
        }
    }

    // Function to get labor rate based on category
    function getLaborRate(wrapperId) {
        let category;
        if (wrapperId.includes('subBid_')) {
            // For sub-bids, extract the category from the sub-bid's data attribute
            const subBidElement = $(`#${wrapperId}`);
            category = subBidElement.data('category');
        } else {
            // For main wrapper, extract category from wrapper ID
            category = wrapperId.replace('Wrapper', '').toLowerCase();
        }

        switch(category) {
            case 'drains':
                return parseFloat($('#laborRateDrains').val()) || 31;
            case 'irrigation':
                return parseFloat($('#laborRateIrrigation').val()) || 31;
            case 'landscape':
                return parseFloat($('#laborRateLandscape').val()) || 31;
            case 'maintenance':
                return parseFloat($('#laborRateMaintenance').val()) || 31;
            case 'subcontractor':
                return 0;
            default:
                console.warn('Unknown category for labor rate:', category);
                return 31;
        }
    }

    function populateDropdown(input, dropdown, type) {
        var query = input.val();
        var url = type === 'part' ? '/inventory/search' : '/autocomplete-factor-codes';

        $.ajax({
            url: url,
            data: { query: query },
            success: function(data) {
                dropdown.empty();
                var items = type === 'part' ? data.inventory : data.factor_codes;
                items.forEach(function(item) {
                    var option = $('<div class="dropdown-option"></div>');
                    option.text(type === 'part' ? `${item.part_number} - ${item.description}` : `${item.factor_code} - ${item.description}`);
                    option.on('click', function() {
                        if (type === 'part') {
                            handlePartNumberSelection(input, item);
                        } else {
                            handleFactorCodeSelection(input, item);
                        }
                        dropdown.hide();
                    });
                    dropdown.append(option);
                });
            },
            error: function() {
                dropdown.empty();
                dropdown.append('<div>No results found</div>');
            }
        });
    }

    function loadLaborRates(bidId) {
        $.ajax({
            url: '/get-bid-labor-rates',
            type: 'GET',
            data: { bid_id: bidId },
            success: function(response) {
                updateLaborRates(response); // Update the fields with either custom or default rates
            },
            error: function(error) {
                console.error('Error loading labor rates:', error);
                alert('Failed to load labor rates.');
            }
        });
    }

    // Function to update individual sub-bid totals
    function updateSubBidTotals(subBidWrapper, laborRate) {
        let totalMaterialCost = 0;
        let totalLaborCost = 0;
        let totalOtherMaterialsCost = 0;
        let totalTax = 0;

        subBidWrapper.find('.itemsTable tbody tr').each(function() {
            const quantity = parseFloat($(this).find('.quantity input').val()) || 0;
            const cost = parseFloat($(this).find('.costInput').val()) || 0;
            const laborHours = parseFloat($(this).find('.laborHoursInput').val()) || 0;
            const otherMaterialsCost = parseFloat($(this).find('.otherMaterials').text().replace('$', '')) || 0;

            totalMaterialCost += quantity * cost;
            totalLaborCost += quantity * laborHours * laborRate;
            totalOtherMaterialsCost += otherMaterialsCost;

            // Update row total
            const rowTotal = (quantity * cost) + (quantity * laborHours * laborRate) + otherMaterialsCost;
            $(this).find('.total').text(`$${rowTotal.toFixed(2)}`);
        });

        // Update sub-bid totals display
        const totalCost = totalMaterialCost + totalLaborCost + totalOtherMaterialsCost + totalTax;
        subBidWrapper.find('.totalMaterialCost').text(`$${totalMaterialCost.toFixed(2)}`);
        subBidWrapper.find('.totalLaborCost').text(`$${totalLaborCost.toFixed(2)}`);
        subBidWrapper.find('.totalOtherMaterialsCost').text(`$${totalOtherMaterialsCost.toFixed(2)}`);
        subBidWrapper.find('.totalTax').text(`$${totalTax.toFixed(2)}`);
        subBidWrapper.find('.totalCost').text(`$${totalCost.toFixed(2)}`);
    }

    function validateBidData(bidData) {
        const errors = [];
        
        // Validate heading info
        if (!bidData.heading_info.customer_name?.trim()) {
            errors.push("Customer name is required");
        }
        
        if (!bidData.heading_info.project_name?.trim()) {
            errors.push("Project name is required");
        }

        // Validate project location
        const projectLocation = [
            bidData.heading_info.project_address,
            bidData.heading_info.project_city,
            bidData.heading_info.project_state,
            bidData.heading_info.project_zip
        ].filter(Boolean);

        if (projectLocation.length === 0) {
            errors.push("At least one project location field (address, city, state, or zip) is required");
        }

        // Validate labor rates
        if (Object.values(bidData.labor_rates).some(rate => rate === 0)) {
            errors.push("All labor rates must be set (cannot be 0)");
        }

        // Validate that at least one category has items
        const hasItems = Object.values(bidData.items).some(categoryItems => 
            Array.isArray(categoryItems) && categoryItems.length > 0
        );
        
        if (!hasItems) {
            errors.push("At least one line item is required in any category");
        }

        // Validate items in each category
        Object.entries(bidData.items).forEach(([category, items]) => {
            if (Array.isArray(items) && items.length > 0) {
                items.forEach((item, index) => {
                    if (!item.part_number?.trim()) {
                        errors.push(`Invalid part number in ${category} line ${index + 1}`);
                    }
                    if (isNaN(item.quantity)) {
                        errors.push(`Invalid quantity in ${category} line ${index + 1}`);
                    }
                    if (item.cost < 0) {
                        errors.push(`Invalid cost in ${category} line ${index + 1}`);
                    }
                });
            }
        });

        return errors;
    }
    function calculateOtherMaterialsCost(factorCode, quantity) {
        // Guard against invalid inputs
        if (!factorCode || !window.factorCodeItemsCache || !window.factorCodeItemsCache[factorCode]) {
            return 0;
        }
        
        // Ensure quantity is a number
        quantity = parseFloat(quantity) || 0;
        
        return window.factorCodeItemsCache[factorCode].reduce((total, item) => {
            const itemCost = parseFloat(item.cost) || 0;
            const itemQuantity = parseFloat(item.quantity) || 0;
            return total + (itemCost * itemQuantity * quantity);
        }, 0);
    }

    function updateLineExtCost(tr, factorCode, quantity) {
        console.log(`Updating other materials cost - Factor Code: ${factorCode}, Quantity: ${quantity}`);
        var otherMaterialsCost = 0;

        if (factorCode && window.factorCodeItemsCache && window.factorCodeItemsCache[factorCode]) {
            otherMaterialsCost = calculateOtherMaterialsCost(factorCode, quantity);
        }
        
        tr.find('.otherMaterials').text(`$${otherMaterialsCost.toFixed(2)}`);
        tr.find('.lineExtCost').text(`$${otherMaterialsCost.toFixed(2)}`);
        
        var contentWrapper = tr.closest('.content-wrapper, .modal-content');
        
        if (contentWrapper.length > 0) {
            updateTotalCost(contentWrapper);
            updateSubBidTotals(contentWrapper);
            
            var category;
            if (contentWrapper.hasClass('content-wrapper')) {
                category = contentWrapper.attr('id').replace('Wrapper', '');
            } else {
                var subBidId = contentWrapper.find('.itemsTable').attr('id');
                category = subBidId ? 'subbid-' + subBidId : 'unknown';
            }

            if (factorCode) {
                fetchFactorCodeItems(factorCode)
                    .then(() => {
                        var otherMaterials = calculateOtherMaterials(category);
                        updateOtherMaterialsList(otherMaterials);
                        showOtherMaterials(category, false);
                    });
            }
        } else {
            console.warn('Content wrapper not found for the current row');
        }
    }

    function setupTokenRefresh() {
    // Refresh token every 20 minutes
    const REFRESH_INTERVAL = 1200000;
    
    // Function to refresh token using an existing page
    function refreshToken() {
        // Create a hidden iframe to load a page from the server
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
        
        // Load a simple existing page that will contain a fresh CSRF token
        iframe.src = '/refresh-token-helper';
        
        // When the iframe loads, extract the token
        iframe.onload = function() {
            try {
                // Extract the CSRF token from the iframe document
                const newToken = iframe.contentWindow.document.getElementById('csrf_token').value;
                if (newToken) {
                    // Update our token
                    document.getElementById('csrf_token').value = newToken;
                    console.log('CSRF token refreshed successfully');
                }
            } catch (error) {
                console.error('Error extracting token from iframe:', error);
            } finally {
                // Clean up
                document.body.removeChild(iframe);
            }
        };
    }
    
    // Simpler alternative: Periodic user warnings
    function showTokenWarning() {
        const warningDiv = document.createElement('div');
        warningDiv.style.position = 'fixed';
        warningDiv.style.top = '10px';
        warningDiv.style.right = '10px';
        warningDiv.style.backgroundColor = '#ffdddd';
        warningDiv.style.border = '1px solid #ff0000';
        warningDiv.style.padding = '10px';
        warningDiv.style.borderRadius = '5px';
        warningDiv.style.zIndex = '9999';
        warningDiv.innerHTML = `
            <p><strong>Warning:</strong> Your session may be expiring soon.</p>
            <p>To avoid losing work, please save now and reload the page.</p>
            <button id="refreshPageBtn" style="margin-right: 10px;">Reload Page</button>
            <button id="dismissWarningBtn">Dismiss</button>
        `;
        
        document.body.appendChild(warningDiv);
        
        document.getElementById('refreshPageBtn').addEventListener('click', function() {
            // Save work before reloading
            saveBid().then(() => {
                window.location.reload();
            }).catch(err => {
                alert('Error saving: ' + err.message + '\nPlease try manually saving before reloading.');
            });
        });
        
        document.getElementById('dismissWarningBtn').addEventListener('click', function() {
            document.body.removeChild(warningDiv);
        });
    }
    
    // Set up periodic warnings
    setInterval(showTokenWarning, REFRESH_INTERVAL);
    
    // Keep session alive with activity tracking
    function trackActivity() {
        // Store last activity time
        localStorage.setItem('lastActivity', new Date().getTime());
    }
    
    // Track user activity
    ['mousedown', 'keypress', 'scroll', 'touchstart'].forEach(function(evt) {
        document.addEventListener(evt, trackActivity, true);
    });
    
    // Check activity and keep session alive
    setInterval(function() {
        const lastActivity = parseInt(localStorage.getItem('lastActivity') || '0');
        const now = new Date().getTime();
        
        // If there was activity in the last 5 minutes
        if (now - lastActivity < 300000) {
            // Make a request to any existing page to keep session alive
            fetch('/ping-session', { 
                method: 'GET',
                credentials: 'same-origin'
            }).catch(e => console.log('Session ping error:', e));
        }
    }, 240000); // Every 4 minutes
    
    // Modified save button handler
    const saveButton = document.getElementById('saveButton');
    if (saveButton) {
        // Store original onclick
        const originalOnClick = saveButton.onclick;
        
        saveButton.onclick = function(e) {
            e.preventDefault();
            
            // Auto-save the current state before attempting to save
            const formData = new FormData();
            formData.append('csrf_token', document.getElementById('csrf_token').value);
            formData.append('bid_id', document.getElementById('bidId').value);
            formData.append('auto_save', 'true');
            
            // Send auto-save request
            fetch('/auto-save-bid', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            })
            .then(() => {
                // Now try the actual save
                if (typeof originalOnClick === 'function') {
                    originalOnClick.call(this, e);
                } else {
                    saveBid();
                }
            })
            .catch(err => {
                console.error('Auto-save failed:', err);
                
                // Show token error message with reload option
                if (confirm('Your session may have expired. Would you like to reload the page to refresh your session? (Your work will be auto-saved)')) {
                    window.location.reload();
                } else {
                    // Try the regular save anyway
                    saveBid();
                }
            });
        };
    }
}

// Initialize when document is ready
document.addEventListener('DOMContentLoaded', function() {
    setupTokenRefresh();
});
    
    function loadDefaultLaborRates() {
        fetch('/get-default-labor-rates')
            .then(response => response.json())
            .then(data => {
                console.log('Received default labor rates:', data);
                
                const setRateIfZero = (id, value) => {
                    const element = document.getElementById(id);
                    if (element && (parseFloat(element.value) === 0 || element.value === '')) {
                        element.value = value;
                    }
                };

                setRateIfZero('laborRateDrains', data.drains_labor_rate);
                setRateIfZero('laborRateIrrigation', data.irrigation_labor_rate);
                setRateIfZero('laborRateLandscape', data.landscape_labor_rate);
                setRateIfZero('laborRateMaintenance', data.maintenance_labor_rate);
                setRateIfZero('localSalesTax', data.local_sales_tax);

                updateBudgetTotals();
            })
            .catch(error => {
                console.error('Error loading default labor rates:', error);
            });
    }


    function updateOtherMaterialsList(otherMaterials) {
        var otherMaterialsHtml = '';
        var totalCost = 0;
        otherMaterials.forEach(item => {
            var itemTotalCost = item.quantity * item.cost;
            totalCost += itemTotalCost;
            otherMaterialsHtml += `
                <tr>
                    <td>${item.part_number}</td>
                    <td>${item.description}</td>
                    <td>${item.quantity.toFixed(2)}</td>
                    <td>$${item.cost.toFixed(2)}</td>
                    <td>$${itemTotalCost.toFixed(2)}</td>
                </tr>
            `;
        });
        $('#otherMaterialsBody').html(otherMaterialsHtml);
        $('#otherMaterialsTotalCost').text(`$${totalCost.toFixed(2)}`);
    }    

    function updateTotalLineExtCost(contentWrapper) {
        var totalLineExtCost = 0;
        contentWrapper.find('.itemsTable tbody tr').each(function() {
            var lineExtCost = parseFloat($(this).find('.lineExtCost').text().replace('$', '')) || 0;
            totalLineExtCost += lineExtCost;
        });
        contentWrapper.find('.line-ext-cost #lineExtCost').text(`$${totalLineExtCost.toFixed(2)}`);
    }

    function updateAdditionalDescriptionForPartNumber(partNumber, description) {
        $('.itemsTable tbody tr').each(function() {
            if ($(this).find('.partNumInput').val() === partNumber) {
                $(this).data('additionalDescription', description);
            }
        });
    }

    function searchFactorCodes(searchInputId, resultsContainerId) {
        const query = $('#' + searchInputId).val().toLowerCase();
        if (query.length >= 2) {
            $.getJSON(`/search-factor-codes?query=${query}`, function(data) {
                const resultsDiv = $('#' + resultsContainerId);
                resultsDiv.empty();

                if (data.factors.length === 0) {
                    resultsDiv.append('<p>No matching factor codes found.</p>');
                } else {
                    const ul = $('<ul>');
                    data.factors.forEach(factor => {
                        ul.append(`<li data-factor='${JSON.stringify(factor)}'>${factor.factor_code} - ${factor.description}</li>`);
                    });
                    resultsDiv.append(ul);

                    // Add click event to factor code results
                    resultsDiv.find('li').on('click', function() {
                        const factor = JSON.parse($(this).attr('data-factor'));
                        fillFactorCodeDetails(factor);
                        resultsDiv.hide(); // Hide the results after selecting
                    });
                    resultsDiv.show(); // Show the results dropdown
                }
            });
        } else {
            $('#' + resultsContainerId).hide(); // Hide the results if query is less than 2 characters
        }
    }

    function fillFactorCodeDetails(factor) {
        // Fill in the details as per your requirement
        $('#factorCodeInput').val(factor.factor_code);
        $('#laborHoursInput').val(factor.labor_hours); // Example for filling labor hours
    }

    function recalculateLineNumbers(wrapper) {
        const rows = $(wrapper).find('.itemsTable tbody tr');
        rows.each(function(index) {
            const lineNumberCell = $(this).find('.lineNumber');
            if (lineNumberCell.length) {
                lineNumberCell.text(index + 1);
            }
        });
    }


    function recalculateOtherMaterialsAndLaborCosts(wrapper) {
        const rows = wrapper.querySelectorAll('.itemsTable tbody tr:not(.sub-bid-header)');
        rows.forEach(row => {
            const quantityInput = row.querySelector('.quantity input');
            if (quantityInput) {
                updateLineAndTotalCosts(quantityInput);
            }
        });
    }


    function enableDragAndDrop(tableSelector) {
        $(tableSelector + ' tbody').sortable({
            cursor: 'move',
            helper: function(e, tr) {
                var $originals = tr.children();
                var $helper = tr.clone();
                $helper.children().each(function(index) {
                    $(this).width($originals.eq(index).width());
                });
                return $helper;
            },
            start: function(e, ui) {
                ui.item.data('start_pos', ui.item.index());
                
                // Hide all additional description rows
                $(tableSelector + ' .additional-description-row').hide();

                // Remove 'active-dropdown' class from all rows
                $(tableSelector + ' tbody tr').removeClass('active-dropdown');

                // Add a class to the dragged item for styling
                ui.item.addClass('ui-sortable-helper');
            },
            stop: function(e, ui) {
                // Remove the helper class
                ui.item.removeClass('ui-sortable-helper');

                // Ensure the dropped item is not selected and its additional description remains hidden
                ui.item.removeClass('active-dropdown');
                ui.item.next('.additional-description-row').hide();

                // Re-apply alternating row colors if needed
                $(tableSelector + ' tbody tr:not(.additional-description-row)').each(function(index) {
                    $(this).removeClass('odd even');
                    $(this).addClass(index % 2 === 0 ? 'odd' : 'even');
                });
            },
            update: function(event, ui) {
                var contentWrapper = $(this).closest('.content-wrapper');
                
                // Recalculate line numbers for all rows
                recalculateLineNumbers(contentWrapper);

                // Update totals
                updateTotalCost(contentWrapper);
                updateBudgetTotals();
            }
        }).disableSelection();
    }
// Additional helper function to handle cell editing state
function enableCellEditing(input) {
    input.prop('readonly', false);
    input.focus();
    input.select();
}

// Additional helper function to disable cell editing
function disableCellEditing(input) {
    input.prop('readonly', true);
}


function handleRowClick(event) {
    // Prevent handling if clicking input or button
    if ($(event.target).is('input, button, .removeBtn')) {
        return;
    }

    var $this = $(this);
    var $additionalDescRow = $this.next('.additional-description-row');
    var wasSelected = $this.hasClass('active-dropdown');

    // Prevent other rows from being selected
    $this.closest('tbody').find('tr').not($this).removeClass('selected active-dropdown');
    $this.closest('tbody').find('.additional-description-row').not($additionalDescRow).remove();

    // If row was already selected and has an additional description row
    if (wasSelected && $additionalDescRow.length) {
        // Save the current description
        const currentDesc = $additionalDescRow.find('.additionalDescriptionInput').val();
        $this.data('additionalDescription', currentDesc);
        console.log('Saving description before hide:', currentDesc);
        
        // Remove the row and deselect
        $additionalDescRow.remove();
        $this.removeClass('active-dropdown');
    } 
    // If row wasn't selected or doesn't have an additional description row
    else {
        // Select the row
        $this.addClass('active-dropdown');
        
        // Get existing description
        const existingDesc = $this.data('additionalDescription') || '';
        console.log('Loading existing description:', existingDesc);

        // Create new description row
        const columnCount = $this.children('td').length;
        const newRow = $(`
            <tr class="additional-description-row">
                <td colspan="${columnCount}">
                    <input type="text" class="additionalDescriptionInput" 
                        value="${existingDesc}" 
                        placeholder="Enter additional description">
                </td>
            </tr>
        `);

        // Insert after current row
        $this.after(newRow);

        // Attach input handler
        const $input = newRow.find('.additionalDescriptionInput');
        $input.on('input', function() {
            const updatedDesc = $(this).val();
            $this.data('additionalDescription', updatedDesc);
            console.log('Updating description:', updatedDesc);
        });

        // Focus the input and prevent event propagation
        $input.focus().on('click', function(e) {
            e.stopPropagation();
        });
    }

    // Prevent event from bubbling up
    event.stopPropagation();
}
    // Update the handleTabNavigation function
    function handleTabNavigation(event) {
        if (event.key === 'Tab' || event.key === 'Enter') {
            event.preventDefault();
            var currentCell = $(event.target);
            var currentRow = currentCell.closest('tr');
            var nextCell;

            if (currentCell.hasClass('partNumInput')) {
                nextCell = currentRow.find('.descriptionInput');
            } else if (currentCell.hasClass('descriptionInput')) {
                nextCell = currentRow.find('.factorCodeInput');
            } else if (currentCell.hasClass('factorCodeInput')) {
                nextCell = currentRow.find('.quantity input');
            } else if (currentCell.hasClass('quantity')) {
                nextCell = currentRow.find('.costInput');
            } else if (currentCell.hasClass('costInput')) {
                nextCell = currentRow.find('.laborHoursInput');
            } else if (currentCell.hasClass('laborHoursInput')) {
                var nextRow = currentRow.next('tr');
                if (nextRow.length) {
                    nextCell = nextRow.find('.partNumInput');
                } else {
                    // If it's the last row, add a new row and focus on its part number input
                    var wrapperId = currentRow.closest('.content-wrapper').attr('id');
                    addBlankLineItem(wrapperId);
                    nextCell = currentRow.next('tr').find('.partNumInput');
                }
            }

            if (nextCell && nextCell.length) {
                nextCell.focus().select();
            }
        }
    }
    // Make sure to attach this event handler to all input fields
    $('.content-wrapper').on('keydown', 'input', handleTabNavigation);


    $('.content-wrapper').on('blur', '.description input', function() {
        var text = $(this).val();
        $(this).parent().text(text);
    });


    function handlePartNumberSelection(input, item) {
        var tr = input.closest('tr');

        // Set values safely
        tr.find('.partNumInput').val(item.value || '').data('inventoryDescription', item.desc || '');
        tr.find('.descriptionInput').val(item.desc ? decodeURIComponent(item.desc) : '');
        tr.find('.costInput').val(item.cost ? item.cost.toFixed(2) : '0.00');
        tr.find('.factorCodeInput').val(item.factorCode || '');

        // Set default quantity to 1 if empty
        if (!tr.find('.quantity input').val()) {
            tr.find('.quantity input').val(1);
        }

        fetchFactorCodeAndLaborHoursForPart(item.value, tr)
            .then(() => {
                return fetchFactorCodeItems(item.factorCode);
            })
            .then(() => {
                var contentWrapper = tr.closest('.content-wrapper, .modal-content');
                var category = contentWrapper.data('category') || contentWrapper.attr('id').replace('Wrapper', '').toLowerCase();

                updateOtherMaterials(category);
                // Call updateLineAndTotalCosts here after all data is fetched and set
                updateLineAndTotalCosts(tr.find('.costInput')[0]);
            })
            .catch(error => {
                console.error('Error updating after part selection:', error);
            });

        highlightAndSelectInput(tr.find('.descriptionInput'));
    }


    // Add a function to highlight and select the content of input fields
    function highlightAndSelectInput(input) {
        // Consider this:
        $('input').on('focus', function() {
            if (!$(this).data('highlighted')) {
                $(this).data('highlighted', true);
                highlightAndSelectInput($(this));
                setTimeout(() => $(this).data('highlighted', false), 100);
            }
        });
    }
    function makeDescriptionEditable(descriptionCell) {
        if (!descriptionCell.find('input').length) {
            var text = descriptionCell.text().trim();
            var input = $('<input type="text">').val(text);
            descriptionCell.html(input);
            
            input.focus();

            input.on('blur', function() {
                var newText = $(this).val();
                if (newText.trim() === '') {
                    descriptionCell.html('<span class="placeholder">Click to edit description</span>');
                } else {
                    descriptionCell.text(newText);
                }
            }).on('keydown', function(e) {
                if (e.key === 'Enter') {
                    $(this).blur();
                }
            });
        }
    }


    function attachAutocompleteToPartNumber(input) {
        // Destroy any existing autocomplete to prevent duplicates
        if (input.autocomplete("instance")) {
            input.autocomplete("destroy");
        }

        input.autocomplete({
            minLength: 2,
            appendTo: input.closest('.tabcontent, .modal-content'),
            source: function(request, response) {
                var searchTerm = request.term.toLowerCase();
                var isClick = this.element.data('isClick') || false;
                
                if (isClick && searchTerm.length >= 4) {
                    searchTerm = searchTerm.substring(0, 4);
                }

                $.ajax({
                    url: "/inventory/search",
                    data: { query: searchTerm },
                    success: function(data) {
                        var exactConversionCodeMatch = data.inventory.find(item => 
                            item.conversion_codes && item.conversion_codes.some(code => 
                                code.toLowerCase() === searchTerm
                            )
                        );

                        var results;
                        if (exactConversionCodeMatch) {
                            results = data.inventory.filter(item => 
                                item.conversion_codes && item.conversion_codes.some(code => 
                                    code.toLowerCase() === searchTerm
                                )
                            );
                        } else {
                            results = data.inventory.filter(function(item) {
                                if (isClick) {
                                    return item.part_number.toLowerCase().startsWith(searchTerm);
                                } else {
                                    return item.part_number.toLowerCase().includes(searchTerm) ||
                                        item.description.toLowerCase().includes(searchTerm);
                                }
                            });
                        }

                        // Store exact match if found
                        var exactMatch = results.find(item => 
                            item.part_number.toLowerCase() === searchTerm
                        );
                        input.data('exactMatch', exactMatch);

                        // If there's an exact match and user pressed Enter, select it immediately
                        if (exactMatch && input.data('enterPressed')) {
                            input.data('enterPressed', false);
                            handlePartNumberSelection(input, {
                                value: exactMatch.part_number,
                                desc: exactMatch.description,
                                cost: exactMatch.cost,
                                factorCode: exactMatch.factor_code
                            });
                            response([]); // Clear dropdown
                            return;
                        }

                        response($.map(results, function(item) {
                            return {
                                label: `${item.part_number} - ${item.description}`,
                                value: item.part_number,
                                desc: item.description,
                                cost: item.cost,
                                factorCode: item.factor_code
                            };
                        }));
                    },
                    error: function() {
                        input.data('exactMatch', null);
                        response([]);
                    }
                });
                this.element.data('isClick', false);
            },
            select: function(event, ui) {
                handlePartNumberSelection($(this), ui.item);
                return false;
            },
            focus: function(event, ui) {
                event.preventDefault();
                $(this).val(ui.item.value);
            },
            create: function() {
                $(this).data('ui-autocomplete')._renderItem = function(ul, item) {
                    const cost = typeof item.cost === 'number' ? item.cost.toFixed(2) : '0.00';
                    return $("<li>")
                        .append(`<div class='part-number-item'>
                                    <div class='item-details'>${item.value} - ${item.desc}</div>
                                    <div class='item-price'>$${cost}</div>
                                </div>`)
                        .appendTo(ul);
                };
            }
        });

        // Add keydown handler to capture Enter key
        input.on('keydown', function(event) {
            if (event.key === 'Enter') {
                $(this).data('enterPressed', true);
                // Trigger a new search with current value
                $(this).autocomplete('search', $(this).val());
            }
        });

        input.off('click').on('click', function() {
            if ($(this).val().length >= 4) {
                $(this).data('isClick', true);
                $(this).autocomplete("search", $(this).val());
            }
        });
    }

    function attachAutocompleteToDescription(input) {
        // Destroy any existing autocomplete to prevent duplicates
        if (input.autocomplete("instance")) {
            input.autocomplete("destroy");
        }

        input.autocomplete({
            minLength: 2,
            appendTo: input.closest('.tabcontent, .modal-content'),
            source: function(request, response) {
                var searchTerm = request.term.toLowerCase();
                var isClick = this.element.data('isClick') || false;
                
                if (isClick && searchTerm.length >= 4) {
                    searchTerm = searchTerm.substring(0, 4);
                }

                $.ajax({
                    url: "/inventory/search",
                    data: { query: searchTerm },
                    success: function(data) {
                        var results = data.inventory.filter(function(item) {
                            if (isClick) {
                                return item.description.toLowerCase().startsWith(searchTerm);
                            } else {
                                return item.description.toLowerCase().includes(searchTerm) ||
                                    item.part_number.toLowerCase().includes(searchTerm);
                            }
                        });

                        response($.map(results, function(item) {
                            return {
                                label: `${item.description} (${item.part_number})`,
                                value: item.description,
                                part_number: item.part_number,
                                cost: item.cost,
                                factorCode: item.factor_code
                            };
                        }));
                    },
                    error: function() {
                        response([]);
                    }
                });
                this.element.data('isClick', false);
            },
            select: function(event, ui) {
                handleDescriptionSelection($(this), ui.item);
                return false;
            },
            focus: function(event, ui) {
                event.preventDefault();
                $(this).val(ui.item.value);
            },
            create: function() {
                $(this).data('ui-autocomplete')._renderItem = function(ul, item) {
                    const cost = typeof item.cost === 'number' ? item.cost.toFixed(2) : '0.00';
                    return $("<li>")
                        .append(`<div class='description-item'>
                                    <div class='item-details'>${item.value} (${item.part_number})</div>
                                    <div class='item-price'>$${cost}</div>
                                </div>`)
                        .appendTo(ul);
                };
            }
        });

        // Removed the custom Enter key handling as well for descriptions.
        // This allows the default jQuery UI autocomplete behavior:
        // Up/Down to navigate and Enter to select.

        input.off('click').on('click', function() {
            if ($(this).val().length >= 4) {
                $(this).data('isClick', true);
                $(this).autocomplete("search", $(this).val());
            }
        });
    }


    function handleDescriptionSelection(input, item) {
        var tr = input.closest('tr');

        // Set values safely
        tr.find('.partNumInput').val(item.part_number || '');
        tr.find('.descriptionInput').val(item.value || '').data('inventoryDescription', item.value || '');
        tr.find('.costInput').val(item.cost ? item.cost.toFixed(2) : '0.00');
        tr.find('.factorCodeInput').val(item.factorCode || '');

        // Set default quantity to 1 if empty
        if (!tr.find('.quantity input').val()) {
            tr.find('.quantity input').val(1);
        }

        fetchFactorCodeAndLaborHoursForPart(item.part_number, tr)
            .then(() => {
                return fetchFactorCodeItems(item.factorCode);
            })
            .then(() => {
                var contentWrapper = tr.closest('.content-wrapper, .modal-content');
                var category = contentWrapper.data('category') || contentWrapper.attr('id').replace('Wrapper', '').toLowerCase();

                updateOtherMaterials(category);
                // Call updateLineAndTotalCosts here after all data is fetched and set
                updateLineAndTotalCosts(tr.find('.costInput')[0]);
            })
            .catch(error => {
                console.error('Error updating after description selection:', error);
            });

        highlightAndSelectInput(tr.find('.quantity input'));
    }


    function attachFactorAutocomplete(selector) {
        selector.autocomplete({
            minLength: 2,
            appendTo: selector.closest('.tabcontent, .modal-content'),
            source: function(request, response) {
                var searchTerm = request.term;
                var isClick = this.element.data('isClick') || false;
                
                if (isClick && searchTerm.length >= 3) {
                    searchTerm = searchTerm.substring(0, 3);
                }

                $.ajax({
                    url: "/autocomplete-factor-codes",
                    data: { query: searchTerm },
                    success: function(data) {
                        var results = data.factor_codes.filter(function(item) {
                            if (isClick) {
                                return item.factor_code.toLowerCase().startsWith(searchTerm.toLowerCase());
                            } else {
                                return item.factor_code.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    item.description.toLowerCase().includes(searchTerm.toLowerCase());
                            }
                        });
                        response($.map(results, function(item) {
                            return {
                                label: `${item.factor_code} - ${item.description}`,
                                value: item.factor_code,
                                description: item.description,
                                labor_hours: item.labor_hours
                            };
                        }));
                    },
                    error: function() {
                        response([]);
                    }
                });
                this.element.data('isClick', false);
            },
            select: function(event, ui) {
                handleFactorCodeSelection($(this), ui.item);
                return false;
            },
            focus: function(event, ui) {
                event.preventDefault();
                $(this).val(ui.item.value);
            },
            create: function() {
                $(this).data('ui-autocomplete')._renderItem = function(ul, item) {
                    return $("<li>")
                        .append(`<div class='factor-code-item'>
                                    <div class='item-details'>${item.value} - ${item.description}</div>
                                    <div class='item-labor-hours'>${item.labor_hours} hours</div>
                                </div>`)
                        .appendTo(ul);
                };
            }
        });

        // Removed custom Enter key handling here as well.

        selector.on('click', function() {
            if ($(this).val().length >= 3) {
                $(this).data('isClick', true);
                $(this).autocomplete("search", $(this).val());
            }
        });
    }


    function handleFactorCodeSelection(input, item) {
        const tr = input.closest('tr');
        input.val(item.value);
        tr.find('.factorCode').text(item.description);
        
        const quantity = parseFloat(tr.find('.quantity input').val()) || 0;
        
        // Update only this row
        updateLaborHoursFromFactorCode(tr, item.value, quantity);
        updateLineExtCost(tr, item.value, quantity);
        
        // Update totals
        var contentWrapper = tr.closest('.content-wrapper, .modal-content, .sub-bid-wrapper');
        updateTotalCost(contentWrapper);
        updateBudgetTotals();
        
        // Only fetch factor code items for this specific row
        fetchFactorCodeItems(item.value)
            .then(() => {
                var subBidId = getSubBidId(input);
                var category = subBidId ? `subbid-${subBidId}` : contentWrapper.attr('id').replace('Wrapper', '');
                updateOtherMaterialsForRow(tr, item.value, quantity);
            });
    }

    // New function to update other materials for a single row
    function updateOtherMaterialsForRow(tr, factorCode, quantity) {
        const otherMaterialsCost = calculateOtherMaterialsCost(factorCode, Math.abs(quantity));
        tr.find('.otherMaterials').text(`$${otherMaterialsCost.toFixed(2)}`);
    }

    function saveAndCloseSubBid(category) {
        console.log(`Saving and closing sub-bid for category: ${category}`);
        var modalId = category + 'SubBidModal';
        var modal = document.getElementById(modalId);
        if (!modal) {
            console.error('Modal not found:', modalId);
            return;
        }

        var subBidContent = document.getElementById(category + 'SubBidContent');
        if (subBidContent && subBidContent.firstElementChild) {
            var subBidId = subBidContent.firstElementChild.id.replace('subBid_', '');
            saveSubBidItems(subBidId, category)
                .then(() => {
                    modal.style.display = "none";
                    populateSubBidsList(category);
                    console.log(`Sub-bid saved and modal closed for category: ${category}`);
                })
                .catch((error) => {
                    console.error('Failed to save sub-bid items:', error);
                    alert('There was an error saving the sub-bid. Please try again.');
                });
        } else {
            console.log('No sub-bid content found in modal:', modalId);
            modal.style.display = "none";
            populateSubBidsList(category);
        }
    }


    function openSubBidModal(category) {
        console.log(`Opening sub-bid modal for category: ${category}`);
        populateSubBidsList(category);
        var modalId = category + 'SubBidModal';
        console.log(`Attempting to open modal with ID: ${modalId}`);
        openModal(modalId);
        var createSubBidElement = document.getElementById('createSubBid' + capitalizeFirstLetter(category));
        if (createSubBidElement) {
            createSubBidElement.style.display = 'block';
            console.log(`Create sub-bid element displayed for ${category}`);
        } else {
            console.error(`Create sub-bid element not found for ${category}`);
        }
        var subBidContentElement = document.getElementById(category + 'SubBidContent');
        if (subBidContentElement) {
            subBidContentElement.innerHTML = ''; // Clear any existing sub-bid content
            console.log(`Cleared sub-bid content for ${category}`);
        } else {
            console.error(`Sub-bid content element not found for ${category}`);
        }
    }

    function getCurrentBidId() {
        return document.body.getAttribute('data-bid-id');
    }    

    function populateSubBidsList(category) {
        var bidId = document.getElementById('bidId').value;
        console.log(`Populating sub bids list for category: ${category}, bid ID: ${bidId}`);

        fetch(`/api/subbids/${bidId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Received sub bids data:', data);
            
            if (!Array.isArray(data)) {
                console.error('Unexpected data format:', data);
                throw new Error('Server returned unexpected data format');
            }
            
            var filteredSubBids = data.filter(subBid => subBid.category === category);
            console.log(`Filtered sub bids for category ${category}:`, filteredSubBids);

            var subBidsListElement = document.getElementById(category + 'SubBidsList');
            if (!subBidsListElement) {
                console.error(`Element not found: ${category}SubBidsList`);
                return;
            }

            subBidsListElement.innerHTML = '<h3>Existing Sub Bids</h3>';
            
            if (filteredSubBids.length === 0) {
                subBidsListElement.innerHTML += '<p>No sub bids found for this category.</p>';
            } else {
                filteredSubBids.forEach(function(subBid) {
                    var subBidElement = document.createElement('div');
                    subBidElement.className = 'sub-bid-entry';
                    subBidElement.innerHTML = `
                        <div class="sub-bid-info">
                            ${subBid.name} - Total Cost: $${subBid.total_cost.toFixed(2)}, Labor Hours: ${subBid.labor_hours.toFixed(2)}
                        </div>
                        <div class="sub-bid-buttons">
                            <button onclick="editSubBid(${subBid.id}, '${category}')">Edit</button>
                            <button class="removeSubBidBtn" onclick="removeSubBid(${subBid.id}, '${category}')">Remove</button>
                            <button class="addToMainBtn" onclick="addSubBidToMain(${subBid.id}, '${category}')">Add to Main</button>
                            <button class="generateSubBidReportBtn" onclick="generateSubBidReport(${subBid.id}, '${category}')">Generate Report</button>
                        </div>
                    `;
                    subBidsListElement.appendChild(subBidElement);
                });
            }

            var createSubBidElement = document.getElementById('createSubBid' + capitalizeFirstLetter(category));
            if (createSubBidElement) {
                createSubBidElement.style.display = 'block';
            } else {
                console.error(`Element not found: createSubBid${capitalizeFirstLetter(category)}`);
            }
        })
        .catch(error => {
            console.error('Error fetching sub-bids:', error);
            var subBidsListElement = document.getElementById(category + 'SubBidsList');
            if (subBidsListElement) {
                subBidsListElement.innerHTML = '<h3>Existing Sub Bids</h3><p>Error loading sub bids. Please try again.</p>';
            }
            var createSubBidElement = document.getElementById('createSubBid' + capitalizeFirstLetter(category));
            if (createSubBidElement) {
                createSubBidElement.style.display = 'block';
            }
        });
    }
    
    async function generateSubBidReport(subBidId, category) {
        try {
            // Fetch the sub-bid details to get the name
            const response = await fetch(`/api/subbids/${subBidId}`);
            if (!response.ok) {
                throw new Error('Failed to fetch sub-bid details');
            }
            const subBid = await response.json();

            // Create a new PDF document
            const { jsPDF } = window.jspdf;
            let doc = new jsPDF();

            // Generate the title for the sub-bid report
            // We're keeping the title text the same, the position adjustment is handled in generateReport
            const title = `${category.charAt(0).toUpperCase() + category.slice(1)} - Sub-Bid: ${subBid.name}`;

            // Use the existing generateReport function with the sub-bid ID
            await generateReport(category, doc, title, subBidId);

            // Save the PDF with the sub-bid name
            doc.save(`SubBid_${subBid.name}_Report.pdf`);

        } catch (error) {
            console.error('Error generating sub-bid report:', error);
            alert('Error generating report. Please try again.');
        }
    }

    function addRowToWrapper(wrapper, item) {
        // Create a new row
        const row = document.createElement('tr');

        // Map the item data to the table columns
        row.innerHTML = `
            <td>${item.id}</td>
            <td>${item.part_number}</td>
            <td>${decodeURIComponent(item.description)}</td>
            <td>${item.factor_code}</td>
            <td>${item.quantity}</td>
            <td>${item.cost.toFixed(2)}</td>
            <td>${item.labor_hours.toFixed(4)}</td>
            <td>${calculateOtherMaterials(item)}</td>
            <td>${item.line_ext_cost.toFixed(2)}</td>
            <td>
                <button onclick="removeItem(${item.id})">Remove</button>
                <button onclick="editItem(${item.id})">Edit</button>
            </td>
        `;

        // Append the row to the table wrapper
        wrapper.appendChild(row);
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        `;
        document.body.insertBefore(alertDiv, document.body.firstChild);
        setTimeout(() => alertDiv.remove(), 5000);
    }
    

    function createRowFromItem(item, category) {
        const row = document.createElement('tr');
        const isSubcontractor = category.toLowerCase() === 'subcontractor';
        const isSubBidHeader = item.part_number === 'SUB-BID';

        // Decode the description
        const decodedDescription = decodeURIComponent(item.description || '');

        row.innerHTML = `
            <td class="lineNumber"></td>
            <td class="partNumber"><input type="text" class="partNumInput" value="${item.part_number || ''}" autocomplete="off" ${isSubBidHeader ? 'readonly' : ''}></td>
            <td><input type="text" class="descriptionInput" value="${decodedDescription}" autocomplete="off" ${isSubBidHeader ? 'readonly' : ''}></td>
            ${!isSubcontractor ? `<td><input type="text" class="factorCodeInput" value="${item.factor_code || ''}" autocomplete="off" ${isSubBidHeader ? 'readonly' : ''}></td>` : ''}
            <td class="quantity"><input type="text" class="quantity" value="${item.quantity || 0}" oninput="updateLineAndTotalCosts(this)" ${isSubBidHeader ? 'readonly' : ''}></td>
            <td><input type="text" class="costInput" value="${(item.cost || 0).toFixed(2)}" oninput="updateLineAndTotalCosts(this)" ${isSubBidHeader ? 'readonly' : ''}></td>
            ${!isSubcontractor ? `
                <td><input type="text" class="laborHoursInput" value="${(item.labor_hours || 0).toFixed(4)}" oninput="updateLineAndTotalCosts(this)" ${isSubBidHeader ? 'readonly' : ''}></td>
                <td class="otherMaterials">$${(item.other_materials_cost || 0).toFixed(2)}</td>
            ` : ''}
            <td class="total">$${(item.line_ext_cost || 0).toFixed(2)}</td>
            <td class="action"><button class="removeBtn">Remove</button></td>
        `;

        if (isSubBidHeader) {
            row.classList.add('sub-bid-header');
        }

        initializeRow($(row));
        return row;
    }

    function closeModal(modalId) {
        var modal = document.getElementById(modalId);
        if (!modal) {
            console.error('Modal not found:', modalId);
            return;
        }
        if (modalId.includes('SubBidModal')) {
            var category = modalId.replace('SubBidModal', '');
            var subBidContent = document.getElementById(category + 'SubBidContent');
            if (subBidContent && subBidContent.firstElementChild) {
                var subBidId = subBidContent.firstElementChild.id.replace('subBid_', '');
                saveSubBidItems(subBidId, category)
                    .then(() => {
                        modal.style.display = "none";
                        populateSubBidsList(category);
                    })
                    .catch((error) => {
                        console.error('Failed to save sub-bid items:', error);
                        if (confirm('There was an error saving the sub-bid. Do you want to close without saving?')) {
                            modal.style.display = "none";
                            populateSubBidsList(category);
                        }
                    });
            } else {
                console.log('No sub-bid content found in modal:', modalId);
                modal.style.display = "none";
                populateSubBidsList(category);
            }
        } else {
            modal.style.display = "none";
        }
    }

    function addSubBidToMain(subBidId, category) {
        if (!currentBidId) {
            console.error('Current bid ID not found');
            showAlert('Error: Current bid ID not found', 'danger');
            return;
        }

        fetch('/add-sub-bid-to-main', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                bid_id: currentBidId,
                sub_bid_id: subBidId,
                category: category
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.message || 'An error occurred');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const wrapper = document.getElementById(`${category}Wrapper`);
                if (!wrapper) {
                    throw new Error(`Wrapper not found for category: ${category}`);
                }
                const tableBody = wrapper.querySelector('.itemsTable tbody');
                if (!tableBody) {
                    throw new Error(`Table body not found in wrapper for category: ${category}`);
                }

                let subBidTotalCost = 0;

                // Add all items, including the sub-bid header
                data.added_items.forEach(item => {
                    if (item.part_number === 'SUB-BID') {
                        // Ensure the sub-bid header has the correct values
                        item.factor_code = '999';
                        item.quantity = 1;
                        item.cost = 0;  // Set cost to 0 for the header row
                        item.labor_hours = 0;
                        subBidTotalCost = parseFloat(item.line_ext_cost) || 0;  // Store the actual total cost
                        item.line_ext_cost = 0;  // Set line_ext_cost to 0 for display purposes
                    } else {
                        // For non-header items, add their cost to the total
                        subBidTotalCost += parseFloat(item.line_ext_cost) || 0;
                    }
                    const newRow = createRowFromItem(item, category);
                    tableBody.appendChild(newRow);
                });

                // Recalculate line numbers, other materials, and labor costs
                recalculateLineNumbers(wrapper);
                recalculateOtherMaterialsAndLaborCosts(wrapper);

                // Remove the sub-bid from the database
                return fetch(`/api/subbids/${subBidId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                        'Content-Type': 'application/json'
                    }
                });
            } else {
                throw new Error('Failed to add sub-bid: ' + data.message);
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete sub-bid');
            }
            // Remove the sub-bid from the sub-bids list in the UI
            const subBidElement = document.querySelector(`[data-subbid-id="${subBidId}"]`);
            if (subBidElement) {
                subBidElement.remove();
            }

            // Close the modal
            closeModal(`${category}SubBidModal`);

            // Update totals
            const wrapper = document.getElementById(`${category}Wrapper`);
            updateTotalCost($(wrapper));
            updateBudgetTotals();

            // Show success message
            showAlert('Sub-bid added to main bid and removed successfully', 'success');
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('An error occurred while adding the sub-bid: ' + error.message, 'danger');
        });
    }


    function addNewSubBid(category) {
        var subBids = JSON.parse(localStorage.getItem('subBids')) || [];
        var subBidName = prompt("Enter Sub Bid Name:");
        if (!subBidName) return;

        var newSubBid = {
            id: Date.now().toString(),
            category: category,
            name: subBidName,
            totalCost: 0,
            laborHours: 0,
            items: []
        };

        subBids.push(newSubBid);
        localStorage.setItem('subBids', JSON.stringify(subBids));
        populateSubBidsList(category);
    }

    function updateSubBidOtherMaterials(subBidId, category) {
        fetch(`/api/subbids/${subBidId}/other-materials`)
            .then(response => response.json())
            .then(otherMaterials => {
                let totalOtherMaterialsCost = 0;
                let otherMaterialsTableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>Part Number</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Cost</th>
                                <th>Total Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                otherMaterials.forEach(item => {
                    const itemTotalCost = item.quantity * item.cost;
                    totalOtherMaterialsCost += itemTotalCost;
                    otherMaterialsTableHtml += `
                        <tr>
                            <td>${item.part_number}</td>
                            <td>${item.description}</td>
                            <td>${item.quantity.toFixed(2)}</td>
                            <td>$${item.cost.toFixed(2)}</td>
                            <td>$${itemTotalCost.toFixed(2)}</td>
                        </tr>
                    `;
                });

                otherMaterialsTableHtml += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4">Total Other Material Cost:</td>
                                <td>$${totalOtherMaterialsCost.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                `;

                // Update the Other Materials table in the modal
                $(`#${category}SubBidModal .modal-content`).append(`
                    <div id="${subBidId}OtherMaterialsTable">
                        <h4>Other Materials</h4>
                        ${otherMaterialsTableHtml}
                    </div>
                `);

                // Update the main table's Other Materials cell for each row
                $(`#${subBidId} .itemsTable tbody tr`).each(function() {
                    const factorCode = $(this).find('.factorCodeInput').val();
                    const quantity = parseFloat($(this).find('.quantity input').val()) || 0;
                    const rowOtherMaterialsCost = calculateRowOtherMaterialsCost(otherMaterials, factorCode, quantity);
                    $(this).find('.otherMaterials').text(`$${rowOtherMaterialsCost.toFixed(2)}`);
                });

                // Update totals
                updateTotalCost($(`#${subBidId}`));
            })
            .catch(error => console.error('Error updating sub-bid other materials:', error));
    }    

    function addSubBidItem(subBidId, category) {
        var subBids = JSON.parse(localStorage.getItem('subBids')) || [];
        var subBid = subBids.find(subBid => subBid.id === subBidId);

        if (!subBid) {
            alert("Sub Bid not found");
            return;
        }

        subBid.items.push({
            name: '',
            cost: 0,
            laborHours: 0
        });

        localStorage.setItem('subBids', JSON.stringify(subBids));
        editSubBid(subBidId, category);
    }

    function removeSubBid(subBidId, category) {
        const csrfToken = getCsrfToken();
        if (!csrfToken) {
            console.error('CSRF token is missing');
            alert('Error: CSRF token is missing. Please refresh the page and try again.');
            return;
        }

        fetch(`/api/subbids/${subBidId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Success:', data);
            populateSubBidsList(category);
        })
        .catch((error) => {
            console.error('Error:', error);
            alert(`Error removing sub-bid: ${error.message}\nPlease try again or contact support if the problem persists.`);
        });
    }

    function removeSubBidItem(subBidId, itemIndex, category) {
        const csrfToken = getCsrfToken();
        if (!csrfToken) {
            console.error('CSRF token is missing');
            alert('Error: CSRF token is missing. Please refresh the page and try again.');
            return;
        }

        fetch(`/api/subbids/${subBidId}/items/${itemIndex}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Item removed successfully:', data);
            // Refresh the sub-bid edit view
            editSubBid(subBidId, category);
        })
        .catch(error => {
            console.error('Error removing sub-bid item:', error);
            let errorMessage = 'An unexpected error occurred while removing the sub-bid item.';
            if (error.message.includes('HTTP error!')) {
                errorMessage = `Server error: ${error.message}`;
            }
            alert(`Error removing sub-bid item: ${errorMessage}\nPlease try again or contact support if the problem persists.`);
        });
    }

    function saveSubBidItems(subBidId, category) {
        console.log(`Saving sub-bid items for subBidId: ${subBidId}, category: ${category}`);

        var subBidElement = document.getElementById(`subBid_${subBidId}`);
        if (!subBidElement) {
            console.error(`Element not found: subBid_${subBidId}`);
            return Promise.reject(`Sub-bid element not found: subBid_${subBidId}`);
        }

        var items = [];
        subBidElement.querySelectorAll('.itemsTable tbody tr:not(.additional-description-row)').forEach((row, index) => {
            var quantity = parseFloat(row.querySelector('.quantity input')?.value) || 0;
            var cost = parseFloat(row.querySelector('.costInput')?.value) || 0;
            
            // Get additional description from both data attribute and next row
            var $row = $(row);
            var additionalDescription = '';
            
            if ($row.data('additionalDescription')) {
                additionalDescription = $row.data('additionalDescription');
            } else {
                var nextRow = $row.next('.additional-description-row');
                if (nextRow.length) {
                    additionalDescription = nextRow.find('.additionalDescriptionInput').val() || '';
                }
            }

            var item = {
                part_number: row.querySelector('.partNumInput')?.value || '',
                description: encodeURIComponent(row.querySelector('.descriptionInput')?.value || ''),
                factor_code: row.querySelector('.factorCodeInput')?.value || '',
                quantity: quantity,
                cost: cost,
                labor_hours: parseFloat(row.querySelector('.laborHoursInput')?.value) || 0,
                additional_description: encodeURIComponent(additionalDescription),
                line_ext_cost: quantity * cost,
                other_materials_cost: parseFloat(row.querySelector('.otherMaterials')?.textContent?.replace('$', '')) || 0
            };

            console.log(`Saving item ${index + 1} with additional description:`, {
                ...item,
                additional_description: decodeURIComponent(item.additional_description)
            });
            items.push(item);
        });

        var totalCost = items.reduce((total, item) => total + item.line_ext_cost, 0);
        var totalLaborHours = items.reduce((total, item) => total + item.labor_hours * item.quantity, 0);

        var subBidData = {
            bid_id: document.getElementById('bidId')?.value,
            sub_bid_id: subBidId,
            name: subBidElement.querySelector('h3')?.textContent || `Sub-bid ${subBidId}`,
            category: category,
            total_cost: totalCost,
            labor_hours: totalLaborHours,
            items: items
        };

        return fetch('/save-sub-bid', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(subBidData),
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Sub-bid saved successfully:', data);
            return fetch(`/api/subbids/${subBidId}`)
                .then(response => response.json())
                .then(refreshedData => {
                    updateSubBidUI(subBidId, refreshedData, category);
                    return refreshedData;
                });
        })
        .catch(error => {
            console.error('Error saving sub-bid:', error);
            throw error;
        });
    }

    function initializeRow(row) {
        if (!row || !row.length) {
            console.warn('Invalid row passed to initializeRow');
            return;
        }

        try {
            // Attach input events
            row.find('.quantity input, .costInput, .laborHoursInput').on('input', function() {
                updateLineAndTotalCosts(this);
            });

            row.find('.partNumInput, .descriptionInput').on('change', function() {
                var partNumber = row.find('.partNumInput').val();
                fetchFactorCodeAndLaborHoursForPart(partNumber, row);
            });

            // Single click handler
            row.find('input').on('click', function(e) {
                if (!$(this).data('doubleClicked')) {
                    e.preventDefault();
                    $(this).prop('readonly', false);
                    $(this).focus();
                    $(this).select();
                }
            });

            // Double click handler
            row.find('input').on('dblclick', function(e) {
                $(this).data('doubleClicked', true);
                $(this).prop('readonly', false);
                if (window.getSelection) {
                    window.getSelection().removeAllRanges();
                }
                setTimeout(() => {
                    $(this).data('doubleClicked', false);
                }, 500);
            });

            // Handle blur event
            row.find('input').on('blur', function() {
                if (!$(this).is(':focus')) {
                    $(this).prop('readonly', false);
                }
            });

            // Initialize part number and factor code autocomplete
            attachAutocompleteToPartNumber(row.find('.partNumInput'));
            attachAutocompleteToDescription(row.find('.descriptionInput'));
            attachFactorAutocomplete(row.find('.factorCodeInput'));

        } catch (error) {
            console.error('Error initializing row:', error);
        }
    }

    function initializeExistingRows(container) {
    if (!container || !container.length) {
        console.warn('Invalid container passed to initializeExistingRows');
        return;
    }

    try {
        // First remove any existing click handlers to prevent duplicates
        container.find('.itemsTable tbody tr:not(.additional-description-row)').off('click');

        // Then reattach handlers to each row
        container.find('.itemsTable tbody tr:not(.additional-description-row)').each(function() {
            const $row = $(this);
            
            // Initialize basic row functionality
            initializeRow($row);
            
            // Attach the click handler for additional description
            $row.on('click', function(e) {
                // Only handle click if not clicking an input or button
                if (!$(e.target).is('input, button, .removeBtn')) {
                    handleRowClick.call(this, e);
                }
            });

            // Update calculations
            const quantityInput = $row.find('.quantity input')[0];
            if (quantityInput) {
                updateLineAndTotalCosts(quantityInput);
            }

            // Restore additional description from data attribute if it exists
            const savedDesc = $row.data('additionalDescription');
            if (savedDesc) {
                console.log('Found saved description:', savedDesc);
                $row.data('additionalDescription', savedDesc);
            }
        });
    } catch (error) {
        console.error('Error initializing existing rows:', error);
    }
}
function editSubBid(subBidId, category) {
    $('#loadingOverlay').show();

    fetch(`/api/subbids/${subBidId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(subBid => {
            if (subBid.error) {
                throw new Error(subBid.error);
            }

            var subBidContentElement = document.getElementById(category + 'SubBidContent');
            if (!subBidContentElement) {
                throw new Error(`Sub-bid content element not found for category: ${category}`);
            }

            // Build the table HTML as before
            let tableHTML = `
                <div id="subBid_${subBidId}" data-category="${category}" class="content-wrapper sub-bid-wrapper">
                    <h3>${subBid.name}</h3>
                    <div class="action-buttons">
                        <button class="addBtn" onclick="addBlankLineItem('subBid_${subBidId}')">Add Line Item</button>
                        <button class="insertBtn" onclick="insertBlankLineItem('subBid_${subBidId}')">Insert Line Item</button>
                        <button class="otherMaterialsBtn" onclick="showOtherMaterials('subbid-${subBidId}')">Other Materials</button>
                    </div>
                    <table class="itemsTable">
                        <thead>
                            <tr>
                                <th class="lineNumber">Line Number</th>
                                <th class="partNumber">Part Number</th>
                                <th class="description">Description</th>
                                <th class="factorCode">Factor Code</th>
                                <th class="quantity">Quantity</th>
                                <th class="cost">Bid Price</th>
                                <th class="laborHours">Labor Hours</th>
                                <th class="otherMaterials">Other Materials</th>
                                <th class="total">Total</th>
                                <th class="action">Action</th>
                            </tr>
                        </thead>
                        <tbody>`;

            // Add the items rows as before
            if (subBid.items && Array.isArray(subBid.items)) {
                subBid.items.forEach((item, index) => {
                    // Item row HTML code as before
                    const quantity = parseFloat(item.quantity) || 0;
                    const cost = parseFloat(item.cost) || 0;
                    const laborHours = parseFloat(item.labor_hours) || 0;
                    const otherMaterialsCost = parseFloat(item.other_materials_cost) || 0;
                    const laborRate = getLaborRate(category + 'Wrapper');
                    const laborCost = quantity * laborHours * laborRate;
                    const materialCost = quantity * cost;
                    const totalCost = materialCost + laborCost + otherMaterialsCost;

                    // Ensure additional_description is included in the data attributes
                    const additionalDesc = item.additional_description || '';

                    // Main row with data attribute
                    tableHTML += `
                        <tr class="item-row" 
                            data-item-id="${item.id || ''}"
                            data-additional-description="${encodeURIComponent(additionalDesc)}">
                            <td class="lineNumber">${index + 1}</td>
                            <td class="partNumber">
                                <input type="text" value="${item.part_number || ''}" class="partNumInput" autocomplete="off">
                            </td>
                            <td>
                                <input type="text" value="${decodeURIComponent(item.description || '')}" class="descriptionInput" autocomplete="off">
                            </td>
                            <td>
                                <input type="text" value="${item.factor_code || ''}" class="factorCodeInput" autocomplete="off">
                            </td>
                            <td class="quantity">
                                <input type="text" value="${quantity}" class="quantity" oninput="updateLineAndTotalCosts(this)">
                            </td>
                            <td>
                                <input type="text" value="${cost.toFixed(2)}" class="costInput" oninput="updateLineAndTotalCosts(this)">
                            </td>
                            <td>
                                <input type="text" value="${laborHours.toFixed(4)}" class="laborHoursInput" oninput="updateLineAndTotalCosts(this)">
                            </td>
                            <td class="otherMaterials">$${otherMaterialsCost.toFixed(2)}</td>
                            <td class="total">$${totalCost.toFixed(2)}</td>
                            <td class="action">
                                <button class='removeBtn'>Remove</button>
                            </td>
                        </tr>`;
                });
            }

            tableHTML += `
                        </tbody>
                    </table>
                    <div class="total-cost">
                        <h2>Material Cost: <span class="totalMaterialCost">$0.00</span></h2>
                        <h2>Labor Cost: <span class="totalLaborCost">$0.00</span></h2>
                        <h2>Other Materials Cost: <span class="totalOtherMaterialsCost">$0.00</span></h2>
                        <h2>Tax: <span class="totalTax">$0.00</span></h2>
                        <h2>Total Cost: <span class="totalCost">$0.00</span></h2>
                    </div>
                </div>`;

            subBidContentElement.innerHTML = tableHTML;

            // Extract all unique factor codes from the items - NEW CODE
            const factorCodes = new Set();
            if (subBid.items && Array.isArray(subBid.items)) {
                subBid.items.forEach(item => {
                    if (item.factor_code) {
                        factorCodes.add(item.factor_code);
                    }
                });
            }

            // Fetch factor code items for all unique factor codes - NEW CODE
            const fetchPromises = Array.from(factorCodes).map(factorCode => {
                return fetchFactorCodeItems(factorCode);
            });

            // Wait for all factor code items to be fetched before initializing - NEW CODE
            return Promise.all(fetchPromises)
                .then(() => {
                    try {
                        const subBidWrapper = $(`#subBid_${subBidId}`);
                        if (!subBidWrapper.length) {
                            throw new Error('Sub-bid wrapper not found after DOM update');
                        }

                        // Attach event handlers
                        attachEventHandlers(subBidWrapper);

                        // Initialize rows with their descriptions
                        subBidWrapper.find('.itemsTable tbody tr.item-row').each(function() {
                            const $row = $(this);
                            const desc = $row.attr('data-additional-description');
                            if (desc) {
                                $row.data('additionalDescription', decodeURIComponent(desc));
                                console.log('Initialized row with description:', decodeURIComponent(desc));
                            }
                        });

                        // Initialize other features
                        initializeExistingRows(subBidWrapper);
                        
                        // Enable drag and drop
                        enableDragAndDrop(`#subBid_${subBidId} .itemsTable`);
                        
                        // Update totals after everything is initialized
                        updateTotalCost(subBidWrapper);
                        
                        // Update other materials with the initialized cache - NEW CODE
                        showOtherMaterials(`subbid-${subBidId}`, false);

                        console.log('Sub-bid initialized with descriptions and factor code cache');
                    } catch (error) {
                        console.error('Error initializing sub-bid:', error);
                    }
                });
        })
        .catch(error => {
            console.error('Error fetching sub-bid data:', error);
            alert('Error fetching sub-bid data: ' + error.message);
        })
        .finally(() => {
            $('#loadingOverlay').hide();
        });
}
    
    function getCsrfToken() {
        const tokenElement = document.getElementById('csrf_token');
        if (!tokenElement) {
            console.error('CSRF token element not found');
            return null;
        }
        return tokenElement.value;
    }

    // Helper function to capitalize first letter
    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }


    function updateSubBidUI(subBidId, data, category) {
        var subBidElement = document.getElementById(`subBid_${subBidId}`);
        if (!subBidElement) return;

        const safeNumber = (value) => typeof value === 'number' && !isNaN(value) ? value : 0;
        const totalCost = safeNumber(data.total_cost);
        const laborHours = safeNumber(data.labor_hours);

        // Update total costs
        subBidElement.querySelector('.totalMaterialCost').textContent = `$${totalCost.toFixed(2)}`;
        subBidElement.querySelector('.totalLaborCost').textContent = `$${(laborHours * getLaborRate(category)).toFixed(2)}`;

        var overallTotalCost = totalCost + (laborHours * getLaborRate(category));
        subBidElement.querySelector('.totalCost').textContent = `$${overallTotalCost.toFixed(2)}`;

        // Update the sub-bid list if it's visible
        var subBidsList = document.getElementById(category + 'SubBidsList');
        if (subBidsList) {
            var subBidEntry = subBidsList.querySelector(`[data-subbid-id="${subBidId}"]`);
            if (subBidEntry) {
                subBidEntry.querySelector('.sub-bid-total').textContent = `$${overallTotalCost.toFixed(2)}`;
                subBidEntry.querySelector('.sub-bid-labor-hours').textContent = laborHours.toFixed(2);
            }
        }

        // Recalculate and update the total line ext cost
        updateTotalLineExtCost($(subBidElement));

        // Update the overall bid totals
        updateBudgetTotals();
    }
    // Function to open a modal
    function openModal(modalId) {
        var modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = "block";
            initializeModalCloseButtons(); // Reinitialize close buttons when opening a modal
        }
    }

    function closeModal(modalId) {
        var modal = document.getElementById(modalId);
        if (!modal) {
            console.error('Modal not found:', modalId);
            return;
        }

        if (modalId.includes('SubBidModal')) {
            var category = modalId.replace('SubBidModal', '');
            var subBidContent = document.getElementById(category + 'SubBidContent');
            if (subBidContent && subBidContent.firstElementChild) {
                var subBidId = subBidContent.firstElementChild.id.replace('subBid_', '');
                saveSubBidItems(subBidId, category)
                    .then(() => {
                        modal.style.display = "none";
                        populateSubBidsList(category);
                    })
                    .catch((error) => {
                        console.error('Failed to save sub-bid items:', error);
                        if (confirm('There was an error saving the sub-bid. Do you want to close without saving?')) {
                            modal.style.display = "none";
                            populateSubBidsList(category);
                        }
                    });
            } else {
                console.log('No sub-bid content found in modal:', modalId);
                modal.style.display = "none";
                populateSubBidsList(category);
            }
        } else {
            modal.style.display = "none";
        }
    }
    function updateCategoryBudget(elementId, data) {
        document.getElementById(elementId).textContent = `Material: $${data.materialTotal.toFixed(2)} | Labor: $${data.laborTotal.toFixed(2)} | Other Materials: $${data.otherMaterialsTotal.toFixed(2)} | Tax: $${data.taxTotal.toFixed(2)} | Total: $${(data.materialTotal + data.laborTotal + data.otherMaterialsTotal + data.taxTotal).toFixed(2)}`;
    }

    function calculateSubBidTotals() {
        var totalMaterial = 0;
        var totalLabor = 0;
        var totalOtherMaterials = 0;

        $('.modal-content').each(function() {
            var subBidId = $(this).find('.itemsTable').attr('id');
            if (subBidId) {
                var subBidData = calculateCategoryTotal(subBidId, getSubBidLaborRate(subBidId));
                totalMaterial += subBidData.materialTotal;
                totalLabor += subBidData.laborTotal;
                totalOtherMaterials += subBidData.otherMaterialsTotal;
            }
        });

        return {
            materialTotal: totalMaterial,
            laborTotal: totalLabor,
            otherMaterialsTotal: totalOtherMaterials
        };
    }

    // Initialize the heading tab and handle factor data
    function initializeHeadingTab() {
        try {
            // Load any saved customer info
            const customerName = $('#customerName').val();
            if (customerName) {
                loadCustomerData(customerName);
            }

            // Load any saved project info
            const projectName = $('#projectName').val();
            if (projectName) {
                loadProjectData(projectName);
            }

            // Initialize labor rate handlers
            initializeLaborRateListeners();

            // Load default labor rates if needed
            loadDefaultLaborRates();

            // Update budget totals
            updateBudgetTotals();
            
            console.log('Heading tab initialized successfully');
        } catch (error) {
            console.error('Error initializing heading tab:', error);
        }
    }

    // Modify the updateBudgetTotals function to handle missing data
    function updateBudgetTotals(serverTotals) {
        console.log('Starting updateBudgetTotals');
        try {
            const categories = ['Drains', 'Irrigation', 'Landscape', 'Maintenance'];
            let totalMaterialBudget = 0;
            let totalLaborBudget = 0;
            let totalOtherMaterialsBudget = 0;
            let totalTaxBudget = 0;
            let totalSubcontractorBudget = 0;

            categories.forEach(category => {
                try {
                    const wrapper = $(`#${category.toLowerCase()}Wrapper`);
                    if (!wrapper.length) {
                        console.warn(`Wrapper not found for category: ${category}`);
                        return;
                    }

                    const laborRate = getLaborRate(`${category.toLowerCase()}Wrapper`);
                    const taxRate = parseFloat($('#localSalesTax').val()) / 100 || 0;
                    const categoryData = calculateCategoryTotal(`${category.toLowerCase()}Wrapper`, laborRate, taxRate);
                    
                    const budgetItem = $(`#budget${category}`);
                    if (budgetItem.length) {
                        budgetItem.find('.budget-value:eq(0)').text(`$${categoryData.materialTotal.toFixed(2)}`);
                        budgetItem.find('.budget-value:eq(1)').text(`$${categoryData.laborTotal.toFixed(2)}`);
                        budgetItem.find('.budget-value:eq(2)').text(`$${categoryData.otherMaterialsTotal.toFixed(2)}`);
                        budgetItem.find('.budget-value:eq(3)').text(`$${categoryData.taxTotal.toFixed(2)}`);
                        
                        let categoryTotal = categoryData.materialTotal + categoryData.laborTotal + 
                                        categoryData.otherMaterialsTotal + categoryData.taxTotal;

                        if (serverTotals && serverTotals[`${category.toLowerCase()}_total`]) {
                            categoryTotal = parseFloat(serverTotals[`${category.toLowerCase()}_total`]) || 0;
                        }

                        budgetItem.find('.budget-value:eq(4)').text(`$${categoryTotal.toFixed(2)}`);
                    }

                    totalMaterialBudget += categoryData.materialTotal;
                    totalLaborBudget += categoryData.laborTotal;
                    totalOtherMaterialsBudget += categoryData.otherMaterialsTotal;
                    totalTaxBudget += categoryData.taxTotal;

                    const categoryTotalElement = $(`#${category.toLowerCase()}TotalValue`);
                    if (categoryTotalElement.length) {
                        categoryTotalElement.text(`$${(categoryData.materialTotal + categoryData.laborTotal + 
                                                categoryData.otherMaterialsTotal + categoryData.taxTotal).toFixed(2)}`);
                    }
                } catch (categoryError) {
                    console.error(`Error processing category ${category}:`, categoryError);
                }
            });

            // Update grand totals with error handling
            updateGrandTotals({
                materialTotal: totalMaterialBudget,
                laborTotal: totalLaborBudget,
                otherMaterialsTotal: totalOtherMaterialsBudget,
                taxTotal: totalTaxBudget,
                subcontractorTotal: totalSubcontractorBudget
            });

        } catch (error) {
            console.error('Error in updateBudgetTotals:', error);
        }
        console.log('updateBudgetTotals completed');
    }


    // Helper function to update grand totals
    function updateGrandTotals(totals) {
        const elements = {
            materialTotal: $('#materialTotalValue'),
            laborTotal: $('#laborTotalValue'),
            subcontractorTotal: $('#subcontractorTotalValue'),
            otherMaterialsTotal: $('#otherMaterialsTotalValue'),
            taxTotal: $('#taxTotalValue'),
            grandTotal: $('#grandTotalValue')
        };

        // Update each total with error handling
        Object.entries(elements).forEach(([key, element]) => {
            if (element.length) {
                const value = totals[key] || 0;
                element.text(`$${value.toFixed(2)}`);
            }
        });

        // Calculate and update grand total
        const grandTotal = Object.values(totals).reduce((sum, value) => sum + (value || 0), 0);
        if (elements.grandTotal.length) {
            elements.grandTotal.text(`$${grandTotal.toFixed(2)}`);
        }
    }

    function attachAutocomplete(selector, inventory) {
        selector.autocomplete({
            minLength: 1,
            source: inventory.map(item => ({
                label: `${item.part_number} - ${item.description}`,
                value: item.part_number
            })),
            select: function(event, ui) {
                const selectedInventory = inventory.find(item => item.part_number === ui.item.value);
                if (selectedInventory) {
                    $(this).closest('tr').find('.description').text(selectedInventory.description);
                    $(this).closest('tr').find('.cost').text(`$${selectedInventory.cost.toFixed(2)}`);
                }
            }
        });
    }

    function updateTotalLineCost(tr) {
        var quantity = parseInt(tr.find('.quantity input').val()) || 0;
        var cost = parseFloat(tr.find('.cost').text().replace('$', '')) || 0;
        var lineCost = quantity * cost;
        tr.find('.lineCost').text('$' + lineCost.toFixed(2));
    }


    function addOtherMaterialsButton(category) {
        const wrapperId = `${category.toLowerCase()}Wrapper`;
        const contentWrapper = $(`#${wrapperId}`);
        const otherMaterialsBtn = `
            <button onclick="showOtherMaterials('${category}')">Other Materials</button>
        `;
        contentWrapper.find('.action-buttons').append(otherMaterialsBtn);
    }
    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }

    let customerSearchTimeout;

    function searchCustomers(query) {
        $.ajax({
            url: '/search-customers',
            method: 'GET',
            data: { query: query },
            success: function(data) {
                displayCustomerResults(data);
            },
            error: function(error) {
                console.error('Error searching customers:', error);
            }
        });
    }
    function displayCustomerResults(customers) {
        const resultsDiv = $('#customerSearchResults');
        resultsDiv.empty();

        if (customers.length === 0) {
            resultsDiv.append('<p>No matching customers found.</p>');
        } else {
            const ul = $('<ul>');
            customers.forEach(customer => {
                ul.append(`<li data-customer='${JSON.stringify(customer)}'>${customer.customer_name}</li>`);
            });
            resultsDiv.append(ul);

            // Add click event to customer results
            resultsDiv.find('li').on('click', function() {
                const customer = JSON.parse($(this).attr('data-customer'));
                fillCustomerDetails(customer);
                resultsDiv.empty();
            });
        }
    }
    function getCsrfToken() {
        const tokenElement = document.getElementById('csrf_token');
        if (!tokenElement) {
            console.error('CSRF token element not found');
            return null;
        }
        return tokenElement.value;
    }

    function saveCustomer() {
        return new Promise((resolve, reject) => {
            const csrfToken = getCsrfToken();
            if (!csrfToken) {
                console.error('CSRF token is missing');
                reject(new Error('CSRF token is missing'));
                return;
            }

            const customerData = {
                customer_name: $('#customerName').val(),
                customer_address: $('#customerAddress').val(),
                customer_state: $('#customerState').val(),
                customer_city: $('#customerCity').val(),
                customer_zip: $('#customerZip').val()
            };

            console.log('Sending customer data:', customerData);

            $.ajax({
                url: '/save-customer',
                method: 'POST',
                data: JSON.stringify(customerData),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                success: function(response) {
                    console.log('Save customer response:', response);
                    if (response.status === 'new') {
                        if (confirm('Customer not found. Would you like to create a new customer?')) {
                            createNewCustomer(customerData, csrfToken)
                                .then(() => {
                                    console.log('New customer created successfully');
                                    resolve();
                                })
                                .catch(reject);
                        } else {
                            clearCustomerFields();
                            resolve();

                        }
                    } else {
                        console.log('Customer updated successfully');
                        resolve();
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('Error saving customer:', textStatus, errorThrown);
                    console.error('Response:', jqXHR.responseText);
                    reject(new Error(`Error saving customer: ${textStatus}`));
                }
            });
        });
    }
    function createNewCustomer(customerData, csrfToken) {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '/create-customer',
                method: 'POST',
                data: JSON.stringify(customerData),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                success: function(response) {
                    alert('New customer created successfully.');
                    resolve();
                },
                error: function(error) {
                    console.error('Error creating new customer:', error);
                    alert('Error creating new customer.');
                    reject(error);
                }
            });
        });
    }
    function clearCustomerFields() {
        $('#customerName').val('');
        $('#customerAddress').val('');
        $('#customerState').val('');
        $('#customerCity').val('');
        $('#customerZip').val('');
    }

    // Add these helper functions to your existing JavaScript
    function getLaborValue(category) {
        const wrapper = $(`#${category.toLowerCase()}Wrapper`);
        const laborRate = getLaborRate(`${category.toLowerCase()}Wrapper`);
        const categoryData = calculateCategoryTotal(`${category.toLowerCase()}Wrapper`, laborRate);
        return categoryData.laborTotal;
    }

    function getMaterialValue(category) {
        const wrapper = $(`#${category.toLowerCase()}Wrapper`);
        const laborRate = getLaborRate(`${category.toLowerCase()}Wrapper`);
        const categoryData = calculateCategoryTotal(`${category.toLowerCase()}Wrapper`, laborRate);
        return categoryData.materialTotal + categoryData.otherMaterialsTotal;
    }

    (function(window, $) {
    // Adjustment Tracking Module
    // Enhanced AdjustmentTracker class
    class AdjustmentTracker {
        constructor() {
            // Get bid ID from the page
            this.bidId = document.getElementById('bidId').value;
            
            // Load existing history from the server
            this.loadHistory();
        }

        // Updated loadHistory method with better error handling
        loadHistory() {
            const bidId = document.getElementById('bidId')?.value;
            
            if (!bidId) {
                console.warn('No bid ID found, skipping adjustment history load');
                this.adjustmentHistory = [];
                return;
            }
            
            fetch(`/api/adjustments/${bidId}`)
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 404) {
                            console.warn('Adjustment API not yet available');
                            return []; // Return empty array for 404
                        }
                        throw new Error(`HTTP error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    this.adjustmentHistory = data || [];
                    this.updateAdjustmentHistoryDisplay();
                })
                .catch(error => {
                    console.error('Error loading adjustment history:', error);
                    this.adjustmentHistory = []; // Initialize as empty array on error
                    // Still try to update the display with empty data
                    this.updateAdjustmentHistoryDisplay();
                });
        }
        // Record an adjustment to the server
        recordAdjustment(details) {
            const adjustmentData = {
                bid_id: this.bidId,
                section: details.section,
                type: details.type,
                direction: details.direction,
                percentage: details.percentage,
                original_values: details.originalValues
            };

            return fetch('/api/adjustments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken()
                },
                body: JSON.stringify(adjustmentData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { 
                        throw new Error(err.error || 'Failed to save adjustment'); 
                    });
                }
                return response.json();
            })
            .then(data => {
                // Add to local history and update display
                this.adjustmentHistory.unshift(data);
                this.updateAdjustmentHistoryDisplay();
                return data;
            });
        }

        // Undo a specific adjustment
        undoAdjustment(adjustmentId) {
            return fetch(`/api/adjustments/${adjustmentId}/undo`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { 
                        throw new Error(err.error || 'Failed to undo adjustment'); 
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Apply the reversion
                    this.revertAdjustment(data.original_values);
                    
                    // Update the local history entry
                    const adjustmentIndex = this.adjustmentHistory.findIndex(
                        adj => adj.id === data.adjustment_id
                    );
                    
                    if (adjustmentIndex !== -1) {
                        this.adjustmentHistory[adjustmentIndex].is_active = false;
                    }
                    
                    this.updateAdjustmentHistoryDisplay();
                    return true;
                }
                throw new Error('Undo operation failed on server');
            });
        }

        // Revert an adjustment using original values
        revertAdjustment(originalValues) {
            // Group items by section
            const sections = {};
            
            // Group items by section
            originalValues.forEach(item => {
                const section = item.section.toLowerCase();
                if (!sections[section]) {
                    sections[section] = [];
                }
                sections[section].push(item);
            });
            
            // Process each section
            Object.entries(sections).forEach(([section, items]) => {
                const wrapper = $(`#${section}Wrapper`);
                let materialAdjusted = false;
                
                // For each row in the section
                wrapper.find('.itemsTable tbody tr').each(function(index) {
                    if (index < items.length) {
                        const origItem = items[index];
                        const tr = $(this);
                        const factorCode = tr.find('.factorCodeInput').val();
                        const quantity = parseFloat(tr.find('.quantity input').val()) || 0;
                        
                        // Restore values based on what's available
                        if (origItem.cost !== undefined) {
                            tr.find('.costInput').val(origItem.cost.toFixed(2));
                            materialAdjusted = true;
                        }
                        
                        if (origItem.laborHours !== undefined) {
                            tr.find('.laborHoursInput').val(origItem.laborHours.toFixed(4));
                        }
                        
                        // Restore factor code item costs if available
                        if (origItem.factorCodeItems && origItem.factorCodeItems.length > 0 && 
                            factorCode && window.factorCodeItemsCache && window.factorCodeItemsCache[factorCode]) {
                            
                            // Restore each original factor code item cost
                            origItem.factorCodeItems.forEach((fcItem, fcIndex) => {
                                if (fcIndex < window.factorCodeItemsCache[factorCode].length) {
                                    window.factorCodeItemsCache[factorCode][fcIndex].cost = fcItem.cost;
                                }
                            });
                            
                            materialAdjusted = true;
                        }
                        
                        // Update calculations
                        updateLineAndTotalCosts(tr.find('.quantity input')[0]);
                    }
                });
                
                // If materials were adjusted, recalculate other materials costs
                if (materialAdjusted) {
                    showOtherMaterials(section, false);
                }
                
                // Update wrapper totals
                updateTotalCost(wrapper);
            });
            
            // Update overall totals
            updateBudgetTotals();
        }
        // Update the adjustment history display in the UI
        updateAdjustmentHistoryDisplay() {
            const historyTable = document.getElementById('adjustmentHistoryTable');
            if (!historyTable) return;

            // Clear existing rows
            while (historyTable.rows.length > 1) {
                historyTable.deleteRow(1);
            }

            // Populate with current history, filtering out inactive adjustments
            const activeAdjustments = this.adjustmentHistory.filter(adj => adj.is_active);
            
            if (activeAdjustments.length === 0) {
                const emptyRow = historyTable.insertRow();
                const cell = emptyRow.insertCell(0);
                cell.colSpan = 7;
                cell.textContent = "No adjustment history available.";
                cell.style.textAlign = "center";
                cell.style.fontStyle = "italic";
                return;
            }
            
            activeAdjustments.forEach(adjustment => {
                const row = historyTable.insertRow();
                const timestamp = new Date(adjustment.timestamp).toLocaleString();
                
                row.innerHTML = `
                    <td>${timestamp}</td>
                    <td>${adjustment.user.username}</td>
                    <td>${adjustment.section}</td>
                    <td>${adjustment.type}</td>
                    <td>${adjustment.direction}</td>
                    <td>${adjustment.percentage}%</td>
                    <td>
                        <button onclick="window.adjustmentTracker.undoAdjustment(${adjustment.id})" 
                                class="undo-btn">Undo</button>
                    </td>
                `;
            });
        }

        // Get the CSRF token from the page
        getCsrfToken() {
            const tokenElement = document.getElementById('csrf_token');
            return tokenElement ? tokenElement.value : null;
        }
    }
    // Attach to window
    window.AdjustmentTracker = AdjustmentTracker;

    // Automatically create an instance
    window.adjustmentTracker = new AdjustmentTracker();

    // Optional: Add a method to reinitialize or reset the tracker
    window.reinitializeAdjustmentTracker = function() {
        window.adjustmentTracker = new AdjustmentTracker();
    };

    // Optional: Check and auto-initialize if not already present
    if (!window.adjustmentTracker) {
        window.adjustmentTracker = new AdjustmentTracker();
    }
})(window, jQuery);

    function initializeAdjustmentTab() {
        // Get all the necessary elements
        const adjustmentType = document.getElementsByName('adjustmentType');
        const direction = document.getElementsByName('direction');
        const category = document.getElementsByName('category');
        const percentageInput = document.getElementById('adjustmentPercentage');
        const resultsTable = document.querySelector('.results-table');
        const applyButton = document.getElementById('applyAdjustment');

        // Helper function to get section values
        function getSectionValues(section) {
            const wrapper = $(`#${section.toLowerCase()}Wrapper`);
            const laborRate = getLaborRate(`${section.toLowerCase()}Wrapper`);
            const categoryData = calculateCategoryTotal(`${section.toLowerCase()}Wrapper`, laborRate);
            
            return {
                labor: categoryData.laborTotal,
                material: categoryData.materialTotal + categoryData.otherMaterialsTotal
            };
        }

        // Function to clear the table
        function clearTable() {
            const rows = ['material-row', 'labor-row'];
            rows.forEach(rowClass => {
                const row = document.querySelector(`.${rowClass}`);
                if (row) {
                    const currentValue = row.querySelector('.current-value');
                    const adjustedValue = row.querySelector('.adjusted-value');
                    if (currentValue) currentValue.textContent = '$0.00';
                    if (adjustedValue) {
                        adjustedValue.textContent = 'N/A';
                        adjustedValue.classList.add('na-value');
                    }
                }
            });
        }

        // Function to clear the form
        function clearForm() {
            document.querySelectorAll('input[name="adjustmentType"], input[name="direction"], input[name="category"]')
                .forEach(input => input.checked = false);
            if (percentageInput) percentageInput.value = '';
            clearTable();
            checkInputsValid();
        }

        // Function to check if all inputs are valid
        function checkInputsValid() {
            const selectedType = document.querySelector('input[name="adjustmentType"]:checked')?.value;
            const selectedSection = document.querySelector('input[name="category"]:checked')?.value;
            const selectedDirection = document.querySelector('input[name="direction"]:checked')?.value;
            const percentage = parseFloat(percentageInput.value);

            const isValid = selectedType && selectedSection && selectedDirection && !isNaN(percentage) && percentage > 0;
            applyButton.disabled = !isValid;
            return isValid;
        }

        // Function to format currency
        function formatCurrency(value) {
            return `$${value.toFixed(2)}`;
        }

        // Function to update the adjusted values
        function updateAdjustedValues() {
            const selectedType = document.querySelector('input[name="adjustmentType"]:checked')?.value;
            const selectedSection = document.querySelector('input[name="category"]:checked')?.value;
            const selectedDirection = document.querySelector('input[name="direction"]:checked')?.value;
            const percentage = parseFloat(percentageInput.value);

            const materialRow = document.querySelector('.material-row');
            const laborRow = document.querySelector('.labor-row');

            // Reset to N/A if inputs are incomplete
            if (!selectedType || !selectedSection || !selectedDirection || isNaN(percentage)) {
                if (materialRow) {
                    const adjustedMaterial = materialRow.querySelector('.adjusted-value');
                    adjustedMaterial.textContent = 'N/A';
                    adjustedMaterial.classList.add('na-value');
                }
                if (laborRow) {
                    const adjustedLabor = laborRow.querySelector('.adjusted-value');
                    adjustedLabor.textContent = 'N/A';
                    adjustedLabor.classList.add('na-value');
                }
                return;
            }

            const multiplier = selectedDirection === 'increase' ? (1 + percentage / 100) : (1 - percentage / 100);
            const sectionValues = getSectionValues(selectedSection);

            if (materialRow && laborRow) {
                const adjustedMaterial = materialRow.querySelector('.adjusted-value');
                const adjustedLabor = laborRow.querySelector('.adjusted-value');

                if (selectedType === 'Materials') {
                    // Update material value, keep labor the same
                    adjustedMaterial.textContent = formatCurrency(sectionValues.material * multiplier);
                    adjustedMaterial.classList.remove('na-value');
                    adjustedLabor.textContent = formatCurrency(sectionValues.labor);
                    adjustedLabor.classList.remove('na-value');
                } else {
                    // Update labor value, keep material the same
                    adjustedMaterial.textContent = formatCurrency(sectionValues.material);
                    adjustedMaterial.classList.remove('na-value');
                    adjustedLabor.textContent = formatCurrency(sectionValues.labor * multiplier);
                    adjustedLabor.classList.remove('na-value');
                }
            }
        }

        // Function to update the current values in the table
        function updateCurrentValues() {
            const selectedType = document.querySelector('input[name="adjustmentType"]:checked')?.value;
            const selectedSection = document.querySelector('input[name="category"]:checked')?.value;
            
            if (!selectedType || !selectedSection) {
                clearTable();
                return;
            }

            const sectionValues = getSectionValues(selectedSection);
            
            // Update material row
            const materialRow = document.querySelector('.material-row');
            if (materialRow) {
                const currentMaterial = materialRow.querySelector('.current-value');
                const adjustedMaterial = materialRow.querySelector('.adjusted-value');
                if (currentMaterial) currentMaterial.textContent = formatCurrency(sectionValues.material);
                if (adjustedMaterial) {
                    adjustedMaterial.textContent = 'N/A';
                    adjustedMaterial.classList.add('na-value');
                }
            }
            
            // Update labor row
            const laborRow = document.querySelector('.labor-row');
            if (laborRow) {
                const currentLabor = laborRow.querySelector('.current-value');
                const adjustedLabor = laborRow.querySelector('.adjusted-value');
                if (currentLabor) currentLabor.textContent = formatCurrency(sectionValues.labor);
                if (adjustedLabor) {
                    adjustedLabor.textContent = 'N/A';
                    adjustedLabor.classList.add('na-value');
                }
            }

            updateAdjustedValues();
        }

        // Use the global adjustmentTracker that was defined in the previous script
        if (!window.adjustmentTracker) {
            console.error('Adjustment Tracker not initialized');
            return;
        }

        // Modified applyAdjustment function
        function applyAdjustment() {
            // Get form values
            const selectedType = document.querySelector('input[name="adjustmentType"]:checked')?.value;
            const selectedSection = document.querySelector('input[name="category"]:checked')?.value;
            const selectedDirection = document.querySelector('input[name="direction"]:checked')?.value;
            const percentageInput = document.getElementById('adjustmentPercentage');
            const percentage = parseFloat(percentageInput?.value || '0');

            // Validate input
            if (!selectedType || !selectedSection || !selectedDirection || isNaN(percentage) || percentage <= 0) {
                showNotification('Please fill in all fields with valid values.', 'error');
                return;
            }

            const multiplier = selectedDirection === 'increase' ? (1 + percentage / 100) : (1 - percentage / 100);
            const wrapper = $(`#${selectedSection.toLowerCase()}Wrapper`);

            if (!wrapper.length) {
                showNotification(`Section "${selectedSection}" not found.`, 'error');
                return;
            }

            // Store original values for potential undo
            const originalValues = [];
            
            // First pass - store all original values
            wrapper.find('.itemsTable tbody tr').each(function() {
                const tr = $(this);
                const factorCode = tr.find('.factorCodeInput').val();
                const quantity = parseFloat(tr.find('.quantity input').val()) || 0;
                const otherMaterialsCost = parseFloat(tr.find('.otherMaterials').text().replace('$', '')) || 0;
                
                if (selectedType === 'Materials') {
                    const costInput = tr.find('.costInput');
                    const currentCost = parseFloat(costInput.val()) || 0;
                    
                    // Store original values
                    const originalItem = {
                        section: selectedSection,
                        cost: currentCost,
                        otherMaterialsCost: otherMaterialsCost,
                        factorCodeItems: []
                    };

                    // Store factor code items if applicable
                    if (factorCode && window.factorCodeItemsCache && window.factorCodeItemsCache[factorCode]) {
                        originalItem.factorCodeItems = window.factorCodeItemsCache[factorCode].map(item => ({
                            cost: parseFloat(item.cost) || 0,
                            quantity: parseFloat(item.quantity) || 0,
                            part_number: item.part_number
                        }));
                    }

                    originalValues.push(originalItem);
                } else {
                    const laborInput = tr.find('.laborHoursInput');
                    const currentLabor = parseFloat(laborInput.val()) || 0;
                    
                    // Store original values
                    originalValues.push({
                        section: selectedSection,
                        laborHours: currentLabor,
                        otherMaterialsCost: otherMaterialsCost
                    });
                }
            });
            
            // Second pass - apply adjustments
            wrapper.find('.itemsTable tbody tr').each(function() {
                const tr = $(this);
                const factorCode = tr.find('.factorCodeInput').val();
                const quantity = parseFloat(tr.find('.quantity input').val()) || 0;
                
                if (selectedType === 'Materials') {
                    const costInput = tr.find('.costInput');
                    const currentCost = parseFloat(costInput.val()) || 0;
                    
                    // Apply adjustment to the direct cost
                    costInput.val((currentCost * multiplier).toFixed(2));
                    
                    // Adjust factor code items costs if applicable
                    if (factorCode && window.factorCodeItemsCache && window.factorCodeItemsCache[factorCode]) {
                        // Adjust each factor code item cost
                        window.factorCodeItemsCache[factorCode].forEach(item => {
                            item.cost = parseFloat(item.cost || 0) * multiplier;
                        });
                    }
                } else {
                    const laborInput = tr.find('.laborHoursInput');
                    const currentLabor = parseFloat(laborInput.val()) || 0;
                    
                    // Apply the adjustment to labor hours
                    laborInput.val((currentLabor * multiplier).toFixed(4));
                }
            });

            // Update other materials costs for the whole section
            if (selectedType === 'Materials') {
                // Use updateOtherMaterials instead of showOtherMaterials to ensure complete recalculation
                updateOtherMaterials(selectedSection.toLowerCase());
            } else {
                // Still need to update calculations for each row
                wrapper.find('.itemsTable tbody tr').each(function() {
                    updateLineAndTotalCosts($(this).find('.quantity input')[0]);
                });
            }
            
            // Update all totals
            updateTotalCost(wrapper);
            updateBudgetTotals();

            // Show loading indicator
            const applyButton = document.getElementById('applyAdjustment');
            const originalText = applyButton.textContent;
            applyButton.textContent = 'Saving...';
            applyButton.disabled = true;

            // Record the adjustment using global tracker
            if (!window.adjustmentTracker) {
                window.adjustmentTracker = new AdjustmentTracker();
            }

            window.adjustmentTracker.recordAdjustment({
                section: selectedSection,
                type: selectedType,
                direction: selectedDirection,
                percentage: percentage,
                originalValues: originalValues
            })
            .then(() => {
                // Clear the form and show success message
                clearForm();
                showNotification('Adjustment applied and saved successfully!', 'success');
            })
            .catch(error => {
                console.error('Error saving adjustment:', error);
                showNotification(`Error: ${error.message}`, 'error');
            })
            .finally(() => {
                // Restore button state
                applyButton.textContent = originalText;
                applyButton.disabled = false;
            });
        }
    // Helper function to show notifications
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        
        // Append to the top of the adjustment tab
        const adjustmentTab = document.getElementById('Adjustment');
        adjustmentTab.insertBefore(notification, adjustmentTab.firstChild);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 500);
        }, 5000);
    }
        // Add event listeners
        adjustmentType.forEach(radio => {
            radio.addEventListener('change', () => {
                updateCurrentValues();
                checkInputsValid();
            });
        });

        category.forEach(radio => {
            radio.addEventListener('change', () => {
                updateCurrentValues();
                checkInputsValid();
            });
        });

        direction.forEach(radio => {
            radio.addEventListener('change', () => {
                updateAdjustedValues();
                checkInputsValid();
            });
        });

        percentageInput.addEventListener('input', () => {
            updateAdjustedValues();
            checkInputsValid();
        });

        applyButton.addEventListener('click', applyAdjustment);

        // Initialize the adjustment history table
        function addAdjustmentHistoryTable() {
            const adjustmentTab = document.getElementById('Adjustment');
            if (!adjustmentTab) return;

            const historyTableHTML = `
                <div class="adjustment-history-container">
                    <h4>Adjustment History</h4>
                    <table id="adjustmentHistoryTable" class="table table-striped">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User</th>
                                <th>Section</th>
                                <th>Type</th>
                                <th>Direction</th>
                                <th>Percentage</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Adjustment history rows will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            `;

            // Append the history table to the Adjustment tab
            adjustmentTab.insertAdjacentHTML('beforeend', historyTableHTML);

            // Initialize the history display
            window.adjustmentTracker.updateAdjustmentHistoryDisplay();
        }

        // Add history table when document is ready
        document.addEventListener('DOMContentLoaded', function() {
            addAdjustmentHistoryTable();
        });

        // Initialize state
        clearTable();
        checkInputsValid();
    }
    // Initialize when document is ready
    document.addEventListener('DOMContentLoaded', function() {
        initializeAdjustmentTab();
        
        // Create global adjustment tracker
        window.adjustmentTracker = new AdjustmentTracker();
    });
    </script>
</body>
</html>